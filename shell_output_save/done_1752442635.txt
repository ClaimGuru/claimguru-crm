claimguru/src/pages/AIInsights.tsx
import React, { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { AISettlementPredictor } from '../components/ai/AISettlementPredictor'
import { AdvancedAIDashboard } from '../components/ai/AdvancedAIDashboard'
import { 
  Brain, 
  FileText, 
  TrendingUp, 
  AlertTriangle,
  CheckCircle,
  DollarSign,
  Clock,
  Eye,
  Download,
  Upload,
  Zap,
  Target,
  BarChart3,
  PieChart,
  Activity,
  Shield,
  Sparkles
} from 'lucide-react'
import { useClaims } from '../hooks/useClaims'
import { useAuth } from '../contexts/AuthContext'

interface AIInsight {
  id: string
  title: string
  type: 'prediction' | 'risk' | 'opportunity' | 'compliance'
  confidence: number
  description: string
  recommendation: string
  created_at: string
  claim_id?: string
}

export function AIInsights() {
  const { userProfile } = useAuth()
  const { claims, loading: claimsLoading } = useClaims()
  const [insights, setInsights] = useState<AIInsight[]>([])
  const [loading, setLoading] = useState(true)
  const [selectedFile, setSelectedFile] = useState<File | null>(null)
  const [analyzing, setAnalyzing] = useState(false)
  const [analysisResult, setAnalysisResult] = useState<any>(null)
  const [activeTab, setActiveTab] = useState<'overview' | 'predictions' | 'analysis' | 'dashboard'>('overview')

  useEffect(() => {
    if (!claimsLoading) {
      loadAIInsights()
    }
  }, [claimsLoading, userProfile?.organization_id])

  async function loadAIInsights() {
    if (!userProfile?.organization_id) return

    try {
      // Generate mock AI insights based on claims data
      const mockInsights: AIInsight[] = [
        {
          id: '1',
          title: 'High Settlement Opportunity Detected',
          type: 'opportunity',
          confidence: 0.91,
          description: 'Claims similar to CG-2025-003 typically settle 23% higher than initial estimates.',
          recommendation: 'Request independent appraisal and gather additional damage documentation.',
          created_at: new Date().toISOString(),
          claim_id: claims[0]?.id
        },
        {
          id: '2', 
          title: 'Risk Alert: Documentation Gap',
          type: 'risk',
          confidence: 0.87,
          description: 'Missing weather reports could impact settlement for wind damage claims.',
          recommendation: 'Obtain official weather data from National Weather Service.',
          created_at: new Date().toISOString(),
          claim_id: claims[1]?.id
        },
        {
          id: '3',
          title: 'Settlement Timeline Prediction',
          type: 'prediction',
          confidence: 0.94,
          description: 'Based on carrier patterns, expect settlement offer within 45-60 days.',
          recommendation: 'Prepare counter-negotiation strategy by day 40.',
          created_at: new Date().toISOString(),
          claim_id: claims[2]?.id
        },
        {
          id: '4',
          title: 'Compliance Requirement Update',
          type: 'compliance',
          confidence: 0.99,
          description: 'New state regulations require additional photo documentation for roof claims.',
          recommendation: 'Schedule re-inspection to capture required angles and details.',
          created_at: new Date().toISOString()
        }
      ]

      setInsights(mockInsights)
      setLoading(false)
    } catch (error) {
      console.error('Error loading AI insights:', error)
      setLoading(false)
    }
  }

  async function analyzeDocument() {
    if (!selectedFile || !userProfile?.organization_id) return

    setAnalyzing(true)
    try {
      // Simulate document analysis
      setTimeout(() => {
        setAnalysisResult({
          summary: 'Document analyzed successfully',
          riskLevel: 'Medium',
          recommendations: ['Gather additional evidence', 'Review policy terms']
        })
        setAnalyzing(false)
        setSelectedFile(null)
      }, 3000)
    } catch (error) {
      console.error('Error analyzing document:', error)
      setAnalyzing(false)
      setSelectedFile(null)
    }
  }

  const getInsightIcon = (type: string) => {
    switch (type) {
      case 'prediction': return TrendingUp
      case 'risk': return AlertTriangle
      case 'opportunity': return DollarSign
      case 'compliance': return CheckCircle
      default: return Brain
    }
  }

  const getInsightColor = (type: string) => {
    switch (type) {
      case 'prediction': return 'text-blue-600 bg-blue-100'
      case 'risk': return 'text-red-600 bg-red-100'
      case 'opportunity': return 'text-green-600 bg-green-100'
      case 'compliance': return 'text-purple-600 bg-purple-100'
      default: return 'text-gray-600 bg-gray-100'
    }
  }

  const getConfidenceColor = (confidence: number) => {
    if (confidence >= 90) return 'text-green-600 bg-green-100'
    if (confidence >= 70) return 'text-yellow-600 bg-yellow-100'
    return 'text-red-600 bg-red-100'
  }

  if (loading || claimsLoading) {
    return (
      <div className="p-6 flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">AI Insights & Analytics</h1>
          <p className="text-gray-600 mt-2">
            Advanced AI analysis, predictions, and recommendations powered by machine learning
          </p>
        </div>
        <div className="flex space-x-2">
          <Button variant="outline">
            <Download className="h-4 w-4 mr-2" />
            Export Report
          </Button>
          <Button>
            <Sparkles className="h-4 w-4 mr-2" />
            Generate Analysis
          </Button>
        </div>
      </div>

      {/* Navigation Tabs */}
      <div className="flex space-x-1 bg-gray-100 rounded-lg p-1">
        {[
          { id: 'overview', label: 'Overview', icon: Eye },
          { id: 'predictions', label: 'Settlement Predictor', icon: Target },
          { id: 'dashboard', label: 'Analytics Dashboard', icon: BarChart3 },
          { id: 'analysis', label: 'Document Analysis', icon: FileText }
        ].map(tab => {
          const Icon = tab.icon
          return (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id as any)}
              className={`flex items-center gap-2 px-4 py-2 rounded-md font-medium text-sm transition-colors ${
                activeTab === tab.id
                  ? 'bg-white text-purple-700 shadow-sm'
                  : 'text-gray-600 hover:text-gray-900'
              }`}
            >
              <Icon className="h-4 w-4" />
              {tab.label}
            </button>
          )
        })}
      </div>

      {/* Tab Content */}
      {activeTab === 'predictions' && (
        <AISettlementPredictor claims={claims} />
      )}

      {activeTab === 'dashboard' && (
        <AdvancedAIDashboard />
      )}

      {activeTab === 'analysis' && (
        <div className="space-y-6">
          {/* Document Analysis Section */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center space-x-2">
                <Brain className="h-5 w-5" />
                <span>Document Analysis</span>
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-6">
                <div className="text-center">
                  <Brain className="h-12 w-12 text-purple-600 mx-auto mb-4" />
                  <h3 className="text-lg font-semibold text-gray-900 mb-2">
                    AI-Powered Document Analysis
                  </h3>
                  <p className="text-gray-600 mb-6">
                    Upload insurance documents to get instant AI analysis, risk assessment, and recommendations
                  </p>
                  
                  <div className="max-w-md mx-auto">
                    <div className="flex items-center justify-center w-full">
                      <label className="flex flex-col items-center justify-center w-full h-32 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                        <div className="flex flex-col items-center justify-center pt-5 pb-6">
                          <Upload className="w-8 h-8 mb-2 text-gray-500" />
                          <p className="text-sm text-gray-500">
                            {selectedFile ? selectedFile.name : 'Click to upload document'}
                          </p>
                        </div>
                        <input 
                          type="file" 
                          className="hidden" 
                          accept=".pdf,.doc,.docx,.jpg,.jpeg,.png"
                          onChange={(e) => setSelectedFile(e.target.files?.[0] || null)}
                        />
                      </label>
                    </div>
                    
                    {selectedFile && (
                      <Button 
                        onClick={analyzeDocument}
                        disabled={analyzing}
                        className="mt-4 w-full flex items-center gap-2"
                      >
                        {analyzing ? (
                          <>
                            <LoadingSpinner size="sm" />
                            Analyzing...
                          </>
                        ) : (
                          <>
                            <Zap className="h-4 w-4" />
                            Analyze with AI
                          </>
                        )}
                      </Button>
                    )}
                  </div>
                </div>
                
                {analysisResult && (
                  <div className="mt-6 p-4 bg-green-50 rounded-lg">
                    <h4 className="font-semibold text-green-800 mb-2">Analysis Complete!</h4>
                    <p className="text-green-700">
                      Document analyzed successfully. Check the insights below for detailed findings.
                    </p>
                  </div>
                )}
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Overview Tab Content */}
      {activeTab === 'overview' && (
        <div className="space-y-6">
          {/* AI Summary Banner */}
          <Card className="bg-gradient-to-r from-purple-600 to-blue-600 text-white">
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <h3 className="text-xl font-semibold mb-2">ðŸ¤– AI Insights Summary</h3>
                  <p className="text-purple-100">
                    {insights.length} active insights â€¢ {insights.filter(i => i.type === 'risk').length} risk alerts â€¢ {insights.filter(i => i.type === 'opportunity').length} opportunities identified
                  </p>
                </div>
                <div className="text-right">
                  <div className="text-3xl font-bold">
                    {Math.round(insights.reduce((sum, insight) => sum + insight.confidence, 0) / insights.length * 100 || 0)}%
                  </div>
                  <div className="text-purple-200 text-sm">Avg Confidence</div>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Quick Stats */}
          <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
            <Card>
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600">Total Insights</p>
                    <p className="text-3xl font-bold text-gray-900">{insights.length}</p>
                  </div>
                  <Brain className="h-8 w-8 text-purple-600" />
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600">Risk Alerts</p>
                    <p className="text-3xl font-bold text-red-600">
                      {insights.filter(i => i.type === 'risk').length}
                    </p>
                  </div>
                  <AlertTriangle className="h-8 w-8 text-red-600" />
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600">Opportunities</p>
                    <p className="text-3xl font-bold text-green-600">
                      {insights.filter(i => i.type === 'opportunity').length}
                    </p>
                  </div>
                  <DollarSign className="h-8 w-8 text-green-600" />
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600">High Confidence</p>
                    <p className="text-3xl font-bold text-blue-600">
                      {insights.filter(i => i.confidence >= 0.9).length}
                    </p>
                  </div>
                  <CheckCircle className="h-8 w-8 text-blue-600" />
                </div>
              </CardContent>
            </Card>
          </div>

          {/* Insights List */}
          <div className="space-y-4">
            <h3 className="text-lg font-semibold text-gray-900">Recent AI Insights</h3>
            {insights.map((insight) => {
              const Icon = getInsightIcon(insight.type)
              return (
                <Card key={insight.id} className="hover:shadow-lg transition-shadow">
                  <CardContent className="p-6">
                    <div className="flex items-start justify-between">
                      <div className="flex items-start space-x-4 flex-1">
                        <div className={`p-2 rounded-lg ${getInsightColor(insight.type)}`}>
                          <Icon className="h-5 w-5" />
                        </div>
                        
                        <div className="flex-1">
                          <div className="flex items-center space-x-2 mb-2">
                            <h4 className="font-semibold text-gray-900">{insight.title}</h4>
                            <span className={`px-2 py-1 text-xs font-medium rounded-full ${getConfidenceColor(insight.confidence * 100)}`}>
                              {Math.round(insight.confidence * 100)}% confidence
                            </span>
                          </div>
                          
                          <p className="text-gray-700 mb-2">{insight.description}</p>
                          <p className="text-sm text-blue-700 font-medium">
                            ðŸ’¡ {insight.recommendation}
                          </p>
                        </div>
                      </div>
                    </div>
                    
                    <div className="mt-4 pt-4 border-t border-gray-200 flex items-center justify-between">
                      <div className="flex items-center text-sm text-gray-500">
                        <Clock className="h-4 w-4 mr-1" />
                        {new Date(insight.created_at).toLocaleString()}
                      </div>
                      
                      <div className="flex items-center space-x-2">
                        <Button variant="outline" size="sm" className="flex items-center gap-1">
                          <Eye className="h-4 w-4" />
                          View Details
                        </Button>
                        <Button variant="outline" size="sm" className="flex items-center gap-1">
                          <Download className="h-4 w-4" />
                          Export
                        </Button>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              )
            })}
          </div>
        </div>
      )}
    </div>
  )
}
\n
claimguru/src/pages/AdminPanel.tsx
/**
 * Admin Panel - Central administration interface
 * Includes custom field management, folder templates, permissions, and system settings
 */

import React, { useState } from 'react';
import { Settings, Users, FolderOpen, Database, Shield, Bell, Mail, Phone } from 'lucide-react';
import { Card } from '../components/ui/Card';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '../components/ui/tabs';
import { Badge } from '../components/ui/Badge';
import CustomFieldManager from '../components/admin/CustomFieldManager';
import FolderTemplateManager from '../components/admin/FolderTemplateManager';

// Mock organization ID - in real app, get from auth context
const ORGANIZATION_ID = 'org-123-demo';

export const AdminPanel: React.FC = () => {
  const [activeTab, setActiveTab] = useState('fields');

  const adminSections = [
    {
      id: 'fields',
      label: 'Custom Fields',
      icon: Database,
      description: 'Manage custom fields for claims and intake wizard',
      component: <CustomFieldManager organizationId={ORGANIZATION_ID} />
    },
    {
      id: 'folders',
      label: 'Folder Templates',
      icon: FolderOpen,
      description: 'Configure automatic folder creation for claims',
      component: <FolderTemplateManager organizationId={ORGANIZATION_ID} />
    },
    {
      id: 'permissions',
      label: 'Permissions',
      icon: Shield,
      description: 'Manage user roles and access controls',
      component: <PermissionsManager />
    },
    {
      id: 'communications',
      label: 'Communications',
      icon: Mail,
      description: 'Configure email, SMS, and phone integrations',
      component: <CommunicationsSettings />
    },
    {
      id: 'users',
      label: 'User Management',
      icon: Users,
      description: 'Manage organization users and teams',
      component: <UserManager />
    },
    {
      id: 'system',
      label: 'System Settings',
      icon: Settings,
      description: 'General system configuration',
      component: <SystemSettings />
    }
  ];

  return (
    <div className="p-6 space-y-6">
      <div className="flex items-center gap-4">
        <Settings className="h-8 w-8 text-blue-600" />
        <div>
          <h1 className="text-3xl font-bold">Admin Panel</h1>
          <p className="text-gray-600">Manage your ClaimGuru organization settings and configurations</p>
        </div>
      </div>

      <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
        <TabsList className="grid w-full grid-cols-6 mb-6">
          {adminSections.map((section) => (
            <TabsTrigger
              key={section.id}
              value={section.id}
              className="flex flex-col items-center gap-1 p-3 h-auto"
            >
              <section.icon className="h-4 w-4" />
              <span className="text-xs">{section.label}</span>
            </TabsTrigger>
          ))}
        </TabsList>

        {adminSections.map((section) => (
          <TabsContent key={section.id} value={section.id} className="space-y-6">
            <div className="flex items-center gap-3 mb-6">
              <section.icon className="h-6 w-6 text-blue-600" />
              <div>
                <h2 className="text-2xl font-bold">{section.label}</h2>
                <p className="text-gray-600">{section.description}</p>
              </div>
            </div>
            {section.component}
          </TabsContent>
        ))}
      </Tabs>
    </div>
  );
};

// Placeholder components for other admin sections
const PermissionsManager: React.FC = () => (
  <Card className="p-6">
    <h3 className="text-lg font-semibold mb-4">Permission Management</h3>
    <div className="space-y-4">
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <Card className="p-4">
          <h4 className="font-semibold mb-2">Admin Role</h4>
          <div className="space-y-2 text-sm">
            <div className="flex items-center justify-between">
              <span>Create Custom Fields</span>
              <Badge variant="default">Enabled</Badge>
            </div>
            <div className="flex items-center justify-between">
              <span>Manage Folders</span>
              <Badge variant="default">Enabled</Badge>
            </div>
            <div className="flex items-center justify-between">
              <span>User Management</span>
              <Badge variant="default">Enabled</Badge>
            </div>
          </div>
        </Card>

        <Card className="p-4">
          <h4 className="font-semibold mb-2">Adjuster Role</h4>
          <div className="space-y-2 text-sm">
            <div className="flex items-center justify-between">
              <span>Create Custom Fields</span>
              <Badge variant="secondary">Disabled</Badge>
            </div>
            <div className="flex items-center justify-between">
              <span>Manage Claims</span>
              <Badge variant="default">Enabled</Badge>
            </div>
            <div className="flex items-center justify-between">
              <span>View Reports</span>
              <Badge variant="default">Enabled</Badge>
            </div>
          </div>
        </Card>

        <Card className="p-4">
          <h4 className="font-semibold mb-2">Support Role</h4>
          <div className="space-y-2 text-sm">
            <div className="flex items-center justify-between">
              <span>View Claims</span>
              <Badge variant="default">Enabled</Badge>
            </div>
            <div className="flex items-center justify-between">
              <span>Edit Claims</span>
              <Badge variant="secondary">Disabled</Badge>
            </div>
            <div className="flex items-center justify-between">
              <span>View Contacts</span>
              <Badge variant="default">Enabled</Badge>
            </div>
          </div>
        </Card>
      </div>
      <p className="text-sm text-gray-600 mt-4">
        Permission management interface coming soon. Contact support to modify user permissions.
      </p>
    </div>
  </Card>
);

const CommunicationsSettings: React.FC = () => (
  <div className="space-y-6">
    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
      <Card className="p-6">
        <div className="flex items-center gap-3 mb-4">
          <Mail className="h-6 w-6 text-blue-600" />
          <h3 className="text-lg font-semibold">Email Integration</h3>
        </div>
        <div className="space-y-2 text-sm">
          <p><strong>Provider:</strong> Gmail/Outlook/Custom SMTP</p>
          <p><strong>Status:</strong> <Badge variant="default">Connected</Badge></p>
          <p><strong>Daily Limit:</strong> 500 emails</p>
        </div>
      </Card>

      <Card className="p-6">
        <div className="flex items-center gap-3 mb-4">
          <Phone className="h-6 w-6 text-green-600" />
          <h3 className="text-lg font-semibold">Phone System</h3>
        </div>
        <div className="space-y-2 text-sm">
          <p><strong>Provider:</strong> Amazon Connect</p>
          <p><strong>Status:</strong> <Badge variant="secondary">Not Connected</Badge></p>
          <p><strong>Features:</strong> Call recording, SMS</p>
        </div>
      </Card>

      <Card className="p-6">
        <div className="flex items-center gap-3 mb-4">
          <Bell className="h-6 w-6 text-orange-600" />
          <h3 className="text-lg font-semibold">Notifications</h3>
        </div>
        <div className="space-y-2 text-sm">
          <p><strong>Email Alerts:</strong> <Badge variant="default">Enabled</Badge></p>
          <p><strong>SMS Alerts:</strong> <Badge variant="secondary">Disabled</Badge></p>
          <p><strong>Push Notifications:</strong> <Badge variant="default">Enabled</Badge></p>
        </div>
      </Card>
    </div>
    <p className="text-sm text-gray-600">
      Full communication settings interface coming soon. Basic email integration is already configured.
    </p>
  </div>
);

const UserManager: React.FC = () => (
  <Card className="p-6">
    <h3 className="text-lg font-semibold mb-4">User Management</h3>
    <div className="space-y-4">
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <Card className="p-4 text-center">
          <div className="text-2xl font-bold text-blue-600 mb-1">12</div>
          <div className="text-sm text-gray-600">Total Users</div>
        </Card>
        <Card className="p-4 text-center">
          <div className="text-2xl font-bold text-green-600 mb-1">10</div>
          <div className="text-sm text-gray-600">Active Users</div>
        </Card>
        <Card className="p-4 text-center">
          <div className="text-2xl font-bold text-orange-600 mb-1">2</div>
          <div className="text-sm text-gray-600">Pending Invites</div>
        </Card>
        <Card className="p-4 text-center">
          <div className="text-2xl font-bold text-gray-600 mb-1">3</div>
          <div className="text-sm text-gray-600">Admin Users</div>
        </Card>
      </div>
      <p className="text-sm text-gray-600">
        User management interface coming soon. Current users can be managed through the Users page.
      </p>
    </div>
  </Card>
);

const SystemSettings: React.FC = () => (
  <div className="space-y-6">
    <Card className="p-6">
      <h3 className="text-lg font-semibold mb-4">Organization Settings</h3>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <h4 className="font-medium mb-2">General Information</h4>
          <div className="space-y-2 text-sm">
            <p><strong>Organization:</strong> Demo Insurance Adjusters</p>
            <p><strong>License:</strong> Professional Plan</p>
            <p><strong>Users:</strong> 12 / 25</p>
            <p><strong>Storage:</strong> 2.4 GB / 100 GB</p>
          </div>
        </div>
        <div>
          <h4 className="font-medium mb-2">System Status</h4>
          <div className="space-y-2 text-sm">
            <p><strong>API Status:</strong> <Badge variant="default">Operational</Badge></p>
            <p><strong>Database:</strong> <Badge variant="default">Healthy</Badge></p>
            <p><strong>Storage:</strong> <Badge variant="default">Available</Badge></p>
            <p><strong>Last Backup:</strong> 2 hours ago</p>
          </div>
        </div>
      </div>
    </Card>

    <Card className="p-6">
      <h3 className="text-lg font-semibold mb-4">Feature Modules</h3>
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div className="flex items-center justify-between p-3 border rounded">
          <span>Custom Fields</span>
          <Badge variant="default">Active</Badge>
        </div>
        <div className="flex items-center justify-between p-3 border rounded">
          <span>Document Folders</span>
          <Badge variant="default">Active</Badge>
        </div>
        <div className="flex items-center justify-between p-3 border rounded">
          <span>Email Automation</span>
          <Badge variant="default">Active</Badge>
        </div>
        <div className="flex items-center justify-between p-3 border rounded">
          <span>AI Processing</span>
          <Badge variant="default">Active</Badge>
        </div>
        <div className="flex items-center justify-between p-3 border rounded">
          <span>Phone Integration</span>
          <Badge variant="secondary">Inactive</Badge>
        </div>
        <div className="flex items-center justify-between p-3 border rounded">
          <span>Advanced Analytics</span>
          <Badge variant="secondary">Coming Soon</Badge>
        </div>
      </div>
    </Card>
  </div>
);

export default AdminPanel;
\n
claimguru/src/pages/AuthCallback.tsx
import React, { useEffect, useState } from 'react'
import { useNavigate, useSearchParams } from 'react-router-dom'
import { supabase } from '../lib/supabase'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { CheckCircle, XCircle } from 'lucide-react'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'

export function AuthCallback() {
  const [loading, setLoading] = useState(true)
  const [success, setSuccess] = useState(false)
  const [error, setError] = useState('')
  const [searchParams] = useSearchParams()
  const navigate = useNavigate()

  useEffect(() => {
    handleAuthCallback()
  }, [])

  async function handleAuthCallback() {
    try {
      const hashFragment = window.location.hash
      const errorParam = searchParams.get('error')
      const errorDescription = searchParams.get('error_description')

      // Check for error parameters first
      if (errorParam) {
        setError(errorDescription || errorParam)
        setLoading(false)
        return
      }

      // Handle email confirmation with hash fragment
      if (hashFragment && hashFragment.length > 0) {
        const { data, error } = await supabase.auth.exchangeCodeForSession(hashFragment)

        if (error) {
          console.error('Error exchanging code for session:', error)
          setError(error.message)
          setLoading(false)
          return
        }

        if (data.session && data.user) {
          console.log('Successfully authenticated user:', data.user.email)
          
          // Check if user profile exists
          const { data: profile, error: profileError } = await supabase
            .from('user_profiles')
            .select('*')
            .eq('id', data.user.id)
            .maybeSingle()

          if (profileError) {
            console.error('Error loading user profile:', profileError)
          }

          // If no profile exists, try to create it using the edge function
          if (!profile) {
            console.log('No user profile found, attempting to create...')
            try {
              const userData = data.user.user_metadata || {}
              const { data: setupData, error: setupError } = await supabase.functions.invoke('setup-new-user', {
                body: {
                  userId: data.user.id,
                  email: data.user.email,
                  firstName: userData.first_name || '',
                  lastName: userData.last_name || '',
                  companyName: userData.company_name || 'New Organization',
                  phone: userData.phone || ''
                }
              })

              if (setupError) {
                console.error('Error setting up user profile:', setupError)
              } else {
                console.log('User profile created successfully')
              }
            } catch (setupError) {
              console.error('Error during user setup:', setupError)
            }
          }

          setSuccess(true)
          setLoading(false)
          
          // Redirect to dashboard after a short delay
          setTimeout(() => {
            navigate('/dashboard')
          }, 2000)
          return
        }
      }

      // If we get here, something went wrong
      setError('No valid authentication data found. Please try signing in again.')
      setLoading(false)
      
    } catch (error: any) {
      console.error('Error during auth callback:', error)
      setError(error.message || 'An unexpected error occurred')
      setLoading(false)
    }
  }

  if (loading) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
        <Card className="w-full max-w-md">
          <CardContent className="p-8 text-center">
            <LoadingSpinner size="lg" className="mx-auto mb-4" />
            <h2 className="text-xl font-semibold mb-2">Confirming your account...</h2>
            <p className="text-gray-600">Please wait while we verify your email address.</p>
          </CardContent>
        </Card>
      </div>
    )
  }

  if (success) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
        <Card className="w-full max-w-md">
          <CardHeader className="text-center">
            <CheckCircle className="w-16 h-16 text-green-600 mx-auto mb-4" />
            <CardTitle className="text-2xl font-bold text-gray-900">
              Email Confirmed Successfully!
            </CardTitle>
          </CardHeader>
          <CardContent className="text-center">
            <p className="text-gray-600 mb-6">
              Your account has been verified. You're being redirected to your dashboard...
            </p>
            <Button 
              onClick={() => navigate('/dashboard')}
              className="w-full"
            >
              Go to Dashboard
            </Button>
          </CardContent>
        </Card>
      </div>
    )
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
      <Card className="w-full max-w-md">
        <CardHeader className="text-center">
          <XCircle className="w-16 h-16 text-red-600 mx-auto mb-4" />
          <CardTitle className="text-2xl font-bold text-gray-900">
            Confirmation Failed
          </CardTitle>
        </CardHeader>
        <CardContent className="text-center">
          <p className="text-red-600 mb-6">
            {error}
          </p>
          <div className="space-y-3">
            <Button 
              onClick={() => navigate('/auth')}
              className="w-full"
            >
              Back to Sign In
            </Button>
            <Button 
              variant="outline"
              onClick={() => window.location.reload()}
              className="w-full"
            >
              Try Again
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}\n
claimguru/src/pages/AuthPage.tsx
import React, { useState } from 'react'
import { LoginForm } from '../components/auth/LoginForm'
import { SignupForm } from '../components/auth/SignupForm'
import { FileText, Shield, Smartphone, Brain, TrendingUp, Users } from 'lucide-react'

export function AuthPage() {
  const [isLogin, setIsLogin] = useState(true)

  const features = [
    {
      icon: Brain,
      title: 'AI-Powered Analysis',
      description: 'Advanced AI analyzes documents and predicts claim outcomes'
    },
    {
      icon: Smartphone,
      title: 'Mobile-First Design',
      description: 'Access your CRM anywhere with our mobile-optimized interface'
    },
    {
      icon: FileText,
      title: 'Smart Document Management',
      description: 'Intelligent categorization and OCR for all your documents'
    },
    {
      icon: Shield,
      title: 'Enterprise Security',
      description: 'Bank-level security with multi-tenant data isolation'
    },
    {
      icon: TrendingUp,
      title: 'Advanced Analytics',
      description: 'Real-time dashboards and predictive business intelligence'
    },
    {
      icon: Users,
      title: 'Team Collaboration',
      description: 'Seamless communication and task management for your team'
    }
  ]

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
      <div className="container mx-auto px-4 py-8">
        {/* Header */}
        <div className="text-center mb-8">
          <h1 className="text-4xl font-bold text-gray-900 mb-2">
            ClaimGuru
          </h1>
          <p className="text-xl text-gray-600">
            The Most Advanced Public Insurance Adjuster CRM
          </p>
        </div>

        <div className="grid lg:grid-cols-2 gap-12 items-start">
          {/* Features Section */}
          <div className="space-y-8">
            <div>
              <h2 className="text-3xl font-bold text-gray-900 mb-4">
                Revolutionize Your Claims Management
              </h2>
              <p className="text-lg text-gray-600 mb-8">
                Built specifically for public insurance adjusters, ClaimGuru combines 
                cutting-edge AI technology with intuitive design to streamline your 
                entire claims process.
              </p>
            </div>

            <div className="grid gap-6">
              {features.map((feature, index) => {
                const Icon = feature.icon
                return (
                  <div key={index} className="flex items-start space-x-4">
                    <div className="flex-shrink-0">
                      <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center">
                        <Icon className="h-6 w-6 text-blue-600" />
                      </div>
                    </div>
                    <div>
                      <h3 className="text-lg font-semibold text-gray-900 mb-1">
                        {feature.title}
                      </h3>
                      <p className="text-gray-600">
                        {feature.description}
                      </p>
                    </div>
                  </div>
                )
              })}
            </div>

            <div className="bg-white rounded-lg p-6 shadow-sm border border-gray-200">
              <h3 className="text-lg font-semibold text-gray-900 mb-2">
                ðŸš€ Free 30-Day Trial
              </h3>
              <p className="text-gray-600">
                Start your free trial today - no credit card required. 
                Experience the future of claims management.
              </p>
            </div>
          </div>

          {/* Auth Form Section */}
          <div className="flex justify-center">
            {isLogin ? (
              <LoginForm onToggleMode={() => setIsLogin(false)} />
            ) : (
              <SignupForm onToggleMode={() => setIsLogin(true)} />
            )}
          </div>
        </div>

        {/* Footer */}
        <div className="mt-16 text-center text-gray-500">
          <p className="text-sm">
            Â© 2024 ClaimGuru. All rights reserved. 
            Built for public insurance adjusters by industry experts.
          </p>
        </div>
      </div>
    </div>
  )
}\n
claimguru/src/pages/Calendar.tsx
import React, { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { useToast } from '../hooks/useToast'
import { useAuth } from '../contexts/AuthContext'
import { supabase } from '../lib/supabase'
import { MonthView } from '../components/calendar/MonthView'
import { EventModal } from '../components/calendar/EventModal'
import {
  Calendar as CalendarIcon,
  Plus,
  ChevronLeft,
  ChevronRight,
  Clock,
  MapPin,
  Users,
  Video,
  Edit,
  Trash2,
  Bell,
  Repeat,
  Filter,
  Download,
  Upload
} from 'lucide-react'

interface Event {
  id: string
  title: string
  description?: string
  start_datetime: string
  end_datetime: string
  event_type: string
  location?: string
  virtual_meeting_url?: string
  status: string
  priority: string
  all_day: boolean
  is_recurring: boolean
  claim_id?: string
  client_id?: string
  vendor_id?: string
  attendees?: Array<{
    name: string
    email: string
    response_status: string
  }>
}

export function Calendar() {
  const { userProfile } = useAuth()
  const { success, error } = useToast()
  const [events, setEvents] = useState<Event[]>([])
  const [loading, setLoading] = useState(true)
  const [currentDate, setCurrentDate] = useState(new Date())
  const [viewMode, setViewMode] = useState<'month' | 'week' | 'day'>('month')
  const [selectedEvent, setSelectedEvent] = useState<Event | null>(null)
  const [showEventModal, setShowEventModal] = useState(false)
  const [selectedDate, setSelectedDate] = useState<Date | null>(null)
  const [filterType, setFilterType] = useState<string>('all')

  useEffect(() => {
    if (userProfile?.organization_id) {
      loadEvents()
    }
  }, [userProfile?.organization_id, currentDate, viewMode])

  async function loadEvents() {
    if (!userProfile?.organization_id) return

    try {
      setLoading(true)
      
      // Calculate date range based on view mode
      const startDate = getViewStartDate()
      const endDate = getViewEndDate()
      
      const { data, error } = await supabase
        .from('events')
        .select(`
          *,
          event_attendees(name, email, response_status)
        `)
        .eq('organization_id', userProfile.organization_id)
        .gte('start_datetime', startDate.toISOString())
        .lte('start_datetime', endDate.toISOString())
        .order('start_datetime', { ascending: true })

      if (error) throw error

      setEvents(data || [])
    } catch (error: any) {
      console.error('Error loading events:', error)
      error('Failed to load events', error.message)
    } finally {
      setLoading(false)
    }
  }

  function getViewStartDate(): Date {
    const date = new Date(currentDate)
    switch (viewMode) {
      case 'month':
        return new Date(date.getFullYear(), date.getMonth(), 1)
      case 'week':
        const day = date.getDay()
        date.setDate(date.getDate() - day)
        return date
      case 'day':
        return new Date(date.getFullYear(), date.getMonth(), date.getDate())
      default:
        return date
    }
  }

  function getViewEndDate(): Date {
    const date = new Date(currentDate)
    switch (viewMode) {
      case 'month':
        return new Date(date.getFullYear(), date.getMonth() + 1, 0)
      case 'week':
        const day = date.getDay()
        date.setDate(date.getDate() - day + 6)
        return date
      case 'day':
        return new Date(date.getFullYear(), date.getMonth(), date.getDate(), 23, 59, 59)
      default:
        return date
    }
  }

  function navigateDate(direction: 'prev' | 'next') {
    const newDate = new Date(currentDate)
    
    switch (viewMode) {
      case 'month':
        newDate.setMonth(newDate.getMonth() + (direction === 'next' ? 1 : -1))
        break
      case 'week':
        newDate.setDate(newDate.getDate() + (direction === 'next' ? 7 : -7))
        break
      case 'day':
        newDate.setDate(newDate.getDate() + (direction === 'next' ? 1 : -1))
        break
    }
    
    setCurrentDate(newDate)
  }

  function formatDateTime(dateTime: string, allDay: boolean = false): string {
    const date = new Date(dateTime)
    if (allDay) {
      return date.toLocaleDateString()
    }
    return date.toLocaleString()
  }

  function getEventTypeColor(eventType: string): string {
    const colors = {
      appointment: 'bg-blue-100 text-blue-800 border-blue-200',
      deadline: 'bg-red-100 text-red-800 border-red-200',
      inspection: 'bg-green-100 text-green-800 border-green-200',
      meeting: 'bg-purple-100 text-purple-800 border-purple-200',
      court_date: 'bg-orange-100 text-orange-800 border-orange-200'
    }
    return colors[eventType as keyof typeof colors] || 'bg-gray-100 text-gray-800 border-gray-200'
  }

  function getPriorityIcon(priority: string) {
    switch (priority) {
      case 'urgent':
        return <Bell className="h-4 w-4 text-red-500" />
      case 'high':
        return <Bell className="h-4 w-4 text-orange-500" />
      default:
        return null
    }
  }

  async function createEvent(eventData: any) {
    if (!userProfile?.organization_id) return

    try {
      const { data, error: insertError } = await supabase
        .from('events')
        .insert({
          ...eventData,
          organization_id: userProfile.organization_id,
          created_by: userProfile.id,
          // Convert dates to proper ISO format
          start_datetime: eventData.all_day 
            ? new Date(eventData.start_datetime + 'T00:00:00').toISOString()
            : new Date(eventData.start_datetime).toISOString(),
          end_datetime: eventData.all_day 
            ? new Date(eventData.end_datetime + 'T23:59:59').toISOString()
            : new Date(eventData.end_datetime).toISOString()
        })
        .select()

      if (insertError) throw insertError

      success('Event created', 'Your event has been successfully scheduled.')
      await loadEvents()
      setShowEventModal(false)
      setSelectedDate(null)
    } catch (err: any) {
      console.error('Error creating event:', err)
      error('Failed to create event', err.message)
    }
  }

  function handleDateClick(date: Date) {
    setSelectedDate(date)
    setSelectedEvent(null)
    setShowEventModal(true)
  }

  function handleEventClick(event: Event) {
    setSelectedEvent(event)
    setSelectedDate(null)
    setShowEventModal(true)
  }

  function handleNewEvent() {
    setSelectedEvent(null)
    setSelectedDate(new Date())
    setShowEventModal(true)
  }

  const filteredEvents = events.filter(event => {
    if (filterType === 'all') return true
    return event.event_type === filterType
  })

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <LoadingSpinner />
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Calendar & Scheduling</h1>
          <p className="text-gray-600">Manage appointments, deadlines, and events</p>
        </div>
        <div className="flex flex-wrap gap-2 mt-4 sm:mt-0">
          <Button onClick={handleNewEvent} className="flex items-center gap-2">
            <Plus className="h-4 w-4" />
            New Event
          </Button>
          <Button variant="outline" className="flex items-center gap-2">
            <Download className="h-4 w-4" />
            Export
          </Button>
          <Button variant="outline" className="flex items-center gap-2">
            <Upload className="h-4 w-4" />
            Import
          </Button>
        </div>
      </div>

      {/* Calendar Controls */}
      <Card>
        <CardContent className="p-6">
          <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            {/* Date Navigation */}
            <div className="flex items-center gap-4">
              <Button 
                variant="outline" 
                size="sm"
                onClick={() => navigateDate('prev')}
              >
                <ChevronLeft className="h-4 w-4" />
              </Button>
              
              <h2 className="text-lg font-semibold">
                {currentDate.toLocaleDateString('en-US', { 
                  month: 'long', 
                  year: 'numeric',
                  ...(viewMode === 'day' && { day: 'numeric' })
                })}
              </h2>
              
              <Button 
                variant="outline" 
                size="sm"
                onClick={() => navigateDate('next')}
              >
                <ChevronRight className="h-4 w-4" />
              </Button>
              
              <Button 
                variant="outline" 
                size="sm"
                onClick={() => setCurrentDate(new Date())}
              >
                Today
              </Button>
            </div>

            {/* View Mode Toggle */}
            <div className="flex items-center gap-2">
              <div className="flex rounded-lg border">
                {(['month', 'week', 'day'] as const).map((mode) => (
                  <Button
                    key={mode}
                    variant={viewMode === mode ? "primary" : "ghost"}
                    size="sm"
                    onClick={() => setViewMode(mode)}
                    className="rounded-none first:rounded-l-lg last:rounded-r-lg"
                  >
                    {mode.charAt(0).toUpperCase() + mode.slice(1)}
                  </Button>
                ))}
              </div>
              
              {/* Filter */}
              <select
                value={filterType}
                onChange={(e) => setFilterType(e.target.value)}
                className="ml-4 px-3 py-2 border border-gray-300 rounded-md text-sm"
              >
                <option value="all">All Events</option>
                <option value="appointment">Appointments</option>
                <option value="deadline">Deadlines</option>
                <option value="inspection">Inspections</option>
                <option value="meeting">Meetings</option>
                <option value="court_date">Court Dates</option>
              </select>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Calendar View */}
      <div className="grid gap-6">
        {viewMode === 'month' && (
          <MonthView 
            events={filteredEvents} 
            currentDate={currentDate}
            onEventClick={handleEventClick}
            onDateClick={handleDateClick}
            getEventTypeColor={getEventTypeColor}
            getPriorityIcon={getPriorityIcon}
          />
        )}
        
        {viewMode === 'week' && (
          <Card>
            <CardContent className="p-6">
              <div className="text-center py-8 text-gray-500">
                <CalendarIcon className="h-12 w-12 mx-auto mb-4 opacity-50" />
                <p>Week view implementation coming soon</p>
                <p className="text-sm">Showing {filteredEvents.length} events</p>
              </div>
            </CardContent>
          </Card>
        )}
        
        {viewMode === 'day' && (
          <Card>
            <CardContent className="p-6">
              <div className="text-center py-8 text-gray-500">
                <CalendarIcon className="h-12 w-12 mx-auto mb-4 opacity-50" />
                <p>Day view implementation coming soon</p>
                <p className="text-sm">Showing {filteredEvents.length} events</p>
              </div>
            </CardContent>
          </Card>
        )}
      </div>

      {/* Upcoming Events Card */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Clock className="h-5 w-5" />
            Upcoming Events
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-3">
            {filteredEvents.slice(0, 5).map((event) => (
              <div 
                key={event.id}
                className={`p-3 rounded-lg border cursor-pointer hover:shadow-md transition-shadow ${getEventTypeColor(event.event_type)}`}
                onClick={() => setSelectedEvent(event)}
              >
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center gap-2">
                      <h4 className="font-medium">{event.title}</h4>
                      {getPriorityIcon(event.priority)}
                      {event.is_recurring && <Repeat className="h-4 w-4" />}
                    </div>
                    <p className="text-sm opacity-75 mt-1">
                      {formatDateTime(event.start_datetime, event.all_day)}
                    </p>
                    {event.location && (
                      <div className="flex items-center gap-1 mt-1">
                        <MapPin className="h-3 w-3" />
                        <span className="text-xs">{event.location}</span>
                      </div>
                    )}
                    {event.virtual_meeting_url && (
                      <div className="flex items-center gap-1 mt-1">
                        <Video className="h-3 w-3" />
                        <span className="text-xs">Virtual Meeting</span>
                      </div>
                    )}
                  </div>
                  <div className="flex items-center gap-2">
                    <Button variant="ghost" size="sm">
                      <Edit className="h-4 w-4" />
                    </Button>
                    <Button variant="ghost" size="sm">
                      <Trash2 className="h-4 w-4" />
                    </Button>
                  </div>
                </div>
              </div>
            ))}
            
            {filteredEvents.length === 0 && (
              <div className="text-center py-8 text-gray-500">
                <CalendarIcon className="h-12 w-12 mx-auto mb-4 opacity-50" />
                <p>No events scheduled</p>
                <Button 
                  variant="outline" 
                  className="mt-2"
                  onClick={handleNewEvent}
                >
                  Create your first event
                </Button>
              </div>
            )}
          </div>
        </CardContent>
      </Card>

      {/* Event Modal */}
      <EventModal
        isOpen={showEventModal}
        onClose={() => {
          setShowEventModal(false)
          setSelectedEvent(null)
          setSelectedDate(null)
        }}
        onSave={createEvent}
        selectedDate={selectedDate || undefined}
        event={selectedEvent}
      />
    </div>
  )
}



export default Calendar\n
claimguru/src/pages/Claims.tsx
import React, { useState } from 'react'
import { useClaims } from '../hooks/useClaims'
import { useClients } from '../hooks/useClients'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { ClaimForm } from '../components/forms/ClaimForm'
// Removed duplicate wizard imports - using only EnhancedAIIntakeWizard
import { EnhancedAIIntakeWizard } from '../components/claims/EnhancedAIClaimWizard'
import { 
  Plus, 
  Search, 
  Filter, 
  FileText, 
  Calendar, 
  DollarSign,
  Clock,
  AlertCircle,
  CheckCircle,
  Eye,
  Edit,
  Brain,
  TrendingUp,
  Trash2,
  ArrowLeft,
  Zap
} from 'lucide-react'
import type { Claim } from '../lib/supabase'

export function Claims() {
  const { claims, loading, createClaim, updateClaim, deleteClaim } = useClaims()
  const { clients } = useClients()
  const [searchTerm, setSearchTerm] = useState('')
  const [statusFilter, setStatusFilter] = useState<string>('all')
  const [isFormOpen, setIsFormOpen] = useState(false)
  // Removed old intake wizard - using only AI wizard
  const [showAIWizard, setShowAIWizard] = useState(false)
  const [editingClaim, setEditingClaim] = useState<Claim | null>(null)
  const [selectedClaim, setSelectedClaim] = useState<Claim | null>(null)
  const [showDetailsModal, setShowDetailsModal] = useState(false)

  const filteredClaims = claims.filter(claim => {
    const matchesSearch = claim.file_number?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         claim.carrier_claim_number?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         claim.cause_of_loss?.toLowerCase().includes(searchTerm.toLowerCase())
    
    const matchesStatus = statusFilter === 'all' || claim.claim_status === statusFilter
    
    return matchesSearch && matchesStatus
  })

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'new': return Clock
      case 'in_progress': return AlertCircle
      case 'under_review': return FileText
      case 'negotiating': return TrendingUp
      case 'settled': return CheckCircle
      case 'closed': return CheckCircle
      default: return Clock
    }
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'new': return 'text-blue-600 bg-blue-100'
      case 'in_progress': return 'text-orange-600 bg-orange-100'
      case 'under_review': return 'text-purple-600 bg-purple-100'
      case 'negotiating': return 'text-yellow-600 bg-yellow-100'
      case 'settled': return 'text-green-600 bg-green-100'
      case 'closed': return 'text-gray-600 bg-gray-100'
      default: return 'text-blue-600 bg-blue-100'
    }
  }

  const handleAddClaim = () => {
    setEditingClaim(null)
    setIsFormOpen(true)
  }

  // Removed old intake wizard handlers - using only AI wizard

  const handleAIWizardComplete = async (claimData: any) => {
    try {
      // Create the claim with AI-generated data
      await createClaim(claimData)
      setShowAIWizard(false)
      // Refresh claims list
      window.location.reload()
    } catch (error) {
      console.error('Error creating AI claim:', error)
      alert('Error creating claim. Please try again.')
    }
  }

  const handleAIWizardCancel = () => {
    setShowAIWizard(false)
  }

  const handleEditClaim = (claim: Claim) => {
    setEditingClaim(claim)
    setIsFormOpen(true)
  }

  const handleDeleteClaim = async (claim: Claim) => {
    if (!confirm(`Are you sure you want to delete claim "${claim.file_number}"?`)) return
    
    try {
      await deleteClaim(claim.id)
    } catch (error) {
      alert('Error deleting claim. Please try again.')
    }
  }

  const handleSaveClaim = async (claim: Claim) => {
    // The form handles the save operation, just close the modal
    setIsFormOpen(false)
    setEditingClaim(null)
  }

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Claims Management</h1>
          <p className="text-gray-600 mt-2">
            Manage and track insurance claims with AI-powered insights
          </p>
        </div>
        <div className="flex items-center gap-3">
          <Button 
            onClick={() => setShowAIWizard(true)}
            className="flex items-center gap-2"
          >
            <Zap className="h-4 w-4" />
            New Claim Intake
          </Button>
          <Button 
            onClick={() => setShowAIWizard(true)}
            className="flex items-center gap-2 bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700"
          >
            <Brain className="h-4 w-4" />
            AI-Enhanced Intake Wizard
          </Button>
        </div>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Total Claims</p>
                <p className="text-3xl font-bold text-gray-900">{claims.length}</p>
              </div>
              <FileText className="h-8 w-8 text-blue-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Open Claims</p>
                <p className="text-3xl font-bold text-gray-900">
                  {claims.filter(c => c.claim_status !== 'closed' && c.claim_status !== 'settled').length}
                </p>
              </div>
              <Clock className="h-8 w-8 text-orange-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Settled Claims</p>
                <p className="text-3xl font-bold text-gray-900">
                  {claims.filter(c => c.claim_status === 'settled').length}
                </p>
              </div>
              <CheckCircle className="h-8 w-8 text-green-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Total Value</p>
                <p className="text-3xl font-bold text-gray-900">
                  ${claims.reduce((sum, c) => sum + (c.estimated_loss_value || 0), 0).toLocaleString()}
                </p>
              </div>
              <DollarSign className="h-8 w-8 text-purple-600" />
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Filters and Search */}
      <div className="flex flex-col sm:flex-row gap-4">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4" />
          <input
            type="text"
            placeholder="Search claims by file number, claim number, or cause of loss..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
        <div className="flex items-center gap-2">
          <Filter className="h-4 w-4 text-gray-400" />
          <select
            value={statusFilter}
            onChange={(e) => setStatusFilter(e.target.value)}
            className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="all">All Status</option>
            <option value="new">New</option>
            <option value="in_progress">In Progress</option>
            <option value="under_review">Under Review</option>
            <option value="negotiating">Negotiating</option>
            <option value="settled">Settled</option>
            <option value="closed">Closed</option>
          </select>
        </div>
      </div>

      {/* Claims List */}
      {filteredClaims.length === 0 ? (
        <Card>
          <CardContent className="p-12 text-center">
            <FileText className="h-16 w-16 text-gray-400 mx-auto mb-4" />
            <h3 className="text-xl font-semibold text-gray-900 mb-2">
              {claims.length === 0 ? 'No claims yet' : 'No matching claims'}
            </h3>
            <p className="text-gray-600 mb-6">
              {claims.length === 0 
                ? 'Create your first claim to get started with ClaimGuru'
                : 'Try adjusting your search or filter criteria'
              }
            </p>

          </CardContent>
        </Card>
      ) : (
        <div className="grid gap-4">
          {filteredClaims.map((claim) => {
            const StatusIcon = getStatusIcon(claim.claim_status)
            const statusColorClass = getStatusColor(claim.claim_status)
            const client = clients.find(c => c.id === claim.client_id)
            
            return (
              <Card key={claim.id} className="hover:shadow-md transition-shadow">
                <CardContent className="p-6">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-4">
                      <div className={`p-2 rounded-full ${statusColorClass}`}>
                        <StatusIcon className="h-5 w-5" />
                      </div>
                      <div>
                        <h3 className="text-lg font-semibold text-gray-900">
                          {claim.file_number || `Claim #${claim.id.slice(0, 8)}`}
                        </h3>
                        <p className="text-gray-600">
                          {claim.cause_of_loss || 'General Loss'} â€¢ {claim.carrier_claim_number || 'No Claim #'}
                        </p>
                        {client && (
                          <p className="text-sm text-gray-500">
                            {client.first_name} {client.last_name}
                          </p>
                        )}
                      </div>
                    </div>
                    
                    <div className="flex items-center space-x-4">
                      <div className="text-right">
                        <p className="text-sm font-medium text-gray-900">
                          ${(claim.estimated_loss_value || 0).toLocaleString()}
                        </p>
                        <p className="text-xs text-gray-500">
                          {new Date(claim.created_at).toLocaleDateString()}
                        </p>
                      </div>
                      
                      <div className="flex items-center space-x-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            setSelectedClaim(claim)
                            setShowDetailsModal(true)
                          }}
                          className="flex items-center gap-1"
                        >
                          <Eye className="h-4 w-4" />
                          View
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleEditClaim(claim)}
                          className="flex items-center gap-1"
                        >
                          <Edit className="h-4 w-4" />
                          Edit
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleDeleteClaim(claim)}
                          className="flex items-center gap-1 text-red-600 hover:text-red-700"
                        >
                          <Trash2 className="h-4 w-4" />
                          Delete
                        </Button>
                      </div>
                    </div>
                  </div>
                  
                  <div className="mt-4 pt-4 border-t border-gray-200">
                    <div className="flex items-center justify-between text-sm">
                      <span className={`px-2 py-1 rounded-full text-xs font-medium ${statusColorClass}`}>
                        {claim.claim_status.charAt(0).toUpperCase() + claim.claim_status.slice(1).replace('_', ' ')}
                      </span>
                      <div className="flex items-center text-gray-500">
                        <Calendar className="h-4 w-4 mr-1" />
                        Last updated: {new Date(claim.updated_at).toLocaleDateString()}
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            )
          })}
        </div>
      )}

      {/* Old intake wizard removed - using only AI wizard */}

      {/* Enhanced AI-Powered Insurance Intake Wizard with Real PDF Processing */}
      {showAIWizard && (
        <EnhancedAIIntakeWizard
          onComplete={handleAIWizardComplete}
          onCancel={handleAIWizardCancel}
        />
      )}

      {/* Claim Form Modal */}
      <ClaimForm
        claim={editingClaim}
        isOpen={isFormOpen}
        onClose={() => {
          setIsFormOpen(false)
          setEditingClaim(null)
        }}
        onSave={handleSaveClaim}
      />
    </div>
  )
}\n
claimguru/src/pages/Clients.tsx
import React, { useState } from 'react'
import { useClients } from '../hooks/useClients'
import { useClaims } from '../hooks/useClaims'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { ClientForm } from '../components/forms/ClientForm'
import { ClientDetailsModal } from '../components/clients/ClientDetailsModal'
import { CreateClaimModal } from '../components/clients/CreateClaimModal'
import { ClientCreateClaimButton } from '../components/clients/ClientCreateClaimButton'
import { 
  Plus, 
  Search, 
  Filter, 
  Users, 
  Phone, 
  Mail,
  MapPin,
  Eye,
  Edit,
  FileText,
  Calendar,
  Building,
  Trash2
} from 'lucide-react'
import type { Client } from '../lib/supabase'

export function Clients() {
  const { clients, loading, createClient, updateClient, deleteClient } = useClients()
  const { claims } = useClaims()
  const [searchTerm, setSearchTerm] = useState('')
  const [typeFilter, setTypeFilter] = useState<string>('all')
  const [isFormOpen, setIsFormOpen] = useState(false)
  const [editingClient, setEditingClient] = useState<Client | null>(null)
  const [selectedClient, setSelectedClient] = useState<Client | null>(null)
  const [showDetailsModal, setShowDetailsModal] = useState(false)
  const [showCreateClaimFlow, setShowCreateClaimFlow] = useState(false)
  const [clientForClaim, setClientForClaim] = useState<Client | null>(null)

  const filteredClients = clients.filter(client => {
    const matchesSearch = 
      client.first_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      client.last_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      client.primary_email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      client.primary_phone?.includes(searchTerm) ||
      client.business_name?.toLowerCase().includes(searchTerm.toLowerCase())
    
    const matchesType = typeFilter === 'all' || client.client_type === typeFilter
    
    return matchesSearch && matchesType
  })

  const getClientClaims = (clientId: string) => {
    return claims.filter(claim => claim.client_id === clientId)
  }

  const handleAddClient = () => {
    setEditingClient(null)
    setIsFormOpen(true)
  }

  const handleEditClient = (client: Client) => {
    setEditingClient(client)
    setIsFormOpen(true)
  }

  const handleDeleteClient = async (client: Client) => {
    if (!confirm(`Are you sure you want to delete client "${client.client_type === 'commercial' ? client.business_name : `${client.first_name} ${client.last_name}`}"?`)) return
    
    try {
      await deleteClient(client.id)
    } catch (error) {
      alert('Error deleting client. Please try again.')
    }
  }

  const handleSaveClient = async (clientData: any) => {
    try {
      let savedClient
      if (editingClient) {
        // Update existing client
        savedClient = await updateClient(editingClient.id, clientData)
      } else {
        // Create new client
        savedClient = await createClient(clientData)
      }
      setIsFormOpen(false)
      setEditingClient(null)
      
      // If this is a new client, show create claim modal
      if (!editingClient && savedClient) {
        setClientForClaim(savedClient)
        setShowCreateClaimFlow(true)
      }
    } catch (error) {
      console.error('Error saving client:', error)
      // Error handling is done in the form
    }
  }

  const handleCreateClaim = (client: Client) => {
    setClientForClaim(client)
    setShowCreateClaimFlow(true)
    setShowDetailsModal(false)
  }

  const handleCloseCreateClaim = () => {
    setShowCreateClaimFlow(false)
    setClientForClaim(null)
  }

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Client Management</h1>
          <p className="text-gray-600 mt-2">
            Manage your client relationships and contact information
          </p>
        </div>
        <Button 
          onClick={handleAddClient}
          className="flex items-center gap-2"
        >
          <Plus className="h-4 w-4" />
          New Client
        </Button>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Total Clients</p>
                <p className="text-3xl font-bold text-gray-900">{clients.length}</p>
              </div>
              <Users className="h-8 w-8 text-blue-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Residential Clients</p>
                <p className="text-3xl font-bold text-gray-900">
                  {clients.filter(c => c.client_type === 'residential').length}
                </p>
              </div>
              <Users className="h-8 w-8 text-green-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Commercial Clients</p>
                <p className="text-3xl font-bold text-gray-900">
                  {clients.filter(c => c.client_type === 'commercial').length}
                </p>
              </div>
              <Building className="h-8 w-8 text-purple-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Active Claims</p>
                <p className="text-3xl font-bold text-gray-900">
                  {claims.filter(c => c.claim_status !== 'closed' && c.claim_status !== 'settled').length}
                </p>
              </div>
              <FileText className="h-8 w-8 text-orange-600" />
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Filters and Search */}
      <div className="flex flex-col sm:flex-row gap-4">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4" />
          <input
            type="text"
            placeholder="Search clients by name, email, phone, or company..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
        <div className="flex items-center gap-2">
          <Filter className="h-4 w-4 text-gray-400" />
          <select
            value={typeFilter}
            onChange={(e) => setTypeFilter(e.target.value)}
            className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="all">All Types</option>
            <option value="residential">Residential</option>
            <option value="commercial">Commercial</option>
          </select>
        </div>
      </div>

      {/* Clients List */}
      {filteredClients.length === 0 ? (
        <Card>
          <CardContent className="p-12 text-center">
            <Users className="h-16 w-16 text-gray-400 mx-auto mb-4" />
            <h3 className="text-xl font-semibold text-gray-900 mb-2">
              {clients.length === 0 ? 'No clients yet' : 'No matching clients'}
            </h3>
            <p className="text-gray-600 mb-6">
              {clients.length === 0 
                ? 'Add your first client to start managing relationships in ClaimGuru'
                : 'Try adjusting your search or filter criteria'
              }
            </p>
            {clients.length === 0 && (
              <Button 
                onClick={handleAddClient}
                className="flex items-center gap-2"
              >
                <Plus className="h-4 w-4" />
                Add First Client
              </Button>
            )}
          </CardContent>
        </Card>
      ) : (
        <div className="grid gap-4">
          {filteredClients.map((client) => {
            const clientClaims = getClientClaims(client.id)
            const activeClaims = clientClaims.filter(claim => 
              claim.claim_status !== 'closed' && claim.claim_status !== 'settled'
            )
            
            return (
              <Card key={client.id} className="hover:shadow-md transition-shadow">
                <CardContent className="p-6">
                  <div className="flex items-center justify-between">
                    <div className="flex items-center space-x-4">
                      <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        {client.client_type === 'commercial' ? (
                          <Building className="h-6 w-6 text-blue-600" />
                        ) : (
                          <Users className="h-6 w-6 text-blue-600" />
                        )}
                      </div>
                      <div>
                        <h3 className="text-lg font-semibold text-gray-900">
                          {client.first_name} {client.last_name}
                        </h3>
                        {client.business_name && (
                          <p className="text-gray-600">{client.business_name}</p>
                        )}
                        <div className="flex items-center space-x-4 mt-1">
                          {client.primary_email && (
                            <div className="flex items-center text-sm text-gray-500">
                              <Mail className="h-4 w-4 mr-1" />
                              {client.primary_email}
                            </div>
                          )}
                          {client.primary_phone && (
                            <div className="flex items-center text-sm text-gray-500">
                              <Phone className="h-4 w-4 mr-1" />
                              {client.primary_phone}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                    
                    <div className="flex items-center space-x-4">
                      <div className="text-right">
                        <p className="text-sm font-medium text-gray-900">
                          {clientClaims.length} {clientClaims.length === 1 ? 'Claim' : 'Claims'}
                        </p>
                        <p className="text-xs text-gray-500">
                          {activeClaims.length} active
                        </p>
                      </div>
                      
                      <div className="flex items-center space-x-2">
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => {
                            setSelectedClient(client)
                            setShowDetailsModal(true)
                          }}
                          className="flex items-center gap-1"
                        >
                          <Eye className="h-4 w-4" />
                          View
                        </Button>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleEditClient(client)}
                          className="flex items-center gap-1"
                        >
                          <Edit className="h-4 w-4" />
                          Edit
                        </Button>
                        <ClientCreateClaimButton
                          client={client}
                          onCreateClaim={handleCreateClaim}
                        />
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => handleDeleteClient(client)}
                          className="flex items-center gap-1 text-red-600 hover:text-red-700"
                        >
                          <Trash2 className="h-4 w-4" />
                          Delete
                        </Button>
                      </div>
                    </div>
                  </div>
                  
                  {(client.address_line_1 || client.city || client.state) && (
                    <div className="mt-4 pt-4 border-t border-gray-200">
                      <div className="flex items-center text-sm text-gray-500">
                        <MapPin className="h-4 w-4 mr-1" />
                        {[client.address_line_1, client.city, client.state]
                          .filter(Boolean)
                          .join(', ')}
                      </div>
                    </div>
                  )}
                  
                  <div className="mt-4 pt-4 border-t border-gray-200">
                    <div className="flex items-center justify-between text-sm">
                      <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                        client.client_type === 'commercial' 
                          ? 'text-purple-600 bg-purple-100'
                          : 'text-blue-600 bg-blue-100'
                      }`}>
                        {client.client_type?.charAt(0).toUpperCase() + client.client_type?.slice(1)}
                      </span>
                      <div className="flex items-center text-gray-500">
                        <Calendar className="h-4 w-4 mr-1" />
                        Added: {new Date(client.created_at).toLocaleDateString()}
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>
            )
          })}
        </div>
      )}

      {/* Client Form Modal */}
      <ClientForm
        client={editingClient}
        isOpen={isFormOpen}
        onClose={() => {
          setIsFormOpen(false)
          setEditingClient(null)
        }}
        onSave={handleSaveClient}
      />

      {/* Client Details Modal */}
      <ClientDetailsModal
        client={selectedClient}
        isOpen={showDetailsModal}
        onClose={() => {
          setShowDetailsModal(false)
          setSelectedClient(null)
        }}
        onEdit={(client) => {
          setEditingClient(client)
          setShowDetailsModal(false)
          setIsFormOpen(true)
        }}
        onCreateClaim={handleCreateClaim}
        claims={claims}
      />

      {/* Enhanced Create Claim Modal */}
      <CreateClaimModal
        client={clientForClaim}
        isOpen={showCreateClaimFlow}
        onClose={handleCloseCreateClaim}
      />
    </div>
  )
}\n
claimguru/src/pages/CommunicationHub.tsx
import React, { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { 
  Mail, 
  MessageSquare, 
  Phone, 
  Send,
  Calendar,
  Users,
  FileText,
  Plus,
  Filter,
  Search,
  Download,
  Eye,
  Edit,
  Trash2,
  Clock,
  CheckCircle,
  AlertCircle,
  BarChart3,
  TrendingUp,
  Bell,
  Settings,
  Zap,
  X
} from 'lucide-react'
import { useAuth } from '../contexts/AuthContext'
import { supabase } from '../lib/supabase'
import type { Communication, Claim, Client } from '../lib/supabase'
import { CommunicationForm } from '../components/forms/CommunicationForm'
import { EmailTemplateManager } from '../components/communication/EmailTemplateManager'
import { CommunicationAnalytics } from '../components/communication/CommunicationAnalytics'
import { AutomationManager } from '../components/communication/AutomationManager'

interface CommunicationStats {
  totalCommunications: number
  emailsSent: number
  smsSent: number
  callsMade: number
  responseRate: number
  averageResponseTime: number
  recentCommunications: Communication[]
  communicationsByType: { type: string; count: number }[]
  communicationsByStatus: { status: string; count: number }[]
  monthlyActivity: { month: string; emails: number; sms: number; calls: number }[]
  pendingFollowUps: number
  scheduledCommunications: number
}

export function CommunicationHub() {
  const { userProfile } = useAuth()
  const [loading, setLoading] = useState(true)
  const [stats, setStats] = useState<CommunicationStats | null>(null)
  const [activeTab, setActiveTab] = useState('overview')
  const [communications, setCommunications] = useState<Communication[]>([])
  const [claims, setClaims] = useState<Claim[]>([])
  const [clients, setClients] = useState<Client[]>([])
  const [showCommunicationForm, setShowCommunicationForm] = useState(false)
  const [selectedCommunication, setSelectedCommunication] = useState<Communication | null>(null)
  const [filterType, setFilterType] = useState('all')
  const [filterStatus, setFilterStatus] = useState('all')
  const [searchTerm, setSearchTerm] = useState('')
  const [dateRange, setDateRange] = useState('30d')

  useEffect(() => {
    if (userProfile?.organization_id) {
      loadCommunicationData()
    }
  }, [userProfile?.organization_id, dateRange, filterType, filterStatus])

  async function loadCommunicationData() {
    if (!userProfile?.organization_id) return

    try {
      setLoading(true)
      
      // Calculate date range
      const endDate = new Date()
      const startDate = new Date()
      switch (dateRange) {
        case '7d': startDate.setDate(endDate.getDate() - 7); break
        case '30d': startDate.setDate(endDate.getDate() - 30); break
        case '90d': startDate.setDate(endDate.getDate() - 90); break
        case '1y': startDate.setFullYear(endDate.getFullYear() - 1); break
        default: startDate.setDate(endDate.getDate() - 30)
      }

      // Build query filters
      let query = supabase
        .from('communications')
        .select('*, claims(file_number), clients(first_name, last_name, business_name)')
        .eq('organization_id', userProfile.organization_id)
        .gte('created_at', startDate.toISOString())
        .order('created_at', { ascending: false })

      if (filterType !== 'all') {
        query = query.eq('communication_type', filterType)
      }
      if (filterStatus !== 'all') {
        query = query.eq('status', filterStatus)
      }

      const [communicationsData, claimsData, clientsData] = await Promise.all([
        query,
        supabase
          .from('claims')
          .select('id, file_number, client_id')
          .eq('organization_id', userProfile.organization_id),
        supabase
          .from('clients')
          .select('id, first_name, last_name, business_name, client_type')
          .eq('organization_id', userProfile.organization_id)
      ])

      const communicationsResult = communicationsData.data || []
      const claimsResult = claimsData.data || []
      const clientsResult = clientsData.data || []

      // Filter by search term
      const filteredCommunications = communicationsResult.filter(comm => {
        if (!searchTerm) return true
        const searchLower = searchTerm.toLowerCase()
        return (
          comm.subject?.toLowerCase().includes(searchLower) ||
          comm.content?.toLowerCase().includes(searchLower) ||
          comm.claims?.file_number?.toLowerCase().includes(searchLower) ||
          comm.clients?.first_name?.toLowerCase().includes(searchLower) ||
          comm.clients?.last_name?.toLowerCase().includes(searchLower) ||
          comm.clients?.business_name?.toLowerCase().includes(searchLower)
        )
      })

      // Calculate statistics
      const totalCommunications = filteredCommunications.length
      const emailsSent = filteredCommunications.filter(c => c.communication_type === 'email').length
      const smsSent = filteredCommunications.filter(c => c.communication_type === 'sms').length
      const callsMade = filteredCommunications.filter(c => c.communication_type === 'phone').length
      
      const completedCommunications = filteredCommunications.filter(c => c.status === 'delivered' || c.status === 'completed')
      const responseRate = totalCommunications > 0 ? (completedCommunications.length / totalCommunications * 100) : 0
      
      // Average response time (simplified calculation)
      const responseTimes = filteredCommunications
        .filter(c => c.delivered_at && c.sent_at)
        .map(c => new Date(c.delivered_at!).getTime() - new Date(c.sent_at!).getTime())
      const averageResponseTime = responseTimes.length > 0 
        ? responseTimes.reduce((sum, time) => sum + time, 0) / responseTimes.length / (1000 * 60 * 60) // Convert to hours
        : 0

      // Communications by type
      const communicationsByType = [
        { type: 'email', count: emailsSent },
        { type: 'sms', count: smsSent },
        { type: 'phone', count: callsMade },
        { type: 'meeting', count: filteredCommunications.filter(c => c.communication_type === 'meeting').length }
      ].filter(item => item.count > 0)

      // Communications by status
      const statusCounts = filteredCommunications.reduce((acc, comm) => {
        acc[comm.status] = (acc[comm.status] || 0) + 1
        return acc
      }, {} as { [key: string]: number })
      
      const communicationsByStatus = Object.entries(statusCounts).map(([status, count]) => ({
        status,
        count: count as number
      }))

      // Monthly activity
      const monthlyData = {}
      filteredCommunications.forEach(comm => {
        const month = new Date(comm.created_at).toLocaleString('default', { month: 'short', year: 'numeric' })
        if (!monthlyData[month]) {
          monthlyData[month] = { emails: 0, sms: 0, calls: 0 }
        }
        if (comm.communication_type === 'email') monthlyData[month].emails++
        else if (comm.communication_type === 'sms') monthlyData[month].sms++
        else if (comm.communication_type === 'phone') monthlyData[month].calls++
      })

      const monthlyActivity = Object.entries(monthlyData).map(([month, data]: [string, any]) => ({
        month,
        emails: data.emails,
        sms: data.sms,
        calls: data.calls
      }))

      const pendingFollowUps = filteredCommunications.filter(c => 
        c.follow_up_required && !c.follow_up_date
      ).length

      const scheduledCommunications = filteredCommunications.filter(c => 
        c.scheduled_at && new Date(c.scheduled_at) > new Date()
      ).length

      setStats({
        totalCommunications,
        emailsSent,
        smsSent,
        callsMade,
        responseRate,
        averageResponseTime,
        recentCommunications: filteredCommunications.slice(0, 10),
        communicationsByType,
        communicationsByStatus,
        monthlyActivity: monthlyActivity.slice(-6),
        pendingFollowUps,
        scheduledCommunications
      })

      setCommunications(filteredCommunications)
      setClaims(claimsResult as Claim[])
      setClients(clientsResult as Client[])
    } catch (error) {
      console.error('Error loading communication data:', error)
    } finally {
      setLoading(false)
    }
  }

  const handleSaveCommunication = async (data: any) => {
    try {
      if (selectedCommunication) {
        await supabase
          .from('communications')
          .update(data)
          .eq('id', selectedCommunication.id)
      } else {
        await supabase
          .from('communications')
          .insert([{ ...data, organization_id: userProfile?.organization_id }])
      }
      
      await loadCommunicationData()
      setShowCommunicationForm(false)
      setSelectedCommunication(null)
    } catch (error) {
      console.error('Error saving communication:', error)
    }
  }

  const handleDeleteCommunication = async (id: string) => {
    if (!confirm('Are you sure you want to delete this communication?')) return

    try {
      await supabase
        .from('communications')
        .delete()
        .eq('id', id)
      
      await loadCommunicationData()
    } catch (error) {
      console.error('Error deleting communication:', error)
    }
  }

  const exportData = () => {
    const exportData = {
      communications,
      stats,
      filters: { type: filterType, status: filterStatus, dateRange, searchTerm }
    }
    
    const dataStr = JSON.stringify(exportData, null, 2)
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr)
    
    const exportFileDefaultName = `communications-report-${new Date().toISOString().split('T')[0]}.json`
    
    const linkElement = document.createElement('a')
    linkElement.setAttribute('href', dataUri)
    linkElement.setAttribute('download', exportFileDefaultName)
    linkElement.click()
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Communication Hub</h1>
          <p className="text-gray-600 mt-2">
            Comprehensive communication management and analytics
          </p>
        </div>
        <div className="flex items-center space-x-4">
          <select 
            value={dateRange} 
            onChange={(e) => setDateRange(e.target.value)}
            className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="7d">Last 7 days</option>
            <option value="30d">Last 30 days</option>
            <option value="90d">Last 90 days</option>
            <option value="1y">Last year</option>
          </select>
          <Button onClick={exportData} variant="outline">
            <Download className="h-4 w-4 mr-2" />
            Export
          </Button>
          <Button onClick={() => setShowCommunicationForm(true)}>
            <Plus className="h-4 w-4 mr-2" />
            New Communication
          </Button>
        </div>
      </div>

      {/* Communication Overview Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <Card className="hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Total Communications</p>
                <p className="text-3xl font-bold text-gray-900">{stats?.totalCommunications || 0}</p>
                <p className="text-xs text-gray-500 mt-1">
                  {dateRange.replace('d', ' days').replace('y', ' year')}
                </p>
              </div>
              <div className="p-2 bg-blue-100 rounded-full">
                <MessageSquare className="h-8 w-8 text-blue-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Response Rate</p>
                <p className="text-3xl font-bold text-green-600">
                  {stats?.responseRate?.toFixed(1) || '0'}%
                </p>
                <p className="text-xs text-gray-500 mt-1">
                  Successful delivery rate
                </p>
              </div>
              <div className="p-2 bg-green-100 rounded-full">
                <TrendingUp className="h-8 w-8 text-green-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Avg Response Time</p>
                <p className="text-3xl font-bold text-orange-600">
                  {stats?.averageResponseTime?.toFixed(1) || '0'}h
                </p>
                <p className="text-xs text-gray-500 mt-1">
                  Average time to respond
                </p>
              </div>
              <div className="p-2 bg-orange-100 rounded-full">
                <Clock className="h-8 w-8 text-orange-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Pending Follow-ups</p>
                <p className="text-3xl font-bold text-red-600">
                  {stats?.pendingFollowUps || 0}
                </p>
                <p className="text-xs text-gray-500 mt-1">
                  Requires attention
                </p>
              </div>
              <div className="p-2 bg-red-100 rounded-full">
                <Bell className="h-8 w-8 text-red-600" />
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Tab Navigation */}
      <div className="border-b border-gray-200">
        <nav className="-mb-px flex space-x-8">
          {[
            { id: 'overview', label: 'Overview', icon: Eye },
            { id: 'communications', label: 'Communications', icon: MessageSquare },
            { id: 'templates', label: 'Email Templates', icon: FileText },
            { id: 'automation', label: 'Automation', icon: Zap },
            { id: 'analytics', label: 'Analytics', icon: BarChart3 }
          ].map((tab) => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm ${
                activeTab === tab.id
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
              }`}
            >
              <tab.icon className="h-5 w-5 mr-2" />
              {tab.label}
            </button>
          ))}
        </nav>
      </div>

      {/* Tab Content */}
      {activeTab === 'overview' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Communication Types Chart */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center space-x-2">
                <BarChart3 className="h-5 w-5" />
                <span>Communication Types</span>
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {stats?.communicationsByType?.map((item, index) => (
                  <div key={item.type} className="flex items-center justify-between">
                    <div className="flex items-center space-x-3">
                      <div className={`p-2 rounded-full ${
                        item.type === 'email' ? 'bg-blue-100' :
                        item.type === 'sms' ? 'bg-green-100' :
                        item.type === 'phone' ? 'bg-orange-100' :
                        'bg-purple-100'
                      }`}>
                        {item.type === 'email' ? (
                          <Mail className="h-4 w-4 text-blue-600" />
                        ) : item.type === 'sms' ? (
                          <MessageSquare className="h-4 w-4 text-green-600" />
                        ) : item.type === 'phone' ? (
                          <Phone className="h-4 w-4 text-orange-600" />
                        ) : (
                          <Calendar className="h-4 w-4 text-purple-600" />
                        )}
                      </div>
                      <span className="text-sm font-medium capitalize">
                        {item.type.replace('_', ' ')}
                      </span>
                    </div>
                    <span className="text-sm font-medium text-gray-900">{item.count}</span>
                  </div>
                )) || (
                  <p className="text-gray-500 text-center py-4">No communication data</p>
                )}
              </div>
            </CardContent>
          </Card>

          {/* Recent Communications */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center space-x-2">
                <Clock className="h-5 w-5" />
                <span>Recent Communications</span>
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {stats?.recentCommunications?.slice(0, 5).map((communication, index) => (
                  <div key={index} className="flex items-start space-x-3 p-3 border rounded-lg hover:bg-gray-50">
                    <div className={`p-2 rounded-full ${
                      communication.communication_type === 'email' ? 'bg-blue-100' :
                      communication.communication_type === 'sms' ? 'bg-green-100' :
                      communication.communication_type === 'phone' ? 'bg-orange-100' :
                      'bg-purple-100'
                    }`}>
                      {communication.communication_type === 'email' ? (
                        <Mail className="h-4 w-4 text-blue-600" />
                      ) : communication.communication_type === 'sms' ? (
                        <MessageSquare className="h-4 w-4 text-green-600" />
                      ) : communication.communication_type === 'phone' ? (
                        <Phone className="h-4 w-4 text-orange-600" />
                      ) : (
                        <Calendar className="h-4 w-4 text-purple-600" />
                      )}
                    </div>
                    <div className="flex-1">
                      <p className="text-sm font-medium text-gray-900">
                        {communication.subject || `${communication.communication_type} communication`}
                      </p>
                      <p className="text-xs text-gray-600">
                        {new Date(communication.created_at).toLocaleDateString()} â€¢ 
                        {communication.claims?.file_number || communication.clients?.first_name || 'System'}
                      </p>
                    </div>
                    <div className={`px-2 py-1 rounded-full text-xs ${
                      communication.status === 'delivered' ? 'bg-green-100 text-green-800' :
                      communication.status === 'sent' ? 'bg-blue-100 text-blue-800' :
                      communication.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                      'bg-red-100 text-red-800'
                    }`}>
                      {communication.status}
                    </div>
                  </div>
                )) || (
                  <p className="text-gray-500 text-center py-4">No recent communications</p>
                )}
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {activeTab === 'communications' && (
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <CardTitle>All Communications</CardTitle>
              <div className="flex items-center space-x-4">
                {/* Search */}
                <div className="relative">
                  <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                  <input
                    type="text"
                    placeholder="Search communications..."
                    value={searchTerm}
                    onChange={(e) => setSearchTerm(e.target.value)}
                    className="pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent w-64"
                  />
                </div>
                
                {/* Filters */}
                <select 
                  value={filterType} 
                  onChange={(e) => setFilterType(e.target.value)}
                  className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="all">All Types</option>
                  <option value="email">Email</option>
                  <option value="sms">SMS</option>
                  <option value="phone">Phone</option>
                  <option value="meeting">Meeting</option>
                </select>
                
                <select 
                  value={filterStatus} 
                  onChange={(e) => setFilterStatus(e.target.value)}
                  className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                >
                  <option value="all">All Status</option>
                  <option value="pending">Pending</option>
                  <option value="sent">Sent</option>
                  <option value="delivered">Delivered</option>
                  <option value="failed">Failed</option>
                </select>
              </div>
            </div>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Subject/Content</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contact</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Date</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {communications.map((communication) => (
                    <tr key={communication.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap">
                        <div className="flex items-center space-x-2">
                          <div className={`p-1 rounded-full ${
                            communication.communication_type === 'email' ? 'bg-blue-100' :
                            communication.communication_type === 'sms' ? 'bg-green-100' :
                            communication.communication_type === 'phone' ? 'bg-orange-100' :
                            'bg-purple-100'
                          }`}>
                            {communication.communication_type === 'email' ? (
                              <Mail className="h-3 w-3 text-blue-600" />
                            ) : communication.communication_type === 'sms' ? (
                              <MessageSquare className="h-3 w-3 text-green-600" />
                            ) : communication.communication_type === 'phone' ? (
                              <Phone className="h-3 w-3 text-orange-600" />
                            ) : (
                              <Calendar className="h-3 w-3 text-purple-600" />
                            )}
                          </div>
                          <span className="text-sm font-medium capitalize">
                            {communication.communication_type}
                          </span>
                        </div>
                      </td>
                      <td className="px-6 py-4">
                        <div className="max-w-xs">
                          <p className="text-sm font-medium text-gray-900 truncate">
                            {communication.subject || 'No subject'}
                          </p>
                          <p className="text-xs text-gray-500 truncate">
                            {communication.content}
                          </p>
                        </div>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {communication.clients?.business_name || 
                         `${communication.clients?.first_name || ''} ${communication.clients?.last_name || ''}`.trim() ||
                         'Unknown'}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                          communication.status === 'delivered' ? 'bg-green-100 text-green-800' :
                          communication.status === 'sent' ? 'bg-blue-100 text-blue-800' :
                          communication.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                          'bg-red-100 text-red-800'
                        }`}>
                          {communication.status}
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {new Date(communication.created_at).toLocaleDateString()}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <Button
                          size="sm"
                          variant="outline"
                          onClick={() => {
                            setSelectedCommunication(communication)
                            setShowCommunicationForm(true)
                          }}
                        >
                          <Edit className="h-4 w-4" />
                        </Button>
                        <Button
                          size="sm"
                          variant="outline"
                          onClick={() => handleDeleteCommunication(communication.id)}
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              {communications.length === 0 && (
                <p className="text-gray-500 text-center py-8">No communications found</p>
              )}
            </div>
          </CardContent>
        </Card>
      )}

      {activeTab === 'templates' && (
        <EmailTemplateManager />
      )}

      {activeTab === 'automation' && (
        <AutomationManager />
      )}

      {activeTab === 'analytics' && (
        <CommunicationAnalytics stats={stats} />
      )}

      {/* Communication Form Modal */}
      {showCommunicationForm && (
        <CommunicationForm
          communication={selectedCommunication}
          claims={claims}
          clients={clients}
          isOpen={showCommunicationForm}
          onClose={() => {
            setShowCommunicationForm(false)
            setSelectedCommunication(null)
          }}
          onSave={handleSaveCommunication}
        />
      )}
    </div>
  )
}\n
claimguru/src/pages/Communications.tsx
import React, { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { 
  Mail, 
  Phone, 
  MessageSquare, 
  Settings, 
  Search, 
  Filter,
  TrendingUp,
  FileText,
  AlertTriangle,
  CheckCircle,
  Clock,
  Brain,
  Users,
  BarChart3,
  Plus,
  Download,
  RefreshCw
} from 'lucide-react'
import { emailAutomationService } from '../services/emailAutomationService'

interface EmailStats {
  totalEmails: number
  claimRelated: number
  highPriority: number
  averageConfidence: number
  tasksCreated: number
  claimNumbersExtracted: number
}

export default function Communications() {
  const [activeTab, setActiveTab] = useState<'emails' | 'calls' | 'sms' | 'settings'>('emails')
  const [emailLogs, setEmailLogs] = useState<any[]>([])
  const [emailStats, setEmailStats] = useState<EmailStats | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')
  const [filterCategory, setFilterCategory] = useState<string>('all')
  const [isRefreshing, setIsRefreshing] = useState(false)

  useEffect(() => {
    loadEmailData()
  }, [])

  const loadEmailData = async () => {
    setIsLoading(true)
    try {
      const [logs, stats] = await Promise.all([
        emailAutomationService.getRecentEmailLogs(100),
        emailAutomationService.getEmailAnalytics(30)
      ])
      
      setEmailLogs(logs)
      setEmailStats(stats)
    } catch (error) {
      console.error('Failed to load email data:', error)
    } finally {
      setIsLoading(false)
    }
  }

  const handleRefresh = async () => {
    setIsRefreshing(true)
    await loadEmailData()
    setIsRefreshing(false)
  }

  const filteredEmails = emailLogs.filter(email => {
    const matchesSearch = email.subject?.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         email.from_email?.toLowerCase().includes(searchTerm.toLowerCase())
    
    if (filterCategory === 'all') return matchesSearch
    return matchesSearch && email.classification?.category === filterCategory
  })

  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case 'high': return 'text-red-600 bg-red-100'
      case 'medium': return 'text-yellow-600 bg-yellow-100'
      case 'low': return 'text-green-600 bg-green-100'
      default: return 'text-gray-600 bg-gray-100'
    }
  }

  const getCategoryColor = (category: string) => {
    const colors = {
      claim_related: 'text-blue-600 bg-blue-100',
      insurer_update: 'text-purple-600 bg-purple-100',
      vendor_communication: 'text-orange-600 bg-orange-100',
      client_communication: 'text-green-600 bg-green-100',
      other: 'text-gray-600 bg-gray-100'
    }
    return colors[category as keyof typeof colors] || 'text-gray-600 bg-gray-100'
  }

  const formatCategory = (category: string) => {
    return category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
  }

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
        <span className="ml-2 text-gray-600">Loading communications...</span>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Communications</h1>
          <p className="text-gray-600">Email automation system with AI processing</p>
        </div>
        <div className="flex gap-2">
          <Button
            variant="outline"
            onClick={handleRefresh}
            disabled={isRefreshing}
            className="flex items-center gap-2"
          >
            <RefreshCw className={`h-4 w-4 ${isRefreshing ? 'animate-spin' : ''}`} />
            Refresh
          </Button>
          <Button className="flex items-center gap-2">
            <Plus className="h-4 w-4" />
            Setup Integration
          </Button>
        </div>
      </div>

      {/* Tabs */}
      <div className="border-b border-gray-200">
        <nav className="flex space-x-8">
          {[
            { id: 'emails', label: 'Email System', icon: Mail },
            { id: 'calls', label: 'Phone System', icon: Phone },
            { id: 'sms', label: 'SMS System', icon: MessageSquare },
            { id: 'settings', label: 'Settings', icon: Settings }
          ].map(tab => {
            const Icon = tab.icon
            return (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as any)}
                className={`flex items-center gap-2 py-2 px-1 border-b-2 font-medium text-sm ${
                  activeTab === tab.id
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
              >
                <Icon className="h-4 w-4" />
                {tab.label}
              </button>
            )
          })}
        </nav>
      </div>

      {/* Email Tab */}
      {activeTab === 'emails' && (
        <div className="space-y-6">
          {/* Email Statistics */}
          {emailStats && (
            <div className="grid grid-cols-2 md:grid-cols-6 gap-4">
              <Card>
                <CardContent className="p-4 text-center">
                  <Mail className="h-6 w-6 text-blue-600 mx-auto mb-2" />
                  <div className="text-2xl font-bold text-blue-600">{emailStats.totalEmails}</div>
                  <div className="text-sm text-gray-600">Total Emails</div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="p-4 text-center">
                  <FileText className="h-6 w-6 text-green-600 mx-auto mb-2" />
                  <div className="text-2xl font-bold text-green-600">{emailStats.claimRelated}</div>
                  <div className="text-sm text-gray-600">Claim Related</div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="p-4 text-center">
                  <AlertTriangle className="h-6 w-6 text-red-600 mx-auto mb-2" />
                  <div className="text-2xl font-bold text-red-600">{emailStats.highPriority}</div>
                  <div className="text-sm text-gray-600">High Priority</div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="p-4 text-center">
                  <Brain className="h-6 w-6 text-purple-600 mx-auto mb-2" />
                  <div className="text-2xl font-bold text-purple-600">
                    {Math.round((emailStats.averageConfidence || 0) * 100)}%
                  </div>
                  <div className="text-sm text-gray-600">AI Confidence</div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="p-4 text-center">
                  <CheckCircle className="h-6 w-6 text-green-600 mx-auto mb-2" />
                  <div className="text-2xl font-bold text-green-600">{emailStats.tasksCreated}</div>
                  <div className="text-sm text-gray-600">Tasks Created</div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className="p-4 text-center">
                  <BarChart3 className="h-6 w-6 text-orange-600 mx-auto mb-2" />
                  <div className="text-2xl font-bold text-orange-600">{emailStats.claimNumbersExtracted}</div>
                  <div className="text-sm text-gray-600">Claims Found</div>
                </CardContent>
              </Card>
            </div>
          )}

          {/* Email System Overview */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Brain className="h-5 w-5 text-purple-600" />
                AI Email Processing System
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div className="text-center">
                  <div className="w-12 h-12 bg-blue-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <Mail className="h-6 w-6 text-blue-600" />
                  </div>
                  <h3 className="font-semibold mb-2">Email Ingestion</h3>
                  <p className="text-sm text-gray-600">
                    Automatic email collection from IMAP/Gmail with real-time processing
                  </p>
                </div>
                <div className="text-center">
                  <div className="w-12 h-12 bg-purple-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <Brain className="h-6 w-6 text-purple-600" />
                  </div>
                  <h3 className="font-semibold mb-2">AI Classification</h3>
                  <p className="text-sm text-gray-600">
                    Smart categorization, claim number extraction, and priority assessment
                  </p>
                </div>
                <div className="text-center">
                  <div className="w-12 h-12 bg-green-100 rounded-lg flex items-center justify-center mx-auto mb-3">
                    <CheckCircle className="h-6 w-6 text-green-600" />
                  </div>
                  <h3 className="font-semibold mb-2">Auto Actions</h3>
                  <p className="text-sm text-gray-600">
                    Automatic task creation, notifications, and workflow triggers
                  </p>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Integration Status */}
          <Card>
            <CardHeader>
              <CardTitle>Integration Status</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-3">
                <div className="flex items-center justify-between p-3 border rounded-lg">
                  <div className="flex items-center gap-3">
                    <Mail className="h-5 w-5 text-blue-600" />
                    <div>
                      <h4 className="font-medium">Email Integration</h4>
                      <p className="text-sm text-gray-600">Backend processing system ready</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span className="text-sm text-green-600">Active</span>
                  </div>
                </div>
                <div className="flex items-center justify-between p-3 border rounded-lg">
                  <div className="flex items-center gap-3">
                    <Brain className="h-5 w-5 text-purple-600" />
                    <div>
                      <h4 className="font-medium">AI Processing</h4>
                      <p className="text-sm text-gray-600">Document processing and extraction</p>
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span className="text-sm text-green-600">Active</span>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Other tabs */}
      {activeTab === 'calls' && (
        <Card>
          <CardContent className="p-8 text-center">
            <Phone className="h-12 w-12 text-gray-300 mx-auto mb-4" />
            <h3 className="text-lg font-medium text-gray-900 mb-2">Phone System Integration</h3>
            <p className="text-gray-600 mb-4">Amazon Connect integration available for advanced phone features</p>
            <Button className="flex items-center gap-2 mx-auto">
              <Settings className="h-4 w-4" />
              Setup Phone System
            </Button>
          </CardContent>
        </Card>
      )}

      {activeTab === 'sms' && (
        <Card>
          <CardContent className="p-8 text-center">
            <MessageSquare className="h-12 w-12 text-gray-300 mx-auto mb-4" />
            <h3 className="text-lg font-medium text-gray-900 mb-2">SMS Integration</h3>
            <p className="text-gray-600 mb-4">SMS automation and tracking ready for configuration</p>
            <Button className="flex items-center gap-2 mx-auto">
              <Settings className="h-4 w-4" />
              Setup SMS Service
            </Button>
          </CardContent>
        </Card>
      )}

      {activeTab === 'settings' && (
        <div className="space-y-6">
          <Card>
            <CardHeader>
              <CardTitle>System Configuration</CardTitle>
            </CardHeader>
            <CardContent className="space-y-4">
              <p className="text-gray-600">
                The communication system is now integrated with real backend processing. 
                Advanced configuration options will be available in the next update.
              </p>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="p-4 border rounded-lg">
                  <h4 className="font-medium mb-2">Document Processing</h4>
                  <p className="text-sm text-gray-600 mb-3">
                    Real AI-powered document extraction with Supabase storage
                  </p>
                  <div className="flex items-center gap-2">
                    <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span className="text-sm text-green-600">Configured</span>
                  </div>
                </div>
                <div className="p-4 border rounded-lg">
                  <h4 className="font-medium mb-2">Email Processing</h4>
                  <p className="text-sm text-gray-600 mb-3">
                    AI classification and automated task creation system
                  </p>
                  <div className="flex items-center gap-2">
                    <div className="w-2 h-2 bg-green-500 rounded-full"></div>
                    <span className="text-sm text-green-600">Ready</span>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      )}
    </div>
  )
}
\n
claimguru/src/pages/Dashboard.tsx
import React, { useEffect, useState } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { AdvancedAIDashboard } from '../components/ai/AdvancedAIDashboard'
import { 
  FileText, 
  Users, 
  DollarSign, 
  TrendingUp, 
  Clock, 
  AlertTriangle,
  CheckCircle,
  Brain,
  Calendar,
  BarChart3,
  PieChart,
  Building,
  Plus,
  Eye,
  Zap,
  Target
} from 'lucide-react'
import { useAuth } from '../contexts/AuthContext'
import { supabase } from '../lib/supabase'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { useNavigate } from 'react-router-dom'
import { useClaims } from '../hooks/useClaims'
import { useClients } from '../hooks/useClients'

interface DashboardStats {
  totalClaims: number
  openClaims: number
  totalClients: number
  pendingTasks: number
  totalValue: number
  settledValue: number
  pendingValue: number
  activeVendors: number
  recentActivity: any[]
  upcomingDeadlines: any[]
  claimsByStatus: { [key: string]: number }
  monthlyRevenue: { month: string; revenue: number }[]
}

export function Dashboard() {
  const { userProfile } = useAuth()
  const navigate = useNavigate()
  const { claims, loading: claimsLoading } = useClaims()
  const { clients, loading: clientsLoading } = useClients()
  const [stats, setStats] = useState<DashboardStats | null>(null)
  const [loading, setLoading] = useState(true)
  const [showAIDashboard, setShowAIDashboard] = useState(false)

  useEffect(() => {
    if (!claimsLoading && !clientsLoading) {
      loadDashboardData()
    }
  }, [claimsLoading, clientsLoading, claims, clients])

  async function loadDashboardData() {
    if (!userProfile?.organization_id) return

    try {
      const [claimsData, clientsData, tasksData, activitiesData, vendorsData] = await Promise.all([
        supabase
          .from('claims')
          .select('id, claim_status, estimated_loss_value, total_settlement_amount, created_at')
          .eq('organization_id', userProfile.organization_id),
        supabase
          .from('clients')
          .select('id, created_at')
          .eq('organization_id', userProfile.organization_id),
        supabase
          .from('tasks')
          .select('id, status, priority, due_date, title')
          .eq('organization_id', userProfile.organization_id),
        supabase
          .from('activities')
          .select('*')
          .eq('organization_id', userProfile.organization_id)
          .order('created_at', { ascending: false })
          .limit(10),
        supabase
          .from('vendors')
          .select('id, is_active')
          .eq('organization_id', userProfile.organization_id)
          .eq('is_active', true)
      ])

      const claims = claimsData.data || []
      const clients = clientsData.data || []
      const tasks = tasksData.data || []
      const activities = activitiesData.data || []
      const vendors = vendorsData.data || []

      const openClaims = claims.filter(claim => 
        ['new', 'in_progress', 'under_review', 'investigating'].includes(claim.claim_status)
      )

      const settledClaims = claims.filter(claim => claim.claim_status === 'settled')
      const totalValue = claims.reduce((sum, claim) => sum + (claim.estimated_loss_value || 0), 0)
      const settledValue = settledClaims.reduce((sum, claim) => sum + (claim.total_settlement_amount || 0), 0)
      const pendingValue = openClaims.reduce((sum, claim) => sum + (claim.estimated_loss_value || 0), 0)

      const claimsByStatus = claims.reduce((acc, claim) => {
        acc[claim.claim_status] = (acc[claim.claim_status] || 0) + 1
        return acc
      }, {} as { [key: string]: number })

      const monthlyRevenue = settledClaims.reduce((acc, claim) => {
        const month = new Date(claim.created_at).toLocaleString('default', { month: 'short', year: 'numeric' })
        const existing = acc.find(item => item.month === month)
        if (existing) {
          existing.revenue += claim.total_settlement_amount || 0
        } else {
          acc.push({ month, revenue: claim.total_settlement_amount || 0 })
        }
        return acc
      }, [] as { month: string; revenue: number }[])

      setStats({
        totalClaims: claims.length,
        openClaims: openClaims.length,
        totalClients: clients.length,
        pendingTasks: tasks.filter(t => t.status === 'pending').length,
        totalValue,
        settledValue,
        pendingValue,
        activeVendors: vendors.length,
        recentActivity: activities,
        upcomingDeadlines: tasks.filter(task => task.due_date).slice(0, 5),
        claimsByStatus,
        monthlyRevenue: monthlyRevenue.slice(-6)
      })
    } catch (error) {
      console.error('Error loading dashboard data:', error)
    } finally {
      setLoading(false)
    }
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <div className="p-6 space-y-6">
      {/* Welcome Section */}
      <div className="mb-8">
        <h1 className="text-3xl font-bold text-gray-900">
          Welcome back, {userProfile?.first_name}!
        </h1>
        <p className="text-gray-600 mt-2">
          Here's what's happening with your claims today.
        </p>
      </div>

      {/* Stats Grid */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <Card className="hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Total Claims</p>
                <p className="text-3xl font-bold text-gray-900">{stats?.totalClaims || 0}</p>
                <p className="text-xs text-gray-500 mt-1">{stats?.openClaims || 0} open</p>
              </div>
              <div className="p-2 bg-blue-100 rounded-full">
                <FileText className="h-8 w-8 text-blue-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Settled Value</p>
                <p className="text-3xl font-bold text-green-600">
                  ${stats?.settledValue?.toLocaleString() || '0'}
                </p>
                <p className="text-xs text-gray-500 mt-1">Revenue generated</p>
              </div>
              <div className="p-2 bg-green-100 rounded-full">
                <TrendingUp className="h-8 w-8 text-green-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Pending Value</p>
                <p className="text-3xl font-bold text-orange-600">
                  ${stats?.pendingValue?.toLocaleString() || '0'}
                </p>
                <p className="text-xs text-gray-500 mt-1">{stats?.openClaims || 0} open claims</p>
              </div>
              <div className="p-2 bg-orange-100 rounded-full">
                <Clock className="h-8 w-8 text-orange-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Active Network</p>
                <p className="text-3xl font-bold text-purple-600">
                  {(stats?.totalClients || 0) + (stats?.activeVendors || 0)}
                </p>
                <p className="text-xs text-gray-500 mt-1">
                  {stats?.totalClients || 0} clients, {stats?.activeVendors || 0} vendors
                </p>
              </div>
              <div className="p-2 bg-purple-100 rounded-full">
                <Building className="h-8 w-8 text-purple-600" />
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Quick Actions */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <Button 
          onClick={() => navigate('/claims')}
          className="p-6 h-auto flex flex-col items-center space-y-2 bg-blue-50 text-blue-700 hover:bg-blue-100 border border-blue-200"
          variant="outline"
        >
          <FileText className="h-8 w-8" />
          <div className="text-center">
            <p className="font-medium">New Claim</p>
            <p className="text-xs opacity-75">Create insurance claim</p>
          </div>
        </Button>

        <Button 
          onClick={() => navigate('/clients')}
          className="p-6 h-auto flex flex-col items-center space-y-2 bg-green-50 text-green-700 hover:bg-green-100 border border-green-200"
          variant="outline"
        >
          <Users className="h-8 w-8" />
          <div className="text-center">
            <p className="font-medium">Add Client</p>
            <p className="text-xs opacity-75">Manage relationships</p>
          </div>
        </Button>

        <Button 
          onClick={() => navigate('/finance')}
          className="p-6 h-auto flex flex-col items-center space-y-2 bg-purple-50 text-purple-700 hover:bg-purple-100 border border-purple-200"
          variant="outline"
        >
          <DollarSign className="h-8 w-8" />
          <div className="text-center">
            <p className="font-medium">Finance</p>
            <p className="text-xs opacity-75">Billing & payments</p>
          </div>
        </Button>

        <Button 
          onClick={() => navigate('/tasks')}
          className="p-6 h-auto flex flex-col items-center space-y-2 bg-orange-50 text-orange-700 hover:bg-orange-100 border border-orange-200"
          variant="outline"
        >
          <Calendar className="h-8 w-8" />
          <div className="text-center">
            <p className="font-medium">Tasks</p>
            <p className="text-xs opacity-75">Manage workflow</p>
          </div>
        </Button>
      </div>

      {/* Analytics Section */}
      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
        {/* Claims by Status */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center space-x-2">
              <PieChart className="h-5 w-5" />
              <span>Claims by Status</span>
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-3">
              {stats?.claimsByStatus && Object.entries(stats.claimsByStatus).map(([status, count]) => (
                <div key={status} className="flex items-center justify-between">
                  <div className="flex items-center space-x-2">
                    <div className={`w-3 h-3 rounded-full ${
                      status === 'new' ? 'bg-blue-500' :
                      status === 'in_progress' ? 'bg-orange-500' :
                      status === 'settled' ? 'bg-green-500' :
                      status === 'closed' ? 'bg-gray-500' : 'bg-purple-500'
                    }`}></div>
                    <span className="text-sm capitalize text-gray-700">
                      {status.replace('_', ' ')}
                    </span>
                  </div>
                  <span className="text-sm font-medium text-gray-900">{count}</span>
                </div>
              )) || (
                <p className="text-gray-500 text-center py-4">No claim data</p>
              )}
            </div>
          </CardContent>
        </Card>

        {/* Recent Activity */}
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center space-x-2">
              <TrendingUp className="h-5 w-5" />
              <span>Recent Activity</span>
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              {stats?.recentActivity?.slice(0, 5).map((activity, index) => (
                <div key={index} className="flex items-start space-x-3">
                  <div className="w-2 h-2 bg-blue-600 rounded-full mt-2"></div>
                  <div className="flex-1">
                    <p className="text-sm font-medium text-gray-900">
                      {activity.title || activity.activity_type}
                    </p>
                    <p className="text-xs text-gray-600">
                      {new Date(activity.created_at).toLocaleDateString()}
                    </p>
                  </div>
                </div>
              )) || (
                <p className="text-gray-500 text-center py-4">No recent activity</p>
              )}
            </div>
          </CardContent>
        </Card>
      </div>
    </div>
  )
}\n
claimguru/src/pages/Documents.tsx
import React from 'react'
import { AdvancedDocumentManager } from '../components/documents/AdvancedDocumentManager'

export function Documents() {
  return (
    <div className="p-6">
      <AdvancedDocumentManager />
    </div>
  )
}
\n
claimguru/src/pages/Finance.tsx
import React, { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { 
  DollarSign, 
  TrendingUp, 
  TrendingDown, 
  Receipt, 
  CreditCard,
  FileText,
  Plus,
  Filter,
  Download,
  Eye,
  Edit,
  Trash2,
  Calendar,
  BarChart3,
  PieChart,
  Target,
  Wallet,
  BanknoteIcon,
  Calculator
} from 'lucide-react'
import { useAuth } from '../contexts/AuthContext'
import { supabase } from '../lib/supabase'
import type { FeeSchedule, Expense, Payment, Claim } from '../lib/supabase'
import { FinanceAnalytics } from '../components/finance/FinanceAnalytics'
import { FeeScheduleForm } from '../components/forms/FeeScheduleForm'
import { ExpenseForm } from '../components/forms/ExpenseForm'
import { PaymentForm } from '../components/forms/PaymentForm'

interface FinanceStats {
  totalRevenue: number
  totalExpenses: number
  netProfit: number
  pendingPayments: number
  outstandingFees: number
  monthlyRevenue: { month: string; revenue: number; expenses: number }[]
  revenueByStatus: { status: string; amount: number }[]
  expensesByCategory: { category: string; amount: number }[]
  topPerformingClaims: { id: string; file_number: string; revenue: number }[]
  recentTransactions: any[]
}

export function Finance() {
  const { userProfile } = useAuth()
  const [loading, setLoading] = useState(true)
  const [stats, setStats] = useState<FinanceStats | null>(null)
  const [activeTab, setActiveTab] = useState('overview')
  const [feeSchedules, setFeeSchedules] = useState<FeeSchedule[]>([])
  const [expenses, setExpenses] = useState<Expense[]>([])
  const [payments, setPayments] = useState<Payment[]>([])
  const [showFeeForm, setShowFeeForm] = useState(false)
  const [showExpenseForm, setShowExpenseForm] = useState(false)
  const [showPaymentForm, setShowPaymentForm] = useState(false)
  const [selectedRecord, setSelectedRecord] = useState<any>(null)
  const [dateRange, setDateRange] = useState('30d')
  const [filterStatus, setFilterStatus] = useState('all')

  useEffect(() => {
    if (userProfile?.organization_id) {
      loadFinanceData()
    }
  }, [userProfile?.organization_id, dateRange])

  async function loadFinanceData() {
    if (!userProfile?.organization_id) return

    try {
      setLoading(true)
      
      // Calculate date range
      const endDate = new Date()
      const startDate = new Date()
      switch (dateRange) {
        case '7d': startDate.setDate(endDate.getDate() - 7); break
        case '30d': startDate.setDate(endDate.getDate() - 30); break
        case '90d': startDate.setDate(endDate.getDate() - 90); break
        case '1y': startDate.setFullYear(endDate.getFullYear() - 1); break
        default: startDate.setDate(endDate.getDate() - 30)
      }

      const [feesData, expensesData, paymentsData, claimsData] = await Promise.all([
        supabase
          .from('fee_schedules')
          .select('*')
          .eq('organization_id', userProfile.organization_id)
          .gte('created_at', startDate.toISOString())
          .order('created_at', { ascending: false }),
        supabase
          .from('expenses')
          .select('*')
          .eq('organization_id', userProfile.organization_id)
          .gte('created_at', startDate.toISOString())
          .order('created_at', { ascending: false }),
        supabase
          .from('payments')
          .select('*')
          .eq('organization_id', userProfile.organization_id)
          .gte('created_at', startDate.toISOString())
          .order('created_at', { ascending: false }),
        supabase
          .from('claims')
          .select('*')
          .eq('organization_id', userProfile.organization_id)
      ])

      const fees = feesData.data || []
      const expensesResult = expensesData.data || []
      const paymentsResult = paymentsData.data || []
      const claims = claimsData.data || []

      // Calculate statistics
      const totalRevenue = paymentsResult
        .filter(p => p.payment_type === 'fee_payment')
        .reduce((sum, p) => sum + (p.amount || 0), 0)
      
      const totalExpenses = expensesResult
        .reduce((sum, e) => sum + (e.amount || 0), 0)
      
      const netProfit = totalRevenue - totalExpenses
      
      const pendingPayments = paymentsResult
        .filter(p => p.status === 'pending')
        .reduce((sum, p) => sum + (p.amount || 0), 0)
      
      const outstandingFees = fees
        .filter(f => f.status === 'pending')
        .reduce((sum, f) => sum + (f.fee_amount || 0), 0)

      // Monthly revenue/expense analysis
      const monthlyData = {}
      paymentsResult.forEach(payment => {
        const month = new Date(payment.created_at).toLocaleString('default', { month: 'short', year: 'numeric' })
        if (!monthlyData[month]) {
          monthlyData[month] = { revenue: 0, expenses: 0 }
        }
        if (payment.payment_type === 'fee_payment') {
          monthlyData[month].revenue += payment.amount || 0
        }
      })
      
      expensesResult.forEach(expense => {
        const month = new Date(expense.created_at).toLocaleString('default', { month: 'short', year: 'numeric' })
        if (!monthlyData[month]) {
          monthlyData[month] = { revenue: 0, expenses: 0 }
        }
        monthlyData[month].expenses += expense.amount || 0
      })

      const monthlyRevenue = Object.entries(monthlyData).map(([month, data]: [string, any]) => ({
        month,
        revenue: data.revenue,
        expenses: data.expenses
      }))

      // Revenue by status
      const revenueByStatus = fees.reduce((acc, fee) => {
        const existing = acc.find(item => item.status === fee.status)
        if (existing) {
          existing.amount += fee.fee_amount || 0
        } else {
          acc.push({ status: fee.status, amount: fee.fee_amount || 0 })
        }
        return acc
      }, [] as { status: string; amount: number }[])

      // Expenses by category
      const expensesByCategory = expensesResult.reduce((acc, expense) => {
        const category = expense.category || 'Other'
        const existing = acc.find(item => item.category === category)
        if (existing) {
          existing.amount += expense.amount || 0
        } else {
          acc.push({ category, amount: expense.amount || 0 })
        }
        return acc
      }, [] as { category: string; amount: number }[])

      // Top performing claims (by revenue)
      const claimsRevenue = claims.map(claim => {
        const claimFees = fees.filter(f => f.claim_id === claim.id)
        const claimRevenue = claimFees.reduce((sum, f) => sum + (f.fee_amount || 0), 0)
        return {
          id: claim.id,
          file_number: claim.file_number,
          revenue: claimRevenue
        }
      }).sort((a, b) => b.revenue - a.revenue).slice(0, 5)

      // Recent transactions
      const recentTransactions = [
        ...paymentsResult.slice(0, 5).map(p => ({ ...p, type: 'payment' })),
        ...expensesResult.slice(0, 5).map(e => ({ ...e, type: 'expense' }))
      ].sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime()).slice(0, 10)

      setStats({
        totalRevenue,
        totalExpenses,
        netProfit,
        pendingPayments,
        outstandingFees,
        monthlyRevenue,
        revenueByStatus,
        expensesByCategory,
        topPerformingClaims: claimsRevenue,
        recentTransactions
      })

      setFeeSchedules(fees)
      setExpenses(expensesResult)
      setPayments(paymentsResult)
    } catch (error) {
      console.error('Error loading finance data:', error)
    } finally {
      setLoading(false)
    }
  }

  const handleSave = async (data: any, type: string) => {
    try {
      if (selectedRecord) {
        // Update existing record
        await supabase
          .from(type === 'fee' ? 'fee_schedules' : type === 'expense' ? 'expenses' : 'payments')
          .update(data)
          .eq('id', selectedRecord.id)
      } else {
        // Create new record
        await supabase
          .from(type === 'fee' ? 'fee_schedules' : type === 'expense' ? 'expenses' : 'payments')
          .insert([{ ...data, organization_id: userProfile?.organization_id }])
      }
      
      // Reload data
      await loadFinanceData()
      
      // Close forms
      setShowFeeForm(false)
      setShowExpenseForm(false)
      setShowPaymentForm(false)
      setSelectedRecord(null)
    } catch (error) {
      console.error(`Error saving ${type}:`, error)
    }
  }

  const handleDelete = async (id: string, type: string) => {
    if (!confirm(`Are you sure you want to delete this ${type}?`)) return

    try {
      await supabase
        .from(type === 'fee' ? 'fee_schedules' : type === 'expense' ? 'expenses' : 'payments')
        .delete()
        .eq('id', id)
      
      await loadFinanceData()
    } catch (error) {
      console.error(`Error deleting ${type}:`, error)
    }
  }

  const exportData = () => {
    // Implementation for data export
    const exportData = {
      feeSchedules,
      expenses,
      payments,
      stats
    }
    
    const dataStr = JSON.stringify(exportData, null, 2)
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr)
    
    const exportFileDefaultName = `finance-report-${new Date().toISOString().split('T')[0]}.json`
    
    const linkElement = document.createElement('a')
    linkElement.setAttribute('href', dataUri)
    linkElement.setAttribute('download', exportFileDefaultName)
    linkElement.click()
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Financial Management</h1>
          <p className="text-gray-600 mt-2">
            Comprehensive financial tracking and analysis
          </p>
        </div>
        <div className="flex items-center space-x-4">
          <select 
            value={dateRange} 
            onChange={(e) => setDateRange(e.target.value)}
            className="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="7d">Last 7 days</option>
            <option value="30d">Last 30 days</option>
            <option value="90d">Last 90 days</option>
            <option value="1y">Last year</option>
          </select>
          <Button onClick={exportData} variant="outline">
            <Download className="h-4 w-4 mr-2" />
            Export
          </Button>
        </div>
      </div>

      {/* Financial Overview Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <Card className="hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Total Revenue</p>
                <p className="text-3xl font-bold text-green-600">
                  ${stats?.totalRevenue?.toLocaleString() || '0'}
                </p>
                <p className="text-xs text-gray-500 mt-1">
                  {dateRange.replace('d', ' days').replace('y', ' year')}
                </p>
              </div>
              <div className="p-2 bg-green-100 rounded-full">
                <TrendingUp className="h-8 w-8 text-green-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Total Expenses</p>
                <p className="text-3xl font-bold text-red-600">
                  ${stats?.totalExpenses?.toLocaleString() || '0'}
                </p>
                <p className="text-xs text-gray-500 mt-1">
                  {dateRange.replace('d', ' days').replace('y', ' year')}
                </p>
              </div>
              <div className="p-2 bg-red-100 rounded-full">
                <TrendingDown className="h-8 w-8 text-red-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Net Profit</p>
                <p className={`text-3xl font-bold ${
                  (stats?.netProfit || 0) >= 0 ? 'text-green-600' : 'text-red-600'
                }`}>
                  ${stats?.netProfit?.toLocaleString() || '0'}
                </p>
                <p className="text-xs text-gray-500 mt-1">
                  {((stats?.netProfit || 0) / (stats?.totalRevenue || 1) * 100).toFixed(1)}% margin
                </p>
              </div>
              <div className="p-2 bg-blue-100 rounded-full">
                <Target className="h-8 w-8 text-blue-600" />
              </div>
            </div>
          </CardContent>
        </Card>

        <Card className="hover:shadow-lg transition-shadow">
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Outstanding</p>
                <p className="text-3xl font-bold text-orange-600">
                  ${stats?.outstandingFees?.toLocaleString() || '0'}
                </p>
                <p className="text-xs text-gray-500 mt-1">
                  Pending collection
                </p>
              </div>
              <div className="p-2 bg-orange-100 rounded-full">
                <Wallet className="h-8 w-8 text-orange-600" />
              </div>
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Tab Navigation */}
      <div className="border-b border-gray-200">
        <nav className="-mb-px flex space-x-8">
          {[
            { id: 'overview', label: 'Overview', icon: BarChart3 },
            { id: 'fees', label: 'Fee Schedules', icon: Receipt },
            { id: 'expenses', label: 'Expenses', icon: CreditCard },
            { id: 'payments', label: 'Payments', icon: BanknoteIcon },
            { id: 'analytics', label: 'Analytics', icon: PieChart }
          ].map((tab) => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm ${
                activeTab === tab.id
                  ? 'border-blue-500 text-blue-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
              }`}
            >
              <tab.icon className="h-5 w-5 mr-2" />
              {tab.label}
            </button>
          ))}
        </nav>
      </div>

      {/* Tab Content */}
      {activeTab === 'overview' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Monthly Revenue Chart */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center space-x-2">
                <BarChart3 className="h-5 w-5" />
                <span>Monthly Revenue vs Expenses</span>
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {stats?.monthlyRevenue?.map((data, index) => (
                  <div key={index} className="space-y-2">
                    <div className="flex justify-between text-sm">
                      <span className="font-medium">{data.month}</span>
                      <span className="text-green-600">+${data.revenue.toLocaleString()}</span>
                    </div>
                    <div className="w-full bg-gray-200 rounded-full h-2">
                      <div 
                        className="bg-green-600 h-2 rounded-full"
                        style={{ width: `${(data.revenue / Math.max(...stats.monthlyRevenue.map(m => m.revenue)) || 1) * 100}%` }}
                      ></div>
                    </div>
                    <div className="flex justify-between text-xs text-gray-500">
                      <span>Expenses: ${data.expenses.toLocaleString()}</span>
                      <span>Net: ${(data.revenue - data.expenses).toLocaleString()}</span>
                    </div>
                  </div>
                )) || (
                  <p className="text-gray-500 text-center py-4">No revenue data</p>
                )}
              </div>
            </CardContent>
          </Card>

          {/* Recent Transactions */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center space-x-2">
                <Calendar className="h-5 w-5" />
                <span>Recent Transactions</span>
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {stats?.recentTransactions?.map((transaction, index) => (
                  <div key={index} className="flex items-center justify-between p-3 border rounded-lg">
                    <div className="flex items-center space-x-3">
                      <div className={`p-2 rounded-full ${
                        transaction.type === 'payment' ? 'bg-green-100' : 'bg-red-100'
                      }`}>
                        {transaction.type === 'payment' ? (
                          <BanknoteIcon className={`h-4 w-4 ${
                            transaction.type === 'payment' ? 'text-green-600' : 'text-red-600'
                          }`} />
                        ) : (
                          <Receipt className="h-4 w-4 text-red-600" />
                        )}
                      </div>
                      <div>
                        <p className="text-sm font-medium">
                          {transaction.description || transaction.payment_type || transaction.expense_type}
                        </p>
                        <p className="text-xs text-gray-500">
                          {new Date(transaction.created_at).toLocaleDateString()}
                        </p>
                      </div>
                    </div>
                    <span className={`font-medium ${
                      transaction.type === 'payment' ? 'text-green-600' : 'text-red-600'
                    }`}>
                      {transaction.type === 'payment' ? '+' : '-'}${transaction.amount?.toLocaleString()}
                    </span>
                  </div>
                )) || (
                  <p className="text-gray-500 text-center py-4">No recent transactions</p>
                )}
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {activeTab === 'fees' && (
        <Card>
          <CardHeader>
            <div className="flex items-center justify-between">
              <CardTitle>Fee Schedules</CardTitle>
              <Button onClick={() => setShowFeeForm(true)}>
                <Plus className="h-4 w-4 mr-2" />
                Add Fee
              </Button>
            </div>
          </CardHeader>
          <CardContent>
            <div className="overflow-x-auto">
              <table className="min-w-full divide-y divide-gray-200">
                <thead className="bg-gray-50">
                  <tr>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Type</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Amount</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Due Date</th>
                    <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                  </tr>
                </thead>
                <tbody className="bg-white divide-y divide-gray-200">
                  {feeSchedules.map((fee) => (
                    <tr key={fee.id} className="hover:bg-gray-50">
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        {fee.fee_type}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${fee.fee_amount?.toLocaleString() || '0'}
                        {fee.fee_percentage && ` (${fee.fee_percentage}%)`}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap">
                        <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                          fee.status === 'paid' ? 'bg-green-100 text-green-800' :
                          fee.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                          'bg-red-100 text-red-800'
                        }`}>
                          {fee.status}
                        </span>
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        {fee.due_date ? new Date(fee.due_date).toLocaleDateString() : '-'}
                      </td>
                      <td className="px-6 py-4 whitespace-nowrap text-sm font-medium space-x-2">
                        <Button
                          size="sm"
                          variant="outline"
                          onClick={() => {
                            setSelectedRecord(fee)
                            setShowFeeForm(true)
                          }}
                        >
                          <Edit className="h-4 w-4" />
                        </Button>
                        <Button
                          size="sm"
                          variant="outline"
                          onClick={() => handleDelete(fee.id, 'fee')}
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
              {feeSchedules.length === 0 && (
                <p className="text-gray-500 text-center py-8">No fee schedules found</p>
              )}
            </div>
          </CardContent>
        </Card>
      )}

      {activeTab === 'analytics' && (
        <FinanceAnalytics stats={stats} />
      )}

      {/* Forms */}
      {showFeeForm && (
        <FeeScheduleForm
          feeSchedule={selectedRecord}
          isOpen={showFeeForm}
          onClose={() => {
            setShowFeeForm(false)
            setSelectedRecord(null)
          }}
          onSave={(data) => handleSave(data, 'fee')}
        />
      )}

      {showExpenseForm && (
        <ExpenseForm
          expense={selectedRecord}
          isOpen={showExpenseForm}
          onClose={() => {
            setShowExpenseForm(false)
            setSelectedRecord(null)
          }}
          onSave={(data) => handleSave(data, 'expense')}
        />
      )}

      {showPaymentForm && (
        <PaymentForm
          payment={selectedRecord}
          isOpen={showPaymentForm}
          onClose={() => {
            setShowPaymentForm(false)
            setSelectedRecord(null)
          }}
          onSave={(data) => handleSave(data, 'payment')}
        />
      )}
    </div>
  )
}\n
claimguru/src/pages/Financial.tsx
import React, { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { 
  DollarSign, 
  TrendingUp, 
  TrendingDown,
  FileText,
  Calendar,
  Plus,
  Search,
  Filter,
  Download,
  CreditCard,
  Receipt,
  AlertCircle,
  CheckCircle,
  Clock,
  Calculator
} from 'lucide-react'
import { useAuth } from '../contexts/AuthContext'
import { supabase } from '../lib/supabase'
import type { FeeSchedule, Expense, Payment } from '../lib/supabase'
import { useClaims } from '../hooks/useClaims'

export function Financial() {
  const { userProfile } = useAuth()
  const { claims } = useClaims()
  const [loading, setLoading] = useState(true)
  const [fees, setFees] = useState<FeeSchedule[]>([])
  const [expenses, setExpenses] = useState<Expense[]>([])
  const [payments, setPayments] = useState<Payment[]>([])
  const [activeTab, setActiveTab] = useState<'overview' | 'fees' | 'expenses' | 'payments'>('overview')
  const [searchTerm, setSearchTerm] = useState('')
  const [statusFilter, setStatusFilter] = useState('all')

  useEffect(() => {
    if (userProfile?.organization_id) {
      loadFinancialData()
    }
  }, [userProfile?.organization_id])

  async function loadFinancialData() {
    if (!userProfile?.organization_id) return

    try {
      setLoading(true)
      const [feesData, expensesData, paymentsData] = await Promise.all([
        supabase
          .from('fee_schedules')
          .select('*')
          .eq('organization_id', userProfile.organization_id)
          .order('created_at', { ascending: false }),
        supabase
          .from('expenses')
          .select('*')
          .eq('organization_id', userProfile.organization_id)
          .order('expense_date', { ascending: false }),
        supabase
          .from('payments')
          .select('*')
          .eq('organization_id', userProfile.organization_id)
          .order('created_at', { ascending: false })
      ])

      setFees(feesData.data || [])
      setExpenses(expensesData.data || [])
      setPayments(paymentsData.data || [])
    } catch (error) {
      console.error('Error loading financial data:', error)
    } finally {
      setLoading(false)
    }
  }

  // Calculate financial metrics
  const totalRevenue = fees.filter(f => f.status === 'paid').reduce((sum, f) => sum + (f.fee_amount || 0), 0)
  const pendingRevenue = fees.filter(f => f.status === 'pending' || f.status === 'invoiced').reduce((sum, f) => sum + (f.fee_amount || 0), 0)
  const totalExpenses = expenses.filter(e => e.approval_status === 'approved').reduce((sum, e) => sum + e.amount, 0)
  const pendingExpenses = expenses.filter(e => e.approval_status === 'pending').reduce((sum, e) => sum + e.amount, 0)
  const netIncome = totalRevenue - totalExpenses

  const filteredData = () => {
    let data: any[] = []
    switch (activeTab) {
      case 'fees':
        data = fees
        break
      case 'expenses':
        data = expenses
        break
      case 'payments':
        data = payments
        break
      default:
        return []
    }

    return data.filter(item => {
      const matchesSearch = searchTerm === '' || 
        JSON.stringify(item).toLowerCase().includes(searchTerm.toLowerCase())
      const matchesStatus = statusFilter === 'all' || 
        item.status === statusFilter || 
        item.approval_status === statusFilter
      return matchesSearch && matchesStatus
    })
  }

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'paid': case 'completed': case 'approved': return CheckCircle
      case 'pending': return Clock
      case 'rejected': case 'failed': return AlertCircle
      default: return Clock
    }
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'paid': case 'completed': case 'approved': return 'text-green-600 bg-green-100'
      case 'pending': return 'text-yellow-600 bg-yellow-100'
      case 'rejected': case 'failed': return 'text-red-600 bg-red-100'
      default: return 'text-gray-600 bg-gray-100'
    }
  }

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Financial Management</h1>
          <p className="text-gray-600 mt-2">
            Track fees, expenses, and payments with comprehensive financial analytics
          </p>
        </div>
        <div className="flex space-x-2">
          <Button variant="outline" className="flex items-center gap-2">
            <Download className="h-4 w-4" />
            Export Report
          </Button>
          <Button className="flex items-center gap-2">
            <Plus className="h-4 w-4" />
            Add Transaction
          </Button>
        </div>
      </div>

      {/* Financial Overview Cards */}
      {activeTab === 'overview' && (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-gray-600">Total Revenue</p>
                  <p className="text-3xl font-bold text-green-600">
                    ${totalRevenue.toLocaleString()}
                  </p>
                  <p className="text-xs text-gray-500 mt-1">
                    {fees.filter(f => f.status === 'paid').length} paid fees
                  </p>
                </div>
                <TrendingUp className="h-8 w-8 text-green-600" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-gray-600">Pending Revenue</p>
                  <p className="text-3xl font-bold text-yellow-600">
                    ${pendingRevenue.toLocaleString()}
                  </p>
                  <p className="text-xs text-gray-500 mt-1">
                    {fees.filter(f => f.status === 'pending' || f.status === 'invoiced').length} pending fees
                  </p>
                </div>
                <Clock className="h-8 w-8 text-yellow-600" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-gray-600">Total Expenses</p>
                  <p className="text-3xl font-bold text-red-600">
                    ${totalExpenses.toLocaleString()}
                  </p>
                  <p className="text-xs text-gray-500 mt-1">
                    {expenses.filter(e => e.approval_status === 'approved').length} approved expenses
                  </p>
                </div>
                <TrendingDown className="h-8 w-8 text-red-600" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-gray-600">Net Income</p>
                  <p className={`text-3xl font-bold ${
                    netIncome >= 0 ? 'text-green-600' : 'text-red-600'
                  }`}>
                    ${netIncome.toLocaleString()}
                  </p>
                  <p className="text-xs text-gray-500 mt-1">
                    Revenue - Expenses
                  </p>
                </div>
                <Calculator className="h-8 w-8 text-blue-600" />
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Tab Navigation */}
      <div className="border-b border-gray-200">
        <nav className="-mb-px flex space-x-8">
          {[
            { id: 'overview', label: 'Overview', icon: TrendingUp },
            { id: 'fees', label: 'Fee Schedules', icon: DollarSign },
            { id: 'expenses', label: 'Expenses', icon: Receipt },
            { id: 'payments', label: 'Payments', icon: CreditCard }
          ].map((tab) => {
            const Icon = tab.icon
            return (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as any)}
                className={`flex items-center space-x-2 py-2 px-1 border-b-2 font-medium text-sm ${
                  activeTab === tab.id
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
              >
                <Icon className="h-4 w-4" />
                <span>{tab.label}</span>
              </button>
            )
          })}
        </nav>
      </div>

      {/* Search and Filters */}
      {activeTab !== 'overview' && (
        <div className="flex flex-col sm:flex-row gap-4">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4" />
            <input
              type="text"
              placeholder={`Search ${activeTab}...`}
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
          <div className="flex items-center gap-2">
            <Filter className="h-4 w-4 text-gray-400" />
            <select
              value={statusFilter}
              onChange={(e) => setStatusFilter(e.target.value)}
              className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="all">All Status</option>
              <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="paid">Paid</option>
              <option value="rejected">Rejected</option>
            </select>
          </div>
        </div>
      )}

      {/* Data Tables */}
      {activeTab !== 'overview' && (
        <Card>
          <CardContent className="p-6">
            {filteredData().length === 0 ? (
              <div className="text-center py-12">
                <FileText className="h-16 w-16 text-gray-400 mx-auto mb-4" />
                <h3 className="text-xl font-semibold text-gray-900 mb-2">
                  No {activeTab} found
                </h3>
                <p className="text-gray-600 mb-6">
                  {searchTerm || statusFilter !== 'all' 
                    ? 'Try adjusting your search or filter criteria'
                    : `Start by adding your first ${activeTab.slice(0, -1)}`
                  }
                </p>
                <Button className="flex items-center gap-2">
                  <Plus className="h-4 w-4" />
                  Add {activeTab.slice(0, -1)}
                </Button>
              </div>
            ) : (
              <div className="space-y-4">
                {filteredData().map((item) => {
                  const status = item.status || item.approval_status
                  const StatusIcon = getStatusIcon(status)
                  const statusColorClass = getStatusColor(status)
                  
                  return (
                    <div key={item.id} className="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center space-x-4">
                          <div className={`p-2 rounded-full ${statusColorClass}`}>
                            <StatusIcon className="h-5 w-5" />
                          </div>
                          <div>
                            <h3 className="font-semibold text-gray-900">
                              {activeTab === 'fees' && `Fee: ${item.fee_type}`}
                              {activeTab === 'expenses' && `${item.expense_type}: ${item.description}`}
                              {activeTab === 'payments' && `${item.payment_type}: ${item.reference_number || 'Payment'}`}
                            </h3>
                            <p className="text-gray-600 text-sm">
                              {activeTab === 'fees' && item.description}
                              {activeTab === 'expenses' && `Category: ${item.category || 'General'}`}
                              {activeTab === 'payments' && `Method: ${item.payment_method || 'N/A'}`}
                            </p>
                            <p className="text-xs text-gray-500">
                              {activeTab === 'fees' && item.due_date && `Due: ${new Date(item.due_date).toLocaleDateString()}`}
                              {activeTab === 'expenses' && `Date: ${new Date(item.expense_date).toLocaleDateString()}`}
                              {activeTab === 'payments' && item.payment_date && `Date: ${new Date(item.payment_date).toLocaleDateString()}`}
                            </p>
                          </div>
                        </div>
                        
                        <div className="text-right">
                          <p className="text-lg font-semibold text-gray-900">
                            ${item.amount?.toLocaleString() || item.fee_amount?.toLocaleString() || '0'}
                          </p>
                          <span className={`px-2 py-1 rounded-full text-xs font-medium ${statusColorClass}`}>
                            {status?.charAt(0).toUpperCase() + status?.slice(1)}
                          </span>
                        </div>
                      </div>
                    </div>
                  )
                })}
              </div>
            )}
          </CardContent>
        </Card>
      )}

      {/* Overview Charts and Details */}
      {activeTab === 'overview' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Recent Transactions */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center space-x-2">
                <FileText className="h-5 w-5" />
                <span>Recent Transactions</span>
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {[...fees.slice(0, 3), ...expenses.slice(0, 3), ...payments.slice(0, 3)]
                  .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime())
                  .slice(0, 5)
                  .map((item, index) => {
                    const isRevenue = 'fee_amount' in item
                    const amount = ('amount' in item ? item.amount : null) || ('fee_amount' in item ? item.fee_amount : 0) || 0
                    
                    return (
                      <div key={index} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div className="flex items-center space-x-3">
                          <div className={`w-10 h-10 rounded-full flex items-center justify-center ${
                            isRevenue ? 'bg-green-100' : 'bg-red-100'
                          }`}>
                            {isRevenue ? (
                              <DollarSign className="h-5 w-5 text-green-600" />
                            ) : (
                              <Receipt className="h-5 w-5 text-red-600" />
                            )}
                          </div>
                          <div>
                            <p className="font-medium text-gray-900">
                              {'fee_type' in item ? `Fee: ${item.fee_type}` : 
                               'expense_type' in item ? `Expense: ${item.expense_type}` : 
                               'Payment'}
                            </p>
                            <p className="text-sm text-gray-500">
                              {new Date(item.created_at).toLocaleDateString()}
                            </p>
                          </div>
                        </div>
                        <div className="text-right">
                          <p className={`font-semibold ${
                            isRevenue ? 'text-green-600' : 'text-red-600'
                          }`}>
                            {isRevenue ? '+' : '-'}${amount.toLocaleString()}
                          </p>
                        </div>
                      </div>
                    )
                  })}
              </div>
            </CardContent>
          </Card>

          {/* Financial Summary */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center space-x-2">
                <Calculator className="h-5 w-5" />
                <span>Financial Summary</span>
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <div className="flex justify-between items-center p-3 bg-green-50 rounded-lg">
                  <span className="text-green-800 font-medium">Total Revenue</span>
                  <span className="text-green-600 font-bold">${totalRevenue.toLocaleString()}</span>
                </div>
                <div className="flex justify-between items-center p-3 bg-yellow-50 rounded-lg">
                  <span className="text-yellow-800 font-medium">Pending Revenue</span>
                  <span className="text-yellow-600 font-bold">${pendingRevenue.toLocaleString()}</span>
                </div>
                <div className="flex justify-between items-center p-3 bg-red-50 rounded-lg">
                  <span className="text-red-800 font-medium">Total Expenses</span>
                  <span className="text-red-600 font-bold">${totalExpenses.toLocaleString()}</span>
                </div>
                <div className="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                  <span className="text-gray-800 font-medium">Pending Expenses</span>
                  <span className="text-gray-600 font-bold">${pendingExpenses.toLocaleString()}</span>
                </div>
                <div className="border-t pt-4">
                  <div className={`flex justify-between items-center p-3 rounded-lg ${
                    netIncome >= 0 ? 'bg-green-50' : 'bg-red-50'
                  }`}>
                    <span className={`font-bold ${
                      netIncome >= 0 ? 'text-green-800' : 'text-red-800'
                    }`}>
                      Net Income
                    </span>
                    <span className={`font-bold text-lg ${
                      netIncome >= 0 ? 'text-green-600' : 'text-red-600'
                    }`}>
                      ${netIncome.toLocaleString()}
                    </span>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      )}
    </div>
  )
}\n
claimguru/src/pages/Insurers.tsx
import React, { useState, useEffect } from 'react'
import { Building2, Phone, Mail, Globe, Search, Filter, Plus, Upload, Download, Users, MapPin, FileText, ChevronRight, CheckCircle, AlertCircle, Eye, Edit, Trash2 } from 'lucide-react'
import { supabase, Insurer } from '../lib/supabase'
import { useToastContext } from '../contexts/ToastContext'
import FileImportExport from '../components/ui/FileImportExport'
import { insurerCSVHeaders, insurerToCSVRow, csvRowToInsurer, sampleInsurerData, ExcelRow } from '../utils/excelUtils'

interface InsurerFormData {
  name: string
  license_number: string
  contact_phone: string
  contact_email: string
  website: string
  address: {
    street: string
    city: string
    state: string
    zip: string
    country: string
  }
  regional_offices: any[]
  coverage_types: string[]
  claims_reporting: {
    email: string
    phone: string
    online_portal: string
    procedure: string
  }
  preferred_communication: string
  notes: string
}

const Insurers: React.FC = () => {
  const [insurers, setInsurers] = useState<Insurer[]>([])
  const [filteredInsurers, setFilteredInsurers] = useState<Insurer[]>([])
  const [loading, setLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')
  const [selectedCoverageType, setSelectedCoverageType] = useState('all')
  const [selectedState, setSelectedState] = useState('all')
  const [showInsurerForm, setShowInsurerForm] = useState(false)
  const [editingInsurer, setEditingInsurer] = useState<Insurer | null>(null)
  const [selectedInsurer, setSelectedInsurer] = useState<Insurer | null>(null)
  const [showImportExport, setShowImportExport] = useState(false)
  const [formData, setFormData] = useState<InsurerFormData>({
    name: '',
    license_number: '',
    contact_phone: '',
    contact_email: '',
    website: '',
    address: {
      street: '',
      city: '',
      state: '',
      zip: '',
      country: 'US'
    },
    regional_offices: [],
    coverage_types: [],
    claims_reporting: {
      email: '',
      phone: '',
      online_portal: '',
      procedure: ''
    },
    preferred_communication: 'email',
    notes: ''
  })

  const coverageTypes = [
    'Homeowners', 'Auto', 'Commercial Property', 'Workers Compensation',
    'General Liability', 'Professional Liability', 'Umbrella', 'Flood',
    'Earthquake', 'Wind/Hail', 'Fire', 'Cyber Liability'
  ]

  const states = [
    'AL', 'AK', 'AZ', 'AR', 'CA', 'CO', 'CT', 'DE', 'FL', 'GA',
    'HI', 'ID', 'IL', 'IN', 'IA', 'KS', 'KY', 'LA', 'ME', 'MD',
    'MA', 'MI', 'MN', 'MS', 'MO', 'MT', 'NE', 'NV', 'NH', 'NJ',
    'NM', 'NY', 'NC', 'ND', 'OH', 'OK', 'OR', 'PA', 'RI', 'SC',
    'SD', 'TN', 'TX', 'UT', 'VT', 'VA', 'WA', 'WV', 'WI', 'WY'
  ]

  const showToast = useToastContext()

  useEffect(() => {
    fetchInsurers()
  }, [])

  useEffect(() => {
    filterInsurers()
  }, [insurers, searchTerm, selectedCoverageType, selectedState])

  const fetchInsurers = async () => {
    try {
      const { data, error } = await supabase
        .from('insurers')
        .select('*')
        .eq('is_active', true)
        .order('name')
      
      if (error) throw error
      setInsurers(data || [])
    } catch (error) {
      console.error('Error fetching insurers:', error)
    } finally {
      setLoading(false)
    }
  }

  const filterInsurers = () => {
    let filtered = insurers

    if (searchTerm) {
      filtered = filtered.filter(insurer => 
        insurer.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
        insurer.contact_email?.toLowerCase().includes(searchTerm.toLowerCase()) ||
        insurer.license_number?.toLowerCase().includes(searchTerm.toLowerCase())
      )
    }

    if (selectedCoverageType !== 'all') {
      filtered = filtered.filter(insurer => 
        insurer.coverage_types?.includes(selectedCoverageType)
      )
    }

    if (selectedState !== 'all') {
      filtered = filtered.filter(insurer => 
        insurer.address?.state === selectedState
      )
    }

    setFilteredInsurers(filtered)
  }

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault()
    
    try {
      const insurerData = {
        ...formData,
        organization_id: '00000000-0000-0000-0000-000000000000' // Default org for now
      }

      if (editingInsurer) {
        const { error } = await supabase
          .from('insurers')
          .update(insurerData)
          .eq('id', editingInsurer.id)
        
        if (error) throw error
      } else {
        const { error } = await supabase
          .from('insurers')
          .insert(insurerData)
        
        if (error) throw error
      }

      setShowInsurerForm(false)
      setEditingInsurer(null)
      resetForm()
      fetchInsurers()
    } catch (error) {
      console.error('Error saving insurer:', error)
    }
  }

  const resetForm = () => {
    setFormData({
      name: '',
      license_number: '',
      contact_phone: '',
      contact_email: '',
      website: '',
      address: {
        street: '',
        city: '',
        state: '',
        zip: '',
        country: 'US'
      },
      regional_offices: [],
      coverage_types: [],
      claims_reporting: {
        email: '',
        phone: '',
        online_portal: '',
        procedure: ''
      },
      preferred_communication: 'email',
      notes: ''
    })
  }

  const handleEdit = (insurer: Insurer) => {
    setEditingInsurer(insurer)
    setFormData({
      name: insurer.name,
      license_number: insurer.license_number || '',
      contact_phone: insurer.contact_phone || '',
      contact_email: insurer.contact_email || '',
      website: insurer.website || '',
      address: insurer.address || {
        street: '',
        city: '',
        state: '',
        zip: '',
        country: 'US'
      },
      regional_offices: insurer.regional_offices || [],
      coverage_types: insurer.coverage_types || [],
      claims_reporting: insurer.claims_reporting || {
        email: '',
        phone: '',
        online_portal: '',
        procedure: ''
      },
      preferred_communication: insurer.preferred_communication,
      notes: insurer.notes || ''
    })
    setShowInsurerForm(true)
  }

  const handleCoverageTypeChange = (type: string) => {
    const updated = formData.coverage_types.includes(type)
      ? formData.coverage_types.filter(t => t !== type)
      : [...formData.coverage_types, type]
    
    setFormData({ ...formData, coverage_types: updated })
  }

  const handleExportInsurers = async (): Promise<ExcelRow[]> => {
    return insurers.map(insurer => insurerToCSVRow(insurer))
  }

  const handleImportInsurers = async (data: ExcelRow[]) => {
    try {
      const importedInsurers = data.map(row => csvRowToInsurer(row))
      
      // Insert in batches to avoid overwhelming the database
      const batchSize = 10
      let successCount = 0
      let errorCount = 0
      
      for (let i = 0; i < importedInsurers.length; i += batchSize) {
        const batch = importedInsurers.slice(i, i + batchSize)
        
        try {
          const { error } = await supabase
            .from('insurers')
            .insert(batch)
          
          if (error) {
            console.error('Batch insert error:', error)
            errorCount += batch.length
          } else {
            successCount += batch.length
          }
        } catch (batchError) {
          console.error('Batch processing error:', batchError)
          errorCount += batch.length
        }
      }
      
      await fetchInsurers()
      
      if (errorCount > 0) {
        showToast.warning(
          'Partial Import Success', 
          `Imported ${successCount} insurers. ${errorCount} failed due to validation errors.`
        )
      } else {
        showToast.success('Import Complete!', `Successfully imported ${successCount} insurers.`)
      }
    } catch (error: any) {
      console.error('Import error:', error)
      throw new Error(error.message || 'Failed to import insurers')
    }
  }

  const handleDeleteInsurer = async (insurerId: string) => {
    if (!confirm('Are you sure you want to delete this insurer?')) return
    
    try {
      const { error } = await supabase
        .from('insurers')
        .delete()
        .eq('id', insurerId)
      
      if (error) throw error
      
      showToast.success('Insurer Deleted', 'The insurer has been successfully removed.')
      fetchInsurers()
    } catch (error: any) {
      console.error('Error deleting insurer:', error)
      showToast.error('Delete Failed', error.message || 'Failed to delete insurer')
    }
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Insurance Carriers</h1>
          <p className="mt-1 text-sm text-gray-500">
            Manage relationships with insurance companies and their reporting procedures
          </p>
        </div>
        <div className="mt-4 sm:mt-0 flex space-x-3">
          <button
            onClick={() => setShowImportExport(true)}
            className="inline-flex items-center px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            <Upload className="h-4 w-4 mr-2" />
            Import/Export
          </button>
          <button
            onClick={() => {
              resetForm()
              setEditingInsurer(null)
              setShowInsurerForm(true)
            }}
            className="inline-flex items-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
          >
            <Plus className="h-4 w-4 mr-2" />
            Add Insurer
          </button>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div className="bg-white p-6 rounded-lg shadow">
          <div className="flex items-center">
            <Building2 className="h-8 w-8 text-blue-600" />
            <div className="ml-4">
              <p className="text-sm font-medium text-gray-500">Total Insurers</p>
              <p className="text-2xl font-bold text-gray-900">{insurers.length}</p>
            </div>
          </div>
        </div>
        <div className="bg-white p-6 rounded-lg shadow">
          <div className="flex items-center">
            <CheckCircle className="h-8 w-8 text-green-600" />
            <div className="ml-4">
              <p className="text-sm font-medium text-gray-500">Active Insurers</p>
              <p className="text-2xl font-bold text-gray-900">{insurers.filter(i => i.is_active).length}</p>
            </div>
          </div>
        </div>
        <div className="bg-white p-6 rounded-lg shadow">
          <div className="flex items-center">
            <FileText className="h-8 w-8 text-yellow-600" />
            <div className="ml-4">
              <p className="text-sm font-medium text-gray-500">Coverage Types</p>
              <p className="text-2xl font-bold text-gray-900">{coverageTypes.length}</p>
            </div>
          </div>
        </div>
        <div className="bg-white p-6 rounded-lg shadow">
          <div className="flex items-center">
            <MapPin className="h-8 w-8 text-purple-600" />
            <div className="ml-4">
              <p className="text-sm font-medium text-gray-500">States Covered</p>
              <p className="text-2xl font-bold text-gray-900">{new Set(insurers.map(i => i.address?.state).filter(Boolean)).size}</p>
            </div>
          </div>
        </div>
      </div>

      {/* Search and Filters */}
      <div className="bg-white p-6 rounded-lg shadow">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4" />
            <input
              type="text"
              placeholder="Search insurers..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="pl-10 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
            />
          </div>
          <select
            value={selectedCoverageType}
            onChange={(e) => setSelectedCoverageType(e.target.value)}
            className="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
          >
            <option value="all">All Coverage Types</option>
            {coverageTypes.map(type => (
              <option key={type} value={type}>{type}</option>
            ))}
          </select>
          <select
            value={selectedState}
            onChange={(e) => setSelectedState(e.target.value)}
            className="block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
          >
            <option value="all">All States</option>
            {states.map(state => (
              <option key={state} value={state}>{state}</option>
            ))}
          </select>
          <div className="flex items-center space-x-2">
            <Filter className="h-4 w-4 text-gray-400" />
            <span className="text-sm text-gray-500">{filteredInsurers.length} results</span>
          </div>
        </div>
      </div>

      {/* Insurers List */}
      <div className="bg-white shadow rounded-lg">
        <div className="px-6 py-4 border-b border-gray-200">
          <h3 className="text-lg font-medium text-gray-900">Insurance Carriers</h3>
        </div>
        <div className="divide-y divide-gray-200">
          {filteredInsurers.map((insurer) => (
            <div key={insurer.id} className="p-6 hover:bg-gray-50 cursor-pointer" onClick={() => setSelectedInsurer(insurer)}>
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-4">
                  <div className="flex-shrink-0">
                    <Building2 className="h-10 w-10 text-blue-600" />
                  </div>
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center space-x-2">
                      <p className="text-lg font-medium text-gray-900 truncate">{insurer.name}</p>
                      {insurer.is_active && (
                        <span className="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                          Active
                        </span>
                      )}
                    </div>
                    <div className="mt-1 flex items-center space-x-4 text-sm text-gray-500">
                      {insurer.license_number && (
                        <span>License: {insurer.license_number}</span>
                      )}
                      {insurer.contact_phone && (
                        <span className="flex items-center">
                          <Phone className="h-4 w-4 mr-1" />
                          {insurer.contact_phone}
                        </span>
                      )}
                      {insurer.contact_email && (
                        <span className="flex items-center">
                          <Mail className="h-4 w-4 mr-1" />
                          {insurer.contact_email}
                        </span>
                      )}
                    </div>
                    {insurer.coverage_types && insurer.coverage_types.length > 0 && (
                      <div className="mt-2 flex flex-wrap gap-1">
                        {insurer.coverage_types.slice(0, 3).map((type) => (
                          <span key={type} className="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">
                            {type}
                          </span>
                        ))}
                        {insurer.coverage_types.length > 3 && (
                          <span className="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-gray-100 text-gray-800">
                            +{insurer.coverage_types.length - 3} more
                          </span>
                        )}
                      </div>
                    )}
                  </div>
                </div>
                <div className="flex items-center space-x-2">
                  <button
                    onClick={(e) => {
                      e.stopPropagation()
                      handleEdit(insurer)
                    }}
                    className="inline-flex items-center px-3 py-2 border border-gray-300 shadow-sm text-sm leading-4 font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                  >
                    Edit
                  </button>
                  <ChevronRight className="h-5 w-5 text-gray-400" />
                </div>
              </div>
            </div>
          ))}
        </div>
        {filteredInsurers.length === 0 && (
          <div className="text-center py-12">
            <Building2 className="mx-auto h-12 w-12 text-gray-400" />
            <h3 className="mt-2 text-sm font-medium text-gray-900">No insurers found</h3>
            <p className="mt-1 text-sm text-gray-500">Get started by adding your first insurance carrier.</p>
            <div className="mt-6">
              <button
                onClick={() => setShowInsurerForm(true)}
                className="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
              >
                <Plus className="h-4 w-4 mr-2" />
                Add Insurer
              </button>
            </div>
          </div>
        )}
      </div>

      {/* Insurer Form Modal */}
      {showInsurerForm && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
          <div className="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div className="mt-3">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-medium text-gray-900">
                  {editingInsurer ? 'Edit Insurance Carrier' : 'Add Insurance Carrier'}
                </h3>
                <button
                  onClick={() => setShowInsurerForm(false)}
                  className="text-gray-400 hover:text-gray-600"
                >
                  Ã—
                </button>
              </div>
              
              <form onSubmit={handleSubmit} className="space-y-6">
                {/* Basic Information */}
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <label className="block text-sm font-medium text-gray-700">Company Name *</label>
                    <input
                      type="text"
                      required
                      value={formData.name}
                      onChange={(e) => setFormData({ ...formData, name: e.target.value })}
                      className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700">License Number</label>
                    <input
                      type="text"
                      value={formData.license_number}
                      onChange={(e) => setFormData({ ...formData, license_number: e.target.value })}
                      className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700">Contact Phone</label>
                    <input
                      type="tel"
                      value={formData.contact_phone}
                      onChange={(e) => setFormData({ ...formData, contact_phone: e.target.value })}
                      className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium text-gray-700">Contact Email</label>
                    <input
                      type="email"
                      value={formData.contact_email}
                      onChange={(e) => setFormData({ ...formData, contact_email: e.target.value })}
                      className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    />
                  </div>
                  <div className="md:col-span-2">
                    <label className="block text-sm font-medium text-gray-700">Website</label>
                    <input
                      type="url"
                      value={formData.website}
                      onChange={(e) => setFormData({ ...formData, website: e.target.value })}
                      className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    />
                  </div>
                </div>

                {/* Address Information */}
                <div>
                  <h4 className="text-sm font-medium text-gray-900 mb-4">Address Information</h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-gray-700">Street Address</label>
                      <input
                        type="text"
                        value={formData.address.street}
                        onChange={(e) => setFormData({ 
                          ...formData, 
                          address: { ...formData.address, street: e.target.value }
                        })}
                        className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">City</label>
                      <input
                        type="text"
                        value={formData.address.city}
                        onChange={(e) => setFormData({ 
                          ...formData, 
                          address: { ...formData.address, city: e.target.value }
                        })}
                        className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">State</label>
                      <select
                        value={formData.address.state}
                        onChange={(e) => setFormData({ 
                          ...formData, 
                          address: { ...formData.address, state: e.target.value }
                        })}
                        className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      >
                        <option value="">Select State</option>
                        {states.map(state => (
                          <option key={state} value={state}>{state}</option>
                        ))}
                      </select>
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">ZIP Code</label>
                      <input
                        type="text"
                        value={formData.address.zip}
                        onChange={(e) => setFormData({ 
                          ...formData, 
                          address: { ...formData.address, zip: e.target.value }
                        })}
                        className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Country</label>
                      <select
                        value={formData.address.country}
                        onChange={(e) => setFormData({ 
                          ...formData, 
                          address: { ...formData.address, country: e.target.value }
                        })}
                        className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      >
                        <option value="US">United States</option>
                        <option value="CA">Canada</option>
                      </select>
                    </div>
                  </div>
                </div>

                {/* Claims Reporting Information */}
                <div>
                  <h4 className="text-sm font-medium text-gray-900 mb-4">Claims Reporting Information</h4>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Claims Email</label>
                      <input
                        type="email"
                        value={formData.claims_reporting.email}
                        onChange={(e) => setFormData({ 
                          ...formData, 
                          claims_reporting: { ...formData.claims_reporting, email: e.target.value }
                        })}
                        className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      />
                    </div>
                    <div>
                      <label className="block text-sm font-medium text-gray-700">Claims Phone</label>
                      <input
                        type="tel"
                        value={formData.claims_reporting.phone}
                        onChange={(e) => setFormData({ 
                          ...formData, 
                          claims_reporting: { ...formData.claims_reporting, phone: e.target.value }
                        })}
                        className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      />
                    </div>
                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-gray-700">Online Portal URL</label>
                      <input
                        type="url"
                        value={formData.claims_reporting.online_portal}
                        onChange={(e) => setFormData({ 
                          ...formData, 
                          claims_reporting: { ...formData.claims_reporting, online_portal: e.target.value }
                        })}
                        className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                      />
                    </div>
                    <div className="md:col-span-2">
                      <label className="block text-sm font-medium text-gray-700">Claims Reporting Procedure</label>
                      <textarea
                        rows={3}
                        value={formData.claims_reporting.procedure}
                        onChange={(e) => setFormData({ 
                          ...formData, 
                          claims_reporting: { ...formData.claims_reporting, procedure: e.target.value }
                        })}
                        className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                        placeholder="Describe the claims reporting process..."
                      />
                    </div>
                  </div>
                </div>

                {/* Coverage Types */}
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-2">Coverage Types</label>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-2">
                    {coverageTypes.map((type) => (
                      <label key={type} className="inline-flex items-center">
                        <input
                          type="checkbox"
                          checked={formData.coverage_types.includes(type)}
                          onChange={() => handleCoverageTypeChange(type)}
                          className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                        />
                        <span className="ml-2 text-sm text-gray-700">{type}</span>
                      </label>
                    ))}
                  </div>
                </div>

                {/* Preferred Communication */}
                <div>
                  <label className="block text-sm font-medium text-gray-700">Preferred Communication</label>
                  <select
                    value={formData.preferred_communication}
                    onChange={(e) => setFormData({ ...formData, preferred_communication: e.target.value })}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                  >
                    <option value="email">Email</option>
                    <option value="phone">Phone</option>
                    <option value="portal">Online Portal</option>
                    <option value="fax">Fax</option>
                  </select>
                </div>

                {/* Notes */}
                <div>
                  <label className="block text-sm font-medium text-gray-700">Notes</label>
                  <textarea
                    rows={3}
                    value={formData.notes}
                    onChange={(e) => setFormData({ ...formData, notes: e.target.value })}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                    placeholder="Additional notes about this insurer..."
                  />
                </div>

                {/* Form Actions */}
                <div className="flex justify-end space-x-3">
                  <button
                    type="button"
                    onClick={() => setShowInsurerForm(false)}
                    className="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                  >
                    Cancel
                  </button>
                  <button
                    type="submit"
                    className="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                  >
                    {editingInsurer ? 'Update' : 'Create'} Insurer
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>
      )}

      {/* Insurer Detail Modal */}
      {selectedInsurer && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
          <div className="relative top-20 mx-auto p-5 border w-11/12 max-w-2xl shadow-lg rounded-md bg-white">
            <div className="mt-3">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-medium text-gray-900">{selectedInsurer.name}</h3>
                <button
                  onClick={() => setSelectedInsurer(null)}
                  className="text-gray-400 hover:text-gray-600"
                >
                  Ã—
                </button>
              </div>
              
              <div className="space-y-4">
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <h4 className="font-medium text-gray-900">Contact Information</h4>
                    <div className="mt-2 space-y-1 text-sm text-gray-600">
                      {selectedInsurer.contact_phone && (
                        <div className="flex items-center">
                          <Phone className="h-4 w-4 mr-2" />
                          {selectedInsurer.contact_phone}
                        </div>
                      )}
                      {selectedInsurer.contact_email && (
                        <div className="flex items-center">
                          <Mail className="h-4 w-4 mr-2" />
                          {selectedInsurer.contact_email}
                        </div>
                      )}
                      {selectedInsurer.website && (
                        <div className="flex items-center">
                          <Globe className="h-4 w-4 mr-2" />
                          <a href={selectedInsurer.website} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800">
                            {selectedInsurer.website}
                          </a>
                        </div>
                      )}
                    </div>
                  </div>
                  
                  <div>
                    <h4 className="font-medium text-gray-900">License & Status</h4>
                    <div className="mt-2 space-y-1 text-sm text-gray-600">
                      {selectedInsurer.license_number && (
                        <p>License: {selectedInsurer.license_number}</p>
                      )}
                      <p>Communication: {selectedInsurer.preferred_communication}</p>
                      <div className="flex items-center">
                        <span className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                          selectedInsurer.is_active 
                            ? 'bg-green-100 text-green-800' 
                            : 'bg-red-100 text-red-800'
                        }`}>
                          {selectedInsurer.is_active ? 'Active' : 'Inactive'}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>

                {selectedInsurer.address && (selectedInsurer.address.street || selectedInsurer.address.city) && (
                  <div>
                    <h4 className="font-medium text-gray-900">Address</h4>
                    <div className="mt-2 text-sm text-gray-600">
                      <div className="flex items-start">
                        <MapPin className="h-4 w-4 mr-2 mt-0.5 flex-shrink-0" />
                        <div>
                          {selectedInsurer.address.street && <div>{selectedInsurer.address.street}</div>}
                          <div>
                            {selectedInsurer.address.city && selectedInsurer.address.city}
                            {selectedInsurer.address.city && selectedInsurer.address.state && ', '}
                            {selectedInsurer.address.state && selectedInsurer.address.state}
                            {selectedInsurer.address.zip && ` ${selectedInsurer.address.zip}`}
                          </div>
                          {selectedInsurer.address.country && selectedInsurer.address.country !== 'US' && (
                            <div>{selectedInsurer.address.country}</div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {selectedInsurer.claims_reporting && (
                  selectedInsurer.claims_reporting.email || 
                  selectedInsurer.claims_reporting.phone || 
                  selectedInsurer.claims_reporting.online_portal
                ) && (
                  <div>
                    <h4 className="font-medium text-gray-900">Claims Reporting</h4>
                    <div className="mt-2 space-y-1 text-sm text-gray-600">
                      {selectedInsurer.claims_reporting.email && (
                        <div className="flex items-center">
                          <Mail className="h-4 w-4 mr-2" />
                          {selectedInsurer.claims_reporting.email}
                        </div>
                      )}
                      {selectedInsurer.claims_reporting.phone && (
                        <div className="flex items-center">
                          <Phone className="h-4 w-4 mr-2" />
                          {selectedInsurer.claims_reporting.phone}
                        </div>
                      )}
                      {selectedInsurer.claims_reporting.online_portal && (
                        <div className="flex items-center">
                          <Globe className="h-4 w-4 mr-2" />
                          <a href={selectedInsurer.claims_reporting.online_portal} target="_blank" rel="noopener noreferrer" className="text-blue-600 hover:text-blue-800">
                            Claims Portal
                          </a>
                        </div>
                      )}
                      {selectedInsurer.claims_reporting.procedure && (
                        <div className="mt-2">
                          <p className="font-medium">Procedure:</p>
                          <p className="mt-1">{selectedInsurer.claims_reporting.procedure}</p>
                        </div>
                      )}
                    </div>
                  </div>
                )}
                
                {selectedInsurer.coverage_types && selectedInsurer.coverage_types.length > 0 && (
                  <div>
                    <h4 className="font-medium text-gray-900">Coverage Types</h4>
                    <div className="mt-2 flex flex-wrap gap-1">
                      {selectedInsurer.coverage_types.map((type) => (
                        <span key={type} className="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-blue-100 text-blue-800">
                          {type}
                        </span>
                      ))}
                    </div>
                  </div>
                )}
                
                {selectedInsurer.notes && (
                  <div>
                    <h4 className="font-medium text-gray-900">Notes</h4>
                    <p className="mt-2 text-sm text-gray-600">{selectedInsurer.notes}</p>
                  </div>
                )}
              </div>
              
              <div className="mt-6 flex justify-end space-x-3">
                <button
                  onClick={() => {
                    setSelectedInsurer(null)
                    handleEdit(selectedInsurer)
                  }}
                  className="px-4 py-2 border border-gray-300 rounded-md shadow-sm text-sm font-medium text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                  Edit
                </button>
                <button
                  onClick={() => setSelectedInsurer(null)}
                  className="px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500"
                >
                  Close
                </button>
              </div>
            </div>
          </div>
        </div>
      )}

      {/* Import/Export Modal */}
      {showImportExport && (
        <div className="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
          <div className="relative top-20 mx-auto p-5 border w-11/12 max-w-4xl shadow-lg rounded-md bg-white">
            <div className="mt-3">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-medium text-gray-900">Import/Export Insurers</h3>
                <button
                  onClick={() => setShowImportExport(false)}
                  className="text-gray-400 hover:text-gray-600"
                >
                  Ã—
                </button>
              </div>
              
              <FileImportExport
                onImport={handleImportInsurers}
                onExport={handleExportInsurers}
                exportHeaders={insurerCSVHeaders}
                exportFilename="insurers"
                importTemplate={sampleInsurerData}
                templateFilename="insurers"
                title="Insurer Data Management"
                description="Import insurers from CSV or Excel files, or export current insurer data for backup or analysis."
              />
            </div>
          </div>
        </div>
      )}
    </div>
  )
}

export default Insurers\n
claimguru/src/pages/Integrations.tsx
import React, { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { Input } from '../components/ui/Input'
import { IntegrationSetupModal } from '../components/integrations/IntegrationSetupModal'
import { useToast } from '../hooks/useToast'
import { useAuth } from '../contexts/AuthContext'
import { supabase } from '../lib/supabase'
import {
  Settings,
  Plus,
  Check,
  X,
  Eye,
  EyeOff,
  RefreshCw,
  Activity,
  AlertTriangle,
  ExternalLink,
  Key,
  Shield,
  Zap,
  Mail,
  MessageSquare,
  Calendar as CalendarIcon,
  CreditCard,
  Brain,
  Video,
  HardDrive,
  FileText,
  Calculator
} from 'lucide-react'

interface IntegrationProvider {
  id: string
  name: string
  category: string
  description: string
  website_url?: string
  documentation_url?: string
  logo_url?: string
  is_active: boolean
  is_core_service?: boolean
  required_credentials: Record<string, boolean>
  supported_features: Record<string, boolean>
  pricing_info: Record<string, any>
  setup_instructions?: string
  credential_fields?: Record<string, any>
  setup_steps?: string[]
  help_url?: string
}

interface OrganizationIntegration {
  id: string
  provider_id: string
  is_enabled: boolean
  configuration: Record<string, any>
  sync_status: string
  error_message?: string
  last_sync_at?: string
  usage_stats: Record<string, any>
  provider: IntegrationProvider
}

export function Integrations() {
  const { userProfile } = useAuth()
  const { success, error } = useToast()
  const [providers, setProviders] = useState<IntegrationProvider[]>([])
  const [integrations, setIntegrations] = useState<OrganizationIntegration[]>([])
  const [loading, setLoading] = useState(true)
  const [selectedCategory, setSelectedCategory] = useState<string>('all')
  const [showCredentials, setShowCredentials] = useState<Record<string, boolean>>({})
  const [configureIntegration, setConfigureIntegration] = useState<IntegrationProvider | null>(null)
  const [credentials, setCredentials] = useState<Record<string, string>>({})

  useEffect(() => {
    if (userProfile?.organization_id) {
      loadIntegrations()
    }
  }, [userProfile?.organization_id])

  async function loadIntegrations() {
    if (!userProfile?.organization_id) return

    try {
      setLoading(true)

      // Load all available providers (excluding core services)
      const { data: providersData, error: providersError } = await supabase
        .from('integration_providers')
        .select('*')
        .eq('is_active', true)
        .eq('is_core_service', false)  // Filter out core platform services
        .order('category', { ascending: true })

      if (providersError) throw providersError

      // Load organization's configured integrations
      const { data: integrationsData, error: integrationsError } = await supabase
        .from('organization_integrations')
        .select(`
          *,
          provider:integration_providers(*)
        `)
        .eq('organization_id', userProfile.organization_id)

      if (integrationsError) throw integrationsError

      setProviders(providersData || [])
      setIntegrations(integrationsData || [])
    } catch (error: any) {
      console.error('Error loading integrations:', error)
      error('Failed to load integrations', error.message)
    } finally {
      setLoading(false)
    }
  }

  async function toggleIntegration(providerId: string, enabled: boolean) {
    if (!userProfile?.organization_id) return

    try {
      if (enabled) {
        // Check if provider requires setup
        const provider = providers.find(p => p.id === providerId)
        if (provider && provider.credential_fields && Object.keys(provider.credential_fields).length > 0) {
          // Open setup modal instead of directly enabling
          setConfigureIntegration(provider)
          return
        }

        // Enable integration - create/update record
        const { error } = await supabase
          .from('organization_integrations')
          .upsert({
            organization_id: userProfile.organization_id,
            provider_id: providerId,
            is_enabled: true,
            configuration: {},
            sync_status: 'disconnected'
          })

        if (error) throw error
        success('Integration enabled', 'You can now configure the connection.')
      } else {
        // Disable integration
        const { error } = await supabase
          .from('organization_integrations')
          .update({ is_enabled: false, sync_status: 'disconnected' })
          .eq('organization_id', userProfile.organization_id)
          .eq('provider_id', providerId)

        if (error) throw error
        success('Integration disabled')
      }

      await loadIntegrations()
    } catch (error: any) {
      console.error('Error toggling integration:', error)
      error('Failed to update integration', error.message)
    }
  }

  async function saveCredentials(providerId: string, credentials: Record<string, string> = {}) {
    if (!userProfile?.organization_id) return

    try {
      // First enable the integration
      const { error: upsertError } = await supabase
        .from('organization_integrations')
        .upsert({
          organization_id: userProfile.organization_id,
          provider_id: providerId,
          is_enabled: true,
          credentials_encrypted: JSON.stringify(credentials),
          sync_status: 'connected',
          configuration: credentials
        })

      if (upsertError) throw upsertError

      success('Integration connected', 'Your credentials have been saved and the integration is now active.')
      setConfigureIntegration(null)
      await loadIntegrations()
    } catch (error: any) {
      console.error('Error saving credentials:', error)
      error('Failed to save credentials', error.message)
    }
  }

  function getCategoryIcon(category: string) {
    const icons = {
      email: Mail,
      sms: MessageSquare,
      calendar: CalendarIcon,
      payment: CreditCard,
      ai: Brain,
      video: Video,
      storage: HardDrive,
      documents: FileText,
      accounting: Calculator
    }
    const IconComponent = icons[category as keyof typeof icons] || Settings
    return <IconComponent className="h-5 w-5" />
  }

  function getStatusColor(status: string): string {
    const colors = {
      connected: 'text-green-600 bg-green-100',
      disconnected: 'text-gray-600 bg-gray-100',
      error: 'text-red-600 bg-red-100',
      syncing: 'text-blue-600 bg-blue-100'
    }
    return colors[status as keyof typeof colors] || 'text-gray-600 bg-gray-100'
  }

  function getStatusIcon(status: string) {
    switch (status) {
      case 'connected':
        return <Check className="h-4 w-4" />
      case 'error':
        return <AlertTriangle className="h-4 w-4" />
      case 'syncing':
        return <RefreshCw className="h-4 w-4 animate-spin" />
      default:
        return <X className="h-4 w-4" />
    }
  }

  // Only show user-configurable integrations (not core services)
  const userConfigurableProviders = providers.filter(p => !p.is_core_service)
  const categories = ['all', ...Array.from(new Set(userConfigurableProviders.map(p => p.category)))]
  const filteredProviders = selectedCategory === 'all' 
    ? userConfigurableProviders 
    : userConfigurableProviders.filter(p => p.category === selectedCategory)

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <LoadingSpinner />
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Third-Party Integrations</h1>
          <p className="text-gray-600">Connect external services to enhance your workflow</p>
        </div>
        <div className="flex gap-2 mt-4 sm:mt-0">
          <Button variant="outline" className="flex items-center gap-2">
            <Activity className="h-4 w-4" />
            View Logs
          </Button>
          <Button variant="outline" className="flex items-center gap-2">
            <Key className="h-4 w-4" />
            API Keys
          </Button>
        </div>
      </div>

      {/* Category Filter */}
      <div className="flex flex-wrap gap-2">
        {categories.map((category) => (
          <Button
            key={category}
            variant={selectedCategory === category ? "primary" : "outline"}
            size="sm"
            onClick={() => setSelectedCategory(category)}
            className="capitalize"
          >
            {category === 'all' ? 'All Categories' : category}
          </Button>
        ))}
      </div>

      {/* Integration Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {filteredProviders.map((provider) => {
          const integration = integrations.find(i => i.provider_id === provider.id)
          const isEnabled = integration?.is_enabled || false
          const status = integration?.sync_status || 'disconnected'

          return (
            <Card key={provider.id} className="relative hover:shadow-lg transition-shadow">
              <CardHeader className="pb-4">
                <div className="flex items-start justify-between">
                  <div className="flex items-center gap-3">
                    <div className={`p-2 rounded-lg ${isEnabled ? 'bg-blue-100' : 'bg-gray-100'}`}>
                      {getCategoryIcon(provider.category)}
                    </div>
                    <div>
                      <CardTitle className="text-lg">{provider.name}</CardTitle>
                      <p className="text-sm text-gray-500 capitalize">{provider.category}</p>
                    </div>
                  </div>
                  
                  {/* Status Badge */}
                  <div className={`px-2 py-1 rounded-full text-xs font-medium flex items-center gap-1 ${getStatusColor(status)}`}>
                    {getStatusIcon(status)}
                    {status}
                  </div>
                </div>
              </CardHeader>

              <CardContent>
                <p className="text-sm text-gray-600 mb-4">{provider.description}</p>

                {/* Features */}
                <div className="mb-4">
                  <h4 className="text-sm font-medium mb-2">Features:</h4>
                  <div className="flex flex-wrap gap-1">
                    {Object.entries(provider.supported_features).slice(0, 3).map(([feature, supported]) => (
                      supported && (
                        <span key={feature} className="px-2 py-1 bg-gray-100 text-xs rounded">
                          {feature.replace(/_/g, ' ')}
                        </span>
                      )
                    ))}
                  </div>
                </div>

                {/* Action Buttons */}
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <label className="relative inline-flex items-center cursor-pointer">
                      <input
                        type="checkbox"
                        checked={isEnabled}
                        onChange={(e) => toggleIntegration(provider.id, e.target.checked)}
                        className="sr-only peer"
                      />
                      <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                    <span className="text-sm">
                      {isEnabled ? 'Enabled' : 'Disabled'}
                    </span>
                  </div>

                  <div className="flex gap-2">
                    {provider.documentation_url && (
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => window.open(provider.documentation_url, '_blank')}
                      >
                        <ExternalLink className="h-4 w-4" />
                      </Button>
                    )}
                    
                    {isEnabled && (
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setConfigureIntegration(provider)}
                      >
                        <Settings className="h-4 w-4" />
                      </Button>
                    )}
                  </div>
                </div>

                {/* Error Message */}
                {integration?.error_message && (
                  <div className="mt-3 p-2 bg-red-50 border border-red-200 rounded text-sm text-red-600">
                    {integration.error_message}
                  </div>
                )}

                {/* Last Sync */}
                {integration?.last_sync_at && (
                  <div className="mt-2 text-xs text-gray-500">
                    Last synced: {new Date(integration.last_sync_at).toLocaleString()}
                  </div>
                )}
              </CardContent>
            </Card>
          )
        })}
      </div>

      {/* Integration Setup Modal */}
      <IntegrationSetupModal
        provider={configureIntegration}
        isOpen={!!configureIntegration}
        onClose={() => setConfigureIntegration(null)}
        onSave={async (providerId, credentials) => {
          await saveCredentials(providerId, credentials)
        }}
      />

      {/* Integration Setup Instructions */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Shield className="h-5 w-5" />
            Integration Setup Guide
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <h4 className="font-medium mb-2">Getting Started</h4>
              <ol className="text-sm text-gray-600 space-y-2">
                <li>1. Select the integration you want to enable</li>
                <li>2. Toggle the switch to enable the integration</li>
                <li>3. Click the settings icon to configure credentials</li>
                <li>4. Follow the provider's documentation for API setup</li>
                <li>5. Test the connection and start using the features</li>
              </ol>
            </div>
            
            <div>
              <h4 className="font-medium mb-2">Security Notes</h4>
              <ul className="text-sm text-gray-600 space-y-2">
                <li>â€¢ All credentials are encrypted before storage</li>
                <li>â€¢ API keys are never logged or displayed</li>
                <li>â€¢ Integrations can be disabled at any time</li>
                <li>â€¢ Regular security audits are performed</li>
                <li>â€¢ Follow provider best practices for API security</li>
              </ul>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}

export default Integrations\n
claimguru/src/pages/Invoicing.tsx
import React, { useState } from 'react'
import { Card } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { 
  Plus, 
  Search, 
  Filter, 
  Download, 
  Eye, 
  Edit, 
  Trash2,
  Send,
  Receipt,
  DollarSign,
  Calendar,
  User
} from 'lucide-react'

interface Invoice {
  id: string
  invoice_number: string
  client_name: string
  amount: number
  status: 'draft' | 'sent' | 'paid' | 'overdue' | 'cancelled'
  issue_date: string
  due_date: string
  claim_number?: string
  description: string
}

const mockInvoices: Invoice[] = [
  {
    id: '1',
    invoice_number: 'INV-2025-001',
    client_name: 'John Smith',
    amount: 2500.00,
    status: 'sent',
    issue_date: '2025-01-01',
    due_date: '2025-01-31',
    claim_number: 'CLM-2025-001',
    description: 'Public Adjuster Services - Storm Damage Assessment'
  },
  {
    id: '2',
    invoice_number: 'INV-2025-002',
    client_name: 'ABC Corporation',
    amount: 5750.00,
    status: 'paid',
    issue_date: '2025-01-05',
    due_date: '2025-02-04',
    claim_number: 'CLM-2025-002',
    description: 'Property Damage Assessment and Documentation'
  }
]

export function Invoicing() {
  const [invoices] = useState<Invoice[]>(mockInvoices)
  const [searchTerm, setSearchTerm] = useState('')
  const [statusFilter, setStatusFilter] = useState<string>('all')

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'draft': return 'bg-gray-100 text-gray-800'
      case 'sent': return 'bg-blue-100 text-blue-800'
      case 'paid': return 'bg-green-100 text-green-800'
      case 'overdue': return 'bg-red-100 text-red-800'
      case 'cancelled': return 'bg-gray-100 text-gray-600'
      default: return 'bg-gray-100 text-gray-800'
    }
  }

  const filteredInvoices = invoices.filter(invoice => {
    const matchesSearch = invoice.invoice_number.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         invoice.client_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         invoice.claim_number?.toLowerCase().includes(searchTerm.toLowerCase())
    const matchesStatus = statusFilter === 'all' || invoice.status === statusFilter
    return matchesSearch && matchesStatus
  })

  const totalAmount = filteredInvoices.reduce((sum, invoice) => sum + invoice.amount, 0)
  const paidAmount = filteredInvoices.filter(inv => inv.status === 'paid').reduce((sum, invoice) => sum + invoice.amount, 0)
  const pendingAmount = totalAmount - paidAmount

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Invoicing</h1>
          <p className="text-gray-600">Manage client invoices and billing</p>
        </div>
        <Button className="flex items-center space-x-2">
          <Plus className="h-4 w-4" />
          <span>Create Invoice</span>
        </Button>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <Card className="p-6">
          <div className="flex items-center space-x-3">
            <div className="p-2 bg-blue-100 rounded-lg">
              <Receipt className="h-6 w-6 text-blue-600" />
            </div>
            <div>
              <p className="text-sm text-gray-600">Total Invoices</p>
              <p className="text-2xl font-bold text-gray-900">{filteredInvoices.length}</p>
            </div>
          </div>
        </Card>

        <Card className="p-6">
          <div className="flex items-center space-x-3">
            <div className="p-2 bg-green-100 rounded-lg">
              <DollarSign className="h-6 w-6 text-green-600" />
            </div>
            <div>
              <p className="text-sm text-gray-600">Total Amount</p>
              <p className="text-2xl font-bold text-gray-900">${totalAmount.toLocaleString()}</p>
            </div>
          </div>
        </Card>

        <Card className="p-6">
          <div className="flex items-center space-x-3">
            <div className="p-2 bg-green-100 rounded-lg">
              <DollarSign className="h-6 w-6 text-green-600" />
            </div>
            <div>
              <p className="text-sm text-gray-600">Paid Amount</p>
              <p className="text-2xl font-bold text-green-600">${paidAmount.toLocaleString()}</p>
            </div>
          </div>
        </Card>

        <Card className="p-6">
          <div className="flex items-center space-x-3">
            <div className="p-2 bg-orange-100 rounded-lg">
              <DollarSign className="h-6 w-6 text-orange-600" />
            </div>
            <div>
              <p className="text-sm text-gray-600">Pending Amount</p>
              <p className="text-2xl font-bold text-orange-600">${pendingAmount.toLocaleString()}</p>
            </div>
          </div>
        </Card>
      </div>

      {/* Filters */}
      <Card className="p-6">
        <div className="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
          <div className="flex-1">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
              <input
                type="text"
                placeholder="Search invoices..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
          </div>
          
          <div className="flex space-x-2">
            <select
              value={statusFilter}
              onChange={(e) => setStatusFilter(e.target.value)}
              className="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">All Status</option>
              <option value="draft">Draft</option>
              <option value="sent">Sent</option>
              <option value="paid">Paid</option>
              <option value="overdue">Overdue</option>
              <option value="cancelled">Cancelled</option>
            </select>
            
            <Button variant="outline">
              <Filter className="h-4 w-4 mr-2" />
              Filter
            </Button>
            
            <Button variant="outline">
              <Download className="h-4 w-4 mr-2" />
              Export
            </Button>
          </div>
        </div>
      </Card>

      {/* Invoices Table */}
      <Card>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Invoice
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Client
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Amount
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Status
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Issue Date
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Due Date
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {filteredInvoices.map((invoice) => (
                <tr key={invoice.id} className="hover:bg-gray-50">
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div>
                      <div className="text-sm font-medium text-gray-900">
                        {invoice.invoice_number}
                      </div>
                      {invoice.claim_number && (
                        <div className="text-sm text-gray-500">
                          {invoice.claim_number}
                        </div>
                      )}
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      <User className="h-4 w-4 text-gray-400 mr-2" />
                      <div className="text-sm text-gray-900">{invoice.client_name}</div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm font-medium text-gray-900">
                      ${invoice.amount.toLocaleString()}
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(invoice.status)}`}>
                      {invoice.status.charAt(0).toUpperCase() + invoice.status.slice(1)}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center text-sm text-gray-500">
                      <Calendar className="h-4 w-4 mr-1" />
                      {new Date(invoice.issue_date).toLocaleDateString()}
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center text-sm text-gray-500">
                      <Calendar className="h-4 w-4 mr-1" />
                      {new Date(invoice.due_date).toLocaleDateString()}
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div className="flex space-x-2">
                      <button className="text-blue-600 hover:text-blue-900">
                        <Eye className="h-4 w-4" />
                      </button>
                      <button className="text-green-600 hover:text-green-900">
                        <Send className="h-4 w-4" />
                      </button>
                      <button className="text-indigo-600 hover:text-indigo-900">
                        <Edit className="h-4 w-4" />
                      </button>
                      <button className="text-red-600 hover:text-red-900">
                        <Trash2 className="h-4 w-4" />
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Card>
    </div>
  )
}
\n
claimguru/src/pages/Notifications.tsx
import React, { useState, useEffect } from 'react'
import { Bell, Check, CheckCircle, Clock, AlertTriangle, Info, X, Eye, Trash2, Filter, Search, Mail, Phone, Calendar, FileText, DollarSign, Users } from 'lucide-react'
import { supabase, Notification } from '../lib/supabase'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'

interface NotificationsPageProps {}

const Notifications: React.FC<NotificationsPageProps> = () => {
  const [notifications, setNotifications] = useState<Notification[]>([])
  const [loading, setLoading] = useState(true)
  const [filter, setFilter] = useState<'all' | 'unread' | 'read'>('all')
  const [typeFilter, setTypeFilter] = useState<string>('all')
  const [searchTerm, setSearchTerm] = useState('')
  const [selectedNotifications, setSelectedNotifications] = useState<string[]>([])

  const notificationTypes = [
    { value: 'all', label: 'All Types', icon: Bell },
    { value: 'claim_update', label: 'Claim Updates', icon: FileText },
    { value: 'document_upload', label: 'Document Uploads', icon: FileText },
    { value: 'payment_received', label: 'Payments', icon: DollarSign },
    { value: 'deadline_reminder', label: 'Deadlines', icon: Clock },
    { value: 'vendor_assignment', label: 'Vendor Assignments', icon: Users },
    { value: 'communication', label: 'Communications', icon: Mail },
    { value: 'system_alert', label: 'System Alerts', icon: AlertTriangle },
    { value: 'appointment', label: 'Appointments', icon: Calendar }
  ]

  useEffect(() => {
    fetchNotifications()
  }, [])

  const fetchNotifications = async () => {
    try {
      setLoading(true)
      const { data, error } = await supabase
        .from('notifications')
        .select('*')
        .order('created_at', { ascending: false })
      
      if (error) throw error
      setNotifications(data || [])
    } catch (error) {
      console.error('Error fetching notifications:', error)
    } finally {
      setLoading(false)
    }
  }

  const markAsRead = async (notificationIds: string[]) => {
    try {
      const { error } = await supabase
        .from('notifications')
        .update({ is_read: true, read_at: new Date().toISOString() })
        .in('id', notificationIds)
      
      if (error) throw error
      
      setNotifications(prev => 
        prev.map(notification => 
          notificationIds.includes(notification.id)
            ? { ...notification, is_read: true, read_at: new Date().toISOString() }
            : notification
        )
      )
      setSelectedNotifications([])
    } catch (error) {
      console.error('Error marking notifications as read:', error)
    }
  }

  const markAsUnread = async (notificationIds: string[]) => {
    try {
      const { error } = await supabase
        .from('notifications')
        .update({ is_read: false, read_at: null })
        .in('id', notificationIds)
      
      if (error) throw error
      
      setNotifications(prev => 
        prev.map(notification => 
          notificationIds.includes(notification.id)
            ? { ...notification, is_read: false, read_at: null }
            : notification
        )
      )
      setSelectedNotifications([])
    } catch (error) {
      console.error('Error marking notifications as unread:', error)
    }
  }

  const deleteNotifications = async (notificationIds: string[]) => {
    if (!confirm(`Are you sure you want to delete ${notificationIds.length} notification(s)?`)) return
    
    try {
      const { error } = await supabase
        .from('notifications')
        .delete()
        .in('id', notificationIds)
      
      if (error) throw error
      
      setNotifications(prev => 
        prev.filter(notification => !notificationIds.includes(notification.id))
      )
      setSelectedNotifications([])
    } catch (error) {
      console.error('Error deleting notifications:', error)
    }
  }

  const markAllAsRead = async () => {
    const unreadNotifications = filteredNotifications.filter(n => !n.is_read)
    if (unreadNotifications.length > 0) {
      await markAsRead(unreadNotifications.map(n => n.id))
    }
  }

  const toggleSelectNotification = (notificationId: string) => {
    setSelectedNotifications(prev => 
      prev.includes(notificationId)
        ? prev.filter(id => id !== notificationId)
        : [...prev, notificationId]
    )
  }

  const selectAllFiltered = () => {
    const allFilteredIds = filteredNotifications.map(n => n.id)
    setSelectedNotifications(allFilteredIds)
  }

  const clearSelection = () => {
    setSelectedNotifications([])
  }

  const filteredNotifications = notifications.filter(notification => {
    const matchesReadFilter = filter === 'all' || 
      (filter === 'read' && notification.is_read) ||
      (filter === 'unread' && !notification.is_read)
    
    const matchesTypeFilter = typeFilter === 'all' || notification.type === typeFilter
    
    const matchesSearch = searchTerm === '' ||
      notification.title.toLowerCase().includes(searchTerm.toLowerCase()) ||
      notification.message.toLowerCase().includes(searchTerm.toLowerCase())
    
    return matchesReadFilter && matchesTypeFilter && matchesSearch
  })

  const getNotificationIcon = (type: string) => {
    const typeConfig = notificationTypes.find(t => t.value === type)
    return typeConfig ? typeConfig.icon : Info
  }

  const getNotificationColor = (type: string, priority?: string) => {
    if (priority === 'high') return 'text-red-600 bg-red-100'
    if (priority === 'medium') return 'text-orange-600 bg-orange-100'
    
    switch (type) {
      case 'claim_update': return 'text-blue-600 bg-blue-100'
      case 'document_upload': return 'text-green-600 bg-green-100'
      case 'payment_received': return 'text-purple-600 bg-purple-100'
      case 'deadline_reminder': return 'text-orange-600 bg-orange-100'
      case 'vendor_assignment': return 'text-indigo-600 bg-indigo-100'
      case 'communication': return 'text-teal-600 bg-teal-100'
      case 'system_alert': return 'text-red-600 bg-red-100'
      case 'appointment': return 'text-pink-600 bg-pink-100'
      default: return 'text-gray-600 bg-gray-100'
    }
  }

  const formatTimeAgo = (dateString: string) => {
    const date = new Date(dateString)
    const now = new Date()
    const diffInMinutes = Math.floor((now.getTime() - date.getTime()) / (1000 * 60))
    
    if (diffInMinutes < 1) return 'Just now'
    if (diffInMinutes < 60) return `${diffInMinutes}m ago`
    if (diffInMinutes < 1440) return `${Math.floor(diffInMinutes / 60)}h ago`
    if (diffInMinutes < 10080) return `${Math.floor(diffInMinutes / 1440)}d ago`
    return date.toLocaleDateString()
  }

  const unreadCount = notifications.filter(n => !n.is_read).length

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Notifications</h1>
          <p className="text-gray-600 mt-2">
            {unreadCount > 0 ? `${unreadCount} unread notification${unreadCount > 1 ? 's' : ''}` : 'All caught up!'}
          </p>
        </div>
        <div className="flex items-center gap-3">
          {selectedNotifications.length > 0 && (
            <div className="flex items-center gap-2">
              <span className="text-sm text-gray-600">
                {selectedNotifications.length} selected
              </span>
              <Button
                variant="outline"
                size="sm"
                onClick={() => markAsRead(selectedNotifications)}
                className="flex items-center gap-1"
              >
                <Check className="h-4 w-4" />
                Mark Read
              </Button>
              <Button
                variant="outline"
                size="sm"
                onClick={() => markAsUnread(selectedNotifications)}
                className="flex items-center gap-1"
              >
                <Bell className="h-4 w-4" />
                Mark Unread
              </Button>
              <Button
                variant="outline"
                size="sm"
                onClick={() => deleteNotifications(selectedNotifications)}
                className="flex items-center gap-1 text-red-600 hover:text-red-700"
              >
                <Trash2 className="h-4 w-4" />
                Delete
              </Button>
              <Button
                variant="outline"
                size="sm"
                onClick={clearSelection}
                className="flex items-center gap-1"
              >
                <X className="h-4 w-4" />
                Clear
              </Button>
            </div>
          )}
          {unreadCount > 0 && (
            <Button
              onClick={markAllAsRead}
              className="flex items-center gap-2"
            >
              <CheckCircle className="h-4 w-4" />
              Mark All Read
            </Button>
          )}
        </div>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Total</p>
                <p className="text-3xl font-bold text-gray-900">{notifications.length}</p>
              </div>
              <Bell className="h-8 w-8 text-blue-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Unread</p>
                <p className="text-3xl font-bold text-gray-900">{unreadCount}</p>
              </div>
              <AlertTriangle className="h-8 w-8 text-orange-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">High Priority</p>
                <p className="text-3xl font-bold text-gray-900">
                  {notifications.filter(n => n.priority === 'high').length}
                </p>
              </div>
              <AlertTriangle className="h-8 w-8 text-red-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Today</p>
                <p className="text-3xl font-bold text-gray-900">
                  {notifications.filter(n => 
                    new Date(n.created_at).toDateString() === new Date().toDateString()
                  ).length}
                </p>
              </div>
              <Clock className="h-8 w-8 text-green-600" />
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Filters and Search */}
      <div className="flex flex-col lg:flex-row gap-4">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4" />
          <input
            type="text"
            placeholder="Search notifications..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
        
        <div className="flex items-center gap-4">
          <div className="flex items-center gap-2">
            <Filter className="h-4 w-4 text-gray-400" />
            <select
              value={filter}
              onChange={(e) => setFilter(e.target.value as 'all' | 'unread' | 'read')}
              className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="all">All</option>
              <option value="unread">Unread</option>
              <option value="read">Read</option>
            </select>
          </div>
          
          <select
            value={typeFilter}
            onChange={(e) => setTypeFilter(e.target.value)}
            className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            {notificationTypes.map((type) => (
              <option key={type.value} value={type.value}>{type.label}</option>
            ))}
          </select>
          
          <Button
            variant="outline"
            onClick={selectAllFiltered}
            disabled={filteredNotifications.length === 0}
            className="flex items-center gap-2"
          >
            <CheckCircle className="h-4 w-4" />
            Select All
          </Button>
        </div>
      </div>

      {/* Notifications List */}
      {filteredNotifications.length === 0 ? (
        <Card>
          <CardContent className="p-12 text-center">
            <Bell className="h-16 w-16 text-gray-400 mx-auto mb-4" />
            <h3 className="text-xl font-semibold text-gray-900 mb-2">
              {notifications.length === 0 ? 'No notifications yet' : 'No matching notifications'}
            </h3>
            <p className="text-gray-600">
              {notifications.length === 0 
                ? 'New notifications will appear here'
                : 'Try adjusting your search or filter criteria'
              }
            </p>
          </CardContent>
        </Card>
      ) : (
        <div className="space-y-2">
          {filteredNotifications.map((notification) => {
            const Icon = getNotificationIcon(notification.type)
            const colorClass = getNotificationColor(notification.type, notification.priority)
            const isSelected = selectedNotifications.includes(notification.id)
            
            return (
              <div
                key={notification.id} 
                className="cursor-pointer"
                onClick={() => toggleSelectNotification(notification.id)}
              >
                <Card 
                  className={`hover:shadow-md transition-shadow ${
                    !notification.is_read ? 'bg-blue-50 border-blue-200' : ''
                  } ${isSelected ? 'ring-2 ring-blue-500' : ''}`}
                >
                <CardContent className="p-4">
                  <div className="flex items-start justify-between">
                    <div className="flex items-start space-x-4 flex-1">
                      <input
                        type="checkbox"
                        checked={isSelected}
                        onChange={() => toggleSelectNotification(notification.id)}
                        className="mt-1 rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                        onClick={(e) => e.stopPropagation()}
                      />
                      
                      <div className={`p-2 rounded-full ${colorClass} flex-shrink-0`}>
                        <Icon className="h-5 w-5" />
                      </div>
                      
                      <div className="flex-1 min-w-0">
                        <div className="flex items-center justify-between">
                          <h3 className={`text-sm font-medium ${
                            !notification.is_read ? 'text-gray-900' : 'text-gray-700'
                          }`}>
                            {notification.title}
                          </h3>
                          <div className="flex items-center space-x-2">
                            {notification.priority === 'high' && (
                              <span className="inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800">
                                High Priority
                              </span>
                            )}
                            {!notification.is_read && (
                              <div className="w-2 h-2 bg-blue-600 rounded-full"></div>
                            )}
                          </div>
                        </div>
                        
                        <p className={`text-sm mt-1 ${
                          !notification.is_read ? 'text-gray-700' : 'text-gray-500'
                        }`}>
                          {notification.message}
                        </p>
                        
                        <div className="flex items-center justify-between mt-2">
                          <span className="text-xs text-gray-500">
                            {formatTimeAgo(notification.created_at)}
                          </span>
                          
                          <div className="flex items-center space-x-2">
                            {notification.action_url && (
                              <Button
                                variant="outline"
                                size="sm"
                                onClick={(e) => {
                                  e.stopPropagation()
                                  window.open(notification.action_url, '_blank')
                                }}
                                className="flex items-center gap-1"
                              >
                                <Eye className="h-3 w-3" />
                                View
                              </Button>
                            )}
                            
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={(e) => {
                                e.stopPropagation()
                                notification.is_read 
                                  ? markAsUnread([notification.id])
                                  : markAsRead([notification.id])
                              }}
                              className="flex items-center gap-1"
                            >
                              {notification.is_read ? (
                                <><Bell className="h-3 w-3" /> Unread</>
                              ) : (
                                <><Check className="h-3 w-3" /> Read</>
                              )}
                            </Button>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </CardContent>
              </Card>
              </div>
            )
          })}
        </div>
      )}
    </div>
  )
}

export default Notifications\n
claimguru/src/pages/Payables.tsx
import React, { useState } from 'react'
import { Card } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { 
  Plus, 
  Search, 
  Filter, 
  Download, 
  Eye, 
  Edit, 
  Trash2,
  Check,
  CreditCard,
  DollarSign,
  Calendar,
  Building,
  AlertTriangle
} from 'lucide-react'

interface Payable {
  id: string
  vendor_name: string
  invoice_number: string
  amount: number
  status: 'pending' | 'approved' | 'paid' | 'overdue' | 'cancelled'
  issue_date: string
  due_date: string
  claim_number?: string
  description: string
  category: string
}

const mockPayables: Payable[] = [
  {
    id: '1',
    vendor_name: 'ABC Restoration Services',
    invoice_number: 'REST-2025-001',
    amount: 1250.00,
    status: 'pending',
    issue_date: '2025-01-01',
    due_date: '2025-01-31',
    claim_number: 'CLM-2025-001',
    description: 'Emergency water damage mitigation services',
    category: 'Restoration'
  },
  {
    id: '2',
    vendor_name: 'Expert Engineering Consultants',
    invoice_number: 'ENG-2025-002',
    amount: 3500.00,
    status: 'approved',
    issue_date: '2025-01-05',
    due_date: '2025-02-04',
    claim_number: 'CLM-2025-002',
    description: 'Structural engineering assessment report',
    category: 'Engineering'
  },
  {
    id: '3',
    vendor_name: 'Legal Associates LLC',
    invoice_number: 'LEG-2025-003',
    amount: 2800.00,
    status: 'overdue',
    issue_date: '2024-12-15',
    due_date: '2025-01-15',
    claim_number: 'CLM-2024-098',
    description: 'Legal consultation and document review',
    category: 'Legal'
  }
]

export function Payables() {
  const [payables] = useState<Payable[]>(mockPayables)
  const [searchTerm, setSearchTerm] = useState('')
  const [statusFilter, setStatusFilter] = useState<string>('all')

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'pending': return 'bg-yellow-100 text-yellow-800'
      case 'approved': return 'bg-blue-100 text-blue-800'
      case 'paid': return 'bg-green-100 text-green-800'
      case 'overdue': return 'bg-red-100 text-red-800'
      case 'cancelled': return 'bg-gray-100 text-gray-600'
      default: return 'bg-gray-100 text-gray-800'
    }
  }

  const filteredPayables = payables.filter(payable => {
    const matchesSearch = payable.vendor_name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         payable.invoice_number.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         payable.claim_number?.toLowerCase().includes(searchTerm.toLowerCase())
    const matchesStatus = statusFilter === 'all' || payable.status === statusFilter
    return matchesSearch && matchesStatus
  })

  const totalAmount = filteredPayables.reduce((sum, payable) => sum + payable.amount, 0)
  const paidAmount = filteredPayables.filter(pay => pay.status === 'paid').reduce((sum, payable) => sum + payable.amount, 0)
  const pendingAmount = filteredPayables.filter(pay => pay.status === 'pending').reduce((sum, payable) => sum + payable.amount, 0)
  const overdueAmount = filteredPayables.filter(pay => pay.status === 'overdue').reduce((sum, payable) => sum + payable.amount, 0)

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Accounts Payable</h1>
          <p className="text-gray-600">Manage vendor invoices and payments</p>
        </div>
        <Button className="flex items-center space-x-2">
          <Plus className="h-4 w-4" />
          <span>Add Payable</span>
        </Button>
      </div>

      {/* Stats Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <Card className="p-6">
          <div className="flex items-center space-x-3">
            <div className="p-2 bg-blue-100 rounded-lg">
              <CreditCard className="h-6 w-6 text-blue-600" />
            </div>
            <div>
              <p className="text-sm text-gray-600">Total Payables</p>
              <p className="text-2xl font-bold text-gray-900">${totalAmount.toLocaleString()}</p>
            </div>
          </div>
        </Card>

        <Card className="p-6">
          <div className="flex items-center space-x-3">
            <div className="p-2 bg-yellow-100 rounded-lg">
              <DollarSign className="h-6 w-6 text-yellow-600" />
            </div>
            <div>
              <p className="text-sm text-gray-600">Pending</p>
              <p className="text-2xl font-bold text-yellow-600">${pendingAmount.toLocaleString()}</p>
            </div>
          </div>
        </Card>

        <Card className="p-6">
          <div className="flex items-center space-x-3">
            <div className="p-2 bg-green-100 rounded-lg">
              <Check className="h-6 w-6 text-green-600" />
            </div>
            <div>
              <p className="text-sm text-gray-600">Paid</p>
              <p className="text-2xl font-bold text-green-600">${paidAmount.toLocaleString()}</p>
            </div>
          </div>
        </Card>

        <Card className="p-6">
          <div className="flex items-center space-x-3">
            <div className="p-2 bg-red-100 rounded-lg">
              <AlertTriangle className="h-6 w-6 text-red-600" />
            </div>
            <div>
              <p className="text-sm text-gray-600">Overdue</p>
              <p className="text-2xl font-bold text-red-600">${overdueAmount.toLocaleString()}</p>
            </div>
          </div>
        </Card>
      </div>

      {/* Filters */}
      <Card className="p-6">
        <div className="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4">
          <div className="flex-1">
            <div className="relative">
              <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
              <input
                type="text"
                placeholder="Search payables..."
                value={searchTerm}
                onChange={(e) => setSearchTerm(e.target.value)}
                className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              />
            </div>
          </div>
          
          <div className="flex space-x-2">
            <select
              value={statusFilter}
              onChange={(e) => setStatusFilter(e.target.value)}
              className="px-4 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            >
              <option value="all">All Status</option>
              <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="paid">Paid</option>
              <option value="overdue">Overdue</option>
              <option value="cancelled">Cancelled</option>
            </select>
            
            <Button variant="outline">
              <Filter className="h-4 w-4 mr-2" />
              Filter
            </Button>
            
            <Button variant="outline">
              <Download className="h-4 w-4 mr-2" />
              Export
            </Button>
          </div>
        </div>
      </Card>

      {/* Payables Table */}
      <Card>
        <div className="overflow-x-auto">
          <table className="w-full">
            <thead className="bg-gray-50">
              <tr>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Vendor
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Invoice
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Amount
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Status
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Category
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Due Date
                </th>
                <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                  Actions
                </th>
              </tr>
            </thead>
            <tbody className="bg-white divide-y divide-gray-200">
              {filteredPayables.map((payable) => (
                <tr key={payable.id} className="hover:bg-gray-50">
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center">
                      <Building className="h-4 w-4 text-gray-400 mr-2" />
                      <div>
                        <div className="text-sm font-medium text-gray-900">
                          {payable.vendor_name}
                        </div>
                        {payable.claim_number && (
                          <div className="text-sm text-gray-500">
                            {payable.claim_number}
                          </div>
                        )}
                      </div>
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm font-medium text-gray-900">
                      {payable.invoice_number}
                    </div>
                    <div className="text-sm text-gray-500">
                      {payable.description}
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm font-medium text-gray-900">
                      ${payable.amount.toLocaleString()}
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(payable.status)}`}>
                      {payable.status.charAt(0).toUpperCase() + payable.status.slice(1)}
                    </span>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="text-sm text-gray-900">{payable.category}</div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap">
                    <div className="flex items-center text-sm text-gray-500">
                      <Calendar className="h-4 w-4 mr-1" />
                      {new Date(payable.due_date).toLocaleDateString()}
                    </div>
                  </td>
                  <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                    <div className="flex space-x-2">
                      <button className="text-blue-600 hover:text-blue-900">
                        <Eye className="h-4 w-4" />
                      </button>
                      <button className="text-green-600 hover:text-green-900">
                        <Check className="h-4 w-4" />
                      </button>
                      <button className="text-indigo-600 hover:text-indigo-900">
                        <Edit className="h-4 w-4" />
                      </button>
                      <button className="text-red-600 hover:text-red-900">
                        <Trash2 className="h-4 w-4" />
                      </button>
                    </div>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </Card>
    </div>
  )
}
\n
claimguru/src/pages/Properties.tsx
import React, { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { 
  Home, MapPin, Calendar, Camera, Search, Filter, Plus, Eye, Edit,
  AlertTriangle, CheckCircle, Clock, DollarSign, Users, FileText,
  Star, Wrench, Building, Shield, Zap, TrendingUp
} from 'lucide-react'
import { useAuth } from '../contexts/AuthContext'
import { supabase } from '../lib/supabase'
import type { Property } from '../lib/supabase'

export function Properties() {
  const { userProfile } = useAuth()
  const [loading, setLoading] = useState(true)
  const [properties, setProperties] = useState<Property[]>([])
  const [searchTerm, setSearchTerm] = useState('')
  const [statusFilter, setStatusFilter] = useState('all')
  const [typeFilter, setTypeFilter] = useState('all')
  const [activeTab, setActiveTab] = useState<'all' | 'recent' | 'inspections' | 'high-value'>('all')

  useEffect(() => {
    if (userProfile?.organization_id) {
      loadProperties()
    }
  }, [userProfile?.organization_id])

  async function loadProperties() {
    if (!userProfile?.organization_id) return
    try {
      setLoading(true)
      const { data, error } = await supabase
        .from('properties')
        .select('*')
        .eq('organization_id', userProfile.organization_id)
        .order('created_at', { ascending: false })
      if (error) throw error
      setProperties(data || [])
    } catch (error) {
      console.error('Error loading properties:', error)
    } finally {
      setLoading(false)
    }
  }

  const filteredProperties = properties.filter(property => {
    const matchesSearch = 
      property.property_address?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      property.owner_name?.toLowerCase().includes(searchTerm.toLowerCase())
    
    const matchesStatus = statusFilter === 'all' || property.property_status === statusFilter
    const matchesType = typeFilter === 'all' || property.property_type === typeFilter
    
    let matchesTab = true
    switch (activeTab) {
      case 'recent':
        const weekAgo = new Date()
        weekAgo.setDate(weekAgo.getDate() - 7)
        matchesTab = new Date(property.created_at) >= weekAgo
        break
      case 'inspections':
        matchesTab = property.inspection_status === 'scheduled' || property.inspection_status === 'in_progress'
        break
      case 'high-value':
        matchesTab = (property.property_value || 0) > 500000
        break
    }
    
    return matchesSearch && matchesStatus && matchesType && matchesTab
  })

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'active': return CheckCircle
      case 'damaged': return AlertTriangle
      case 'under_repair': return Wrench
      case 'repaired': return CheckCircle
      default: return Clock
    }
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'active': case 'repaired': return 'text-green-600 bg-green-100'
      case 'damaged': return 'text-red-600 bg-red-100'
      case 'under_repair': return 'text-yellow-600 bg-yellow-100'
      default: return 'text-gray-600 bg-gray-100'
    }
  }

  const getPropertyIcon = (type: string) => {
    switch (type) {
      case 'residential': return Home
      case 'commercial': return Building
      case 'industrial': return Building
      default: return Home
    }
  }

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
    }).format(amount)
  }

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Property Management</h1>
          <p className="text-gray-600 mt-2">
            Manage property details, inspections, and damage assessments
          </p>
        </div>
        <div className="flex space-x-2">
          <Button variant="outline" className="flex items-center gap-2">
            <Camera className="h-4 w-4" />
            Photo Upload
          </Button>
          <Button variant="outline" className="flex items-center gap-2">
            <Calendar className="h-4 w-4" />
            Schedule Inspection
          </Button>
          <Button className="flex items-center gap-2">
            <Plus className="h-4 w-4" />
            Add Property
          </Button>
        </div>
      </div>

      {/* Statistics Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Total Properties</p>
                <p className="text-3xl font-bold text-gray-900">{properties.length}</p>
              </div>
              <Home className="h-8 w-8 text-blue-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Active Claims</p>
                <p className="text-3xl font-bold text-gray-900">
                  {properties.filter(p => p.property_status === 'damaged' || p.property_status === 'under_repair').length}
                </p>
              </div>
              <AlertTriangle className="h-8 w-8 text-orange-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Pending Inspections</p>
                <p className="text-3xl font-bold text-gray-900">
                  {properties.filter(p => p.inspection_status === 'scheduled').length}
                </p>
              </div>
              <Calendar className="h-8 w-8 text-purple-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Total Value</p>
                <p className="text-3xl font-bold text-gray-900">
                  {formatCurrency(properties.reduce((sum, p) => sum + (p.property_value || 0), 0))}
                </p>
              </div>
              <DollarSign className="h-8 w-8 text-green-600" />
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Tab Navigation */}
      <div className="border-b border-gray-200">
        <nav className="-mb-px flex space-x-8">
          {[
            { id: 'all', label: 'All Properties', icon: Home },
            { id: 'recent', label: 'Recent', icon: Clock },
            { id: 'inspections', label: 'Pending Inspections', icon: Calendar },
            { id: 'high-value', label: 'High Value', icon: Star }
          ].map((tab) => {
            const Icon = tab.icon
            return (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as any)}
                className={`flex items-center space-x-2 py-2 px-1 border-b-2 font-medium text-sm ${
                  activeTab === tab.id
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
              >
                <Icon className="h-4 w-4" />
                <span>{tab.label}</span>
              </button>
            )
          })}
        </nav>
      </div>

      {/* Search and Filters */}
      <div className="flex flex-col sm:flex-row gap-4">
        <div className="relative flex-1">
          <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4" />
          <input
            type="text"
            placeholder="Search properties by address or owner..."
            value={searchTerm}
            onChange={(e) => setSearchTerm(e.target.value)}
            className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          />
        </div>
        <div className="flex items-center gap-2">
          <Filter className="h-4 w-4 text-gray-400" />
          <select
            value={typeFilter}
            onChange={(e) => setTypeFilter(e.target.value)}
            className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="all">All Types</option>
            <option value="residential">Residential</option>
            <option value="commercial">Commercial</option>
            <option value="industrial">Industrial</option>
          </select>
          <select
            value={statusFilter}
            onChange={(e) => setStatusFilter(e.target.value)}
            className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
          >
            <option value="all">All Status</option>
            <option value="active">Active</option>
            <option value="damaged">Damaged</option>
            <option value="under_repair">Under Repair</option>
            <option value="repaired">Repaired</option>
          </select>
        </div>
      </div>

      {/* Properties Grid */}
      {filteredProperties.length === 0 ? (
        <Card>
          <CardContent className="p-12 text-center">
            <Home className="h-16 w-16 text-gray-400 mx-auto mb-4" />
            <h3 className="text-xl font-semibold text-gray-900 mb-2">
              {properties.length === 0 ? 'No properties yet' : 'No matching properties'}
            </h3>
            <p className="text-gray-600 mb-6">
              {properties.length === 0 
                ? 'Add your first property to get started'
                : 'Try adjusting your search or filter criteria'
              }
            </p>
            {properties.length === 0 && (
              <Button className="flex items-center gap-2">
                <Plus className="h-4 w-4" />
                Add First Property
              </Button>
            )}
          </CardContent>
        </Card>
      ) : (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          {filteredProperties.map((property) => {
            const PropertyIcon = getPropertyIcon(property.property_type)
            const StatusIcon = getStatusIcon(property.property_status)
            const statusColorClass = getStatusColor(property.property_status)
            
            return (
              <Card key={property.id} className="hover:shadow-lg transition-shadow">
                <CardContent className="p-6">
                  <div className="flex items-start justify-between mb-4">
                    <div className="flex items-center space-x-3">
                      <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <PropertyIcon className="h-6 w-6 text-blue-600" />
                      </div>
                      <div>
                        <h3 className="font-semibold text-gray-900">
                          {property.property_address}
                        </h3>
                        <p className="text-sm text-gray-500 capitalize">
                          {property.property_type}
                        </p>
                      </div>
                    </div>
                    <div className={`px-2 py-1 rounded-full text-xs font-medium ${statusColorClass}`}>
                      <StatusIcon className="h-3 w-3 inline mr-1" />
                      {property.property_status?.replace('_', ' ')}
                    </div>
                  </div>

                  {/* Property Details */}
                  <div className="space-y-2 mb-4">
                    {property.owner_name && (
                      <div className="flex items-center text-sm text-gray-600">
                        <Users className="h-4 w-4 mr-2" />
                        {property.owner_name}
                      </div>
                    )}
                    
                    {property.property_value && (
                      <div className="flex items-center text-sm text-gray-600">
                        <DollarSign className="h-4 w-4 mr-2" />
                        {formatCurrency(property.property_value)}
                      </div>
                    )}
                    
                    {property.year_built && (
                      <div className="flex items-center text-sm text-gray-600">
                        <Calendar className="h-4 w-4 mr-2" />
                        Built: {property.year_built}
                      </div>
                    )}
                    
                    {property.square_footage && (
                      <div className="flex items-center text-sm text-gray-600">
                        <Home className="h-4 w-4 mr-2" />
                        {property.square_footage.toLocaleString()} sq ft
                      </div>
                    )}
                  </div>

                  {/* Inspection Status */}
                  {property.inspection_status && (
                    <div className="bg-gray-50 rounded-lg p-3 mb-4">
                      <div className="flex items-center justify-between">
                        <span className="text-sm font-medium text-gray-700">
                          Inspection Status
                        </span>
                        <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                          property.inspection_status === 'completed' ? 'text-green-600 bg-green-100' :
                          property.inspection_status === 'scheduled' ? 'text-blue-600 bg-blue-100' :
                          property.inspection_status === 'in_progress' ? 'text-yellow-600 bg-yellow-100' :
                          'text-gray-600 bg-gray-100'
                        }`}>
                          {property.inspection_status.replace('_', ' ')}
                        </span>
                      </div>
                      {property.inspection_date && (
                        <p className="text-xs text-gray-500 mt-1">
                          Date: {new Date(property.inspection_date).toLocaleDateString()}
                        </p>
                      )}
                    </div>
                  )}

                  {/* Property Features */}
                  {property.features && property.features.length > 0 && (
                    <div className="mb-4">
                      <p className="text-xs text-gray-500 mb-2">Features:</p>
                      <div className="flex flex-wrap gap-1">
                        {property.features.slice(0, 3).map((feature, index) => (
                          <span 
                            key={index}
                            className="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs"
                          >
                            {feature}
                          </span>
                        ))}
                        {property.features.length > 3 && (
                          <span className="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs">
                            +{property.features.length - 3} more
                          </span>
                        )}
                      </div>
                    </div>
                  )}

                  {/* Actions */}
                  <div className="flex space-x-2">
                    <Button variant="outline" size="sm" className="flex-1 flex items-center gap-1">
                      <Eye className="h-4 w-4" />
                      View
                    </Button>
                    <Button variant="outline" size="sm" className="flex-1 flex items-center gap-1">
                      <Edit className="h-4 w-4" />
                      Edit
                    </Button>
                    <Button variant="outline" size="sm" className="flex-1 flex items-center gap-1">
                      <Camera className="h-4 w-4" />
                      Photos
                    </Button>
                  </div>
                </CardContent>
              </Card>
            )
          })}
        </div>
      )}

      {/* Quick Actions */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center space-x-2">
            <Zap className="h-5 w-5" />
            <span>Quick Actions</span>
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <Button variant="outline" className="flex items-center space-x-2 p-4 h-auto">
              <Camera className="h-6 w-6 text-blue-600" />
              <div className="text-left">
                <p className="font-medium">Upload Property Photos</p>
                <p className="text-sm text-gray-500">Add inspection or damage photos</p>
              </div>
            </Button>
            
            <Button variant="outline" className="flex items-center space-x-2 p-4 h-auto">
              <Calendar className="h-6 w-6 text-green-600" />
              <div className="text-left">
                <p className="font-medium">Schedule Inspection</p>
                <p className="text-sm text-gray-500">Book property inspection appointment</p>
              </div>
            </Button>
            
            <Button variant="outline" className="flex items-center space-x-2 p-4 h-auto">
              <FileText className="h-6 w-6 text-purple-600" />
              <div className="text-left">
                <p className="font-medium">Generate Report</p>
                <p className="text-sm text-gray-500">Create property assessment report</p>
              </div>
            </Button>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}\n
claimguru/src/pages/Settings.tsx
import React, { useState, useEffect } from 'react'
import { Save, User, Shield, Bell, Cog, CreditCard, Users, Database, Upload, Download, Key, Mail, Phone, Eye, EyeOff, Check, X, AlertTriangle, Zap, Brain, DollarSign, Calendar } from 'lucide-react'
import { supabase } from '../lib/supabase'
import { useAuth } from '../contexts/AuthContext'
import { useToastContext } from '../contexts/ToastContext'
import useNotifications from '../hooks/useNotifications'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'

interface SettingsPageProps {}

interface UserSettings {
  profile: {
    first_name: string
    last_name: string
    email: string
    phone: string
    title: string
    bio: string
    timezone: string
    date_format: string
    language: string
  }
  notifications: {
    email_notifications: boolean
    sms_notifications: boolean
    push_notifications: boolean
    claim_updates: boolean
    deadline_reminders: boolean
    payment_notifications: boolean
    vendor_updates: boolean
    system_alerts: boolean
    marketing_emails: boolean
  }
  security: {
    two_factor_enabled: boolean
    session_timeout: number
    password_requirements: string
    login_alerts: boolean
  }
  organization: {
    company_name: string
    license_number: string
    address: string
    city: string
    state: string
    zip_code: string
    website: string
    default_fee_percentage: number
    currency: string
    tax_rate: number
  }
  modules: {
    ai_insights: boolean
    document_analysis: boolean
    vendor_management: boolean
    communication_hub: boolean
    financial_tracking: boolean
    calendar_integration: boolean
    mobile_app: boolean
    api_access: boolean
  }
  integrations: {
    quickbooks: { enabled: boolean, api_key?: string }
    xactimate: { enabled: boolean, username?: string }
    hover: { enabled: boolean, api_key?: string }
    google_calendar: { enabled: boolean, calendar_id?: string }
    outlook: { enabled: boolean, client_id?: string }
    dropbox: { enabled: boolean, folder_path?: string }
    symbility: { enabled: boolean, api_key?: string }
  }
}

const Settings: React.FC<SettingsPageProps> = () => {
  const { user, userProfile } = useAuth()
  const showToast = useToastContext()
  const { createNotification } = useNotifications()
  const [activeTab, setActiveTab] = useState('profile')
  const [loading, setLoading] = useState(true)
  const [saving, setSaving] = useState(false)
  const [showPassword, setShowPassword] = useState(false)
  const [passwordStrength, setPasswordStrength] = useState(0)
  const [settings, setSettings] = useState<UserSettings>({
    profile: {
      first_name: userProfile?.first_name || '',
      last_name: userProfile?.last_name || '',
      email: user?.email || '',
      phone: userProfile?.phone || '',
      title: userProfile?.title || '',
      bio: userProfile?.bio || '',
      timezone: 'America/New_York',
      date_format: 'MM/DD/YYYY',
      language: 'en'
    },
    notifications: {
      email_notifications: true,
      sms_notifications: false,
      push_notifications: true,
      claim_updates: true,
      deadline_reminders: true,
      payment_notifications: true,
      vendor_updates: true,
      system_alerts: true,
      marketing_emails: false
    },
    security: {
      two_factor_enabled: false,
      session_timeout: 30,
      password_requirements: 'strong',
      login_alerts: true
    },
    organization: {
      company_name: '',
      license_number: '',
      address: '',
      city: '',
      state: '',
      zip_code: '',
      website: '',
      default_fee_percentage: 10,
      currency: 'USD',
      tax_rate: 0
    },
    modules: {
      ai_insights: true,
      document_analysis: true,
      vendor_management: true,
      communication_hub: true,
      financial_tracking: true,
      calendar_integration: false,
      mobile_app: true,
      api_access: false
    },
    integrations: {
      quickbooks: { enabled: false },
      xactimate: { enabled: false },
      hover: { enabled: false },
      google_calendar: { enabled: false },
      outlook: { enabled: false },
      dropbox: { enabled: false },
      symbility: { enabled: false }
    }
  })

  const tabs = [
    { id: 'profile', name: 'Profile', icon: User },
    { id: 'notifications', name: 'Notifications', icon: Bell },
    { id: 'security', name: 'Security', icon: Shield },
    { id: 'organization', name: 'Organization', icon: Users },
    { id: 'modules', name: 'Modules', icon: Zap },
    { id: 'integrations', name: 'Integrations', icon: Cog },
    { id: 'billing', name: 'Billing', icon: CreditCard },
    { id: 'data', name: 'Data & Import', icon: Database }
  ]

  const timezones = [
    'America/New_York',
    'America/Chicago',
    'America/Denver',
    'America/Los_Angeles',
    'America/Phoenix',
    'America/Anchorage',
    'Pacific/Honolulu'
  ]

  const languages = [
    { code: 'en', name: 'English' },
    { code: 'es', name: 'Spanish' },
    { code: 'fr', name: 'French' }
  ]

  const dateFormats = [
    'MM/DD/YYYY',
    'DD/MM/YYYY',
    'YYYY-MM-DD',
    'Month DD, YYYY'
  ]

  const updateSettings = (section: keyof UserSettings, field: string, value: any) => {
    setSettings(prev => ({
      ...prev,
      [section]: {
        ...prev[section],
        [field]: value
      }
    }))
  }

  const updateIntegration = (integration: string, field: string, value: any) => {
    setSettings(prev => ({
      ...prev,
      integrations: {
        ...prev.integrations,
        [integration]: {
          ...prev.integrations[integration as keyof typeof prev.integrations],
          [field]: value
        }
      }
    }))
  }

  // Load settings on component mount
  useEffect(() => {
    loadSettings()
  }, [user])

  const loadSettings = async () => {
    if (!user) return
    
    try {
      setLoading(true)
      
      // Load user profile and settings
      const { data: profile, error: profileError } = await supabase
        .from('user_profiles')
        .select('*')
        .eq('user_id', user.id)
        .single()
      
      if (profileError && profileError.code !== 'PGRST116') {
        throw profileError
      }
      
      if (profile) {
        // Merge loaded settings with defaults
        setSettings(prevSettings => ({
          profile: {
            ...prevSettings.profile,
            first_name: profile.first_name || prevSettings.profile.first_name,
            last_name: profile.last_name || prevSettings.profile.last_name,
            email: user.email || prevSettings.profile.email,
            phone: profile.phone || prevSettings.profile.phone,
            title: profile.title || prevSettings.profile.title,
            bio: profile.bio || prevSettings.profile.bio,
            timezone: profile.settings?.timezone || prevSettings.profile.timezone,
            date_format: profile.settings?.date_format || prevSettings.profile.date_format,
            language: profile.settings?.language || prevSettings.profile.language
          },
          notifications: {
            ...prevSettings.notifications,
            ...profile.settings?.notifications
          },
          security: {
            ...prevSettings.security,
            ...profile.settings?.security
          },
          organization: {
            ...prevSettings.organization,
            ...profile.settings?.organization
          },
          modules: {
            ...prevSettings.modules,
            ...profile.settings?.modules
          },
          integrations: {
            ...prevSettings.integrations,
            ...profile.settings?.integrations
          }
        }))
      }
    } catch (error) {
      console.error('Error loading settings:', error)
      showToast.error('Failed to Load Settings', 'Unable to load your settings. Using defaults.')
    } finally {
      setLoading(false)
    }
  }

  const downloadInvoice = () => {
    try {
      // Create a sample invoice (in real implementation, this would fetch from billing system)
      const invoiceData = {
        invoice_number: 'INV-2025-001',
        date: new Date().toISOString().split('T')[0],
        due_date: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
        customer: {
          name: `${settings.profile.first_name} ${settings.profile.last_name}`,
          email: settings.profile.email,
          company: settings.organization.company_name || 'N/A'
        },
        items: [
          {
            description: 'ClaimGuru Professional Plan',
            quantity: 1,
            unit_price: 349.00,
            total: 349.00
          }
        ],
        subtotal: 349.00,
        tax: 349.00 * (settings.organization.tax_rate / 100),
        total: 349.00 + (349.00 * (settings.organization.tax_rate / 100))
      }

      const invoiceContent = `
INVOICE

Invoice #: ${invoiceData.invoice_number}
Date: ${invoiceData.date}
Due Date: ${invoiceData.due_date}

Bill To:
${invoiceData.customer.name}
${invoiceData.customer.email}
${invoiceData.customer.company}

Item                              Qty    Price     Total
ClaimGuru Professional Plan        1     $349.00   $349.00

Subtotal: $${invoiceData.subtotal.toFixed(2)}
Tax: $${invoiceData.tax.toFixed(2)}
Total: $${invoiceData.total.toFixed(2)}

Thank you for your business!
      `

      const blob = new Blob([invoiceContent], { type: 'text/plain' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `claimguru-invoice-${invoiceData.invoice_number}.txt`
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)
      URL.revokeObjectURL(url)

      showToast.success('Invoice Downloaded', 'Your invoice has been downloaded successfully.')
    } catch (error) {
      console.error('Error downloading invoice:', error)
      showToast.error('Download Failed', 'Unable to download invoice. Please try again.')
    }
  }

  const handleCancelSubscription = () => {
    if (window.confirm('Are you sure you want to cancel your subscription? This action cannot be undone and you will lose access to ClaimGuru at the end of your current billing period.')) {
      showToast.warning('Subscription Cancellation', 'Please contact support to complete the cancellation process. We\'d love to hear your feedback!')
      
      // In a real implementation, this would call a cancellation API
      createNotification({
        organization_id: '00000000-0000-0000-0000-000000000000',
        type: 'warning',
        title: 'Subscription Cancellation Requested',
        message: 'User has requested to cancel their subscription. Support follow-up required.',
        user_id: user?.id || '00000000-0000-0000-0000-000000000000',
        priority: 'high',
        entity_type: 'billing',
        is_read: false
      })
    }
  }

  const testIntegration = async (integrationKey: string) => {
    const integration = settings.integrations[integrationKey as keyof typeof settings.integrations]
    
    if (!integration.enabled) {
      showToast.warning('Integration Disabled', 'Please enable the integration before testing.')
      return
    }

    try {
      setLoading(true)
      showToast.info('Testing Connection...', `Verifying ${integrationKey} integration`)

      // Simulate API testing based on integration type
      await new Promise(resolve => setTimeout(resolve, 2000)) // Simulate API call

      // In a real implementation, you would call actual APIs here
      const integrationNames: { [key: string]: string } = {
        quickbooks: 'QuickBooks',
        xactimate: 'Xactimate',
        hover: 'Hover',
        google_calendar: 'Google Calendar',
        outlook: 'Microsoft Outlook',
        dropbox: 'Dropbox',
        symbility: 'Symbility'
      }

      // For demo purposes, randomly succeed or fail
      const success = Math.random() > 0.3

      if (success) {
        showToast.success('Connection Successful!', `${integrationNames[integrationKey]} integration is working correctly.`)
        
        // Create notification about successful integration test
        await createNotification({
          organization_id: '00000000-0000-0000-0000-000000000000',
          type: 'success',
          title: 'Integration Test Successful',
          message: `${integrationNames[integrationKey]} connection test completed successfully.`,
          user_id: user?.id || '00000000-0000-0000-0000-000000000000',
          priority: 'low',
          entity_type: 'integration',
          is_read: false
        })
      } else {
        showToast.error('Connection Failed', `Unable to connect to ${integrationNames[integrationKey]}. Please check your credentials.`)
      }
    } catch (error: any) {
      console.error('Error testing integration:', error)
      showToast.error('Test Failed', 'An error occurred while testing the integration.')
    } finally {
      setLoading(false)
    }
  }

  const calculatePasswordStrength = (password: string) => {
    let strength = 0
    if (password.length >= 8) strength += 25
    if (/[a-z]/.test(password)) strength += 25
    if (/[A-Z]/.test(password)) strength += 25
    if (/[0-9]/.test(password)) strength += 25
    if (/[^A-Za-z0-9]/.test(password)) strength += 25
    return Math.min(strength, 100)
  }

  const saveSettings = async () => {
    if (!user) {
      showToast.error('Authentication Error', 'You must be logged in to save settings.')
      return
    }

    setSaving(true)
    try {
      showToast.info('Saving Settings...', 'Updating your preferences')

      // Check if profile exists
      const { data: existingProfile } = await supabase
        .from('user_profiles')
        .select('id')
        .eq('user_id', user.id)
        .single()

      const profileData = {
        user_id: user.id,
        first_name: settings.profile.first_name,
        last_name: settings.profile.last_name,
        phone: settings.profile.phone,
        title: settings.profile.title,
        bio: settings.profile.bio,
        settings: {
          notifications: settings.notifications,
          security: settings.security,
          organization: settings.organization,
          modules: settings.modules,
          integrations: settings.integrations,
          timezone: settings.profile.timezone,
          date_format: settings.profile.date_format,
          language: settings.profile.language
        },
        updated_at: new Date().toISOString()
      }

      let profileError
      if (existingProfile) {
        // Update existing profile
        const { error } = await supabase
          .from('user_profiles')
          .update(profileData)
          .eq('user_id', user.id)
        profileError = error
      } else {
        // Insert new profile
        const { error } = await supabase
          .from('user_profiles')
          .insert(profileData)
        profileError = error
      }

      if (profileError) throw profileError

      // Create notification about settings update
      await createNotification({
        organization_id: '00000000-0000-0000-0000-000000000000',
        type: 'info',
        title: 'Settings Updated',
        message: 'Your account settings have been successfully updated.',
        user_id: user.id,
        priority: 'low',
        entity_type: 'settings',
        is_read: false
      })

      showToast.success('Settings Saved!', 'Your preferences have been successfully updated.')
    } catch (error: any) {
      console.error('Error saving settings:', error)
      showToast.error('Failed to Save Settings', 
        error.message || 'An unexpected error occurred while saving your settings. Please try again.'
      )
    } finally {
      setSaving(false)
    }
  }

  const exportData = async () => {
    if (!user) {
      showToast.error('Authentication Error', 'You must be logged in to export data.')
      return
    }

    try {
      setLoading(true)
      showToast.info('Exporting Data...', 'Preparing your data for download')

      // Fetch all user data from multiple tables
      const [claimsResult, clientsResult, vendorsResult, insurersResult] = await Promise.all([
        supabase.from('claims').select('*').order('created_at'),
        supabase.from('clients').select('*').order('created_at'),
        supabase.from('vendors').select('*').order('created_at'),
        supabase.from('insurers').select('*').order('created_at')
      ])

      // Check for errors
      if (claimsResult.error) throw claimsResult.error
      if (clientsResult.error) throw clientsResult.error
      if (vendorsResult.error) throw vendorsResult.error
      if (insurersResult.error) throw insurersResult.error

      const exportData = {
        export_info: {
          exported_at: new Date().toISOString(),
          exported_by: user.email,
          version: '1.0',
          source: 'ClaimGuru'
        },
        claims: claimsResult.data || [],
        clients: clientsResult.data || [],
        vendors: vendorsResult.data || [],
        insurers: insurersResult.data || [],
        settings: settings,
        statistics: {
          total_claims: claimsResult.data?.length || 0,
          total_clients: clientsResult.data?.length || 0,
          total_vendors: vendorsResult.data?.length || 0,
          total_insurers: insurersResult.data?.length || 0
        }
      }
      
      // Create and download the file
      const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' })
      const url = URL.createObjectURL(blob)
      const a = document.createElement('a')
      a.href = url
      a.download = `claimguru-export-${new Date().toISOString().split('T')[0]}.json`
      document.body.appendChild(a)
      a.click()
      document.body.removeChild(a)
      URL.revokeObjectURL(url)
      
      // Create notification about successful export
      await createNotification({
        organization_id: '00000000-0000-0000-0000-000000000000',
        type: 'success',
        title: 'Data Export Complete',
        message: `Successfully exported ${exportData.statistics.total_claims} claims and ${exportData.statistics.total_clients} clients.`,
        user_id: user.id,
        priority: 'medium',
        entity_type: 'export',
        is_read: false
      })
      
      showToast.success('Data Exported Successfully!', 
        `Downloaded complete backup with ${exportData.statistics.total_claims} claims and ${exportData.statistics.total_clients} clients.`
      )
    } catch (error: any) {
      console.error('Error exporting data:', error)
      showToast.error('Export Failed', 
        error.message || 'An error occurred while exporting your data. Please try again.'
      )
    } finally {
      setLoading(false)
    }
  }

  const renderTabContent = () => {
    switch (activeTab) {
      case 'profile':
        return (
          <div className="space-y-6">
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Personal Information</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700">First Name</label>
                  <input
                    type="text"
                    value={settings.profile.first_name}
                    onChange={(e) => updateSettings('profile', 'first_name', e.target.value)}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Last Name</label>
                  <input
                    type="text"
                    value={settings.profile.last_name}
                    onChange={(e) => updateSettings('profile', 'last_name', e.target.value)}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Email</label>
                  <input
                    type="email"
                    value={settings.profile.email}
                    disabled
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm bg-gray-100 text-gray-500"
                  />
                  <p className="text-xs text-gray-500 mt-1">Email cannot be changed here. Contact support if needed.</p>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Phone</label>
                  <input
                    type="tel"
                    value={settings.profile.phone}
                    onChange={(e) => updateSettings('profile', 'phone', e.target.value)}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Job Title</label>
                  <input
                    type="text"
                    value={settings.profile.title}
                    onChange={(e) => updateSettings('profile', 'title', e.target.value)}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Timezone</label>
                  <select
                    value={settings.profile.timezone}
                    onChange={(e) => updateSettings('profile', 'timezone', e.target.value)}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  >
                    {timezones.map(tz => (
                      <option key={tz} value={tz}>{tz}</option>
                    ))}
                  </select>
                </div>
              </div>
              
              <div className="mt-4">
                <label className="block text-sm font-medium text-gray-700">Bio</label>
                <textarea
                  rows={3}
                  value={settings.profile.bio}
                  onChange={(e) => updateSettings('profile', 'bio', e.target.value)}
                  className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  placeholder="Tell us about yourself..."
                />
              </div>
            </div>
            
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Preferences</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700">Date Format</label>
                  <select
                    value={settings.profile.date_format}
                    onChange={(e) => updateSettings('profile', 'date_format', e.target.value)}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  >
                    {dateFormats.map(format => (
                      <option key={format} value={format}>{format}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Language</label>
                  <select
                    value={settings.profile.language}
                    onChange={(e) => updateSettings('profile', 'language', e.target.value)}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  >
                    {languages.map(lang => (
                      <option key={lang.code} value={lang.code}>{lang.name}</option>
                    ))}
                  </select>
                </div>
              </div>
            </div>
          </div>
        )

      case 'notifications':
        return (
          <div className="space-y-6">
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Notification Channels</h3>
              <div className="space-y-4">
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={settings.notifications.email_notifications}
                    onChange={(e) => updateSettings('notifications', 'email_notifications', e.target.checked)}
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span className="ml-2 text-sm text-gray-700">Email notifications</span>
                </label>
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={settings.notifications.sms_notifications}
                    onChange={(e) => updateSettings('notifications', 'sms_notifications', e.target.checked)}
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span className="ml-2 text-sm text-gray-700">SMS notifications</span>
                </label>
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={settings.notifications.push_notifications}
                    onChange={(e) => updateSettings('notifications', 'push_notifications', e.target.checked)}
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span className="ml-2 text-sm text-gray-700">Push notifications</span>
                </label>
              </div>
            </div>
            
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Notification Types</h3>
              <div className="space-y-4">
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={settings.notifications.claim_updates}
                    onChange={(e) => updateSettings('notifications', 'claim_updates', e.target.checked)}
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span className="ml-2 text-sm text-gray-700">Claim updates and status changes</span>
                </label>
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={settings.notifications.deadline_reminders}
                    onChange={(e) => updateSettings('notifications', 'deadline_reminders', e.target.checked)}
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span className="ml-2 text-sm text-gray-700">Deadline reminders</span>
                </label>
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={settings.notifications.payment_notifications}
                    onChange={(e) => updateSettings('notifications', 'payment_notifications', e.target.checked)}
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span className="ml-2 text-sm text-gray-700">Payment notifications</span>
                </label>
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={settings.notifications.vendor_updates}
                    onChange={(e) => updateSettings('notifications', 'vendor_updates', e.target.checked)}
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span className="ml-2 text-sm text-gray-700">Vendor assignments and updates</span>
                </label>
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={settings.notifications.system_alerts}
                    onChange={(e) => updateSettings('notifications', 'system_alerts', e.target.checked)}
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span className="ml-2 text-sm text-gray-700">System alerts and maintenance</span>
                </label>
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={settings.notifications.marketing_emails}
                    onChange={(e) => updateSettings('notifications', 'marketing_emails', e.target.checked)}
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span className="ml-2 text-sm text-gray-700">Marketing emails and updates</span>
                </label>
              </div>
            </div>
          </div>
        )

      case 'security':
        return (
          <div className="space-y-6">
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Authentication</h3>
              <div className="space-y-4">
                <div className="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                  <div>
                    <h4 className="text-sm font-medium text-gray-900">Two-Factor Authentication</h4>
                    <p className="text-sm text-gray-500">Add an extra layer of security to your account</p>
                  </div>
                  <Button
                    variant={settings.security.two_factor_enabled ? "outline" : "primary"}
                    onClick={() => updateSettings('security', 'two_factor_enabled', !settings.security.two_factor_enabled)}
                  >
                    {settings.security.two_factor_enabled ? 'Disable' : 'Enable'}
                  </Button>
                </div>
                
                <div>
                  <label className="block text-sm font-medium text-gray-700">Session Timeout (minutes)</label>
                  <input
                    type="number"
                    min="5"
                    max="480"
                    value={settings.security.session_timeout}
                    onChange={(e) => updateSettings('security', 'session_timeout', parseInt(e.target.value))}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                
                <label className="flex items-center">
                  <input
                    type="checkbox"
                    checked={settings.security.login_alerts}
                    onChange={(e) => updateSettings('security', 'login_alerts', e.target.checked)}
                    className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                  />
                  <span className="ml-2 text-sm text-gray-700">Receive alerts for new login attempts</span>
                </label>
              </div>
            </div>
            
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Password Requirements</h3>
              <div className="space-y-2">
                <label className="flex items-center">
                  <input
                    type="radio"
                    name="password_requirements"
                    value="basic"
                    checked={settings.security.password_requirements === 'basic'}
                    onChange={(e) => updateSettings('security', 'password_requirements', e.target.value)}
                    className="text-blue-600 focus:ring-blue-500"
                  />
                  <span className="ml-2 text-sm text-gray-700">Basic (8+ characters)</span>
                </label>
                <label className="flex items-center">
                  <input
                    type="radio"
                    name="password_requirements"
                    value="strong"
                    checked={settings.security.password_requirements === 'strong'}
                    onChange={(e) => updateSettings('security', 'password_requirements', e.target.value)}
                    className="text-blue-600 focus:ring-blue-500"
                  />
                  <span className="ml-2 text-sm text-gray-700">Strong (8+ characters, mixed case, numbers)</span>
                </label>
                <label className="flex items-center">
                  <input
                    type="radio"
                    name="password_requirements"
                    value="strict"
                    checked={settings.security.password_requirements === 'strict'}
                    onChange={(e) => updateSettings('security', 'password_requirements', e.target.value)}
                    className="text-blue-600 focus:ring-blue-500"
                  />
                  <span className="ml-2 text-sm text-gray-700">Strict (12+ characters, mixed case, numbers, symbols)</span>
                </label>
              </div>
            </div>
          </div>
        )

      case 'organization':
        return (
          <div className="space-y-6">
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Company Information</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700">Company Name</label>
                  <input
                    type="text"
                    value={settings.organization.company_name}
                    onChange={(e) => updateSettings('organization', 'company_name', e.target.value)}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">License Number</label>
                  <input
                    type="text"
                    value={settings.organization.license_number}
                    onChange={(e) => updateSettings('organization', 'license_number', e.target.value)}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                <div className="md:col-span-2">
                  <label className="block text-sm font-medium text-gray-700">Address</label>
                  <input
                    type="text"
                    value={settings.organization.address}
                    onChange={(e) => updateSettings('organization', 'address', e.target.value)}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">City</label>
                  <input
                    type="text"
                    value={settings.organization.city}
                    onChange={(e) => updateSettings('organization', 'city', e.target.value)}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">State</label>
                  <input
                    type="text"
                    value={settings.organization.state}
                    onChange={(e) => updateSettings('organization', 'state', e.target.value)}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">ZIP Code</label>
                  <input
                    type="text"
                    value={settings.organization.zip_code}
                    onChange={(e) => updateSettings('organization', 'zip_code', e.target.value)}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Website</label>
                  <input
                    type="url"
                    value={settings.organization.website}
                    onChange={(e) => updateSettings('organization', 'website', e.target.value)}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
              </div>
            </div>
            
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Business Settings</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                  <label className="block text-sm font-medium text-gray-700">Default Fee Percentage</label>
                  <input
                    type="number"
                    min="0"
                    max="100"
                    step="0.1"
                    value={settings.organization.default_fee_percentage}
                    onChange={(e) => updateSettings('organization', 'default_fee_percentage', parseFloat(e.target.value))}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Currency</label>
                  <select
                    value={settings.organization.currency}
                    onChange={(e) => updateSettings('organization', 'currency', e.target.value)}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="USD">USD - US Dollar</option>
                    <option value="CAD">CAD - Canadian Dollar</option>
                    <option value="EUR">EUR - Euro</option>
                    <option value="GBP">GBP - British Pound</option>
                  </select>
                </div>
                <div>
                  <label className="block text-sm font-medium text-gray-700">Tax Rate (%)</label>
                  <input
                    type="number"
                    min="0"
                    max="100"
                    step="0.01"
                    value={settings.organization.tax_rate}
                    onChange={(e) => updateSettings('organization', 'tax_rate', parseFloat(e.target.value))}
                    className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                  />
                </div>
              </div>
            </div>
          </div>
        )

      case 'modules':
        return (
          <div className="space-y-6">
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Available Modules</h3>
              <p className="text-sm text-gray-600 mb-6">Enable or disable specific features for your organization.</p>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                  <div className="flex items-center space-x-3">
                    <div className="p-2 bg-blue-100 rounded-lg">
                      <Brain className="h-5 w-5 text-blue-600" />
                    </div>
                    <div>
                      <h4 className="text-sm font-medium text-gray-900">AI Insights</h4>
                      <p className="text-sm text-gray-500">AI-powered claim analysis and predictions</p>
                    </div>
                  </div>
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={settings.modules.ai_insights}
                      onChange={(e) => updateSettings('modules', 'ai_insights', e.target.checked)}
                      className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                  </label>
                </div>
                
                <div className="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                  <div className="flex items-center space-x-3">
                    <div className="p-2 bg-green-100 rounded-lg">
                      <Upload className="h-5 w-5 text-green-600" />
                    </div>
                    <div>
                      <h4 className="text-sm font-medium text-gray-900">Document Analysis</h4>
                      <p className="text-sm text-gray-500">Automated document processing and analysis</p>
                    </div>
                  </div>
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={settings.modules.document_analysis}
                      onChange={(e) => updateSettings('modules', 'document_analysis', e.target.checked)}
                      className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                  </label>
                </div>
                
                <div className="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                  <div className="flex items-center space-x-3">
                    <div className="p-2 bg-purple-100 rounded-lg">
                      <Users className="h-5 w-5 text-purple-600" />
                    </div>
                    <div>
                      <h4 className="text-sm font-medium text-gray-900">Vendor Management</h4>
                      <p className="text-sm text-gray-500">Advanced vendor tracking and performance</p>
                    </div>
                  </div>
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={settings.modules.vendor_management}
                      onChange={(e) => updateSettings('modules', 'vendor_management', e.target.checked)}
                      className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                  </label>
                </div>
                
                <div className="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                  <div className="flex items-center space-x-3">
                    <div className="p-2 bg-teal-100 rounded-lg">
                      <Mail className="h-5 w-5 text-teal-600" />
                    </div>
                    <div>
                      <h4 className="text-sm font-medium text-gray-900">Communication Hub</h4>
                      <p className="text-sm text-gray-500">Centralized communication management</p>
                    </div>
                  </div>
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={settings.modules.communication_hub}
                      onChange={(e) => updateSettings('modules', 'communication_hub', e.target.checked)}
                      className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                  </label>
                </div>
                
                <div className="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                  <div className="flex items-center space-x-3">
                    <div className="p-2 bg-yellow-100 rounded-lg">
                      <DollarSign className="h-5 w-5 text-yellow-600" />
                    </div>
                    <div>
                      <h4 className="text-sm font-medium text-gray-900">Financial Tracking</h4>
                      <p className="text-sm text-gray-500">Advanced financial reporting and analytics</p>
                    </div>
                  </div>
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={settings.modules.financial_tracking}
                      onChange={(e) => updateSettings('modules', 'financial_tracking', e.target.checked)}
                      className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                  </label>
                </div>
                
                <div className="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                  <div className="flex items-center space-x-3">
                    <div className="p-2 bg-indigo-100 rounded-lg">
                      <Calendar className="h-5 w-5 text-indigo-600" />
                    </div>
                    <div>
                      <h4 className="text-sm font-medium text-gray-900">Calendar Integration</h4>
                      <p className="text-sm text-gray-500">Sync with external calendar systems</p>
                    </div>
                  </div>
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={settings.modules.calendar_integration}
                      onChange={(e) => updateSettings('modules', 'calendar_integration', e.target.checked)}
                      className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                  </label>
                </div>
                
                <div className="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                  <div className="flex items-center space-x-3">
                    <div className="p-2 bg-pink-100 rounded-lg">
                      <Phone className="h-5 w-5 text-pink-600" />
                    </div>
                    <div>
                      <h4 className="text-sm font-medium text-gray-900">Mobile App</h4>
                      <p className="text-sm text-gray-500">Progressive web app with offline capabilities</p>
                    </div>
                  </div>
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={settings.modules.mobile_app}
                      onChange={(e) => updateSettings('modules', 'mobile_app', e.target.checked)}
                      className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                  </label>
                </div>
                
                <div className="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                  <div className="flex items-center space-x-3">
                    <div className="p-2 bg-red-100 rounded-lg">
                      <Key className="h-5 w-5 text-red-600" />
                    </div>
                    <div>
                      <h4 className="text-sm font-medium text-gray-900">API Access</h4>
                      <p className="text-sm text-gray-500">Developer API for custom integrations</p>
                    </div>
                  </div>
                  <label className="flex items-center">
                    <input
                      type="checkbox"
                      checked={settings.modules.api_access}
                      onChange={(e) => updateSettings('modules', 'api_access', e.target.checked)}
                      className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                    />
                  </label>
                </div>
              </div>
            </div>
          </div>
        )

      case 'integrations':
        return (
          <div className="space-y-6">
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Third-Party Integrations</h3>
              <p className="text-sm text-gray-600 mb-6">Connect ClaimGuru with your existing tools and workflows.</p>
              
              <div className="space-y-4">
                {Object.entries(settings.integrations).map(([key, integration]) => {
                  const integrationNames: { [key: string]: string } = {
                    quickbooks: 'QuickBooks',
                    xactimate: 'Xactimate',
                    hover: 'Hover',
                    google_calendar: 'Google Calendar',
                    outlook: 'Microsoft Outlook',
                    dropbox: 'Dropbox',
                    symbility: 'Symbility'
                  }
                  
                  return (
                    <div key={key} className="border border-gray-200 rounded-lg p-4">
                      <div className="flex items-center justify-between mb-3">
                        <h4 className="text-sm font-medium text-gray-900">{integrationNames[key]}</h4>
                        <label className="flex items-center">
                          <input
                            type="checkbox"
                            checked={integration.enabled}
                            onChange={(e) => updateIntegration(key, 'enabled', e.target.checked)}
                            className="rounded border-gray-300 text-blue-600 focus:ring-blue-500"
                          />
                          <span className="ml-2 text-sm text-gray-700">Enable</span>
                        </label>
                      </div>
                      
                      {integration.enabled && (
                        <div className="space-y-3">
                          {(key === 'quickbooks' || key === 'hover' || key === 'symbility') && (
                            <div>
                              <label className="block text-sm font-medium text-gray-700">API Key</label>
                              <input
                                type="password"
                                value={(integration as any).api_key || ''}
                                onChange={(e) => updateIntegration(key, 'api_key', e.target.value)}
                                className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter API key..."
                              />
                            </div>
                          )}
                          
                          {key === 'xactimate' && (
                            <div>
                              <label className="block text-sm font-medium text-gray-700">Username</label>
                              <input
                                type="text"
                                value={(integration as any).username || ''}
                                onChange={(e) => updateIntegration(key, 'username', e.target.value)}
                                className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter username..."
                              />
                            </div>
                          )}
                          
                          {key === 'google_calendar' && (
                            <div>
                              <label className="block text-sm font-medium text-gray-700">Calendar ID</label>
                              <input
                                type="text"
                                value={(integration as any).calendar_id || ''}
                                onChange={(e) => updateIntegration(key, 'calendar_id', e.target.value)}
                                className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter calendar ID..."
                              />
                            </div>
                          )}
                          
                          {key === 'outlook' && (
                            <div>
                              <label className="block text-sm font-medium text-gray-700">Client ID</label>
                              <input
                                type="text"
                                value={(integration as any).client_id || ''}
                                onChange={(e) => updateIntegration(key, 'client_id', e.target.value)}
                                className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter client ID..."
                              />
                            </div>
                          )}
                          
                          {key === 'dropbox' && (
                            <div>
                              <label className="block text-sm font-medium text-gray-700">Folder Path</label>
                              <input
                                type="text"
                                value={(integration as any).folder_path || ''}
                                onChange={(e) => updateIntegration(key, 'folder_path', e.target.value)}
                                className="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500"
                                placeholder="/ClaimGuru"
                              />
                            </div>
                          )}
                          
                          <Button 
                            variant="outline" 
                            size="sm"
                            onClick={() => testIntegration(key)}
                            disabled={loading}
                          >
                            {loading ? <LoadingSpinner size="sm" /> : 'Test Connection'}
                          </Button>
                        </div>
                      )}
                    </div>
                  )
                })}
              </div>
            </div>
          </div>
        )

      case 'billing':
        return (
          <div className="space-y-6">
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Subscription</h3>
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <h4 className="text-lg font-medium text-blue-900">Professional Plan</h4>
                    <p className="text-blue-700">$349/month â€¢ 5 users included</p>
                    <p className="text-sm text-blue-600 mt-1">Next billing date: March 15, 2025</p>
                  </div>
                  <div className="text-right">
                    <span className="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800">
                      Active
                    </span>
                  </div>
                </div>
              </div>
            </div>
            
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Usage</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="bg-gray-50 p-4 rounded-lg">
                  <p className="text-sm font-medium text-gray-600">Active Users</p>
                  <p className="text-2xl font-bold text-gray-900">3 / 5</p>
                  <div className="mt-2 bg-gray-200 rounded-full h-2">
                    <div className="bg-blue-600 h-2 rounded-full" style={{ width: '60%' }}></div>
                  </div>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg">
                  <p className="text-sm font-medium text-gray-600">Storage Used</p>
                  <p className="text-2xl font-bold text-gray-900">45 GB / 100 GB</p>
                  <div className="mt-2 bg-gray-200 rounded-full h-2">
                    <div className="bg-green-600 h-2 rounded-full" style={{ width: '45%' }}></div>
                  </div>
                </div>
                <div className="bg-gray-50 p-4 rounded-lg">
                  <p className="text-sm font-medium text-gray-600">API Calls</p>
                  <p className="text-2xl font-bold text-gray-900">12,450 / 50,000</p>
                  <div className="mt-2 bg-gray-200 rounded-full h-2">
                    <div className="bg-yellow-600 h-2 rounded-full" style={{ width: '25%' }}></div>
                  </div>
                </div>
              </div>
            </div>
            
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Payment Method</h3>
              <div className="bg-white border border-gray-200 rounded-lg p-4">
                <div className="flex items-center justify-between">
                  <div className="flex items-center space-x-3">
                    <div className="w-8 h-6 bg-blue-600 rounded flex items-center justify-center">
                      <CreditCard className="h-4 w-4 text-white" />
                    </div>
                    <div>
                      <p className="text-sm font-medium text-gray-900">â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ â€¢â€¢â€¢â€¢ 4242</p>
                      <p className="text-sm text-gray-500">Expires 12/26</p>
                    </div>
                  </div>
                  <Button variant="outline" size="sm">Update</Button>
                </div>
              </div>
            </div>
            
            <div className="flex space-x-4">
              <Button 
                variant="outline"
                onClick={() => showToast.info('Feature Coming Soon', 'Plan changes will be available in the next update.')}
              >
                Change Plan
              </Button>
              <Button 
                variant="outline"
                onClick={() => downloadInvoice()}
              >
                Download Invoice
              </Button>
              <Button 
                variant="outline" 
                className="text-red-600 hover:text-red-700"
                onClick={() => handleCancelSubscription()}
              >
                Cancel Subscription
              </Button>
            </div>
          </div>
        )

      case 'data':
        return (
          <div className="space-y-6">
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Data Export</h3>
              <p className="text-sm text-gray-600 mb-4">Export your data for backup or migration purposes.</p>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="border border-gray-200 rounded-lg p-4">
                  <h4 className="text-sm font-medium text-gray-900 mb-2">Complete Data Export</h4>
                  <p className="text-sm text-gray-500 mb-4">Export all your claims, clients, documents, and settings.</p>
                  <Button
                    onClick={exportData}
                    disabled={loading}
                    className="flex items-center gap-2"
                  >
                    {loading ? <LoadingSpinner size="sm" /> : <Download className="h-4 w-4" />}
                    Export All Data
                  </Button>
                </div>
                
                <div className="border border-gray-200 rounded-lg p-4">
                  <h4 className="text-sm font-medium text-gray-900 mb-2">Claims Export</h4>
                  <p className="text-sm text-gray-500 mb-4">Export only claims data in CSV format.</p>
                  <Button variant="outline" className="flex items-center gap-2">
                    <Download className="h-4 w-4" />
                    Export Claims
                  </Button>
                </div>
              </div>
            </div>
            
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Data Import</h3>
              <p className="text-sm text-gray-600 mb-4">Import data from other systems or restore from backup.</p>
              
              <div className="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center">
                <Upload className="h-12 w-12 text-gray-400 mx-auto mb-4" />
                <h4 className="text-sm font-medium text-gray-900 mb-2">Import Data File</h4>
                <p className="text-sm text-gray-500 mb-4">Supports CSV, JSON, and Excel files</p>
                <Button variant="outline" className="flex items-center gap-2">
                  <Upload className="h-4 w-4" />
                  Choose File
                </Button>
              </div>
              
              <div className="mt-4 text-sm text-gray-500">
                <p><strong>Supported formats:</strong></p>
                <ul className="list-disc list-inside mt-2 space-y-1">
                  <li>Claims data: CSV, Excel (.xlsx)</li>
                  <li>Client data: CSV, Excel (.xlsx)</li>
                  <li>Complete backup: JSON</li>
                </ul>
              </div>
            </div>
            
            <div>
              <h3 className="text-lg font-medium text-gray-900 mb-4">Data Migration</h3>
              <p className="text-sm text-gray-600 mb-4">Migrate from other claim management systems.</p>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div className="border border-gray-200 rounded-lg p-4 text-center">
                  <h4 className="text-sm font-medium text-gray-900 mb-2">ClaimWizard</h4>
                  <p className="text-sm text-gray-500 mb-4">Direct migration available</p>
                  <Button variant="outline" size="sm">Migrate</Button>
                </div>
                
                <div className="border border-gray-200 rounded-lg p-4 text-center">
                  <h4 className="text-sm font-medium text-gray-900 mb-2">Xactimate</h4>
                  <p className="text-sm text-gray-500 mb-4">Import estimates and data</p>
                  <Button variant="outline" size="sm">Import</Button>
                </div>
                
                <div className="border border-gray-200 rounded-lg p-4 text-center">
                  <h4 className="text-sm font-medium text-gray-900 mb-2">Custom</h4>
                  <p className="text-sm text-gray-500 mb-4">Contact support for help</p>
                  <Button variant="outline" size="sm">Contact</Button>
                </div>
              </div>
            </div>
          </div>
        )

      default:
        return null
    }
  }

  if (loading) {
    return (
      <div className="p-6">
        <div className="flex items-center justify-center h-64">
          <div className="text-center">
            <LoadingSpinner size="lg" />
            <p className="mt-4 text-gray-600">Loading your settings...</p>
          </div>
        </div>
      </div>
    )
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Settings</h1>
          <p className="text-gray-600 mt-2">
            Manage your account, organization, and system preferences
          </p>
        </div>
        <Button
          onClick={saveSettings}
          disabled={saving}
          className="flex items-center gap-2"
        >
          {saving ? <LoadingSpinner size="sm" /> : <Save className="h-4 w-4" />}
          {saving ? 'Saving...' : 'Save Changes'}
        </Button>
      </div>

      <div className="flex flex-col lg:flex-row gap-6">
        {/* Sidebar */}
        <div className="lg:w-64">
          <nav className="space-y-1">
            {tabs.map((tab) => {
              const Icon = tab.icon
              return (
                <button
                  key={tab.id}
                  onClick={() => setActiveTab(tab.id)}
                  className={`w-full flex items-center px-3 py-2 text-sm font-medium rounded-md transition-colors ${
                    activeTab === tab.id
                      ? 'bg-blue-100 text-blue-700'
                      : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'
                  }`}
                >
                  <Icon className="mr-3 h-5 w-5" />
                  {tab.name}
                </button>
              )
            })}
          </nav>
        </div>

        {/* Content */}
        <div className="flex-1">
          <Card>
            <CardContent className="p-6">
              {renderTabContent()}
            </CardContent>
          </Card>
        </div>
      </div>
    </div>
  )
}

export default Settings\n
claimguru/src/pages/Settlements.tsx
import React, { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { 
  DollarSign, TrendingUp, Clock, CheckCircle, AlertTriangle, Search, Filter,
  Plus, Eye, Edit, FileText, Calculator, Award, Target, Users, Calendar,
  BarChart3, PieChart, ArrowUpRight, ArrowDownRight, Handshake, Gavel
} from 'lucide-react'
import { useAuth } from '../contexts/AuthContext'
import { supabase } from '../lib/supabase'
import type { Settlement } from '../lib/supabase'

export function Settlements() {
  const { userProfile } = useAuth()
  const [loading, setLoading] = useState(true)
  const [settlements, setSettlements] = useState<Settlement[]>([])
  const [searchTerm, setSearchTerm] = useState('')
  const [statusFilter, setStatusFilter] = useState('all')
  const [typeFilter, setTypeFilter] = useState('all')
  const [activeTab, setActiveTab] = useState<'overview' | 'settlements' | 'negotiations' | 'analytics'>('overview')

  useEffect(() => {
    if (userProfile?.organization_id) {
      loadSettlements()
    }
  }, [userProfile?.organization_id])

  async function loadSettlements() {
    if (!userProfile?.organization_id) return
    try {
      setLoading(true)
      const { data, error } = await supabase
        .from('settlements')
        .select('*')
        .eq('organization_id', userProfile.organization_id)
        .order('created_at', { ascending: false })
      if (error) throw error
      setSettlements(data || [])
    } catch (error) {
      console.error('Error loading settlements:', error)
    } finally {
      setLoading(false)
    }
  }

  const filteredSettlements = settlements.filter(settlement => {
    const matchesSearch = 
      settlement.settlement_type?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      settlement.notes?.toLowerCase().includes(searchTerm.toLowerCase())
    
    const matchesStatus = statusFilter === 'all' || settlement.settlement_status === statusFilter
    const matchesType = typeFilter === 'all' || settlement.settlement_type === typeFilter
    
    return matchesSearch && matchesStatus && matchesType
  })

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'finalized': case 'paid': return CheckCircle
      case 'negotiating': return Handshake
      case 'pending_approval': return Clock
      case 'disputed': return AlertTriangle
      case 'rejected': return AlertTriangle
      default: return Clock
    }
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'finalized': case 'paid': return 'text-green-600 bg-green-100'
      case 'negotiating': return 'text-blue-600 bg-blue-100'
      case 'pending_approval': return 'text-yellow-600 bg-yellow-100'
      case 'disputed': case 'rejected': return 'text-red-600 bg-red-100'
      default: return 'text-gray-600 bg-gray-100'
    }
  }

  const formatCurrency = (amount: number) => {
    return new Intl.NumberFormat('en-US', {
      style: 'currency',
      currency: 'USD',
      minimumFractionDigits: 0,
    }).format(amount)
  }

  // Calculate settlement metrics
  const totalSettlements = settlements.length
  const totalSettlementAmount = settlements
    .filter(s => s.settlement_status === 'finalized' || s.settlement_status === 'paid')
    .reduce((sum, s) => sum + (s.settlement_amount || 0), 0)
  const pendingSettlements = settlements.filter(s => 
    s.settlement_status === 'negotiating' || s.settlement_status === 'pending_approval'
  )
  const pendingAmount = pendingSettlements.reduce((sum, s) => sum + (s.settlement_amount || 0), 0)
  const averageSettlement = totalSettlements > 0 ? totalSettlementAmount / totalSettlements : 0

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Settlement Management</h1>
          <p className="text-gray-600 mt-2">
            Track negotiations, manage settlements, and analyze payment outcomes
          </p>
        </div>
        <div className="flex space-x-2">
          <Button variant="outline" className="flex items-center gap-2">
            <Calculator className="h-4 w-4" />
            Calculate Settlement
          </Button>
          <Button variant="outline" className="flex items-center gap-2">
            <FileText className="h-4 w-4" />
            Generate Report
          </Button>
          <Button className="flex items-center gap-2">
            <Plus className="h-4 w-4" />
            New Settlement
          </Button>
        </div>
      </div>

      {/* Overview Statistics */}
      {activeTab === 'overview' && (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-gray-600">Total Settlements</p>
                  <p className="text-3xl font-bold text-gray-900">{totalSettlements}</p>
                  <p className="text-xs text-gray-500 mt-1">
                    {settlements.filter(s => s.settlement_status === 'finalized').length} finalized
                  </p>
                </div>
                <Handshake className="h-8 w-8 text-blue-600" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-gray-600">Total Value</p>
                  <p className="text-3xl font-bold text-gray-900">
                    {formatCurrency(totalSettlementAmount)}
                  </p>
                  <p className="text-xs text-gray-500 mt-1">
                    Completed settlements
                  </p>
                </div>
                <DollarSign className="h-8 w-8 text-green-600" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-gray-600">Pending Value</p>
                  <p className="text-3xl font-bold text-gray-900">
                    {formatCurrency(pendingAmount)}
                  </p>
                  <p className="text-xs text-gray-500 mt-1">
                    {pendingSettlements.length} in progress
                  </p>
                </div>
                <Clock className="h-8 w-8 text-yellow-600" />
              </div>
            </CardContent>
          </Card>

          <Card>
            <CardContent className="p-6">
              <div className="flex items-center justify-between">
                <div>
                  <p className="text-sm font-medium text-gray-600">Average Settlement</p>
                  <p className="text-3xl font-bold text-gray-900">
                    {formatCurrency(averageSettlement)}
                  </p>
                  <p className="text-xs text-gray-500 mt-1">
                    Per case average
                  </p>
                </div>
                <Target className="h-8 w-8 text-purple-600" />
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Tab Navigation */}
      <div className="border-b border-gray-200">
        <nav className="-mb-px flex space-x-8">
          {[
            { id: 'overview', label: 'Overview', icon: BarChart3 },
            { id: 'settlements', label: 'Settlements', icon: DollarSign },
            { id: 'negotiations', label: 'Active Negotiations', icon: Handshake },
            { id: 'analytics', label: 'Analytics', icon: TrendingUp }
          ].map((tab) => {
            const Icon = tab.icon
            return (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as any)}
                className={`flex items-center space-x-2 py-2 px-1 border-b-2 font-medium text-sm ${
                  activeTab === tab.id
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
              >
                <Icon className="h-4 w-4" />
                <span>{tab.label}</span>
              </button>
            )
          })}
        </nav>
      </div>

      {/* Search and Filters */}
      {(activeTab === 'settlements' || activeTab === 'negotiations') && (
        <div className="flex flex-col sm:flex-row gap-4">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4" />
            <input
              type="text"
              placeholder="Search settlements..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
          <div className="flex items-center gap-2">
            <Filter className="h-4 w-4 text-gray-400" />
            <select
              value={statusFilter}
              onChange={(e) => setStatusFilter(e.target.value)}
              className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="all">All Status</option>
              <option value="negotiating">Negotiating</option>
              <option value="pending_approval">Pending Approval</option>
              <option value="finalized">Finalized</option>
              <option value="paid">Paid</option>
              <option value="disputed">Disputed</option>
            </select>
            <select
              value={typeFilter}
              onChange={(e) => setTypeFilter(e.target.value)}
              className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="all">All Types</option>
              <option value="property_damage">Property Damage</option>
              <option value="business_interruption">Business Interruption</option>
              <option value="additional_living_expenses">Additional Living Expenses</option>
              <option value="contents">Contents</option>
            </select>
          </div>
        </div>
      )}

      {/* Settlements List */}
      {(activeTab === 'settlements' || activeTab === 'negotiations') && (
        <>
          {filteredSettlements.length === 0 ? (
            <Card>
              <CardContent className="p-12 text-center">
                <DollarSign className="h-16 w-16 text-gray-400 mx-auto mb-4" />
                <h3 className="text-xl font-semibold text-gray-900 mb-2">
                  {settlements.length === 0 ? 'No settlements yet' : 'No matching settlements'}
                </h3>
                <p className="text-gray-600 mb-6">
                  {settlements.length === 0 
                    ? 'Start your first settlement negotiation'
                    : 'Try adjusting your search or filter criteria'
                  }
                </p>
                {settlements.length === 0 && (
                  <Button className="flex items-center gap-2">
                    <Plus className="h-4 w-4" />
                    Create First Settlement
                  </Button>
                )}
              </CardContent>
            </Card>
          ) : (
            <div className="space-y-4">
              {filteredSettlements.map((settlement) => {
                const StatusIcon = getStatusIcon(settlement.settlement_status)
                const statusColorClass = getStatusColor(settlement.settlement_status)
                
                return (
                  <Card key={settlement.id} className="hover:shadow-md transition-shadow">
                    <CardContent className="p-6">
                      <div className="flex items-start justify-between">
                        <div className="flex items-start space-x-4 flex-1">
                          <div className="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                            <DollarSign className="h-6 w-6 text-green-600" />
                          </div>
                          
                          <div className="flex-1">
                            <div className="flex items-center space-x-3 mb-2">
                              <h3 className="font-semibold text-gray-900">
                                {settlement.settlement_type?.replace('_', ' ').split(' ').map(word => 
                                  word.charAt(0).toUpperCase() + word.slice(1)
                                ).join(' ')} Settlement
                              </h3>
                              <span className={`px-3 py-1 rounded-full text-xs font-medium ${statusColorClass}`}>
                                <StatusIcon className="h-3 w-3 inline mr-1" />
                                {settlement.settlement_status?.replace('_', ' ')}
                              </span>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-3">
                              <div>
                                <p className="text-sm text-gray-500">Settlement Amount</p>
                                <p className="font-semibold text-lg text-green-600">
                                  {formatCurrency(settlement.settlement_amount || 0)}
                                </p>
                              </div>
                              
                              {settlement.initial_demand && (
                                <div>
                                  <p className="text-sm text-gray-500">Initial Demand</p>
                                  <p className="font-medium text-gray-900">
                                    {formatCurrency(settlement.initial_demand)}
                                  </p>
                                </div>
                              )}
                              
                              {settlement.settlement_date && (
                                <div>
                                  <p className="text-sm text-gray-500">Settlement Date</p>
                                  <p className="font-medium text-gray-900">
                                    {new Date(settlement.settlement_date).toLocaleDateString()}
                                  </p>
                                </div>
                              )}
                            </div>
                            
                            {settlement.notes && (
                              <p className="text-gray-600 text-sm mb-3 line-clamp-2">
                                {settlement.notes}
                              </p>
                            )}
                            
                            <div className="flex items-center space-x-4 text-xs text-gray-500">
                              <span className="flex items-center">
                                <Calendar className="h-3 w-3 mr-1" />
                                Created {new Date(settlement.created_at).toLocaleDateString()}
                              </span>
                              
                              {settlement.negotiation_rounds && (
                                <span className="flex items-center">
                                  <Handshake className="h-3 w-3 mr-1" />
                                  {settlement.negotiation_rounds} rounds
                                </span>
                              )}
                            </div>
                          </div>
                        </div>
                        
                        <div className="flex items-center space-x-2">
                          <Button variant="outline" size="sm" className="flex items-center gap-1">
                            <Eye className="h-3 w-3" />
                            View
                          </Button>
                          <Button variant="outline" size="sm" className="flex items-center gap-1">
                            <Edit className="h-3 w-3" />
                            Edit
                          </Button>
                          {settlement.settlement_status === 'negotiating' && (
                            <Button size="sm" className="flex items-center gap-1">
                              <Handshake className="h-3 w-3" />
                              Negotiate
                            </Button>
                          )}
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                )
              })}
            </div>
          )}
        </>
      )}

      {/* Overview Dashboard */}
      {activeTab === 'overview' && (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
          {/* Recent Settlements */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center space-x-2">
                <Clock className="h-5 w-5" />
                <span>Recent Settlements</span>
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {settlements.slice(0, 5).map((settlement) => {
                  const StatusIcon = getStatusIcon(settlement.settlement_status)
                  const statusColorClass = getStatusColor(settlement.settlement_status)
                  
                  return (
                    <div key={settlement.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                          <DollarSign className="h-4 w-4 text-green-600" />
                        </div>
                        <div>
                          <p className="font-medium text-gray-900">
                            {settlement.settlement_type?.replace('_', ' ')} Settlement
                          </p>
                          <p className="text-sm text-gray-500">
                            {new Date(settlement.created_at).toLocaleDateString()}
                          </p>
                        </div>
                      </div>
                      <div className="text-right">
                        <p className="font-semibold text-green-600">
                          {formatCurrency(settlement.settlement_amount || 0)}
                        </p>
                        <span className={`px-2 py-1 rounded-full text-xs font-medium ${statusColorClass}`}>
                          {settlement.settlement_status?.replace('_', ' ')}
                        </span>
                      </div>
                    </div>
                  )
                })}
              </div>
            </CardContent>
          </Card>

          {/* Settlement Breakdown */}
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center space-x-2">
                <PieChart className="h-5 w-5" />
                <span>Settlement Breakdown</span>
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                {[
                  { type: 'Property Damage', amount: settlements.filter(s => s.settlement_type === 'property_damage').reduce((sum, s) => sum + (s.settlement_amount || 0), 0), color: 'bg-blue-100 text-blue-600' },
                  { type: 'Business Interruption', amount: settlements.filter(s => s.settlement_type === 'business_interruption').reduce((sum, s) => sum + (s.settlement_amount || 0), 0), color: 'bg-green-100 text-green-600' },
                  { type: 'Additional Living', amount: settlements.filter(s => s.settlement_type === 'additional_living_expenses').reduce((sum, s) => sum + (s.settlement_amount || 0), 0), color: 'bg-yellow-100 text-yellow-600' },
                  { type: 'Contents', amount: settlements.filter(s => s.settlement_type === 'contents').reduce((sum, s) => sum + (s.settlement_amount || 0), 0), color: 'bg-purple-100 text-purple-600' }
                ].map((item, index) => (
                  <div key={index} className="flex items-center justify-between p-3 border border-gray-200 rounded-lg">
                    <div className="flex items-center space-x-3">
                      <div className={`w-4 h-4 rounded-full ${item.color.split(' ')[0]}`}></div>
                      <span className="font-medium text-gray-900">{item.type}</span>
                    </div>
                    <div className="text-right">
                      <p className="font-semibold text-gray-900">{formatCurrency(item.amount)}</p>
                      <p className="text-xs text-gray-500">
                        {totalSettlementAmount > 0 ? ((item.amount / totalSettlementAmount) * 100).toFixed(1) : 0}%
                      </p>
                    </div>
                  </div>
                ))}
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Analytics Dashboard */}
      {activeTab === 'analytics' && (
        <div className="space-y-6">
          <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
            <Card>
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600">Success Rate</p>
                    <p className="text-3xl font-bold text-gray-900">
                      {totalSettlements > 0 ? ((settlements.filter(s => s.settlement_status === 'finalized' || s.settlement_status === 'paid').length / totalSettlements) * 100).toFixed(1) : 0}%
                    </p>
                  </div>
                  <TrendingUp className="h-8 w-8 text-green-600" />
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600">Avg. Negotiation Time</p>
                    <p className="text-3xl font-bold text-gray-900">24</p>
                    <p className="text-xs text-gray-500">days</p>
                  </div>
                  <Clock className="h-8 w-8 text-blue-600" />
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardContent className="p-6">
                <div className="flex items-center justify-between">
                  <div>
                    <p className="text-sm font-medium text-gray-600">Recovery Rate</p>
                    <p className="text-3xl font-bold text-gray-900">87%</p>
                    <p className="text-xs text-gray-500">of initial demand</p>
                  </div>
                  <Award className="h-8 w-8 text-purple-600" />
                </div>
              </CardContent>
            </Card>
          </div>

          <Card>
            <CardHeader>
              <CardTitle>Settlement Performance Insights</CardTitle>
            </CardHeader>
            <CardContent>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div className="p-4 border border-gray-200 rounded-lg">
                  <h3 className="font-semibold text-gray-900 mb-2">Top Performing Categories</h3>
                  <div className="space-y-2">
                    <div className="flex justify-between">
                      <span className="text-sm text-gray-600">Property Damage</span>
                      <span className="text-sm font-medium">92% success</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm text-gray-600">Business Interruption</span>
                      <span className="text-sm font-medium">85% success</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm text-gray-600">Contents</span>
                      <span className="text-sm font-medium">78% success</span>
                    </div>
                  </div>
                </div>

                <div className="p-4 border border-gray-200 rounded-lg">
                  <h3 className="font-semibold text-gray-900 mb-2">Settlement Trends</h3>
                  <div className="space-y-2">
                    <div className="flex items-center justify-between">
                      <span className="text-sm text-gray-600">This Month</span>
                      <div className="flex items-center text-green-600">
                        <ArrowUpRight className="h-4 w-4 mr-1" />
                        <span className="text-sm font-medium">+15%</span>
                      </div>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm text-gray-600">Avg. Settlement</span>
                      <div className="flex items-center text-green-600">
                        <ArrowUpRight className="h-4 w-4 mr-1" />
                        <span className="text-sm font-medium">+8%</span>
                      </div>
                    </div>
                    <div className="flex items-center justify-between">
                      <span className="text-sm text-gray-600">Resolution Time</span>
                      <div className="flex items-center text-red-600">
                        <ArrowDownRight className="h-4 w-4 mr-1" />
                        <span className="text-sm font-medium">-12%</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      )}
    </div>
  )
}\n
claimguru/src/pages/Tasks.tsx
import React, { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { 
  CheckSquare, Clock, AlertCircle, Users, Calendar, Search, Filter, Plus,
  Play, Pause, Square, MoreVertical, Flag, User, ArrowRight, Target,
  TrendingUp, CheckCircle, XCircle, Timer, Zap, FileText
} from 'lucide-react'
import { useAuth } from '../contexts/AuthContext'
import { supabase } from '../lib/supabase'
import type { Task } from '../lib/supabase'

export function Tasks() {
  const { userProfile } = useAuth()
  const [loading, setLoading] = useState(true)
  const [tasks, setTasks] = useState<Task[]>([])
  const [searchTerm, setSearchTerm] = useState('')
  const [statusFilter, setStatusFilter] = useState('all')
  const [priorityFilter, setPriorityFilter] = useState('all')
  const [assigneeFilter, setAssigneeFilter] = useState('all')
  const [activeTab, setActiveTab] = useState<'my-tasks' | 'all-tasks' | 'workflows' | 'templates'>('my-tasks')

  useEffect(() => {
    if (userProfile?.organization_id) {
      loadTasks()
    }
  }, [userProfile?.organization_id])

  async function loadTasks() {
    if (!userProfile?.organization_id) return
    try {
      setLoading(true)
      const { data, error } = await supabase
        .from('tasks')
        .select('*')
        .eq('organization_id', userProfile.organization_id)
        .order('created_at', { ascending: false })
      if (error) throw error
      setTasks(data || [])
    } catch (error) {
      console.error('Error loading tasks:', error)
    } finally {
      setLoading(false)
    }
  }

  const filteredTasks = tasks.filter(task => {
    const matchesSearch = 
      task.task_title.toLowerCase().includes(searchTerm.toLowerCase()) ||
      task.description?.toLowerCase().includes(searchTerm.toLowerCase())
    
    const matchesStatus = statusFilter === 'all' || task.status === statusFilter
    const matchesPriority = priorityFilter === 'all' || task.priority === priorityFilter
    const matchesAssignee = assigneeFilter === 'all' || task.assigned_to === assigneeFilter
    
    let matchesTab = true
    if (activeTab === 'my-tasks') {
      matchesTab = task.assigned_to === userProfile?.id
    }
    
    return matchesSearch && matchesStatus && matchesPriority && matchesAssignee && matchesTab
  })

  const getStatusIcon = (status: string) => {
    switch (status) {
      case 'completed': return CheckCircle
      case 'in_progress': return Play
      case 'pending': return Clock
      case 'cancelled': return XCircle
      default: return Clock
    }
  }

  const getStatusColor = (status: string) => {
    switch (status) {
      case 'completed': return 'text-green-600 bg-green-100'
      case 'in_progress': return 'text-blue-600 bg-blue-100'
      case 'pending': return 'text-yellow-600 bg-yellow-100'
      case 'cancelled': return 'text-red-600 bg-red-100'
      default: return 'text-gray-600 bg-gray-100'
    }
  }

  const getPriorityIcon = (priority: string) => {
    switch (priority) {
      case 'high': return AlertCircle
      case 'medium': return Flag
      case 'low': return Clock
      default: return Clock
    }
  }

  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case 'high': return 'text-red-600'
      case 'medium': return 'text-yellow-600'
      case 'low': return 'text-green-600'
      default: return 'text-gray-600'
    }
  }

  const getDueDateStatus = (dueDate: string) => {
    const due = new Date(dueDate)
    const now = new Date()
    const diffTime = due.getTime() - now.getTime()
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24))
    
    if (diffDays < 0) return { status: 'overdue', color: 'text-red-600', text: 'Overdue' }
    if (diffDays === 0) return { status: 'today', color: 'text-orange-600', text: 'Due Today' }
    if (diffDays === 1) return { status: 'tomorrow', color: 'text-yellow-600', text: 'Due Tomorrow' }
    if (diffDays <= 7) return { status: 'week', color: 'text-blue-600', text: `${diffDays} days` }
    return { status: 'future', color: 'text-gray-600', text: `${diffDays} days` }
  }

  // Calculate task metrics
  const totalTasks = tasks.length
  const myTasks = tasks.filter(t => t.assigned_to === userProfile?.id)
  const completedTasks = tasks.filter(t => t.status === 'completed')
  const overdueTasks = tasks.filter(t => {
    if (!t.due_date) return false
    return new Date(t.due_date) < new Date() && t.status !== 'completed'
  })
  const inProgressTasks = tasks.filter(t => t.status === 'in_progress')

  if (loading) {
    return (
      <div className="p-6 flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <div className="p-6 space-y-6">
      {/* Header */}
      <div className="flex justify-between items-center">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Task Management</h1>
          <p className="text-gray-600 mt-2">
            Organize workflows, assign tasks, and track progress
          </p>
        </div>
        <div className="flex space-x-2">
          <Button variant="outline" className="flex items-center gap-2">
            <FileText className="h-4 w-4" />
            Templates
          </Button>
          <Button variant="outline" className="flex items-center gap-2">
            <Zap className="h-4 w-4" />
            Workflow
          </Button>
          <Button className="flex items-center gap-2">
            <Plus className="h-4 w-4" />
            New Task
          </Button>
        </div>
      </div>

      {/* Statistics Cards */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">My Tasks</p>
                <p className="text-3xl font-bold text-gray-900">{myTasks.length}</p>
                <p className="text-xs text-gray-500 mt-1">
                  {myTasks.filter(t => t.status !== 'completed').length} pending
                </p>
              </div>
              <User className="h-8 w-8 text-blue-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">In Progress</p>
                <p className="text-3xl font-bold text-gray-900">{inProgressTasks.length}</p>
                <p className="text-xs text-gray-500 mt-1">
                  {((inProgressTasks.length / totalTasks) * 100).toFixed(0)}% of total
                </p>
              </div>
              <Play className="h-8 w-8 text-green-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Completed</p>
                <p className="text-3xl font-bold text-gray-900">{completedTasks.length}</p>
                <p className="text-xs text-gray-500 mt-1">
                  {((completedTasks.length / totalTasks) * 100).toFixed(0)}% completion rate
                </p>
              </div>
              <CheckCircle className="h-8 w-8 text-purple-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Overdue</p>
                <p className="text-3xl font-bold text-gray-900">{overdueTasks.length}</p>
                <p className="text-xs text-gray-500 mt-1">
                  Requires attention
                </p>
              </div>
              <AlertCircle className="h-8 w-8 text-red-600" />
            </div>
          </CardContent>
        </Card>
      </div>

      {/* Tab Navigation */}
      <div className="border-b border-gray-200">
        <nav className="-mb-px flex space-x-8">
          {[
            { id: 'my-tasks', label: 'My Tasks', icon: User },
            { id: 'all-tasks', label: 'All Tasks', icon: CheckSquare },
            { id: 'workflows', label: 'Workflows', icon: Zap },
            { id: 'templates', label: 'Templates', icon: FileText }
          ].map((tab) => {
            const Icon = tab.icon
            return (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as any)}
                className={`flex items-center space-x-2 py-2 px-1 border-b-2 font-medium text-sm ${
                  activeTab === tab.id
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
              >
                <Icon className="h-4 w-4" />
                <span>{tab.label}</span>
              </button>
            )
          })}
        </nav>
      </div>

      {/* Search and Filters */}
      {(activeTab === 'my-tasks' || activeTab === 'all-tasks') && (
        <div className="flex flex-col lg:flex-row gap-4">
          <div className="relative flex-1">
            <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4" />
            <input
              type="text"
              placeholder="Search tasks..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
          </div>
          <div className="flex items-center gap-2">
            <Filter className="h-4 w-4 text-gray-400" />
            <select
              value={statusFilter}
              onChange={(e) => setStatusFilter(e.target.value)}
              className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="all">All Status</option>
              <option value="pending">Pending</option>
              <option value="in_progress">In Progress</option>
              <option value="completed">Completed</option>
              <option value="cancelled">Cancelled</option>
            </select>
            <select
              value={priorityFilter}
              onChange={(e) => setPriorityFilter(e.target.value)}
              className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            >
              <option value="all">All Priority</option>
              <option value="high">High</option>
              <option value="medium">Medium</option>
              <option value="low">Low</option>
            </select>
          </div>
        </div>
      )}

      {/* Tasks Display */}
      {(activeTab === 'my-tasks' || activeTab === 'all-tasks') && (
        <>
          {filteredTasks.length === 0 ? (
            <Card>
              <CardContent className="p-12 text-center">
                <CheckSquare className="h-16 w-16 text-gray-400 mx-auto mb-4" />
                <h3 className="text-xl font-semibold text-gray-900 mb-2">
                  {tasks.length === 0 ? 'No tasks yet' : 'No matching tasks'}
                </h3>
                <p className="text-gray-600 mb-6">
                  {tasks.length === 0 
                    ? 'Create your first task to get started'
                    : 'Try adjusting your search or filter criteria'
                  }
                </p>
                {tasks.length === 0 && (
                  <Button className="flex items-center gap-2">
                    <Plus className="h-4 w-4" />
                    Create First Task
                  </Button>
                )}
              </CardContent>
            </Card>
          ) : (
            <div className="space-y-4">
              {filteredTasks.map((task) => {
                const StatusIcon = getStatusIcon(task.status)
                const PriorityIcon = getPriorityIcon(task.priority)
                const statusColorClass = getStatusColor(task.status)
                const priorityColorClass = getPriorityColor(task.priority)
                const dueDateInfo = task.due_date ? getDueDateStatus(task.due_date) : null
                
                return (
                  <Card key={task.id} className="hover:shadow-md transition-shadow">
                    <CardContent className="p-6">
                      <div className="flex items-start justify-between">
                        <div className="flex items-start space-x-4 flex-1">
                          <div className="flex items-center space-x-2">
                            <input
                              type="checkbox"
                              checked={task.status === 'completed'}
                              className="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded"
                              onChange={() => {
                                // Handle task completion toggle
                              }}
                            />
                            <div className={`w-8 h-8 rounded-full flex items-center justify-center ${
                              task.priority === 'high' ? 'bg-red-100' :
                              task.priority === 'medium' ? 'bg-yellow-100' :
                              'bg-green-100'
                            }`}>
                              <PriorityIcon className={`h-4 w-4 ${priorityColorClass}`} />
                            </div>
                          </div>
                          
                          <div className="flex-1">
                            <div className="flex items-center space-x-2 mb-1">
                              <h3 className={`font-semibold ${
                                task.status === 'completed' ? 'line-through text-gray-500' : 'text-gray-900'
                              }`}>
                                {task.task_title}
                              </h3>
                              <span className={`px-2 py-1 rounded-full text-xs font-medium ${statusColorClass}`}>
                                <StatusIcon className="h-3 w-3 inline mr-1" />
                                {task.status.replace('_', ' ')}
                              </span>
                            </div>
                            
                            {task.description && (
                              <p className="text-gray-600 text-sm mb-2 line-clamp-2">
                                {task.description}
                              </p>
                            )}
                            
                            <div className="flex items-center space-x-4 text-xs text-gray-500">
                              {task.due_date && dueDateInfo && (
                                <span className={`flex items-center ${dueDateInfo.color}`}>
                                  <Calendar className="h-3 w-3 mr-1" />
                                  {dueDateInfo.text}
                                </span>
                              )}
                              
                              {task.assigned_to && (
                                <span className="flex items-center">
                                  <User className="h-3 w-3 mr-1" />
                                  Assigned
                                </span>
                              )}
                              
                              <span className="flex items-center">
                                <Clock className="h-3 w-3 mr-1" />
                                Created {new Date(task.created_at).toLocaleDateString()}
                              </span>
                            </div>
                          </div>
                        </div>
                        
                        <div className="flex items-center space-x-2">
                          {task.status === 'pending' && (
                            <Button variant="outline" size="sm" className="flex items-center gap-1">
                              <Play className="h-3 w-3" />
                              Start
                            </Button>
                          )}
                          {task.status === 'in_progress' && (
                            <Button variant="outline" size="sm" className="flex items-center gap-1">
                              <Pause className="h-3 w-3" />
                              Pause
                            </Button>
                          )}
                          <Button variant="ghost" size="sm">
                            <MoreVertical className="h-4 w-4" />
                          </Button>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                )
              })}
            </div>
          )}
        </>
      )}

      {/* Workflows Tab */}
      {activeTab === 'workflows' && (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <h2 className="text-xl font-semibold text-gray-900">Workflow Automation</h2>
            <Button className="flex items-center gap-2">
              <Plus className="h-4 w-4" />
              Create Workflow
            </Button>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {[
              {
                name: 'New Claim Processing',
                description: 'Automatically creates tasks when a new claim is assigned',
                trigger: 'New claim created',
                actions: '5 automated tasks',
                status: 'active'
              },
              {
                name: 'Inspection Follow-up',
                description: 'Sends reminders and creates follow-up tasks for inspections',
                trigger: 'Inspection scheduled',
                actions: '3 automated tasks',
                status: 'active'
              },
              {
                name: 'Document Review',
                description: 'Routes documents for review and approval',
                trigger: 'Document uploaded',
                actions: '2 automated tasks',
                status: 'draft'
              }
            ].map((workflow, index) => (
              <Card key={index} className="hover:shadow-lg transition-shadow">
                <CardContent className="p-6">
                  <div className="flex items-start justify-between mb-4">
                    <div className="w-10 h-10 bg-purple-100 rounded-full flex items-center justify-center">
                      <Zap className="h-5 w-5 text-purple-600" />
                    </div>
                    <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                      workflow.status === 'active' ? 'text-green-600 bg-green-100' : 'text-gray-600 bg-gray-100'
                    }`}>
                      {workflow.status}
                    </span>
                  </div>
                  
                  <h3 className="font-semibold text-gray-900 mb-2">{workflow.name}</h3>
                  <p className="text-sm text-gray-600 mb-4">{workflow.description}</p>
                  
                  <div className="space-y-2 text-xs text-gray-500">
                    <div className="flex items-center">
                      <Target className="h-3 w-3 mr-2" />
                      Trigger: {workflow.trigger}
                    </div>
                    <div className="flex items-center">
                      <ArrowRight className="h-3 w-3 mr-2" />
                      {workflow.actions}
                    </div>
                  </div>
                  
                  <div className="flex space-x-2 mt-4">
                    <Button variant="outline" size="sm" className="flex-1">
                      Edit
                    </Button>
                    <Button variant="outline" size="sm" className="flex-1">
                      View
                    </Button>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>
      )}

      {/* Templates Tab */}
      {activeTab === 'templates' && (
        <div className="space-y-6">
          <div className="flex justify-between items-center">
            <h2 className="text-xl font-semibold text-gray-900">Task Templates</h2>
            <Button className="flex items-center gap-2">
              <Plus className="h-4 w-4" />
              Create Template
            </Button>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {[
              {
                name: 'Property Inspection Checklist',
                description: 'Standard checklist for property inspections',
                tasks: 12,
                category: 'Inspection'
              },
              {
                name: 'Claim Investigation Process',
                description: 'Step-by-step investigation workflow',
                tasks: 8,
                category: 'Investigation'
              },
              {
                name: 'Document Collection',
                description: 'Gather all required documentation',
                tasks: 6,
                category: 'Documentation'
              },
              {
                name: 'Settlement Negotiation',
                description: 'Negotiation and settlement process',
                tasks: 10,
                category: 'Settlement'
              }
            ].map((template, index) => (
              <Card key={index} className="hover:shadow-lg transition-shadow">
                <CardContent className="p-6">
                  <div className="flex items-start justify-between mb-4">
                    <div className="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                      <FileText className="h-5 w-5 text-blue-600" />
                    </div>
                    <span className="px-2 py-1 bg-gray-100 text-gray-600 rounded text-xs font-medium">
                      {template.category}
                    </span>
                  </div>
                  
                  <h3 className="font-semibold text-gray-900 mb-2">{template.name}</h3>
                  <p className="text-sm text-gray-600 mb-4">{template.description}</p>
                  
                  <div className="flex items-center text-xs text-gray-500 mb-4">
                    <CheckSquare className="h-3 w-3 mr-2" />
                    {template.tasks} tasks included
                  </div>
                  
                  <div className="flex space-x-2">
                    <Button variant="outline" size="sm" className="flex-1">
                      Preview
                    </Button>
                    <Button size="sm" className="flex-1">
                      Use Template
                    </Button>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        </div>
      )}
    </div>
  )
}\n
claimguru/src/pages/Vendors.tsx
import React, { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { 
  Users, 
  Plus, 
  Search, 
  Filter,
  Download,
  Eye,
  Edit,
  Trash2,
  Star,
  StarOff,
  MapPin,
  Phone,
  Mail,
  Building,
  Calendar,
  DollarSign,
  TrendingUp,
  Award,
  Clock,
  CheckCircle,
  AlertTriangle,
  BarChart3,
  X
} from 'lucide-react'
import { useAuth } from '../contexts/AuthContext'
import { supabase } from '../lib/supabase'
import type { Vendor } from '../lib/supabase'
import { VendorForm } from '../components/forms/VendorForm'
import { VendorDetails } from '../components/vendors/VendorDetails'
import { VendorPerformance } from '../components/vendors/VendorPerformance'
import { VendorAssignments } from '../components/vendors/VendorAssignments'

interface VendorStats {
  totalVendors: number
  activeVendors: number
  topRatedVendors: number
  pendingPayments: number
  totalSpent: number
  averageRating: number
  vendorsByCategory: { category: string; count: number }[]
  topPerformingVendors: { vendor: Vendor; rating: number; completedJobs: number }[]
  recentActivity: any[]
}

export function Vendors() {
  const { userProfile } = useAuth()
  const [loading, setLoading] = useState(true)
  const [vendors, setVendors] = useState<Vendor[]>([])
  const [stats, setStats] = useState<VendorStats | null>(null)
  const [activeTab, setActiveTab] = useState('overview')
  const [showForm, setShowForm] = useState(false)
  const [selectedVendor, setSelectedVendor] = useState<Vendor | null>(null)
  const [searchTerm, setSearchTerm] = useState('')
  const [filterCategory, setFilterCategory] = useState('all')
  const [filterStatus, setFilterStatus] = useState('all')
  const [filterRating, setFilterRating] = useState('all')

  useEffect(() => {
    if (userProfile?.organization_id) {
      loadVendorData()
    }
  }, [userProfile?.organization_id])

  async function loadVendorData() {
    try {
      setLoading(true)
      
      // Fetch vendors with related data
      const { data: vendorsData } = await supabase
        .from('vendors')
        .select(`
          *,
          vendor_assignments(
            id,
            claim_id,
            status,
            assigned_date,
            completed_date,
            amount,
            rating
          )
        `)
        .eq('organization_id', userProfile?.organization_id)
        .order('created_at', { ascending: false })

      const vendorsResult = vendorsData || []
      
      // Calculate statistics
      const totalVendors = vendorsResult.length
      const activeVendors = vendorsResult.filter(vendor => vendor.status === 'active').length
      const topRatedVendors = vendorsResult.filter(vendor => vendor.rating >= 4.5).length
      
      // Calculate vendor performance stats
      const vendorStats = vendorsResult.map(vendor => {
        const assignments = vendor.vendor_assignments || []
        const completedJobs = assignments.filter(a => a.status === 'completed').length
        const totalRatings = assignments.filter(a => a.rating).length
        const averageRating = totalRatings > 0 
          ? assignments.reduce((sum, a) => sum + (a.rating || 0), 0) / totalRatings 
          : 0
        
        return {
          vendor,
          rating: averageRating,
          completedJobs
        }
      })
      
      const topPerformingVendors = vendorStats
        .sort((a, b) => b.rating - a.rating)
        .slice(0, 5)
      
      // Calculate financial metrics
      const totalSpent = vendorsResult.reduce((sum, vendor) => {
        const assignments = vendor.vendor_assignments || []
        return sum + assignments.reduce((assignmentSum, assignment) => 
          assignmentSum + (assignment.amount || 0), 0)
      }, 0)
      
      const pendingPayments = vendorsResult.reduce((sum, vendor) => {
        const assignments = vendor.vendor_assignments || []
        return sum + assignments
          .filter(a => a.status === 'completed' && !a.paid)
          .reduce((assignmentSum, assignment) => assignmentSum + (assignment.amount || 0), 0)
      }, 0)
      
      // Calculate category distribution
      const categoryCounts = vendorsResult.reduce((acc, vendor) => {
        const category = vendor.specialty || vendor.category || 'Other'
        acc[category] = (acc[category] || 0) + 1
        return acc
      }, {} as { [key: string]: number })
      
      // Group by contractor vs expert type
      const typeCounts = vendorsResult.reduce((acc, vendor) => {
        const specialty = vendor.specialty || vendor.category || ''
        const type = contractorCategories.includes(specialty) ? 'Contractors' : 'Experts'
        acc[type] = (acc[type] || 0) + 1
        return acc
      }, {} as { [key: string]: number })
      
      const vendorsByCategory = [
        ...Object.entries(typeCounts).map(([category, count]) => ({
          category,
          count: count as number
        })),
        ...Object.entries(categoryCounts)
          .filter(([category]) => category !== 'Other' || categoryCounts[category] > 0)
          .sort(([,a], [,b]) => (b as number) - (a as number))
          .slice(0, 8)
          .map(([category, count]) => ({
            category,
            count: count as number
          }))
      ]
      
      const averageRating = vendorStats.length > 0 
        ? vendorStats.reduce((sum, v) => sum + v.rating, 0) / vendorStats.length 
        : 0
      
      setStats({
        totalVendors,
        activeVendors,
        topRatedVendors,
        pendingPayments,
        totalSpent,
        averageRating,
        vendorsByCategory,
        topPerformingVendors,
        recentActivity: []
      })
      
      setVendors(vendorsResult)
    } catch (error) {
      console.error('Error loading vendor data:', error)
    } finally {
      setLoading(false)
    }
  }

  const handleSaveVendor = async (data: any) => {
    try {
      const vendorData = {
        ...data,
        organization_id: userProfile?.organization_id
      }

      if (selectedVendor) {
        await supabase
          .from('vendors')
          .update(vendorData)
          .eq('id', selectedVendor.id)
      } else {
        await supabase
          .from('vendors')
          .insert([vendorData])
      }
      
      await loadVendorData()
      setShowForm(false)
      setSelectedVendor(null)
    } catch (error) {
      console.error('Error saving vendor:', error)
    }
  }

  const handleDeleteVendor = async (id: string) => {
    if (!confirm('Are you sure you want to delete this vendor?')) return

    try {
      await supabase
        .from('vendors')
        .delete()
        .eq('id', id)
      
      await loadVendorData()
    } catch (error) {
      console.error('Error deleting vendor:', error)
    }
  }

  const handleToggleFavorite = async (vendor: Vendor) => {
    try {
      await supabase
        .from('vendors')
        .update({ is_preferred: !vendor.is_preferred })
        .eq('id', vendor.id)
      
      await loadVendorData()
    } catch (error) {
      console.error('Error updating vendor favorite status:', error)
    }
  }

  // Filter vendors
  const filteredVendors = vendors.filter(vendor => {
    const matchesSearch = !searchTerm || 
      vendor.company_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      vendor.contact_name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      vendor.category?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      vendor.specialty?.toLowerCase().includes(searchTerm.toLowerCase()) ||
      vendor.specialties?.some(s => s.toLowerCase().includes(searchTerm.toLowerCase()))
    
    const matchesCategory = filterCategory === 'all' || 
      vendor.category === filterCategory || 
      vendor.specialty === filterCategory ||
      vendor.specialties?.includes(filterCategory)
    
    const matchesStatus = filterStatus === 'all' || vendor.status === filterStatus
    
    let matchesRating = true
    if (filterRating !== 'all') {
      const rating = vendor.rating || 0
      switch (filterRating) {
        case '5': matchesRating = rating >= 4.5; break
        case '4': matchesRating = rating >= 3.5 && rating < 4.5; break
        case '3': matchesRating = rating >= 2.5 && rating < 3.5; break
        case '2': matchesRating = rating >= 1.5 && rating < 2.5; break
        case '1': matchesRating = rating < 1.5; break
      }
    }
    
    return matchesSearch && matchesCategory && matchesStatus && matchesRating
  })

  const contractorCategories = [
    'General Contractor',
    'Mold Remediation Specialist',
    'Water Mitigation/Restoration',
    'Lead Testing Specialist',
    'Emergency Tarping Service',
    'Roofing Contractor',
    'Plumbing Contractor',
    'Electrical Contractor',
    'HVAC Contractor',
    'Flooring Specialist',
    'Drywall/Painting Contractor',
    'Window/Glass Replacement',
    'Structural Repair',
    'Landscaping/Exterior',
    'Cleaning/Restoration Services'
  ]

  const expertCategories = [
    'Structural Engineer',
    'Environmental Consultant',
    'Public Adjuster',
    'Insurance Consultant',
    'Legal Expert/Attorney',
    'Forensic Accountant',
    'Building Code Consultant',
    'Fire Investigation Expert',
    'Weather Expert/Meteorologist',
    'Construction Consultant',
    'Safety Inspector',
    'Appraisal Expert'
  ]

  const allCategories = [...contractorCategories, ...expertCategories]
  const uniqueCategories = [...new Set(vendors.map(v => v.specialty || v.category).filter(Boolean))]

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold text-gray-900">Vendor Management</h1>
          <p className="text-gray-600 mt-1">Manage your network of trusted vendors and service providers</p>
        </div>
        <Button onClick={() => setShowForm(true)}>
          <Plus className="h-4 w-4 mr-2" />
          Add Vendor
        </Button>
      </div>

      {/* Tab Navigation */}
      <div className="border-b border-gray-200">
        <nav className="-mb-px flex space-x-8">
          {[
            { id: 'overview', label: 'Overview', icon: BarChart3 },
            { id: 'directory', label: 'Vendor Directory', icon: Users },
            { id: 'performance', label: 'Performance', icon: TrendingUp },
            { id: 'assignments', label: 'Assignments', icon: Calendar }
          ].map((tab) => (
            <button
              key={tab.id}
              onClick={() => setActiveTab(tab.id)}
              className={`group inline-flex items-center py-4 px-1 border-b-2 font-medium text-sm ${
                activeTab === tab.id
                  ? 'border-indigo-500 text-indigo-600'
                  : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
              }`}
            >
              <tab.icon className="h-5 w-5 mr-2" />
              {tab.label}
            </button>
          ))}
        </nav>
      </div>

      {/* Overview Tab */}
      {activeTab === 'overview' && (
        <div className="space-y-6">
          {/* Statistics Cards */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            <Card>
              <CardHeader className="pb-3">
                <CardTitle className="flex items-center space-x-2">
                  <Users className="h-5 w-5 text-indigo-600" />
                  <span>Total Vendors</span>
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold text-indigo-600">{stats?.totalVendors || 0}</div>
                <p className="text-sm text-gray-600">{stats?.activeVendors || 0} active</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="pb-3">
                <CardTitle className="flex items-center space-x-2">
                  <Award className="h-5 w-5 text-yellow-600" />
                  <span>Top Rated</span>
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold text-yellow-600">{stats?.topRatedVendors || 0}</div>
                <div className="flex items-center mt-1">
                  <Star className="h-4 w-4 text-yellow-400 fill-current" />
                  <span className="text-sm text-gray-600 ml-1">
                    {stats?.averageRating.toFixed(1) || '0.0'} avg rating
                  </span>
                </div>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="pb-3">
                <CardTitle className="flex items-center space-x-2">
                  <DollarSign className="h-5 w-5 text-green-600" />
                  <span>Total Spent</span>
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold text-green-600">
                  ${stats?.totalSpent.toLocaleString() || '0'}
                </div>
                <p className="text-sm text-gray-600">This year</p>
              </CardContent>
            </Card>

            <Card>
              <CardHeader className="pb-3">
                <CardTitle className="flex items-center space-x-2">
                  <Clock className="h-5 w-5 text-red-600" />
                  <span>Pending Payments</span>
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="text-3xl font-bold text-red-600">
                  ${stats?.pendingPayments.toLocaleString() || '0'}
                </div>
                <p className="text-sm text-gray-600">Outstanding</p>
              </CardContent>
            </Card>
          </div>

          {/* Charts and Analytics */}
          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
            {/* Vendor Categories */}
            <Card>
              <CardHeader>
                <CardTitle>Vendors by Category</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {stats?.vendorsByCategory.map((item, index) => {
                    const percentage = stats.totalVendors > 0 ? (item.count / stats.totalVendors * 100) : 0
                    return (
                      <div key={item.category} className="space-y-2">
                        <div className="flex justify-between text-sm">
                          <span className="font-medium">{item.category}</span>
                          <span className="text-gray-600">{item.count} vendors</span>
                        </div>
                        <div className="w-full bg-gray-200 rounded-full h-2">
                          <div 
                            className="bg-indigo-600 h-2 rounded-full" 
                            style={{ width: `${percentage}%` }}
                          ></div>
                        </div>
                      </div>
                    )
                  })}
                </div>
              </CardContent>
            </Card>

            {/* Top Performing Vendors */}
            <Card>
              <CardHeader>
                <CardTitle>Top Performing Vendors</CardTitle>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {stats?.topPerformingVendors.map((item, index) => (
                    <div key={item.vendor.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <div className="flex items-center space-x-3">
                        <div className={`w-8 h-8 rounded-full flex items-center justify-center text-white font-bold ${
                          index === 0 ? 'bg-yellow-500' :
                          index === 1 ? 'bg-gray-400' :
                          index === 2 ? 'bg-orange-500' :
                          'bg-indigo-500'
                        }`}>
                          {index + 1}
                        </div>
                        <div>
                          <p className="font-medium text-gray-900">{item.vendor.company_name}</p>
                          <p className="text-sm text-gray-600">{item.vendor.category}</p>
                        </div>
                      </div>
                      <div className="text-right">
                        <div className="flex items-center space-x-1">
                          <Star className="h-4 w-4 text-yellow-400 fill-current" />
                          <span className="font-medium">{item.rating.toFixed(1)}</span>
                        </div>
                        <p className="text-xs text-gray-600">{item.completedJobs} jobs</p>
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          </div>
        </div>
      )}

      {/* Vendor Directory Tab */}
      {activeTab === 'directory' && (
        <div className="space-y-6">
          {/* Filters */}
          <div className="flex flex-wrap items-center gap-4 p-4 bg-gray-50 rounded-lg">
            <div className="flex-1 min-w-64">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4" />
                <input
                  type="text"
                  placeholder="Search vendors..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="pl-10 pr-4 py-2 w-full border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                />
              </div>
            </div>
            
            <select
              value={filterCategory}
              onChange={(e) => setFilterCategory(e.target.value)}
              className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            >
              <option value="all">All Categories</option>
              {uniqueCategories.map(category => (
                <option key={category} value={category}>{category}</option>
              ))}
            </select>
            
            <select
              value={filterStatus}
              onChange={(e) => setFilterStatus(e.target.value)}
              className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            >
              <option value="all">All Status</option>
              <option value="active">Active</option>
              <option value="inactive">Inactive</option>
              <option value="suspended">Suspended</option>
            </select>
            
            <select
              value={filterRating}
              onChange={(e) => setFilterRating(e.target.value)}
              className="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
            >
              <option value="all">All Ratings</option>
              <option value="5">5 Stars</option>
              <option value="4">4 Stars</option>
              <option value="3">3 Stars</option>
              <option value="2">2 Stars</option>
              <option value="1">1 Star</option>
            </select>
            
            <Button variant="outline">
              <Download className="h-4 w-4 mr-2" />
              Export
            </Button>
          </div>

          {/* Vendor Grid */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {filteredVendors.map((vendor) => (
              <Card key={vendor.id} className="hover:shadow-lg transition-shadow">
                <CardHeader className="pb-3">
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <CardTitle className="text-lg">{vendor.company_name}</CardTitle>
                      <div className="flex items-center space-x-2 mt-1">
                        <p className="text-sm text-gray-600">{vendor.specialty || vendor.category}</p>
                        {vendor.category && (
                          <span className={`inline-flex px-2 py-1 text-xs font-medium rounded-full ${
                            contractorCategories.includes(vendor.specialty || vendor.category || '')
                              ? 'bg-blue-100 text-blue-800'
                              : 'bg-green-100 text-green-800'
                          }`}>
                            {contractorCategories.includes(vendor.specialty || vendor.category || '') ? 'Contractor' : 'Expert'}
                          </span>
                        )}\n                      </div>\n                      {vendor.emergency_available && (
                        <span className="inline-flex items-center px-2 py-1 mt-1 text-xs font-medium bg-red-100 text-red-800 rounded-full">
                          Emergency Available
                        </span>
                      )}\n                    </div>
                    <div className="flex items-center space-x-2">
                      <button
                        onClick={() => handleToggleFavorite(vendor)}
                        className="p-1 hover:bg-gray-100 rounded-full transition-colors"
                      >
                        {vendor.is_preferred ? (
                          <Star className="h-4 w-4 text-yellow-400 fill-current" />
                        ) : (
                          <StarOff className="h-4 w-4 text-gray-400" />
                        )}
                      </button>
                      <span className={`inline-flex px-2 py-1 text-xs font-semibold rounded-full ${
                        vendor.status === 'active' ? 'bg-green-100 text-green-800' :
                        vendor.status === 'inactive' ? 'bg-gray-100 text-gray-800' :
                        'bg-red-100 text-red-800'
                      }`}>
                        {vendor.status?.charAt(0).toUpperCase() + vendor.status?.slice(1)}
                      </span>
                    </div>
                  </div>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    <div className="flex items-center space-x-2 text-sm text-gray-600">
                      <Building className="h-4 w-4" />
                      <span>{vendor.contact_name}</span>
                    </div>
                    
                    {vendor.phone && (
                      <div className="flex items-center space-x-2 text-sm text-gray-600">
                        <Phone className="h-4 w-4" />
                        <span>{vendor.phone}</span>
                      </div>
                    )}
                    
                    {vendor.email && (
                      <div className="flex items-center space-x-2 text-sm text-gray-600">
                        <Mail className="h-4 w-4" />
                        <span>{vendor.email}</span>
                      </div>
                    )}
                    
                    {vendor.city && vendor.state && (
                      <div className="flex items-center space-x-2 text-sm text-gray-600">
                        <MapPin className="h-4 w-4" />
                        <span>{vendor.city}, {vendor.state}</span>
                      </div>
                    )}
                    
                    {vendor.rating && (
                      <div className="flex items-center space-x-2">
                        <div className="flex items-center">
                          {[1, 2, 3, 4, 5].map((star) => (
                            <Star
                              key={star}
                              className={`h-4 w-4 ${
                                star <= (vendor.rating || 0) 
                                  ? 'text-yellow-400 fill-current' 
                                  : 'text-gray-300'
                              }`}
                            />
                          ))}
                        </div>
                        <span className="text-sm text-gray-600">({vendor.rating})</span>
                      </div>
                    )}
                  </div>
                  
                  <div className="flex items-center justify-between pt-4 border-t border-gray-100 mt-4">
                    <Button
                      size="sm"
                      variant="outline"
                      onClick={() => setSelectedVendor(vendor)}
                    >
                      <Eye className="h-3 w-3 mr-1" />
                      View
                    </Button>
                    <div className="flex items-center space-x-1">
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => {
                          setSelectedVendor(vendor)
                          setShowForm(true)
                        }}
                      >
                        <Edit className="h-3 w-3" />
                      </Button>
                      <Button
                        size="sm"
                        variant="outline"
                        onClick={() => handleDeleteVendor(vendor.id)}
                      >
                        <Trash2 className="h-3 w-3" />
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>

          {filteredVendors.length === 0 && (
            <div className="text-center py-12">
              <Users className="h-12 w-12 text-gray-400 mx-auto mb-4" />
              <h3 className="text-lg font-medium text-gray-900 mb-2">No vendors found</h3>
              <p className="text-gray-600 mb-6">
                {searchTerm || filterCategory !== 'all' || filterStatus !== 'all' || filterRating !== 'all'
                  ? 'Try adjusting your search or filter criteria'
                  : 'Add your first vendor to get started'
                }
              </p>
              {!searchTerm && filterCategory === 'all' && filterStatus === 'all' && filterRating === 'all' && (
                <Button onClick={() => setShowForm(true)}>
                  <Plus className="h-4 w-4 mr-2" />
                  Add Vendor
                </Button>
              )}
            </div>
          )}
        </div>
      )}

      {/* Performance Tab */}
      {activeTab === 'performance' && (
        <VendorPerformance vendors={vendors} />
      )}

      {/* Assignments Tab */}
      {activeTab === 'assignments' && (
        <VendorAssignments vendors={vendors} onRefresh={loadVendorData} />
      )}

      {/* Vendor Form Modal */}
      {showForm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between p-6 border-b border-gray-200">
              <h3 className="text-xl font-semibold text-gray-900">
                {selectedVendor ? 'Edit Vendor' : 'Add New Vendor'}
              </h3>
              <button
                onClick={() => {
                  setShowForm(false)
                  setSelectedVendor(null)
                }}
                className="p-2 hover:bg-gray-100 rounded-full transition-colors"
              >
                <X className="h-5 w-5" />
              </button>
            </div>
            <VendorForm
              vendor={selectedVendor}
              onSave={handleSaveVendor}
              onCancel={() => {
                setShowForm(false)
                setSelectedVendor(null)
              }}
            />
          </div>
        </div>
      )}

      {/* Vendor Details Modal */}
      {selectedVendor && !showForm && (
        <div className="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
          <div className="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div className="flex items-center justify-between p-6 border-b border-gray-200">
              <h3 className="text-xl font-semibold text-gray-900">
                {selectedVendor.company_name}
              </h3>
              <button
                onClick={() => setSelectedVendor(null)}
                className="p-2 hover:bg-gray-100 rounded-full transition-colors"
              >
                <X className="h-5 w-5" />
              </button>
            </div>
            <VendorDetails vendor={selectedVendor} onEdit={() => setShowForm(true)} />
          </div>
        </div>
      )}
    </div>
  )
}\n
