import React, { useState, useEffect } from 'react'\nimport { Card, CardContent, CardHeader, CardTitle } from '../../ui/Card'\nimport { Button } from '../../ui/Button'\nimport { Input } from '../../ui/Input'\nimport { LoadingSpinner } from '../../ui/LoadingSpinner'\nimport { \n  CheckSquare, \n  Plus, \n  Calendar,\n  Clock,\n  AlertTriangle,\n  Brain,\n  Flag,\n  User,\n  X,\n  Star,\n  Bell,\n  Target,\n  Archive,\n  CheckCircle\n} from 'lucide-react'\nimport { enhancedClaimWizardAI } from '../../../services/enhancedClaimWizardAI'\n\ninterface Task {\n  id: string\n  title: string\n  description: string\n  priority: 'low' | 'medium' | 'high' | 'critical'\n  category: 'documentation' | 'communication' | 'inspection' | 'legal' | 'administrative' | 'follow_up'\n  assigneeId?: string\n  assigneeName?: string\n  dueDate: string\n  estimatedHours?: number\n  status: 'pending' | 'in_progress' | 'completed' | 'overdue'\n  dependencies?: string[]\n  isAIGenerated: boolean\n  aiReasoning?: string\n  automationPossible?: boolean\n}\n\ninterface TaskTemplate {\n  title: string\n  description: string\n  category: string\n  priority: string\n  estimatedHours: number\n  defaultDueDays: number\n}\n\ninterface OfficeTasksStepProps {\n  data: any\n  onUpdate: (data: any) => void\n  onComplete?: () => void\n}\n\nexport const OfficeTasksStep: React.FC<OfficeTasksStepProps> = ({\n  data,\n  onUpdate,\n  onComplete\n}) => {\n  const [tasks, setTasks] = useState<Task[]>(data.officeTasks || [])\n  const [isGeneratingTasks, setIsGeneratingTasks] = useState(false)\n  const [showCustomForm, setShowCustomForm] = useState(false)\n  const [newTask, setNewTask] = useState<Partial<Task>>({\n    title: '',\n    description: '',\n    priority: 'medium',\n    category: 'administrative',\n    dueDate: '',\n    estimatedHours: 1,\n    status: 'pending',\n    isAIGenerated: false\n  })\n  const [selectedCategory, setSelectedCategory] = useState<string>('all')\n  const [selectedPriority, setSelectedPriority] = useState<string>('all')\n\n  const taskTemplates: TaskTemplate[] = [\n    {\n      title: 'Initial Client Contact',\n      description: 'Make initial contact with client to confirm claim details and schedule inspection',\n      category: 'communication',\n      priority: 'high',\n      estimatedHours: 0.5,\n      defaultDueDays: 1\n    },\n    {\n      title: 'Property Inspection Scheduling',\n      description: 'Schedule and coordinate property inspection with client and team',\n      category: 'inspection',\n      priority: 'high',\n      estimatedHours: 1,\n      defaultDueDays: 3\n    },\n    {\n      title: 'Insurance Carrier Notification',\n      description: 'Notify insurance carrier of representation and request claim file',\n      category: 'legal',\n      priority: 'critical',\n      estimatedHours: 1,\n      defaultDueDays: 3\n    },\n    {\n      title: 'Document Collection',\n      description: 'Collect all relevant policy documents, photos, and supporting materials',\n      category: 'documentation',\n      priority: 'medium',\n      estimatedHours: 2,\n      defaultDueDays: 7\n    },\n    {\n      title: 'Proof of Loss Preparation',\n      description: 'Prepare and review proof of loss documentation',\n      category: 'documentation',\n      priority: 'high',\n      estimatedHours: 4,\n      defaultDueDays: 30\n    }\n  ]\n\n  // Generate AI-recommended tasks\n  const generateAITasks = async () => {\n    setIsGeneratingTasks(true)\n    try {\n      const aiTasks = await enhancedClaimWizardAI.generateOfficeTasks({\n        claimData: data,\n        existingTasks: tasks,\n        personnelAssignments: data.personnelAssignments || []\n      })\n      \n      const newTasks = aiTasks.map((task: any) => ({\n        ...task,\n        id: `ai-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,\n        status: 'pending' as const,\n        isAIGenerated: true\n      }))\n      \n      setTasks(prev => [...prev, ...newTasks])\n      onUpdate({\n        ...data,\n        officeTasks: [...tasks, ...newTasks]\n      })\n    } catch (error) {\n      console.error('Failed to generate AI tasks:', error)\n    } finally {\n      setIsGeneratingTasks(false)\n    }\n  }\n\n  // Add custom task\n  const addCustomTask = () => {\n    if (!newTask.title?.trim() || !newTask.dueDate) return\n\n    const task: Task = {\n      id: `custom-${Date.now()}`,\n      title: newTask.title,\n      description: newTask.description || '',\n      priority: newTask.priority as Task['priority'],\n      category: newTask.category as Task['category'],\n      dueDate: newTask.dueDate,\n      estimatedHours: newTask.estimatedHours || 1,\n      status: 'pending',\n      isAIGenerated: false\n    }\n\n    const updatedTasks = [...tasks, task]\n    setTasks(updatedTasks)\n    onUpdate({\n      ...data,\n      officeTasks: updatedTasks\n    })\n\n    // Reset form\n    setNewTask({\n      title: '',\n      description: '',\n      priority: 'medium',\n      category: 'administrative',\n      dueDate: '',\n      estimatedHours: 1,\n      status: 'pending',\n      isAIGenerated: false\n    })\n    setShowCustomForm(false)\n  }\n\n  // Add task from template\n  const addTaskFromTemplate = (template: TaskTemplate) => {\n    const dueDate = new Date()\n    dueDate.setDate(dueDate.getDate() + template.defaultDueDays)\n\n    const task: Task = {\n      id: `template-${Date.now()}`,\n      title: template.title,\n      description: template.description,\n      priority: template.priority as Task['priority'],\n      category: template.category as Task['category'],\n      dueDate: dueDate.toISOString().split('T')[0],\n      estimatedHours: template.estimatedHours,\n      status: 'pending',\n      isAIGenerated: false\n    }\n\n    const updatedTasks = [...tasks, task]\n    setTasks(updatedTasks)\n    onUpdate({\n      ...data,\n      officeTasks: updatedTasks\n    })\n  }\n\n  // Remove task\n  const removeTask = (taskId: string) => {\n    const updatedTasks = tasks.filter(task => task.id !== taskId)\n    setTasks(updatedTasks)\n    onUpdate({\n      ...data,\n      officeTasks: updatedTasks\n    })\n  }\n\n  // Update task status\n  const updateTaskStatus = (taskId: string, status: Task['status']) => {\n    const updatedTasks = tasks.map(task => \n      task.id === taskId ? { ...task, status } : task\n    )\n    setTasks(updatedTasks)\n    onUpdate({\n      ...data,\n      officeTasks: updatedTasks\n    })\n  }\n\n  // Get priority color\n  const getPriorityColor = (priority: string) => {\n    switch (priority) {\n      case 'critical': return 'text-red-600 bg-red-100 border-red-200'\n      case 'high': return 'text-orange-600 bg-orange-100 border-orange-200'\n      case 'medium': return 'text-yellow-600 bg-yellow-100 border-yellow-200'\n      case 'low': return 'text-green-600 bg-green-100 border-green-200'\n      default: return 'text-gray-600 bg-gray-100 border-gray-200'\n    }\n  }\n\n  // Get category icon\n  const getCategoryIcon = (category: string) => {\n    switch (category) {\n      case 'documentation': return <Archive className=\"h-4 w-4\" />\n      case 'communication': return <Bell className=\"h-4 w-4\" />\n      case 'inspection': return <Target className=\"h-4 w-4\" />\n      case 'legal': return <Flag className=\"h-4 w-4\" />\n      case 'administrative': return <CheckSquare className=\"h-4 w-4\" />\n      case 'follow_up': return <Clock className=\"h-4 w-4\" />\n      default: return <CheckSquare className=\"h-4 w-4\" />\n    }\n  }\n\n  // Get status color\n  const getStatusColor = (status: string) => {\n    switch (status) {\n      case 'completed': return 'text-green-600 bg-green-100'\n      case 'in_progress': return 'text-blue-600 bg-blue-100'\n      case 'overdue': return 'text-red-600 bg-red-100'\n      case 'pending': return 'text-gray-600 bg-gray-100'\n      default: return 'text-gray-600 bg-gray-100'\n    }\n  }\n\n  // Filter tasks\n  const filteredTasks = tasks.filter(task => {\n    const matchesCategory = selectedCategory === 'all' || task.category === selectedCategory\n    const matchesPriority = selectedPriority === 'all' || task.priority === selectedPriority\n    return matchesCategory && matchesPriority\n  })\n\n  // Calculate task statistics\n  const taskStats = {\n    total: tasks.length,\n    pending: tasks.filter(t => t.status === 'pending').length,\n    inProgress: tasks.filter(t => t.status === 'in_progress').length,\n    completed: tasks.filter(t => t.status === 'completed').length,\n    overdue: tasks.filter(t => t.status === 'overdue').length,\n    critical: tasks.filter(t => t.priority === 'critical').length\n  }\n\n  useEffect(() => {\n    // Auto-generate AI tasks on component mount if no tasks exist\n    if (tasks.length === 0) {\n      generateAITasks()\n    }\n  }, [])\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center space-x-2\">\n            <CheckSquare className=\"h-6 w-6 text-blue-600\" />\n            <span>Office Tasks & Follow-ups</span>\n          </CardTitle>\n          <p className=\"text-gray-600\">\n            Manage tasks and follow-ups for this claim. AI generates priority tasks based on claim details and deadlines.\n          </p>\n        </CardHeader>\n      </Card>\n\n      {/* Task Statistics */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Task Overview</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-2 md:grid-cols-6 gap-4\">\n            <div className=\"text-center p-3 bg-gray-50 rounded-lg\">\n              <div className=\"text-2xl font-bold text-gray-900\">{taskStats.total}</div>\n              <div className=\"text-sm text-gray-600\">Total Tasks</div>\n            </div>\n            <div className=\"text-center p-3 bg-yellow-50 rounded-lg\">\n              <div className=\"text-2xl font-bold text-yellow-900\">{taskStats.pending}</div>\n              <div className=\"text-sm text-yellow-700\">Pending</div>\n            </div>\n            <div className=\"text-center p-3 bg-blue-50 rounded-lg\">\n              <div className=\"text-2xl font-bold text-blue-900\">{taskStats.inProgress}</div>\n              <div className=\"text-sm text-blue-700\">In Progress</div>\n            </div>\n            <div className=\"text-center p-3 bg-green-50 rounded-lg\">\n              <div className=\"text-2xl font-bold text-green-900\">{taskStats.completed}</div>\n              <div className=\"text-sm text-green-700\">Completed</div>\n            </div>\n            <div className=\"text-center p-3 bg-red-50 rounded-lg\">\n              <div className=\"text-2xl font-bold text-red-900\">{taskStats.overdue}</div>\n              <div className=\"text-sm text-red-700\">Overdue</div>\n            </div>\n            <div className=\"text-center p-3 bg-orange-50 rounded-lg\">\n              <div className=\"text-2xl font-bold text-orange-900\">{taskStats.critical}</div>\n              <div className=\"text-sm text-orange-700\">Critical</div>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Actions and Filters */}\n      <Card>\n        <CardContent className=\"pt-6\">\n          <div className=\"flex flex-wrap items-center justify-between gap-4\">\n            <div className=\"flex items-center space-x-4\">\n              <Button\n                onClick={generateAITasks}\n                disabled={isGeneratingTasks}\n                className=\"flex items-center space-x-2\"\n              >\n                {isGeneratingTasks ? (\n                  <LoadingSpinner className=\"h-4 w-4\" />\n                ) : (\n                  <Brain className=\"h-4 w-4\" />\n                )}\n                <span>Generate AI Tasks</span>\n              </Button>\n              \n              <Button\n                variant=\"outline\"\n                onClick={() => setShowCustomForm(!showCustomForm)}\n              >\n                <Plus className=\"h-4 w-4 mr-2\" />\n                Add Custom Task\n              </Button>\n            </div>\n            \n            <div className=\"flex items-center space-x-2\">\n              <select\n                value={selectedCategory}\n                onChange={(e) => setSelectedCategory(e.target.value)}\n                className=\"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              >\n                <option value=\"all\">All Categories</option>\n                <option value=\"documentation\">Documentation</option>\n                <option value=\"communication\">Communication</option>\n                <option value=\"inspection\">Inspection</option>\n                <option value=\"legal\">Legal</option>\n                <option value=\"administrative\">Administrative</option>\n                <option value=\"follow_up\">Follow-up</option>\n              </select>\n              \n              <select\n                value={selectedPriority}\n                onChange={(e) => setSelectedPriority(e.target.value)}\n                className=\"px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              >\n                <option value=\"all\">All Priorities</option>\n                <option value=\"critical\">Critical</option>\n                <option value=\"high\">High</option>\n                <option value=\"medium\">Medium</option>\n                <option value=\"low\">Low</option>\n              </select>\n            </div>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Custom Task Form */}\n      {showCustomForm && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Add Custom Task</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <Input\n                  label=\"Task Title *\"\n                  value={newTask.title || ''}\n                  onChange={(e) => setNewTask({ ...newTask, title: e.target.value })}\n                  placeholder=\"Enter task title\"\n                />\n                <Input\n                  label=\"Due Date *\"\n                  type=\"date\"\n                  value={newTask.dueDate || ''}\n                  onChange={(e) => setNewTask({ ...newTask, dueDate: e.target.value })}\n                />\n              </div>\n              \n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                    Category\n                  </label>\n                  <select\n                    value={newTask.category}\n                    onChange={(e) => setNewTask({ ...newTask, category: e.target.value as any })}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  >\n                    <option value=\"administrative\">Administrative</option>\n                    <option value=\"documentation\">Documentation</option>\n                    <option value=\"communication\">Communication</option>\n                    <option value=\"inspection\">Inspection</option>\n                    <option value=\"legal\">Legal</option>\n                    <option value=\"follow_up\">Follow-up</option>\n                  </select>\n                </div>\n                \n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                    Priority\n                  </label>\n                  <select\n                    value={newTask.priority}\n                    onChange={(e) => setNewTask({ ...newTask, priority: e.target.value as any })}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  >\n                    <option value=\"low\">Low</option>\n                    <option value=\"medium\">Medium</option>\n                    <option value=\"high\">High</option>\n                    <option value=\"critical\">Critical</option>\n                  </select>\n                </div>\n                \n                <Input\n                  label=\"Estimated Hours\"\n                  type=\"number\"\n                  min=\"0.5\"\n                  step=\"0.5\"\n                  value={newTask.estimatedHours || ''}\n                  onChange={(e) => setNewTask({ ...newTask, estimatedHours: parseFloat(e.target.value) })}\n                  placeholder=\"1\"\n                />\n              </div>\n              \n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                  Description\n                </label>\n                <textarea\n                  value={newTask.description || ''}\n                  onChange={(e) => setNewTask({ ...newTask, description: e.target.value })}\n                  placeholder=\"Task description and details...\"\n                  rows={3}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                />\n              </div>\n              \n              <div className=\"flex space-x-3\">\n                <Button\n                  onClick={addCustomTask}\n                  disabled={!newTask.title?.trim() || !newTask.dueDate}\n                >\n                  Add Task\n                </Button>\n                <Button\n                  variant=\"outline\"\n                  onClick={() => setShowCustomForm(false)}\n                >\n                  Cancel\n                </Button>\n              </div>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Task Templates */}\n      <Card>\n        <CardHeader>\n          <CardTitle>Quick Add - Common Tasks</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3\">\n            {taskTemplates.map((template, index) => (\n              <button\n                key={index}\n                onClick={() => addTaskFromTemplate(template)}\n                className=\"p-3 border border-gray-200 rounded-lg text-left hover:border-blue-300 hover:bg-blue-50 transition-colors\"\n              >\n                <div className=\"flex items-start justify-between mb-2\">\n                  <h4 className=\"font-medium text-gray-900 text-sm\">{template.title}</h4>\n                  <span className={`px-2 py-1 text-xs rounded-full ${getPriorityColor(template.priority)} border`}>\n                    {template.priority}\n                  </span>\n                </div>\n                <p className=\"text-xs text-gray-600 mb-2\">{template.description}</p>\n                <div className=\"flex items-center justify-between text-xs text-gray-500\">\n                  <span className=\"capitalize\">{template.category.replace('_', ' ')}</span>\n                  <span>{template.estimatedHours}h â€¢ {template.defaultDueDays}d</span>\n                </div>\n              </button>\n            ))}\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Task List */}\n      {filteredTasks.length > 0 ? (\n        <Card>\n          <CardHeader>\n            <CardTitle>Tasks ({filteredTasks.length})</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              {filteredTasks.map((task) => (\n                <div key={task.id} className=\"border rounded-lg p-4\">\n                  <div className=\"flex items-start justify-between\">\n                    <div className=\"flex-1\">\n                      <div className=\"flex items-center space-x-2 mb-2\">\n                        {getCategoryIcon(task.category)}\n                        <h4 className=\"font-medium text-gray-900\">{task.title}</h4>\n                        <span className={`px-2 py-1 text-xs rounded-full ${getPriorityColor(task.priority)} border`}>\n                          {task.priority}\n                        </span>\n                        <span className={`px-2 py-1 text-xs rounded-full ${getStatusColor(task.status)}`}>\n                          {task.status.replace('_', ' ')}\n                        </span>\n                        {task.isAIGenerated && (\n                          <span className=\"px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800\">\n                            AI Generated\n                          </span>\n                        )}\n                      </div>\n                      \n                      {task.description && (\n                        <p className=\"text-sm text-gray-600 mb-2\">{task.description}</p>\n                      )}\n                      \n                      <div className=\"flex items-center space-x-4 text-sm text-gray-500\">\n                        <div className=\"flex items-center space-x-1\">\n                          <Calendar className=\"h-3 w-3\" />\n                          <span>Due: {new Date(task.dueDate).toLocaleDateString()}</span>\n                        </div>\n                        {task.estimatedHours && (\n                          <div className=\"flex items-center space-x-1\">\n                            <Clock className=\"h-3 w-3\" />\n                            <span>{task.estimatedHours}h estimated</span>\n                          </div>\n                        )}\n                        {task.assigneeName && (\n                          <div className=\"flex items-center space-x-1\">\n                            <User className=\"h-3 w-3\" />\n                            <span>{task.assigneeName}</span>\n                          </div>\n                        )}\n                      </div>\n                      \n                      {task.aiReasoning && (\n                        <div className=\"mt-2 p-2 bg-purple-50 rounded text-xs text-purple-700\">\n                          <span className=\"font-medium\">AI Reasoning:</span> {task.aiReasoning}\n                        </div>\n                      )}\n                    </div>\n                    \n                    <div className=\"flex items-center space-x-2\">\n                      {task.status !== 'completed' && (\n                        <select\n                          value={task.status}\n                          onChange={(e) => updateTaskStatus(task.id, e.target.value as Task['status'])}\n                          className=\"text-sm px-2 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500\"\n                        >\n                          <option value=\"pending\">Pending</option>\n                          <option value=\"in_progress\">In Progress</option>\n                          <option value=\"completed\">Completed</option>\n                        </select>\n                      )}\n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => removeTask(task.id)}\n                        className=\"text-red-600 hover:text-red-700\"\n                      >\n                        <X className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </div>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      ) : (\n        <Card className=\"border-dashed border-2\">\n          <CardContent className=\"text-center py-8\">\n            <CheckSquare className=\"mx-auto h-12 w-12 text-gray-400 mb-4\" />\n            <h3 className=\"text-lg font-medium text-gray-900 mb-2\">\n              No Tasks Yet\n            </h3>\n            <p className=\"text-gray-600 mb-4\">\n              Generate AI-recommended tasks or add custom tasks to get started.\n            </p>\n            <Button onClick={generateAITasks} disabled={isGeneratingTasks}>\n              {isGeneratingTasks ? (\n                <LoadingSpinner className=\"mr-2 h-4 w-4\" />\n              ) : (\n                <Brain className=\"mr-2 h-4 w-4\" />\n              )}\n              Generate AI Tasks\n            </Button>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Navigation */}\n      <div className=\"flex justify-between\">\n        <div></div>\n        <Button onClick={onComplete}>\n          Complete Task Setup\n        </Button>\n      </div>\n    </div>\n  )\n}\n