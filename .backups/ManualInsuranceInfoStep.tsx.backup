import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '../../ui/Card';
import { Button } from '../../ui/Button';
import { Input } from '../../ui/Input';
import { AddressAutocomplete } from '../../ui/AddressAutocomplete';
import { Shield, DollarSign, Plus, X, Calendar, CheckCircle, User, Building, MapPin } from 'lucide-react';
import { formatPhoneNumber, getPhoneInputProps } from '../../../utils/phoneUtils';
import { InsurerPersonnelInformation } from './InsurerPersonnelInformation';

interface Coverage {
  id: string;
  type: string;
  limit: number;
  otherDescription?: string;
}

interface Deductible {
  id: string;
  type: string;
  amount: number;
  isPercentage: boolean;
  percentageOf?: string;
  percentageValue?: number;
  calculatedAmount?: number;
  isAmountOverridden?: boolean;
  otherDescription?: string;
  appliesTo?: string; // For claim-specific deductible selection
}

interface PriorPayment {
  id: string;
  amount: number;
  date: string;
  description: string;
  coverageId?: string; // Which coverage this payment was for
  recoverableDepreciation?: number;
  nonRecoverableDepreciation?: number;
  deductibleApplied?: number;
}

interface ManualInsuranceInfoStepProps {
  data: any;
  onUpdate: (data: any) => void;
}

export const ManualInsuranceInfoStep: React.FC<ManualInsuranceInfoStepProps> = ({
  data,
  onUpdate
}) => {
  const [insuranceCarrier, setInsuranceCarrier] = useState(data.insuranceCarrier || {
    name: '',
    agentInfo: {
      agencyName: '',
      agentFirstName: '',
      agentLastName: '',
      agentEmail: '',
      agentPhone: '',
      agencyLicenseNumber: '',
      agentAddress: {
        addressLine1: '',
        addressLine2: '',
        city: '',
        state: '',
        zipCode: ''
      }
    }
  });
  const [policyDetails, setPolicyDetails] = useState(data.policyDetails || {});
  const [coverages, setCoverages] = useState<Coverage[]>(data.coverages || []);
  const [deductibles, setDeductibles] = useState<Deductible[]>(data.deductibles || []);
  const [priorPayments, setPriorPayments] = useState<PriorPayment[]>(data.priorPayments || []);
  const [isForcedPlaced, setIsForcedPlaced] = useState(false);
  const [applicableDeductible, setApplicableDeductible] = useState<string>(data.applicableDeductible || '');
  const [insurerPersonnel, setInsurerPersonnel] = useState(data.insurerPersonnel || []);

  // Update parent data whenever local state changes
  useEffect(() => {
    onUpdate({
      ...data,
      insuranceCarrier,
      policyDetails,
      coverages,
      deductibles,
      priorPayments,
      applicableDeductible,
      insurerPersonnel
    });
  }, [insuranceCarrier, policyDetails, coverages, deductibles, priorPayments, applicableDeductible, insurerPersonnel]);

  // Coverage Management
  const addCoverage = () => {
    const newCoverage: Coverage = {
      id: Date.now().toString(),
      type: '',
      limit: 0
    };
    setCoverages([...coverages, newCoverage]);
  };

  const updateCoverage = (id: string, field: keyof Coverage, value: any) => {
    setCoverages(coverages.map(coverage => 
      coverage.id === id ? { ...coverage, [field]: value } : coverage
    ));
  };

  const removeCoverage = (id: string) => {
    setCoverages(coverages.filter(coverage => coverage.id !== id));
  };

  // Deductible Management
  const addDeductible = () => {
    const newDeductible: Deductible = {
      id: Date.now().toString(),
      type: '',
      amount: 0,
      isPercentage: false
    };
    setDeductibles([...deductibles, newDeductible]);
  };

  const updateDeductible = (id: string, field: keyof Deductible, value: any) => {
    setDeductibles(deductibles.map(deductible => {
      if (deductible.id === id) {
        const updated = { ...deductible, [field]: value };
        
        // Auto-calculate amount when percentage fields change
        if (field === 'isPercentage' || field === 'percentageOf' || field === 'percentageValue') {
          if (updated.isPercentage && updated.percentageOf && updated.percentageValue) {
            const selectedCoverage = coverages.find(c => c.id === updated.percentageOf);
            if (selectedCoverage && selectedCoverage.limit) {
              updated.calculatedAmount = (selectedCoverage.limit * updated.percentageValue) / 100;
              if (!updated.isAmountOverridden) {
                updated.amount = updated.calculatedAmount;
              }
            }
          }
        }
        
        // Mark amount as overridden if user manually changes it while percentage is active
        if (field === 'amount' && updated.isPercentage && updated.calculatedAmount) {
          updated.isAmountOverridden = value !== updated.calculatedAmount;
        }
        
        return updated;
      }
      return deductible;
    }));
  };

  const removeDeductible = (id: string) => {
    setDeductibles(deductibles.filter(deductible => deductible.id !== id));
  };

  // Prior Payment Management
  const addPriorPayment = () => {
    const newPayment: PriorPayment = {
      id: Date.now().toString(),
      amount: 0,
      date: '',
      description: ''
    };
    setPriorPayments([...priorPayments, newPayment]);
  };

  const updatePriorPayment = (id: string, field: keyof PriorPayment, value: any) => {
    setPriorPayments(priorPayments.map(payment => 
      payment.id === id ? { ...payment, [field]: value } : payment
    ));
  };

  const removePriorPayment = (id: string) => {
    setPriorPayments(priorPayments.filter(payment => payment.id !== id));
  };

  return (
    <div className="space-y-6">
      {/* Insurance Carrier Information */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Shield className="h-5 w-5" />
            Insurance Carrier Information
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium mb-1">Insurance Carrier *</label>
              <select
                value={insuranceCarrier.name || ''}
                onChange={(e) => setInsuranceCarrier({
                  ...insuranceCarrier,
                  name: e.target.value
                })}
                className="w-full p-2 border rounded-lg"
                required
              >
                <option value="">Select carrier</option>
                <option value="State Farm">State Farm</option>
                <option value="Allstate">Allstate</option>
                <option value="GEICO">GEICO</option>
                <option value="Progressive">Progressive</option>
                <option value="USAA">USAA</option>
                <option value="Farmers">Farmers</option>
                <option value="Liberty Mutual">Liberty Mutual</option>
                <option value="Nationwide">Nationwide</option>
                <option value="American Family">American Family</option>
                <option value="Travelers">Travelers</option>
                <option value="Other">Other</option>
              </select>
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Policy Number *</label>
              <Input
                value={policyDetails.policyNumber || ''}
                onChange={(e) => setPolicyDetails({
                  ...policyDetails,
                  policyNumber: e.target.value
                })}
                placeholder="Enter policy number"
                required
              />
            </div>
          </div>

          {/* Forced Placed Policy */}
          <div>
            <label className="flex items-center gap-2">
              <input
                type="checkbox"
                checked={isForcedPlaced}
                onChange={(e) => setIsForcedPlaced(e.target.checked)}
                className="rounded"
              />
              <span className="text-sm">This is a forced-placed policy</span>
            </label>
          </div>

          {/* Comprehensive Agent Information */}
          <div className="space-y-6 border-t pt-6">
            <h4 className="font-medium text-gray-900 mb-4 flex items-center gap-2">
              <User className="h-5 w-5 text-green-600" />
              Insurance Agent & Agency Information
            </h4>
            
            {/* Agency Information */}
            <div className="bg-gray-50 p-4 rounded-lg">
              <h5 className="font-medium text-gray-800 mb-3 flex items-center gap-2">
                <Building className="h-4 w-4 text-blue-600" />
                Agency Details
              </h5>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Agency Name *</label>
                  <Input
                    value={insuranceCarrier.agentInfo?.agencyName || ''}
                    onChange={(e) => setInsuranceCarrier({
                      ...insuranceCarrier,
                      agentInfo: {
                        ...insuranceCarrier.agentInfo,
                        agencyName: e.target.value
                      }
                    })}
                    placeholder="Insurance agency name"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Agency License Number</label>
                  <Input
                    value={insuranceCarrier.agentInfo?.agencyLicenseNumber || ''}
                    onChange={(e) => setInsuranceCarrier({
                      ...insuranceCarrier,
                      agentInfo: {
                        ...insuranceCarrier.agentInfo,
                        agencyLicenseNumber: e.target.value
                      }
                    })}
                    placeholder="License number"
                  />
                </div>
              </div>
            </div>

            {/* Agent Personal Information */}
            <div className="bg-blue-50 p-4 rounded-lg">
              <h5 className="font-medium text-gray-800 mb-3 flex items-center gap-2">
                <User className="h-4 w-4 text-green-600" />
                Agent Details
              </h5>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Agent First Name *</label>
                  <Input
                    value={insuranceCarrier.agentInfo?.agentFirstName || ''}
                    onChange={(e) => setInsuranceCarrier({
                      ...insuranceCarrier,
                      agentInfo: {
                        ...insuranceCarrier.agentInfo,
                        agentFirstName: e.target.value
                      }
                    })}
                    placeholder="First name"
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Agent Last Name *</label>
                  <Input
                    value={insuranceCarrier.agentInfo?.agentLastName || ''}
                    onChange={(e) => setInsuranceCarrier({
                      ...insuranceCarrier,
                      agentInfo: {
                        ...insuranceCarrier.agentInfo,
                        agentLastName: e.target.value
                      }
                    })}
                    placeholder="Last name"
                    required
                  />
                </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label className="block text-sm font-medium mb-1">Agent Phone *</label>
                  <Input
                    type="tel"
                    value={insuranceCarrier.agentInfo?.agentPhone || ''}
                    onChange={(e) => setInsuranceCarrier({
                      ...insuranceCarrier,
                      agentInfo: {
                        ...insuranceCarrier.agentInfo,
                        agentPhone: formatPhoneNumber(e.target.value)
                      }
                    })}
                    placeholder="(555) 123-4567"
                    {...getPhoneInputProps()}
                    required
                  />
                </div>
                <div>
                  <label className="block text-sm font-medium mb-1">Agent Email *</label>
                  <Input
                    type="email"
                    value={insuranceCarrier.agentInfo?.agentEmail || ''}
                    onChange={(e) => setInsuranceCarrier({
                      ...insuranceCarrier,
                      agentInfo: {
                        ...insuranceCarrier.agentInfo,
                        agentEmail: e.target.value
                      }
                    })}
                    placeholder="agent@insurance.com"
                    required
                  />
                </div>
              </div>
            </div>

            {/* Agent Address */}
            <div className="bg-green-50 p-4 rounded-lg">
              <h5 className="font-medium text-gray-800 mb-3 flex items-center gap-2">
                <MapPin className="h-4 w-4 text-orange-600" />
                Agent/Agency Address
              </h5>
              
              <div className="space-y-4">
                <AddressAutocomplete
                  value={insuranceCarrier.agentInfo?.agentAddress?.addressLine1 || ''}
                  onChange={(address, details) => {
                    console.log('ðŸ¢ Manual Agent Address Selected:', { address, details })
                    
                    if (details?.address_components) {
                      const components = details.address_components;
                      console.log('ðŸ“ Manual Address Components:', components)
                      
                      // Extract street number and route for addressLine1
                      const streetNumber = components.find(c => c.types.includes('street_number'))?.long_name || ''
                      const route = components.find(c => c.types.includes('route'))?.long_name || ''
                      const fullStreet = `${streetNumber} ${route}`.trim()
                      
                      // Extract city (locality, sublocality, or administrative_area_level_3)
                      const city = components.find(c => c.types.includes('locality'))?.long_name || 
                                  components.find(c => c.types.includes('sublocality'))?.long_name ||
                                  components.find(c => c.types.includes('administrative_area_level_3'))?.long_name || ''
                      
                      // Extract state (administrative_area_level_1)
                      const state = components.find(c => c.types.includes('administrative_area_level_1'))?.short_name || ''
                      
                      // Extract zip code (postal_code)
                      const zipCode = components.find(c => c.types.includes('postal_code'))?.long_name || ''
                      
                      console.log('ðŸ“Š Manual Parsed Address Components:', { fullStreet, city, state, zipCode })
                      
                      // Update all address fields at once
                      setInsuranceCarrier(prev => ({
                        ...prev,
                        agentInfo: {
                          ...prev.agentInfo,
                          agentAddress: {
                            ...prev.agentInfo?.agentAddress,
                            addressLine1: fullStreet || address,
                            city: city || prev.agentInfo?.agentAddress?.city || '',
                            state: state || prev.agentInfo?.agentAddress?.state || '',
                            zipCode: zipCode || prev.agentInfo?.agentAddress?.zipCode || ''
                          }
                        }
                      }));
                    } else {
                      // Fallback for when no details are provided
                      setInsuranceCarrier(prev => ({
                        ...prev,
                        agentInfo: {
                          ...prev.agentInfo,
                          agentAddress: {
                            ...prev.agentInfo?.agentAddress,
                            addressLine1: address
                          }
                        }
                      }));
                    }
                  }}
                  label="Agent/Agency Address"
                  placeholder="Start typing agent/agency address..."
                />
                
                <div>
                  <label className="block text-sm font-medium mb-1">Address Line 2 (Optional)</label>
                  <Input
                    value={insuranceCarrier.agentInfo?.agentAddress?.addressLine2 || ''}
                    onChange={(e) => setInsuranceCarrier({
                      ...insuranceCarrier,
                      agentInfo: {
                        ...insuranceCarrier.agentInfo,
                        agentAddress: {
                          ...insuranceCarrier.agentInfo?.agentAddress,
                          addressLine2: e.target.value
                        }
                      }
                    })}
                    placeholder="Suite, Unit, etc."
                  />
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div>
                    <label className="block text-sm font-medium mb-1">City</label>
                    <Input
                      value={insuranceCarrier.agentInfo?.agentAddress?.city || ''}
                      onChange={(e) => setInsuranceCarrier({
                        ...insuranceCarrier,
                        agentInfo: {
                          ...insuranceCarrier.agentInfo,
                          agentAddress: {
                            ...insuranceCarrier.agentInfo?.agentAddress,
                            city: e.target.value
                          }
                        }
                      })}
                      placeholder="City"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">State</label>
                    <Input
                      value={insuranceCarrier.agentInfo?.agentAddress?.state || ''}
                      onChange={(e) => setInsuranceCarrier({
                        ...insuranceCarrier,
                        agentInfo: {
                          ...insuranceCarrier.agentInfo,
                          agentAddress: {
                            ...insuranceCarrier.agentInfo?.agentAddress,
                            state: e.target.value
                          }
                        }
                      })}
                      placeholder="State"
                    />
                  </div>
                  <div>
                    <label className="block text-sm font-medium mb-1">ZIP Code</label>
                    <Input
                      value={insuranceCarrier.agentInfo?.agentAddress?.zipCode || ''}
                      onChange={(e) => setInsuranceCarrier({
                        ...insuranceCarrier,
                        agentInfo: {
                          ...insuranceCarrier.agentInfo,
                          agentAddress: {
                            ...insuranceCarrier.agentInfo?.agentAddress,
                            zipCode: e.target.value
                          }
                        }
                      })}
                      placeholder="ZIP Code"
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Policy Details */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Calendar className="h-5 w-5" />
            Policy Details
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="grid grid-cols-3 gap-4">
            <div>
              <label className="block text-sm font-medium mb-1">Effective Date *</label>
              <Input
                type="date"
                value={policyDetails.effectiveDate || ''}
                onChange={(e) => {
                  const effectiveDate = e.target.value
                  // Automatically calculate expiration date (1 year later)
                  let expirationDate = ''
                  if (effectiveDate) {
                    const date = new Date(effectiveDate)
                    date.setFullYear(date.getFullYear() + 1)
                    expirationDate = date.toISOString().split('T')[0] // YYYY-MM-DD format
                  }
                  
                  setPolicyDetails({
                    ...policyDetails,
                    effectiveDate: effectiveDate,
                    expirationDate: expirationDate
                  })
                }}
                required
              />
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Expiration Date *</label>
              <Input
                type="date"
                value={policyDetails.expirationDate || ''}
                onChange={(e) => setPolicyDetails({
                  ...policyDetails,
                  expirationDate: e.target.value
                })}
                required
              />
              <p className="text-xs text-gray-500 mt-1">
                âœ¨ Auto-calculated as 1 year after effective date
              </p>
            </div>
            <div>
              <label className="block text-sm font-medium mb-1">Policy Type</label>
              <select
                value={policyDetails.policyType || ''}
                onChange={(e) => setPolicyDetails({
                  ...policyDetails,
                  policyType: e.target.value
                })}
                className="w-full p-2 border rounded-lg"
              >
                <option value="">Select type</option>
                <option value="Homeowners">Homeowners</option>
                <option value="Renters">Renters</option>
                <option value="Condo">Condo</option>
                <option value="Commercial">Commercial</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Insurer Personnel Information */}
      <InsurerPersonnelInformation
        data={insurerPersonnel}
        onUpdate={setInsurerPersonnel}
        insurerName={insuranceCarrier.name || 'the insurance company'}
      />

      {/* Coverage Information */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Shield className="h-5 w-5" />
            Coverage Information
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {coverages.map((coverage) => (
            <div key={coverage.id} className="flex items-center gap-4 p-3 border rounded-lg">
              <div className="flex-1">
                <select
                  value={coverage.type}
                  onChange={(e) => updateCoverage(coverage.id, 'type', e.target.value)}
                  className="w-full p-2 border rounded-lg"
                >
                  <option value="">Select coverage type</option>
                  <option value="Dwelling">Dwelling (Coverage A)</option>
                  <option value="Other Structures">Other Structures (Coverage B)</option>
                  <option value="Personal Property">Personal Property (Coverage C)</option>
                  <option value="Loss of Use">Loss of Use (Coverage D)</option>
                  <option value="Personal Liability">Personal Liability</option>
                  <option value="Medical Payments">Medical Payments</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              {coverage.type === 'Other' && (
                <div className="flex-1">
                  <Input
                    value={coverage.otherDescription || ''}
                    onChange={(e) => updateCoverage(coverage.id, 'otherDescription', e.target.value)}
                    placeholder="Describe other coverage type"
                    className="w-full"
                  />
                </div>
              )}
              <div className="w-32">
                <Input
                  type="number"
                  value={coverage.limit || ''}
                  onChange={(e) => updateCoverage(coverage.id, 'limit', parseInt(e.target.value) || 0)}
                  onFocus={(e) => e.target.select()}
                  onKeyDown={(e) => {
                    // Clear field on first digit input if current value is 0
                    if (coverage.limit === 0 && /\d/.test(e.key)) {
                      updateCoverage(coverage.id, 'limit', '');
                    }
                  }}
                  placeholder="0"
                  min="0"
                />
              </div>
              <Button
                onClick={() => removeCoverage(coverage.id)}
                variant="ghost"
                size="sm"
                className="text-red-600 hover:text-red-700"
              >
                <X className="h-4 w-4" />
              </Button>
            </div>
          ))}
          
          <Button
            onClick={addCoverage}
            variant="outline"
            className="w-full flex items-center gap-2"
          >
            <Plus className="h-4 w-4" />
            Add Coverage
          </Button>
        </CardContent>
      </Card>

      {/* Deductibles */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <DollarSign className="h-5 w-5" />
            Deductibles
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {deductibles.map((deductible) => (
            <div key={deductible.id} className="p-4 border rounded-lg space-y-3">
              {/* First Row: Type and Other Description */}
              <div className="flex items-center gap-4">
                <div className="flex-1">
                  <label className="block text-sm font-medium mb-1">Deductible Type</label>
                  <select
                    value={deductible.type}
                    onChange={(e) => updateDeductible(deductible.id, 'type', e.target.value)}
                    className="w-full p-2 border rounded-lg"
                  >
                    <option value="">Select deductible type</option>
                    <option value="All Other Perils">All Other Perils</option>
                    <option value="Wind/Hail">Wind/Hail</option>
                    <option value="Windstorm">Windstorm</option>
                    <option value="Hurricane">Hurricane</option>
                    <option value="Earthquake">Earthquake</option>
                    <option value="Flood">Flood</option>
                    <option value="Other">Other</option>
                  </select>
                </div>
                {deductible.type === 'Other' && (
                  <div className="flex-1">
                    <label className="block text-sm font-medium mb-1">Description</label>
                    <Input
                      value={deductible.otherDescription || ''}
                      onChange={(e) => updateDeductible(deductible.id, 'otherDescription', e.target.value)}
                      placeholder="Describe other deductible type"
                      className="w-full"
                    />
                  </div>
                )}
                <div className="flex items-end">
                  <Button
                    onClick={() => removeDeductible(deductible.id)}
                    variant="ghost"
                    size="sm"
                    className="text-red-600 hover:text-red-700"
                  >
                    <X className="h-4 w-4" />
                  </Button>
                </div>
              </div>

              {/* Second Row: Percentage Controls */}
              <div className="flex items-center gap-4">
                <div className="flex items-center gap-2">
                  <input
                    type="checkbox"
                    checked={deductible.isPercentage}
                    onChange={(e) => updateDeductible(deductible.id, 'isPercentage', e.target.checked)}
                    className="h-4 w-4"
                  />
                  <label className="text-sm font-medium">Calculate as Percentage</label>
                </div>
                
                {deductible.isPercentage && (
                  <>
                    <div className="w-48">
                      <label className="block text-sm font-medium mb-1">Percentage Of</label>
                      <select
                        value={deductible.percentageOf || ''}
                        onChange={(e) => updateDeductible(deductible.id, 'percentageOf', e.target.value)}
                        className="w-full p-2 border rounded-lg"
                      >
                        <option value="">Select coverage</option>
                        {coverages.map((coverage) => (
                          <option key={coverage.id} value={coverage.id}>
                            {coverage.type}{coverage.type === 'Other' && coverage.otherDescription ? ` (${coverage.otherDescription})` : ''} - ${coverage.limit?.toLocaleString() || 0}
                          </option>
                        ))}
                      </select>
                    </div>
                    
                    <div className="w-20">
                      <label className="block text-sm font-medium mb-1">%</label>
                      <Input
                        type="number"
                        value={deductible.percentageValue || ''}
                        onChange={(e) => updateDeductible(deductible.id, 'percentageValue', parseFloat(e.target.value) || 0)}
                        onFocus={(e) => e.target.select()}
                        placeholder="0"
                        min="0"
                        max="100"
                        step="0.1"
                      />
                    </div>
                  </>
                )}
              </div>

              {/* Third Row: Amount and Calculation Display */}
              <div className="flex items-center gap-4">
                <div className="w-32">
                  <label className="block text-sm font-medium mb-1">Amount ($)</label>
                  <Input
                    type="number"
                    value={deductible.amount || ''}
                    onChange={(e) => updateDeductible(deductible.id, 'amount', parseFloat(e.target.value) || 0)}
                    onFocus={(e) => e.target.select()}
                    onKeyDown={(e) => {
                      // Clear field on first digit input if current value is 0
                      if (deductible.amount === 0 && /\d/.test(e.key)) {
                        updateDeductible(deductible.id, 'amount', '');
                      }
                    }}
                    placeholder="0"
                    min="0"
                    disabled={deductible.isPercentage && deductible.calculatedAmount && !deductible.isAmountOverridden}
                  />
                </div>
                
                {deductible.isPercentage && deductible.calculatedAmount && (
                  <div className="flex-1 text-sm">
                    <span className="text-gray-600">
                      Auto-calculated: ${deductible.calculatedAmount.toLocaleString()}
                      {deductible.isAmountOverridden && (
                        <span className="text-orange-600 ml-2">(Overridden by user)</span>
                      )}
                    </span>
                  </div>
                )}
              </div>

              {/* Fourth Row: Claim Applicability */}
              <div className="flex items-center gap-4">
                <div className="w-48">
                  <label className="block text-sm font-medium mb-1">Applies to This Claim</label>
                  <select
                    value={deductible.appliesTo || ''}
                    onChange={(e) => updateDeductible(deductible.id, 'appliesTo', e.target.value)}
                    className="w-full p-2 border rounded-lg"
                  >
                    <option value="">Not applicable</option>
                    <option value="Yes">Yes - This deductible applies</option>
                    <option value="No">No - This deductible does not apply</option>
                  </select>
                </div>
                {deductible.appliesTo === 'Yes' && (
                  <div className="text-sm text-green-600 flex items-center gap-1">
                    <CheckCircle className="h-4 w-4" />
                    This deductible will be applied to the claim
                  </div>
                )}
              </div>
            </div>
          ))}
          
          <Button
            onClick={addDeductible}
            variant="outline"
            className="w-full flex items-center gap-2"
          >
            <Plus className="h-4 w-4" />
            Add Deductible
          </Button>
        </CardContent>
      </Card>

      {/* Prior Payments */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <DollarSign className="h-5 w-5" />
            Prior Payments (Optional)
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {priorPayments.map((payment) => (
            <div key={payment.id} className="p-4 border rounded-lg space-y-3">
              {/* First Row: Description and Coverage */}
              <div className="flex items-center gap-4">
                <div className="flex-1">
                  <label className="block text-sm font-medium mb-1">Payment Description</label>
                  <Input
                    value={payment.description}
                    onChange={(e) => updatePriorPayment(payment.id, 'description', e.target.value)}
                    placeholder="Payment description"
                  />
                </div>
                <div className="w-48">
                  <label className="block text-sm font-medium mb-1">Coverage Paid For</label>
                  <select
                    value={payment.coverageId || ''}
                    onChange={(e) => updatePriorPayment(payment.id, 'coverageId', e.target.value)}
                    className="w-full p-2 border rounded-lg"
                  >
                    <option value="">Select coverage</option>
                    {coverages.map((coverage) => (
                      <option key={coverage.id} value={coverage.id}>
                        {coverage.type}{coverage.type === 'Other' && coverage.otherDescription ? ` (${coverage.otherDescription})` : ''}
                      </option>
                    ))}
                  </select>
                </div>
                <div className="flex items-end">
                  <Button
                    onClick={() => removePriorPayment(payment.id)}
                    variant="ghost"
                    size="sm"
                    className="text-red-600 hover:text-red-700"
                  >
                    <X className="h-4 w-4" />
                  </Button>
                </div>
              </div>

              {/* Second Row: Amount, Date, and Deductible */}
              <div className="flex items-center gap-4">
                <div className="w-32">
                  <label className="block text-sm font-medium mb-1">Amount ($)</label>
                  <Input
                    type="number"
                    value={payment.amount || ''}
                    onChange={(e) => updatePriorPayment(payment.id, 'amount', parseFloat(e.target.value) || 0)}
                    onFocus={(e) => e.target.select()}
                    onKeyDown={(e) => {
                      // Clear field on first digit input if current value is 0
                      if (payment.amount === 0 && /\d/.test(e.key)) {
                        updatePriorPayment(payment.id, 'amount', '');
                      }
                    }}
                    placeholder="0"
                    min="0"
                  />
                </div>
                <div className="w-36">
                  <label className="block text-sm font-medium mb-1">Payment Date</label>
                  <Input
                    type="date"
                    value={payment.date}
                    onChange={(e) => updatePriorPayment(payment.id, 'date', e.target.value)}
                  />
                </div>
                <div className="w-32">
                  <label className="block text-sm font-medium mb-1">Deductible Applied ($)</label>
                  <Input
                    type="number"
                    value={payment.deductibleApplied || ''}
                    onChange={(e) => updatePriorPayment(payment.id, 'deductibleApplied', parseFloat(e.target.value) || 0)}
                    onFocus={(e) => e.target.select()}
                    onKeyDown={(e) => {
                      // Clear field on first digit input if current value is 0
                      if ((payment.deductibleApplied || 0) === 0 && /\d/.test(e.key)) {
                        updatePriorPayment(payment.id, 'deductibleApplied', '');
                      }
                    }}
                    placeholder="0"
                    min="0"
                  />
                </div>
              </div>

              {/* Third Row: Depreciation Fields */}
              <div className="flex items-center gap-4">
                <div className="w-40">
                  <label className="block text-sm font-medium mb-1">Recoverable Depreciation ($)</label>
                  <Input
                    type="number"
                    value={payment.recoverableDepreciation || ''}
                    onChange={(e) => updatePriorPayment(payment.id, 'recoverableDepreciation', parseFloat(e.target.value) || 0)}
                    onFocus={(e) => e.target.select()}
                    onKeyDown={(e) => {
                      // Clear field on first digit input if current value is 0
                      if ((payment.recoverableDepreciation || 0) === 0 && /\d/.test(e.key)) {
                        updatePriorPayment(payment.id, 'recoverableDepreciation', '');
                      }
                    }}
                    placeholder="0"
                    min="0"
                  />
                </div>
                <div className="w-40">
                  <label className="block text-sm font-medium mb-1">Non-Recoverable Depreciation ($)</label>
                  <Input
                    type="number"
                    value={payment.nonRecoverableDepreciation || ''}
                    onChange={(e) => updatePriorPayment(payment.id, 'nonRecoverableDepreciation', parseFloat(e.target.value) || 0)}
                    onFocus={(e) => e.target.select()}
                    onKeyDown={(e) => {
                      // Clear field on first digit input if current value is 0
                      if ((payment.nonRecoverableDepreciation || 0) === 0 && /\d/.test(e.key)) {
                        updatePriorPayment(payment.id, 'nonRecoverableDepreciation', '');
                      }
                    }}
                    placeholder="0"
                    min="0"
                  />
                </div>
                <div className="flex-1">
                  {/* Payment Calculation Display */}
                  <div className="text-sm text-gray-600 pt-6 space-y-1">
                    <div>
                      <span className="font-medium text-green-700">
                        Net Payment Issued: ${((payment.amount || 0) - (payment.nonRecoverableDepreciation || 0) - (payment.deductibleApplied || 0)).toLocaleString()}
                      </span>
                    </div>
                    {(payment.recoverableDepreciation || 0) > 0 && (
                      <div className="text-xs text-blue-600">
                        + ${(payment.recoverableDepreciation || 0).toLocaleString()} recoverable after repairs
                      </div>
                    )}
                  </div>
                </div>
              </div>
            </div>
          ))}
          
          <Button
            onClick={addPriorPayment}
            variant="outline"
            className="w-full flex items-center gap-2"
          >
            <Plus className="h-4 w-4" />
            Add Prior Payment
          </Button>
        </CardContent>
      </Card>

      {/* Applicable Deductible for This Claim */}
      {deductibles.length > 0 && (
        <Card>
          <CardHeader>
            <CardTitle className="flex items-center gap-2">
              <Shield className="h-5 w-5" />
              Applicable Deductible for This Claim
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <p className="text-sm text-blue-800">
                  Select which deductible applies to this specific claim. This will be used for calculations and reporting.
                </p>
              </div>
              
              <div className="grid grid-cols-1 gap-3">
                <div>
                  <label className="block text-sm font-medium mb-2">
                    Select Applicable Deductible *
                  </label>
                  <select
                    value={applicableDeductible}
                    onChange={(e) => setApplicableDeductible(e.target.value)}
                    className="w-full p-3 border rounded-lg"
                  >
                    <option value="">Select the deductible that applies to this claim</option>
                    {deductibles.map((deductible) => (
                      <option key={deductible.id} value={deductible.id}>
                        {deductible.type}
                        {deductible.type === 'Other' && deductible.otherDescription ? ` (${deductible.otherDescription})` : ''} - 
                        ${deductible.amount?.toLocaleString() || 0}
                        {deductible.isPercentage && deductible.percentageValue ? ` (${deductible.percentageValue}%)` : ''}
                      </option>
                    ))}
                  </select>
                </div>
                
                {applicableDeductible && (
                  <div className="bg-green-50 border border-green-200 rounded-lg p-3">
                    {(() => {
                      const selectedDeductible = deductibles.find(d => d.id === applicableDeductible);
                      return selectedDeductible ? (
                        <div className="text-sm text-green-800">
                          <div className="flex items-center gap-2 mb-2">
                            <CheckCircle className="h-4 w-4" />
                            <span className="font-medium">Selected Deductible Details:</span>
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <span className="font-medium">Type:</span> {selectedDeductible.type}
                              {selectedDeductible.type === 'Other' && selectedDeductible.otherDescription && (
                                <span> ({selectedDeductible.otherDescription})</span>
                              )}
                            </div>
                            <div>
                              <span className="font-medium">Amount:</span> ${selectedDeductible.amount?.toLocaleString() || 0}
                            </div>
                            {selectedDeductible.isPercentage && (
                              <>
                                <div>
                                  <span className="font-medium">Percentage:</span> {selectedDeductible.percentageValue}%
                                </div>
                                <div>
                                  <span className="font-medium">Calculated From:</span> {
                                    coverages.find(c => c.id === selectedDeductible.percentageOf)?.type || 'Unknown Coverage'
                                  }
                                </div>
                              </>
                            )}
                          </div>
                        </div>
                      ) : null;
                    })()}
                  </div>
                )}
              </div>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
};