import React, { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { Input } from '../components/ui/Input'
import { IntegrationSetupModal } from '../components/integrations/IntegrationSetupModal'
import { useToast } from '../hooks/useToast'
import { useAuth } from '../contexts/AuthContext'
import { supabase } from '../lib/supabase'
import {
  Settings,
  Plus,
  Check,
  X,
  Eye,
  EyeOff,
  RefreshCw,
  Activity,
  AlertTriangle,
  ExternalLink,
  Key,
  Shield,
  Zap,
  Mail,
  MessageSquare,
  Calendar as CalendarIcon,
  CreditCard,
  Brain,
  Video,
  HardDrive,
  FileText,
  Calculator
} from 'lucide-react'

interface IntegrationProvider {
  id: string
  name: string
  category: string
  description: string
  website_url?: string
  documentation_url?: string
  logo_url?: string
  is_active: boolean
  is_core_service?: boolean
  required_credentials: Record<string, boolean>
  supported_features: Record<string, boolean>
  pricing_info: Record<string, any>
  setup_instructions?: string
  credential_fields?: Record<string, any>
  setup_steps?: string[]
  help_url?: string
}

interface OrganizationIntegration {
  id: string
  provider_id: string
  is_enabled: boolean
  configuration: Record<string, any>
  sync_status: string
  error_message?: string
  last_sync_at?: string
  usage_stats: Record<string, any>
  provider: IntegrationProvider
}

export function Integrations() {
  const { userProfile } = useAuth()
  const { success, error } = useToast()
  const [providers, setProviders] = useState<IntegrationProvider[]>([])
  const [integrations, setIntegrations] = useState<OrganizationIntegration[]>([])
  const [loading, setLoading] = useState(true)
  const [selectedCategory, setSelectedCategory] = useState<string>('all')
  const [showCredentials, setShowCredentials] = useState<Record<string, boolean>>({})
  const [configureIntegration, setConfigureIntegration] = useState<IntegrationProvider | null>(null)
  const [credentials, setCredentials] = useState<Record<string, string>>({})

  useEffect(() => {
    if (userProfile?.organization_id) {
      loadIntegrations()
    }
  }, [userProfile?.organization_id])

  async function loadIntegrations() {
    if (!userProfile?.organization_id) return

    try {
      setLoading(true)

      // Load all available providers (excluding core services)
      const { data: providersData, error: providersError } = await supabase
        .from('integration_providers')
        .select('*')
        .eq('is_active', true)
        .eq('is_core_service', false)  // Filter out core platform services
        .order('category', { ascending: true })

      if (providersError) throw providersError

      // Load organization's configured integrations
      const { data: integrationsData, error: integrationsError } = await supabase
        .from('organization_integrations')
        .select(`
          *,
          provider:integration_providers(*)
        `)
        .eq('organization_id', userProfile.organization_id)

      if (integrationsError) throw integrationsError

      setProviders(providersData || [])
      setIntegrations(integrationsData || [])
    } catch (error: any) {
      console.error('Error loading integrations:', error)
      error('Failed to load integrations', error.message)
    } finally {
      setLoading(false)
    }
  }

  async function toggleIntegration(providerId: string, enabled: boolean) {
    if (!userProfile?.organization_id) return

    try {
      if (enabled) {
        // Check if provider requires setup
        const provider = providers.find(p => p.id === providerId)
        if (provider && provider.credential_fields && Object.keys(provider.credential_fields).length > 0) {
          // Open setup modal instead of directly enabling
          setConfigureIntegration(provider)
          return
        }

        // Enable integration - create/update record
        const { error } = await supabase
          .from('organization_integrations')
          .upsert({
            organization_id: userProfile.organization_id,
            provider_id: providerId,
            is_enabled: true,
            configuration: {},
            sync_status: 'disconnected'
          })

        if (error) throw error
        success('Integration enabled', 'You can now configure the connection.')
      } else {
        // Disable integration
        const { error } = await supabase
          .from('organization_integrations')
          .update({ is_enabled: false, sync_status: 'disconnected' })
          .eq('organization_id', userProfile.organization_id)
          .eq('provider_id', providerId)

        if (error) throw error
        success('Integration disabled')
      }

      await loadIntegrations()
    } catch (error: any) {
      console.error('Error toggling integration:', error)
      error('Failed to update integration', error.message)
    }
  }

  async function saveCredentials(providerId: string, credentials: Record<string, string> = {}) {
    if (!userProfile?.organization_id) return

    try {
      // First enable the integration
      const { error: upsertError } = await supabase
        .from('organization_integrations')
        .upsert({
          organization_id: userProfile.organization_id,
          provider_id: providerId,
          is_enabled: true,
          credentials_encrypted: JSON.stringify(credentials),
          sync_status: 'connected',
          configuration: credentials
        })

      if (upsertError) throw upsertError

      success('Integration connected', 'Your credentials have been saved and the integration is now active.')
      setConfigureIntegration(null)
      await loadIntegrations()
    } catch (error: any) {
      console.error('Error saving credentials:', error)
      error('Failed to save credentials', error.message)
    }
  }

  function getCategoryIcon(category: string) {
    const icons = {
      email: Mail,
      sms: MessageSquare,
      calendar: CalendarIcon,
      payment: CreditCard,
      ai: Brain,
      video: Video,
      storage: HardDrive,
      documents: FileText,
      accounting: Calculator
    }
    const IconComponent = icons[category as keyof typeof icons] || Settings
    return <IconComponent className="h-5 w-5" />
  }

  function getStatusColor(status: string): string {
    const colors = {
      connected: 'text-green-600 bg-green-100',
      disconnected: 'text-gray-600 bg-gray-100',
      error: 'text-red-600 bg-red-100',
      syncing: 'text-blue-600 bg-blue-100'
    }
    return colors[status as keyof typeof colors] || 'text-gray-600 bg-gray-100'
  }

  function getStatusIcon(status: string) {
    switch (status) {
      case 'connected':
        return <Check className="h-4 w-4" />
      case 'error':
        return <AlertTriangle className="h-4 w-4" />
      case 'syncing':
        return <RefreshCw className="h-4 w-4 animate-spin" />
      default:
        return <X className="h-4 w-4" />
    }
  }

  // Only show user-configurable integrations (not core services)
  const userConfigurableProviders = providers.filter(p => !p.is_core_service)
  const categories = ['all', ...Array.from(new Set(userConfigurableProviders.map(p => p.category)))]
  const filteredProviders = selectedCategory === 'all' 
    ? userConfigurableProviders 
    : userConfigurableProviders.filter(p => p.category === selectedCategory)

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <LoadingSpinner />
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex flex-col sm:flex-row sm:items-center sm:justify-between">
        <div>
          <h1 className="text-2xl font-bold text-gray-900">Third-Party Integrations</h1>
          <p className="text-gray-600">Connect external services to enhance your workflow</p>
        </div>
        <div className="flex gap-2 mt-4 sm:mt-0">
          <Button variant="outline" className="flex items-center gap-2">
            <Activity className="h-4 w-4" />
            View Logs
          </Button>
          <Button variant="outline" className="flex items-center gap-2">
            <Key className="h-4 w-4" />
            API Keys
          </Button>
        </div>
      </div>

      {/* Category Filter */}
      <div className="flex flex-wrap gap-2">
        {categories.map((category) => (
          <Button
            key={category}
            variant={selectedCategory === category ? "primary" : "outline"}
            size="sm"
            onClick={() => setSelectedCategory(category)}
            className="capitalize"
          >
            {category === 'all' ? 'All Categories' : category}
          </Button>
        ))}
      </div>

      {/* Integration Cards */}
      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {filteredProviders.map((provider) => {
          const integration = integrations.find(i => i.provider_id === provider.id)
          const isEnabled = integration?.is_enabled || false
          const status = integration?.sync_status || 'disconnected'

          return (
            <Card key={provider.id} className="relative hover:shadow-lg transition-shadow">
              <CardHeader className="pb-4">
                <div className="flex items-start justify-between">
                  <div className="flex items-center gap-3">
                    <div className={`p-2 rounded-lg ${isEnabled ? 'bg-blue-100' : 'bg-gray-100'}`}>
                      {getCategoryIcon(provider.category)}
                    </div>
                    <div>
                      <CardTitle className="text-lg">{provider.name}</CardTitle>
                      <p className="text-sm text-gray-500 capitalize">{provider.category}</p>
                    </div>
                  </div>
                  
                  {/* Status Badge */}
                  <div className={`px-2 py-1 rounded-full text-xs font-medium flex items-center gap-1 ${getStatusColor(status)}`}>
                    {getStatusIcon(status)}
                    {status}
                  </div>
                </div>
              </CardHeader>

              <CardContent>
                <p className="text-sm text-gray-600 mb-4">{provider.description}</p>

                {/* Features */}
                <div className="mb-4">
                  <h4 className="text-sm font-medium mb-2">Features:</h4>
                  <div className="flex flex-wrap gap-1">
                    {Object.entries(provider.supported_features).slice(0, 3).map(([feature, supported]) => (
                      supported && (
                        <span key={feature} className="px-2 py-1 bg-gray-100 text-xs rounded">
                          {feature.replace(/_/g, ' ')}
                        </span>
                      )
                    ))}
                  </div>
                </div>

                {/* Action Buttons */}
                <div className="flex items-center justify-between">
                  <div className="flex items-center gap-2">
                    <label className="relative inline-flex items-center cursor-pointer">
                      <input
                        type="checkbox"
                        checked={isEnabled}
                        onChange={(e) => toggleIntegration(provider.id, e.target.checked)}
                        className="sr-only peer"
                      />
                      <div className="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                    <span className="text-sm">
                      {isEnabled ? 'Enabled' : 'Disabled'}
                    </span>
                  </div>

                  <div className="flex gap-2">
                    {provider.documentation_url && (
                      <Button
                        variant="ghost"
                        size="sm"
                        onClick={() => window.open(provider.documentation_url, '_blank')}
                      >
                        <ExternalLink className="h-4 w-4" />
                      </Button>
                    )}
                    
                    {isEnabled && (
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => setConfigureIntegration(provider)}
                      >
                        <Settings className="h-4 w-4" />
                      </Button>
                    )}
                  </div>
                </div>

                {/* Error Message */}
                {integration?.error_message && (
                  <div className="mt-3 p-2 bg-red-50 border border-red-200 rounded text-sm text-red-600">
                    {integration.error_message}
                  </div>
                )}

                {/* Last Sync */}
                {integration?.last_sync_at && (
                  <div className="mt-2 text-xs text-gray-500">
                    Last synced: {new Date(integration.last_sync_at).toLocaleString()}
                  </div>
                )}
              </CardContent>
            </Card>
          )
        })}
      </div>

      {/* Configuration Modal */}
      {configureIntegration && (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
          <Card className="w-full max-w-md">
            <CardHeader>
              <CardTitle className="flex items-center gap-2">
                <Settings className="h-5 w-5" />
                Configure {configureIntegration.name}
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className="space-y-4">
                <p className="text-sm text-gray-600">
                  Enter your API credentials to connect {configureIntegration.name}
                </p>

                {Object.entries(configureIntegration.required_credentials).map(([field, required]) => (
                  required && (
                    <div key={field}>
                      <label className="block text-sm font-medium mb-1 capitalize">
                        {field.replace(/_/g, ' ')}
                      </label>
                      <div className="relative">
                        <Input
                          type={showCredentials[field] ? 'text' : 'password'}
                          value={credentials[field] || ''}
                          onChange={(e) => setCredentials(prev => ({ ...prev, [field]: e.target.value }))}
                          placeholder={`Enter ${field.replace(/_/g, ' ')}`}
                        />
                        <Button
                          type="button"
                          variant="ghost"
                          size="sm"
                          className="absolute right-2 top-1/2 -translate-y-1/2"
                          onClick={() => setShowCredentials(prev => ({ ...prev, [field]: !prev[field] }))}
                        >
                          {showCredentials[field] ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                        </Button>
                      </div>
                    </div>
                  )
                ))}

                <div className="flex justify-end gap-2 pt-4">
                  <Button
                    variant="outline"
                    onClick={() => {
                      setConfigureIntegration(null)
                      setCredentials({})
                    }}
                  >
                    Cancel
                  </Button>
                  <Button onClick={() => saveCredentials(configureIntegration.id)}>
                    Save & Connect
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Integration Setup Instructions */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <Shield className="h-5 w-5" />
            Integration Setup Guide
          </CardTitle>
        </CardHeader>
        <CardContent>
          <div className="grid md:grid-cols-2 gap-6">
            <div>
              <h4 className="font-medium mb-2">Getting Started</h4>
              <ol className="text-sm text-gray-600 space-y-2">
                <li>1. Select the integration you want to enable</li>
                <li>2. Toggle the switch to enable the integration</li>
                <li>3. Click the settings icon to configure credentials</li>
                <li>4. Follow the provider's documentation for API setup</li>
                <li>5. Test the connection and start using the features</li>
              </ol>
            </div>
            
            <div>
              <h4 className="font-medium mb-2">Security Notes</h4>
              <ul className="text-sm text-gray-600 space-y-2">
                <li>• All credentials are encrypted before storage</li>
                <li>• API keys are never logged or displayed</li>
                <li>• Integrations can be disabled at any time</li>
                <li>• Regular security audits are performed</li>
                <li>• Follow provider best practices for API security</li>
              </ul>
            </div>
          </div>
        </CardContent>
      </Card>
    </div>
  )
}

export default Integrations