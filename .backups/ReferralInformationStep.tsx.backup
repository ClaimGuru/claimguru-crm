import React, { useState, useEffect } from 'react'\nimport { Card, CardContent, CardHeader, CardTitle } from '../../ui/Card'\nimport { Button } from '../../ui/Button'\nimport { Input } from '../../ui/Input'\nimport { LoadingSpinner } from '../../ui/LoadingSpinner'\nimport { \n  Users, \n  TrendingUp, \n  Brain, \n  Star,\n  Calendar,\n  DollarSign,\n  AlertCircle,\n  CheckCircle\n} from 'lucide-react'\nimport { enhancedClaimWizardAI } from '../../../services/enhancedClaimWizardAI'\n\ninterface ReferralSource {\n  id: string\n  name: string\n  type: 'agent' | 'attorney' | 'contractor' | 'client' | 'marketing' | 'other'\n  contactPerson?: string\n  phone?: string\n  email?: string\n  relationship?: string\n  notes?: string\n}\n\ninterface ReferralAnalytics {\n  totalReferrals: number\n  averageClaimValue: number\n  conversionRate: number\n  relationshipStrength: 'strong' | 'moderate' | 'weak'\n  recommendations: string[]\n}\n\ninterface ReferralInformationStepProps {\n  data: any\n  onUpdate: (data: any) => void\n  onComplete?: () => void\n}\n\nexport const ReferralInformationStep: React.FC<ReferralInformationStepProps> = ({\n  data,\n  onUpdate,\n  onComplete\n}) => {\n  const [selectedReferral, setSelectedReferral] = useState<ReferralSource | null>(\n    data.referralInformation?.source || null\n  )\n  const [customReferral, setCustomReferral] = useState<ReferralSource>({\n    id: '',\n    name: '',\n    type: 'other',\n    contactPerson: '',\n    phone: '',\n    email: '',\n    relationship: '',\n    notes: ''\n  })\n  const [referralAnalytics, setReferralAnalytics] = useState<ReferralAnalytics | null>(null)\n  const [isAnalyzing, setIsAnalyzing] = useState(false)\n  const [commonReferrals] = useState<ReferralSource[]>([\n    {\n      id: '1',\n      name: 'Direct Client Contact',\n      type: 'client',\n      relationship: 'Direct inquiry'\n    },\n    {\n      id: '2', \n      name: 'Insurance Agent Referral',\n      type: 'agent',\n      relationship: 'Professional network'\n    },\n    {\n      id: '3',\n      name: 'Attorney Referral',\n      type: 'attorney', \n      relationship: 'Legal partnership'\n    },\n    {\n      id: '4',\n      name: 'Contractor Referral',\n      type: 'contractor',\n      relationship: 'Trade partnership'\n    },\n    {\n      id: '5',\n      name: 'Existing Client Referral',\n      type: 'client',\n      relationship: 'Client satisfaction'\n    },\n    {\n      id: '6',\n      name: 'Online Marketing',\n      type: 'marketing',\n      relationship: 'Digital presence'\n    }\n  ])\n  const [showCustomForm, setShowCustomForm] = useState(false)\n\n  // AI referral source analysis\n  const analyzeReferralSource = async (referral: ReferralSource) => {\n    setIsAnalyzing(true)\n    try {\n      const analytics = await enhancedClaimWizardAI.analyzeReferralSource({\n        referralSource: referral,\n        claimData: data,\n        organizationId: data.organizationId\n      })\n      \n      setReferralAnalytics(analytics)\n    } catch (error) {\n      console.error('Referral analysis failed:', error)\n    } finally {\n      setIsAnalyzing(false)\n    }\n  }\n\n  useEffect(() => {\n    if (selectedReferral) {\n      analyzeReferralSource(selectedReferral)\n    }\n  }, [selectedReferral])\n\n  const selectReferral = (referral: ReferralSource) => {\n    setSelectedReferral(referral)\n    onUpdate({\n      ...data,\n      referralInformation: {\n        source: referral,\n        analytics: referralAnalytics\n      }\n    })\n    setShowCustomForm(false)\n  }\n\n  const createCustomReferral = () => {\n    if (!customReferral.name.trim()) return\n\n    const newReferral: ReferralSource = {\n      ...customReferral,\n      id: `custom-${Date.now()}`\n    }\n\n    selectReferral(newReferral)\n    setCustomReferral({\n      id: '',\n      name: '',\n      type: 'other',\n      contactPerson: '',\n      phone: '',\n      email: '',\n      relationship: '',\n      notes: ''\n    })\n  }\n\n  const getReferralTypeIcon = (type: string) => {\n    switch (type) {\n      case 'agent': return 'ðŸ¢'\n      case 'attorney': return 'âš–ï¸'\n      case 'contractor': return 'ðŸ”¨'\n      case 'client': return 'ðŸ‘¤'\n      case 'marketing': return 'ðŸ“±'\n      default: return 'ðŸ“‹'\n    }\n  }\n\n  const getReferralTypeColor = (type: string) => {\n    switch (type) {\n      case 'agent': return 'bg-blue-100 text-blue-800'\n      case 'attorney': return 'bg-purple-100 text-purple-800'\n      case 'contractor': return 'bg-orange-100 text-orange-800'\n      case 'client': return 'bg-green-100 text-green-800'\n      case 'marketing': return 'bg-pink-100 text-pink-800'\n      default: return 'bg-gray-100 text-gray-800'\n    }\n  }\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center space-x-2\">\n            <Users className=\"h-6 w-6 text-blue-600\" />\n            <span>Referral Information</span>\n          </CardTitle>\n          <p className=\"text-gray-600\">\n            Track how this client found your services. AI analyzes referral patterns to optimize your business development.\n          </p>\n        </CardHeader>\n      </Card>\n\n      {/* Referral Source Selection */}\n      <Card>\n        <CardHeader>\n          <CardTitle>How did this client find you?</CardTitle>\n        </CardHeader>\n        <CardContent>\n          <div className=\"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4\">\n            {commonReferrals.map((referral) => (\n              <div\n                key={referral.id}\n                onClick={() => selectReferral(referral)}\n                className={`p-4 border rounded-lg cursor-pointer transition-all ${\n                  selectedReferral?.id === referral.id\n                    ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200'\n                    : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'\n                }`}\n              >\n                <div className=\"flex items-start space-x-3\">\n                  <span className=\"text-2xl\">{getReferralTypeIcon(referral.type)}</span>\n                  <div className=\"flex-1\">\n                    <h3 className=\"font-medium text-gray-900\">{referral.name}</h3>\n                    <p className=\"text-sm text-gray-600 mt-1\">{referral.relationship}</p>\n                    <span className={`inline-block px-2 py-1 text-xs rounded-full mt-2 ${getReferralTypeColor(referral.type)}`}>\n                      {referral.type.charAt(0).toUpperCase() + referral.type.slice(1)}\n                    </span>\n                  </div>\n                  {selectedReferral?.id === referral.id && (\n                    <CheckCircle className=\"h-5 w-5 text-blue-600\" />\n                  )}\n                </div>\n              </div>\n            ))}\n          </div>\n          \n          <div className=\"mt-4\">\n            <Button\n              variant=\"outline\"\n              onClick={() => setShowCustomForm(!showCustomForm)}\n              className=\"w-full\"\n            >\n              {showCustomForm ? 'Cancel' : 'Add Custom Referral Source'}\n            </Button>\n          </div>\n        </CardContent>\n      </Card>\n\n      {/* Custom Referral Form */}\n      {showCustomForm && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Custom Referral Source</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <Input\n                  label=\"Referral Source Name *\"\n                  value={customReferral.name}\n                  onChange={(e) => setCustomReferral({ ...customReferral, name: e.target.value })}\n                  placeholder=\"e.g., John Smith Insurance Agency\"\n                />\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                    Type *\n                  </label>\n                  <select\n                    value={customReferral.type}\n                    onChange={(e) => setCustomReferral({ ...customReferral, type: e.target.value as any })}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  >\n                    <option value=\"agent\">Insurance Agent</option>\n                    <option value=\"attorney\">Attorney</option>\n                    <option value=\"contractor\">Contractor</option>\n                    <option value=\"client\">Client</option>\n                    <option value=\"marketing\">Marketing</option>\n                    <option value=\"other\">Other</option>\n                  </select>\n                </div>\n              </div>\n              \n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <Input\n                  label=\"Contact Person\"\n                  value={customReferral.contactPerson}\n                  onChange={(e) => setCustomReferral({ ...customReferral, contactPerson: e.target.value })}\n                  placeholder=\"Primary contact name\"\n                />\n                <Input\n                  label=\"Phone Number\"\n                  value={customReferral.phone}\n                  onChange={(e) => setCustomReferral({ ...customReferral, phone: e.target.value })}\n                  placeholder=\"(555) 123-4567\"\n                />\n              </div>\n              \n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <Input\n                  label=\"Email Address\"\n                  type=\"email\"\n                  value={customReferral.email}\n                  onChange={(e) => setCustomReferral({ ...customReferral, email: e.target.value })}\n                  placeholder=\"contact@example.com\"\n                />\n                <Input\n                  label=\"Relationship\"\n                  value={customReferral.relationship}\n                  onChange={(e) => setCustomReferral({ ...customReferral, relationship: e.target.value })}\n                  placeholder=\"How you know this source\"\n                />\n              </div>\n              \n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                  Notes\n                </label>\n                <textarea\n                  value={customReferral.notes}\n                  onChange={(e) => setCustomReferral({ ...customReferral, notes: e.target.value })}\n                  placeholder=\"Additional notes about this referral source...\"\n                  rows={3}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                />\n              </div>\n              \n              <Button\n                onClick={createCustomReferral}\n                disabled={!customReferral.name.trim()}\n              >\n                Add Custom Referral Source\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* AI Analytics */}\n      {selectedReferral && referralAnalytics && (\n        <Card className=\"border-green-200 bg-green-50\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center space-x-2 text-green-800\">\n              <Brain className=\"h-5 w-5\" />\n              <span>AI Referral Analytics</span>\n              {isAnalyzing && <LoadingSpinner className=\"ml-2\" />}\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"grid grid-cols-1 md:grid-cols-4 gap-4 mb-4\">\n              <div className=\"text-center p-3 bg-white rounded-lg\">\n                <TrendingUp className=\"h-6 w-6 text-blue-600 mx-auto mb-2\" />\n                <div className=\"text-2xl font-bold text-gray-900\">{referralAnalytics.totalReferrals}</div>\n                <div className=\"text-sm text-gray-600\">Total Referrals</div>\n              </div>\n              <div className=\"text-center p-3 bg-white rounded-lg\">\n                <DollarSign className=\"h-6 w-6 text-green-600 mx-auto mb-2\" />\n                <div className=\"text-2xl font-bold text-gray-900\">\n                  ${referralAnalytics.averageClaimValue.toLocaleString()}\n                </div>\n                <div className=\"text-sm text-gray-600\">Avg Claim Value</div>\n              </div>\n              <div className=\"text-center p-3 bg-white rounded-lg\">\n                <Star className=\"h-6 w-6 text-yellow-600 mx-auto mb-2\" />\n                <div className=\"text-2xl font-bold text-gray-900\">\n                  {Math.round(referralAnalytics.conversionRate * 100)}%\n                </div>\n                <div className=\"text-sm text-gray-600\">Conversion Rate</div>\n              </div>\n              <div className=\"text-center p-3 bg-white rounded-lg\">\n                <Calendar className=\"h-6 w-6 text-purple-600 mx-auto mb-2\" />\n                <div className=\"text-2xl font-bold text-gray-900 capitalize\">\n                  {referralAnalytics.relationshipStrength}\n                </div>\n                <div className=\"text-sm text-gray-600\">Relationship</div>\n              </div>\n            </div>\n            \n            {referralAnalytics.recommendations.length > 0 && (\n              <div className=\"space-y-2\">\n                <h4 className=\"font-medium text-green-800 mb-2\">AI Recommendations:</h4>\n                {referralAnalytics.recommendations.map((rec, index) => (\n                  <div key={index} className=\"flex items-start space-x-2 text-sm text-green-700\">\n                    <CheckCircle className=\"h-4 w-4 mt-0.5 flex-shrink-0\" />\n                    <span>{rec}</span>\n                  </div>\n                ))}\n              </div>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Selected Referral Summary */}\n      {selectedReferral && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Selected Referral Source</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"flex items-center space-x-4 p-4 bg-gray-50 rounded-lg\">\n              <span className=\"text-3xl\">{getReferralTypeIcon(selectedReferral.type)}</span>\n              <div className=\"flex-1\">\n                <h3 className=\"font-medium text-gray-900\">{selectedReferral.name}</h3>\n                <p className=\"text-sm text-gray-600\">{selectedReferral.relationship}</p>\n                {selectedReferral.contactPerson && (\n                  <p className=\"text-sm text-gray-600\">Contact: {selectedReferral.contactPerson}</p>\n                )}\n                <span className={`inline-block px-2 py-1 text-xs rounded-full mt-2 ${getReferralTypeColor(selectedReferral.type)}`}>\n                  {selectedReferral.type.charAt(0).toUpperCase() + selectedReferral.type.slice(1)}\n                </span>\n              </div>\n              <Button\n                variant=\"outline\"\n                onClick={() => setSelectedReferral(null)}\n              >\n                Change\n              </Button>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Navigation */}\n      <div className=\"flex justify-between\">\n        <div></div>\n        <Button\n          onClick={onComplete}\n          disabled={!selectedReferral}\n        >\n          Continue to Next Step\n        </Button>\n      </div>\n    </div>\n  )\n}\n