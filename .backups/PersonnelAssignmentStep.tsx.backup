import React, { useState, useEffect } from 'react'\nimport { Card, CardContent, CardHeader, CardTitle } from '../../ui/Card'\nimport { Button } from '../../ui/Button'\nimport { Input } from '../../ui/Input'\nimport { LoadingSpinner } from '../../ui/LoadingSpinner'\nimport { \n  Users, \n  UserPlus, \n  Brain, \n  Star,\n  Clock,\n  Award,\n  Search,\n  Filter,\n  CheckCircle,\n  AlertCircle,\n  User,\n  Settings\n} from 'lucide-react'\nimport { enhancedClaimWizardAI } from '../../../services/enhancedClaimWizardAI'\n\ninterface TeamMember {\n  id: string\n  name: string\n  role: 'lead_adjuster' | 'assistant_adjuster' | 'admin' | 'specialist' | 'coordinator'\n  email: string\n  phone?: string\n  expertise: string[]\n  currentWorkload: number\n  availability: 'available' | 'busy' | 'unavailable'\n  rating: number\n  yearsExperience: number\n  specializations: string[]\n  recentPerformance: {\n    casesCompleted: number\n    averageResolutionTime: number\n    clientSatisfaction: number\n  }\n}\n\ninterface Assignment {\n  memberId: string\n  role: string\n  responsibilities: string[]\n  isPrimary: boolean\n  estimatedHours?: number\n  notes?: string\n}\n\ninterface AIRecommendation {\n  member: TeamMember\n  score: number\n  reasoning: string[]\n  suggestedRole: string\n  estimatedHours: number\n  conflicts?: string[]\n}\n\ninterface PersonnelAssignmentStepProps {\n  data: any\n  onUpdate: (data: any) => void\n  onComplete?: () => void\n}\n\nexport const PersonnelAssignmentStep: React.FC<PersonnelAssignmentStepProps> = ({\n  data,\n  onUpdate,\n  onComplete\n}) => {\n  const [assignments, setAssignments] = useState<Assignment[]>(\n    data.personnelAssignments || []\n  )\n  const [availableMembers, setAvailableMembers] = useState<TeamMember[]>([])\n  const [aiRecommendations, setAiRecommendations] = useState<AIRecommendation[]>([])\n  const [isLoadingRecommendations, setIsLoadingRecommendations] = useState(false)\n  const [searchTerm, setSearchTerm] = useState('')\n  const [filterRole, setFilterRole] = useState<string>('all')\n  const [selectedMember, setSelectedMember] = useState<TeamMember | null>(null)\n  const [assignmentRole, setAssignmentRole] = useState('')\n  const [assignmentNotes, setAssignmentNotes] = useState('')\n\n  // Load team members and AI recommendations\n  useEffect(() => {\n    loadTeamMembers()\n    generateAIRecommendations()\n  }, [])\n\n  const loadTeamMembers = async () => {\n    // Simulate loading team members (in production, fetch from API)\n    const mockMembers: TeamMember[] = [\n      {\n        id: '1',\n        name: 'Sarah Johnson',\n        role: 'lead_adjuster',\n        email: 'sarah.johnson@claimguru.com',\n        phone: '(555) 123-4567',\n        expertise: ['Commercial Claims', 'Water Damage', 'Fire Claims'],\n        currentWorkload: 75,\n        availability: 'available',\n        rating: 4.8,\n        yearsExperience: 8,\n        specializations: ['Large Loss', 'Complex Claims'],\n        recentPerformance: {\n          casesCompleted: 24,\n          averageResolutionTime: 45,\n          clientSatisfaction: 4.7\n        }\n      },\n      {\n        id: '2',\n        name: 'Mike Chen',\n        role: 'assistant_adjuster',\n        email: 'mike.chen@claimguru.com',\n        phone: '(555) 234-5678',\n        expertise: ['Residential Claims', 'Storm Damage', 'Personal Property'],\n        currentWorkload: 60,\n        availability: 'available',\n        rating: 4.5,\n        yearsExperience: 4,\n        specializations: ['First-Time Homeowner Claims'],\n        recentPerformance: {\n          casesCompleted: 32,\n          averageResolutionTime: 38,\n          clientSatisfaction: 4.4\n        }\n      },\n      {\n        id: '3',\n        name: 'Jessica Rodriguez',\n        role: 'specialist',\n        email: 'jessica.rodriguez@claimguru.com',\n        expertise: ['Fraud Investigation', 'Legal Support', 'Disputed Claims'],\n        currentWorkload: 90,\n        availability: 'busy',\n        rating: 4.9,\n        yearsExperience: 12,\n        specializations: ['Fraud Detection', 'Litigation Support'],\n        recentPerformance: {\n          casesCompleted: 18,\n          averageResolutionTime: 62,\n          clientSatisfaction: 4.8\n        }\n      },\n      {\n        id: '4',\n        name: 'David Park',\n        role: 'coordinator',\n        email: 'david.park@claimguru.com',\n        phone: '(555) 345-6789',\n        expertise: ['Project Management', 'Client Communication', 'Documentation'],\n        currentWorkload: 45,\n        availability: 'available',\n        rating: 4.3,\n        yearsExperience: 3,\n        specializations: ['Client Relations'],\n        recentPerformance: {\n          casesCompleted: 28,\n          averageResolutionTime: 30,\n          clientSatisfaction: 4.6\n        }\n      }\n    ]\n    \n    setAvailableMembers(mockMembers)\n  }\n\n  const generateAIRecommendations = async () => {\n    setIsLoadingRecommendations(true)\n    try {\n      const recommendations = await enhancedClaimWizardAI.generatePersonnelRecommendations({\n        claimData: data,\n        organizationId: data.organizationId,\n        currentAssignments: assignments\n      })\n      \n      setAiRecommendations(recommendations)\n    } catch (error) {\n      console.error('Failed to generate AI recommendations:', error)\n    } finally {\n      setIsLoadingRecommendations(false)\n    }\n  }\n\n  const addAssignment = () => {\n    if (!selectedMember || !assignmentRole) return\n\n    const newAssignment: Assignment = {\n      memberId: selectedMember.id,\n      role: assignmentRole,\n      responsibilities: getDefaultResponsibilities(assignmentRole),\n      isPrimary: assignments.length === 0,\n      notes: assignmentNotes\n    }\n\n    const updatedAssignments = [...assignments, newAssignment]\n    setAssignments(updatedAssignments)\n    onUpdate({\n      ...data,\n      personnelAssignments: updatedAssignments\n    })\n\n    // Reset form\n    setSelectedMember(null)\n    setAssignmentRole('')\n    setAssignmentNotes('')\n  }\n\n  const removeAssignment = (index: number) => {\n    const updatedAssignments = assignments.filter((_, i) => i !== index)\n    setAssignments(updatedAssignments)\n    onUpdate({\n      ...data,\n      personnelAssignments: updatedAssignments\n    })\n  }\n\n  const applyAIRecommendation = (recommendation: AIRecommendation) => {\n    setSelectedMember(recommendation.member)\n    setAssignmentRole(recommendation.suggestedRole)\n    setAssignmentNotes(`AI Recommended: ${recommendation.reasoning.join(', ')}`)\n  }\n\n  const getDefaultResponsibilities = (role: string): string[] => {\n    switch (role) {\n      case 'Primary Adjuster':\n        return ['Overall claim management', 'Client communication', 'Settlement negotiation', 'Final approval']\n      case 'Assistant Adjuster':\n        return ['Documentation', 'Property inspection', 'Vendor coordination', 'Progress updates']\n      case 'Specialist':\n        return ['Technical analysis', 'Expert consultation', 'Complex evaluation', 'Special investigations']\n      case 'Coordinator':\n        return ['Task management', 'Scheduling', 'Client updates', 'Administrative support']\n      default:\n        return ['General support', 'As needed assistance']\n    }\n  }\n\n  const getWorkloadColor = (workload: number) => {\n    if (workload >= 80) return 'text-red-600 bg-red-100'\n    if (workload >= 60) return 'text-yellow-600 bg-yellow-100'\n    return 'text-green-600 bg-green-100'\n  }\n\n  const getAvailabilityColor = (availability: string) => {\n    switch (availability) {\n      case 'available': return 'text-green-600 bg-green-100'\n      case 'busy': return 'text-yellow-600 bg-yellow-100'\n      case 'unavailable': return 'text-red-600 bg-red-100'\n      default: return 'text-gray-600 bg-gray-100'\n    }\n  }\n\n  const filteredMembers = availableMembers.filter(member => {\n    const matchesSearch = member.name.toLowerCase().includes(searchTerm.toLowerCase()) ||\n                         member.expertise.some(exp => exp.toLowerCase().includes(searchTerm.toLowerCase()))\n    const matchesRole = filterRole === 'all' || member.role === filterRole\n    return matchesSearch && matchesRole\n  })\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center space-x-2\">\n            <Users className=\"h-6 w-6 text-blue-600\" />\n            <span>Personnel Assignment</span>\n          </CardTitle>\n          <p className=\"text-gray-600\">\n            Assign team members to this claim. AI recommends optimal assignments based on expertise, workload, and claim complexity.\n          </p>\n        </CardHeader>\n      </Card>\n\n      {/* AI Recommendations */}\n      {aiRecommendations.length > 0 && (\n        <Card className=\"border-blue-200 bg-blue-50\">\n          <CardHeader>\n            <CardTitle className=\"flex items-center space-x-2 text-blue-800\">\n              <Brain className=\"h-5 w-5\" />\n              <span>AI Personnel Recommendations</span>\n              {isLoadingRecommendations && <LoadingSpinner className=\"ml-2\" />}\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-3\">\n              {aiRecommendations.slice(0, 3).map((rec, index) => (\n                <div key={index} className=\"flex items-center justify-between p-3 bg-white rounded-lg border\">\n                  <div className=\"flex-1\">\n                    <div className=\"flex items-center space-x-2 mb-1\">\n                      <h4 className=\"font-medium text-gray-900\">{rec.member.name}</h4>\n                      <span className=\"text-sm text-blue-600\">({rec.suggestedRole})</span>\n                      <div className=\"flex items-center space-x-1\">\n                        <Star className=\"h-3 w-3 text-yellow-500\" />\n                        <span className=\"text-xs text-gray-600\">{rec.score}% match</span>\n                      </div>\n                    </div>\n                    <p className=\"text-sm text-gray-600\">{rec.reasoning.join(', ')}</p>\n                    {rec.conflicts && (\n                      <p className=\"text-xs text-red-600 mt-1\">⚠️ {rec.conflicts.join(', ')}</p>\n                    )}\n                  </div>\n                  <Button\n                    variant=\"outline\"\n                    size=\"sm\"\n                    onClick={() => applyAIRecommendation(rec)}\n                  >\n                    Assign\n                  </Button>\n                </div>\n              ))}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Current Assignments */}\n      {assignments.length > 0 && (\n        <Card>\n          <CardHeader>\n            <CardTitle>Current Assignments</CardTitle>\n          </CardHeader>\n          <CardContent>\n            <div className=\"space-y-4\">\n              {assignments.map((assignment, index) => {\n                const member = availableMembers.find(m => m.id === assignment.memberId)\n                if (!member) return null\n                \n                return (\n                  <div key={index} className=\"border rounded-lg p-4\">\n                    <div className=\"flex items-start justify-between\">\n                      <div className=\"flex-1\">\n                        <div className=\"flex items-center space-x-2 mb-2\">\n                          <h4 className=\"font-medium text-gray-900\">{member.name}</h4>\n                          <span className=\"px-2 py-1 bg-blue-100 text-blue-800 text-xs rounded-full\">\n                            {assignment.role}\n                          </span>\n                          {assignment.isPrimary && (\n                            <span className=\"px-2 py-1 bg-green-100 text-green-800 text-xs rounded-full\">\n                              Primary\n                            </span>\n                          )}\n                        </div>\n                        \n                        <div className=\"text-sm text-gray-600 mb-2\">\n                          <span className=\"font-medium\">Responsibilities:</span>\n                          <ul className=\"list-disc list-inside mt-1 ml-2\">\n                            {assignment.responsibilities.map((resp, i) => (\n                              <li key={i}>{resp}</li>\n                            ))}\n                          </ul>\n                        </div>\n                        \n                        {assignment.notes && (\n                          <p className=\"text-sm text-gray-600\">\n                            <span className=\"font-medium\">Notes:</span> {assignment.notes}\n                          </p>\n                        )}\n                      </div>\n                      \n                      <Button\n                        variant=\"outline\"\n                        size=\"sm\"\n                        onClick={() => removeAssignment(index)}\n                        className=\"text-red-600 hover:text-red-700\"\n                      >\n                        Remove\n                      </Button>\n                    </div>\n                  </div>\n                )\n              })}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Add Assignment */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center space-x-2\">\n            <UserPlus className=\"h-5 w-5\" />\n            <span>Add Team Member</span>\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {/* Search and Filter */}\n          <div className=\"flex space-x-4 mb-4\">\n            <div className=\"flex-1\">\n              <Input\n                placeholder=\"Search team members or expertise...\"\n                value={searchTerm}\n                onChange={(e) => setSearchTerm(e.target.value)}\n                icon={<Search className=\"h-4 w-4\" />}\n              />\n            </div>\n            <div className=\"w-48\">\n              <select\n                value={filterRole}\n                onChange={(e) => setFilterRole(e.target.value)}\n                className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\n              >\n                <option value=\"all\">All Roles</option>\n                <option value=\"lead_adjuster\">Lead Adjuster</option>\n                <option value=\"assistant_adjuster\">Assistant Adjuster</option>\n                <option value=\"specialist\">Specialist</option>\n                <option value=\"coordinator\">Coordinator</option>\n              </select>\n            </div>\n          </div>\n\n          {/* Team Member Selection */}\n          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4 mb-4\">\n            {filteredMembers.map((member) => (\n              <div\n                key={member.id}\n                onClick={() => setSelectedMember(member)}\n                className={`p-4 border rounded-lg cursor-pointer transition-all ${\n                  selectedMember?.id === member.id\n                    ? 'border-blue-500 bg-blue-50 ring-2 ring-blue-200'\n                    : 'border-gray-200 hover:border-gray-300 hover:bg-gray-50'\n                }`}\n              >\n                <div className=\"flex items-start justify-between mb-2\">\n                  <div>\n                    <h4 className=\"font-medium text-gray-900\">{member.name}</h4>\n                    <p className=\"text-sm text-gray-600 capitalize\">{member.role.replace('_', ' ')}</p>\n                  </div>\n                  <div className=\"flex items-center space-x-1\">\n                    <Star className=\"h-4 w-4 text-yellow-500\" />\n                    <span className=\"text-sm font-medium\">{member.rating}</span>\n                  </div>\n                </div>\n                \n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between text-sm\">\n                    <span className=\"text-gray-600\">Workload:</span>\n                    <span className={`px-2 py-1 text-xs rounded-full ${getWorkloadColor(member.currentWorkload)}`}>\n                      {member.currentWorkload}%\n                    </span>\n                  </div>\n                  \n                  <div className=\"flex items-center justify-between text-sm\">\n                    <span className=\"text-gray-600\">Status:</span>\n                    <span className={`px-2 py-1 text-xs rounded-full capitalize ${getAvailabilityColor(member.availability)}`}>\n                      {member.availability}\n                    </span>\n                  </div>\n                  \n                  <div className=\"text-sm\">\n                    <span className=\"text-gray-600\">Expertise:</span>\n                    <div className=\"flex flex-wrap gap-1 mt-1\">\n                      {member.expertise.slice(0, 2).map((exp, i) => (\n                        <span key={i} className=\"px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded\">\n                          {exp}\n                        </span>\n                      ))}\n                      {member.expertise.length > 2 && (\n                        <span className=\"px-2 py-1 bg-gray-100 text-gray-700 text-xs rounded\">\n                          +{member.expertise.length - 2} more\n                        </span>\n                      )}\n                    </div>\n                  </div>\n                </div>\n                \n                {selectedMember?.id === member.id && (\n                  <CheckCircle className=\"h-5 w-5 text-blue-600 mt-2\" />\n                )}\n              </div>\n            ))}\n          </div>\n\n          {/* Assignment Details */}\n          {selectedMember && (\n            <div className=\"border-t pt-4 space-y-4\">\n              <h4 className=\"font-medium text-gray-900\">Assignment Details for {selectedMember.name}</h4>\n              \n              <div className=\"grid grid-cols-1 md:grid-cols-2 gap-4\">\n                <div>\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                    Role *\n                  </label>\n                  <select\n                    value={assignmentRole}\n                    onChange={(e) => setAssignmentRole(e.target.value)}\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                  >\n                    <option value=\"\">Select role</option>\n                    <option value=\"Primary Adjuster\">Primary Adjuster</option>\n                    <option value=\"Assistant Adjuster\">Assistant Adjuster</option>\n                    <option value=\"Specialist\">Specialist</option>\n                    <option value=\"Coordinator\">Coordinator</option>\n                    <option value=\"Support\">Support</option>\n                  </select>\n                </div>\n              </div>\n              \n              <div>\n                <label className=\"block text-sm font-medium text-gray-700 mb-1\">\n                  Assignment Notes\n                </label>\n                <textarea\n                  value={assignmentNotes}\n                  onChange={(e) => setAssignmentNotes(e.target.value)}\n                  placeholder=\"Special instructions or notes for this assignment...\"\n                  rows={3}\n                  className=\"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500\"\n                />\n              </div>\n              \n              <Button\n                onClick={addAssignment}\n                disabled={!assignmentRole}\n              >\n                Add Assignment\n              </Button>\n            </div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Navigation */}\n      <div className=\"flex justify-between\">\n        <div></div>\n        <Button\n          onClick={onComplete}\n          disabled={assignments.length === 0}\n        >\n          Continue to Next Step\n        </Button>\n      </div>\n    </div>\n  )\n}\n