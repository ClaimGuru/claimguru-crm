import React, { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '../components/ui/Card'
import { Button } from '../components/ui/Button'
import { LoadingSpinner } from '../components/ui/LoadingSpinner'
import { 
  Mail, 
  Phone, 
  MessageSquare, 
  Settings, 
  Search, 
  Filter,
  TrendingUp,
  FileText,
  AlertTriangle,
  CheckCircle,
  Clock,
  Brain,
  Users,
  BarChart3,
  Plus,
  Download,
  RefreshCw
} from 'lucide-react'
import { emailAutomationService, type ClassifiedEmail } from '../services/emailAutomationService'

interface EmailStats {
  totalEmails: number
  claimRelated: number
  highPriority: number
  averageConfidence: number
  tasksCreated: number
  claimNumbersExtracted: number
}

export default function Communications() {
  const [activeTab, setActiveTab] = useState<'emails' | 'calls' | 'sms' | 'settings'>('emails')
  const [emailLogs, setEmailLogs] = useState<any[]>([])
  const [emailStats, setEmailStats] = useState<EmailStats | null>(null)
  const [isLoading, setIsLoading] = useState(true)
  const [searchTerm, setSearchTerm] = useState('')
  const [filterCategory, setFilterCategory] = useState<string>('all')
  const [isRefreshing, setIsRefreshing] = useState(false)

  useEffect(() => {
    loadEmailData()
  }, [])

  const loadEmailData = async () => {
    setIsLoading(true)
    try {
      const [logs, stats] = await Promise.all([
        emailAutomationService.getRecentEmailLogs(100),
        emailAutomationService.getEmailAnalytics(30)
      ])
      
      setEmailLogs(logs)
      setEmailStats(stats)
    } catch (error) {
      console.error('Failed to load email data:', error)
    } finally {
      setIsLoading(false)
    }
  }

  const handleRefresh = async () => {
    setIsRefreshing(true)
    await loadEmailData()
    setIsRefreshing(false)
  }

  const filteredEmails = emailLogs.filter(email => {
    const matchesSearch = email.subject.toLowerCase().includes(searchTerm.toLowerCase()) ||
                         email.from_email.toLowerCase().includes(searchTerm.toLowerCase())
    
    if (filterCategory === 'all') return matchesSearch
    return matchesSearch && email.classification?.category === filterCategory
  })

  const getPriorityColor = (priority: string) => {
    switch (priority) {
      case 'high': return 'text-red-600 bg-red-100'
      case 'medium': return 'text-yellow-600 bg-yellow-100'
      case 'low': return 'text-green-600 bg-green-100'
      default: return 'text-gray-600 bg-gray-100'
    }
  }

  const getCategoryColor = (category: string) => {
    const colors = {
      claim_related: 'text-blue-600 bg-blue-100',
      insurer_update: 'text-purple-600 bg-purple-100',
      vendor_communication: 'text-orange-600 bg-orange-100',
      client_communication: 'text-green-600 bg-green-100',
      other: 'text-gray-600 bg-gray-100'
    }
    return colors[category as keyof typeof colors] || 'text-gray-600 bg-gray-100'
  }

  const formatCategory = (category: string) => {
    return category.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())
  }

  if (isLoading) {
    return (
      <div className="flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
        <span className="ml-2 text-gray-600">Loading communications...</span>
      </div>
    )
  }

  return (
    <div className=\"space-y-6\">
      {/* Header */}
      <div className=\"flex justify-between items-center\">
        <div>
          <h1 className=\"text-2xl font-bold text-gray-900\">Communications</h1>
          <p className=\"text-gray-600\">Manage all email, phone, and SMS communications</p>
        </div>
        <div className=\"flex gap-2\">
          <Button
            variant=\"outline\"
            onClick={handleRefresh}
            disabled={isRefreshing}
            className=\"flex items-center gap-2\"
          >
            <RefreshCw className={`h-4 w-4 ${isRefreshing ? 'animate-spin' : ''}`} />
            Refresh
          </Button>
          <Button className=\"flex items-center gap-2\">
            <Plus className=\"h-4 w-4\" />
            Compose Email
          </Button>
        </div>
      </div>

      {/* Tabs */}
      <div className=\"border-b border-gray-200\">
        <nav className=\"flex space-x-8\">
          {[
            { id: 'emails', label: 'Emails', icon: Mail },
            { id: 'calls', label: 'Calls', icon: Phone },
            { id: 'sms', label: 'SMS', icon: MessageSquare },
            { id: 'settings', label: 'Settings', icon: Settings }
          ].map(tab => {
            const Icon = tab.icon
            return (
              <button
                key={tab.id}
                onClick={() => setActiveTab(tab.id as any)}
                className={`flex items-center gap-2 py-2 px-1 border-b-2 font-medium text-sm ${
                  activeTab === tab.id
                    ? 'border-blue-500 text-blue-600'
                    : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300'
                }`}
              >
                <Icon className=\"h-4 w-4\" />
                {tab.label}
              </button>
            )
          })}
        </nav>
      </div>

      {/* Email Tab */}
      {activeTab === 'emails' && (
        <div className=\"space-y-6\">
          {/* Email Statistics */}
          {emailStats && (
            <div className=\"grid grid-cols-2 md:grid-cols-6 gap-4\">
              <Card>
                <CardContent className=\"p-4 text-center\">
                  <Mail className=\"h-6 w-6 text-blue-600 mx-auto mb-2\" />
                  <div className=\"text-2xl font-bold text-blue-600\">{emailStats.totalEmails}</div>
                  <div className=\"text-sm text-gray-600\">Total Emails</div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className=\"p-4 text-center\">
                  <FileText className=\"h-6 w-6 text-green-600 mx-auto mb-2\" />
                  <div className=\"text-2xl font-bold text-green-600\">{emailStats.claimRelated}</div>
                  <div className=\"text-sm text-gray-600\">Claim Related</div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className=\"p-4 text-center\">
                  <AlertTriangle className=\"h-6 w-6 text-red-600 mx-auto mb-2\" />
                  <div className=\"text-2xl font-bold text-red-600\">{emailStats.highPriority}</div>
                  <div className=\"text-sm text-gray-600\">High Priority</div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className=\"p-4 text-center\">
                  <Brain className=\"h-6 w-6 text-purple-600 mx-auto mb-2\" />
                  <div className=\"text-2xl font-bold text-purple-600\">
                    {Math.round((emailStats.averageConfidence || 0) * 100)}%
                  </div>
                  <div className=\"text-sm text-gray-600\">Avg Confidence</div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className=\"p-4 text-center\">
                  <CheckCircle className=\"h-6 w-6 text-green-600 mx-auto mb-2\" />
                  <div className=\"text-2xl font-bold text-green-600\">{emailStats.tasksCreated}</div>
                  <div className=\"text-sm text-gray-600\">Tasks Created</div>
                </CardContent>
              </Card>
              <Card>
                <CardContent className=\"p-4 text-center\">
                  <BarChart3 className=\"h-6 w-6 text-orange-600 mx-auto mb-2\" />
                  <div className=\"text-2xl font-bold text-orange-600\">{emailStats.claimNumbersExtracted}</div>
                  <div className=\"text-sm text-gray-600\">Claims Found</div>
                </CardContent>
              </Card>
            </div>
          )}

          {/* Email Filters */}
          <Card>
            <CardContent className=\"p-4\">
              <div className=\"flex flex-col md:flex-row gap-4\">
                <div className=\"flex-1\">
                  <div className=\"relative\">
                    <Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400\" />
                    <input
                      type=\"text\"
                      placeholder=\"Search emails...\"
                      value={searchTerm}
                      onChange={(e) => setSearchTerm(e.target.value)}
                      className=\"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"
                    />
                  </div>
                </div>
                <div className=\"flex gap-2\">
                  <select
                    value={filterCategory}
                    onChange={(e) => setFilterCategory(e.target.value)}
                    className=\"px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"
                  >
                    <option value=\"all\">All Categories</option>
                    <option value=\"claim_related\">Claim Related</option>
                    <option value=\"insurer_update\">Insurer Updates</option>
                    <option value=\"vendor_communication\">Vendor Communication</option>
                    <option value=\"client_communication\">Client Communication</option>
                    <option value=\"other\">Other</option>
                  </select>
                  <Button variant=\"outline\" className=\"flex items-center gap-2\">
                    <Filter className=\"h-4 w-4\" />
                    More Filters
                  </Button>
                </div>
              </div>
            </CardContent>
          </Card>

          {/* Email List */}
          <Card>
            <CardHeader>
              <CardTitle className=\"flex items-center gap-2\">
                <Mail className=\"h-5 w-5\" />
                Recent Emails ({filteredEmails.length})
              </CardTitle>
            </CardHeader>
            <CardContent>
              <div className=\"space-y-3\">
                {filteredEmails.length === 0 ? (
                  <div className=\"text-center py-8 text-gray-500\">
                    <Mail className=\"h-12 w-12 mx-auto mb-4 text-gray-300\" />
                    <p>No emails found matching your criteria</p>
                  </div>
                ) : (
                  filteredEmails.map((email, index) => (
                    <div key={email.id || index} className=\"border rounded-lg p-4 hover:bg-gray-50\">
                      <div className=\"flex items-start justify-between\">
                        <div className=\"flex-1\">
                          <div className=\"flex items-center gap-2 mb-2\">
                            <h4 className=\"font-medium text-gray-900 truncate\">{email.subject}</h4>
                            <span className={`px-2 py-1 text-xs rounded-full ${getPriorityColor(email.classification?.priority || 'low')}`}>
                              {email.classification?.priority || 'low'}
                            </span>
                            <span className={`px-2 py-1 text-xs rounded-full ${getCategoryColor(email.classification?.category || 'other')}`}>
                              {formatCategory(email.classification?.category || 'other')}
                            </span>
                            {email.confidence_score && (
                              <span className=\"px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-600\">
                                {Math.round(email.confidence_score * 100)}% AI
                              </span>
                            )}
                          </div>
                          <p className=\"text-sm text-gray-600 mb-2\">
                            From: <span className=\"font-medium\">{email.from_name || email.from_email}</span>
                            <span className=\"text-gray-400 ml-2\">{email.from_email}</span>
                          </p>
                          <div className=\"flex items-center gap-4 text-xs text-gray-500\">
                            <span className=\"flex items-center gap-1\">
                              <Clock className=\"h-3 w-3\" />
                              {new Date(email.received_at || email.created_at).toLocaleString()}
                            </span>
                            {email.extracted_data?.claimNumbers?.length > 0 && (
                              <span className=\"flex items-center gap-1\">
                                <FileText className=\"h-3 w-3\" />
                                Claims: {email.extracted_data.claimNumbers.join(', ')}
                              </span>
                            )}
                            {email.attachments_count > 0 && (
                              <span className=\"flex items-center gap-1\">
                                ðŸ“Ž {email.attachments_count} attachments
                              </span>
                            )}
                          </div>
                        </div>
                        <div className=\"flex gap-2 ml-4\">
                          <Button size=\"sm\" variant=\"outline\">
                            View
                          </Button>
                          <Button size=\"sm\" variant=\"outline\">
                            Reply
                          </Button>
                        </div>
                      </div>
                      
                      {/* Extracted Data Summary */}
                      {email.extracted_data && (
                        <div className=\"mt-3 p-3 bg-blue-50 rounded-lg\">
                          <h5 className=\"text-sm font-medium text-blue-900 mb-2 flex items-center gap-1\">
                            <Brain className=\"h-3 w-3\" />
                            AI Extracted Data
                          </h5>
                          <div className=\"grid grid-cols-2 md:grid-cols-4 gap-2 text-xs\">
                            {email.extracted_data.claimNumbers?.length > 0 && (
                              <div>
                                <span className=\"font-medium\">Claims:</span> {email.extracted_data.claimNumbers.join(', ')}
                              </div>
                            )}
                            {email.extracted_data.policyNumbers?.length > 0 && (
                              <div>
                                <span className=\"font-medium\">Policies:</span> {email.extracted_data.policyNumbers.join(', ')}
                              </div>
                            )}
                            {email.extracted_data.amounts?.estimate && (
                              <div>
                                <span className=\"font-medium\">Estimate:</span> ${email.extracted_data.amounts.estimate.toLocaleString()}
                              </div>
                            )}
                            {email.extracted_data.urgencyKeywords?.length > 0 && (
                              <div>
                                <span className=\"font-medium\">Urgency:</span> {email.extracted_data.urgencyKeywords.join(', ')}
                              </div>
                            )}
                          </div>
                        </div>
                      )}
                    </div>
                  ))
                )}
              </div>
            </CardContent>
          </Card>
        </div>
      )}

      {/* Call Tab */}
      {activeTab === 'calls' && (
        <Card>
          <CardContent className=\"p-8 text-center\">
            <Phone className=\"h-12 w-12 text-gray-300 mx-auto mb-4\" />
            <h3 className=\"text-lg font-medium text-gray-900 mb-2\">Call Management</h3>
            <p className=\"text-gray-600 mb-4\">Amazon Connect integration coming soon</p>
            <Button className=\"flex items-center gap-2 mx-auto\">
              <Settings className=\"h-4 w-4\" />
              Configure Phone System
            </Button>
          </CardContent>
        </Card>
      )}

      {/* SMS Tab */}
      {activeTab === 'sms' && (
        <Card>
          <CardContent className=\"p-8 text-center\">
            <MessageSquare className=\"h-12 w-12 text-gray-300 mx-auto mb-4\" />
            <h3 className=\"text-lg font-medium text-gray-900 mb-2\">SMS Management</h3>
            <p className=\"text-gray-600 mb-4\">SMS automation and tracking coming soon</p>
            <Button className=\"flex items-center gap-2 mx-auto\">
              <Settings className=\"h-4 w-4\" />
              Configure SMS Service
            </Button>
          </CardContent>
        </Card>
      )}

      {/* Settings Tab */}
      {activeTab === 'settings' && (
        <div className=\"space-y-6\">
          <Card>
            <CardHeader>
              <CardTitle>Email Integration Settings</CardTitle>
            </CardHeader>
            <CardContent className=\"space-y-4\">
              <div>
                <label className=\"block text-sm font-medium text-gray-700 mb-2\">
                  Email Provider
                </label>
                <select className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\">
                  <option value=\"\">Select email provider</option>
                  <option value=\"gmail\">Gmail</option>
                  <option value=\"outlook\">Outlook</option>
                  <option value=\"imap\">IMAP (Custom)</option>
                </select>
              </div>
              
              <div>
                <label className=\"block text-sm font-medium text-gray-700 mb-2\">
                  Excluded Domains (one per line)
                </label>
                <textarea
                  rows={4}
                  placeholder=\"example.com&#10;spam-domain.com\"
                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"
                />
              </div>
              
              <div className=\"flex items-center gap-2\">
                <input type=\"checkbox\" id=\"auto-classify\" className=\"rounded\" />
                <label htmlFor=\"auto-classify\" className=\"text-sm text-gray-700\">
                  Enable automatic email classification
                </label>
              </div>
              
              <div className=\"flex items-center gap-2\">
                <input type=\"checkbox\" id=\"auto-tasks\" className=\"rounded\" />
                <label htmlFor=\"auto-tasks\" className=\"text-sm text-gray-700\">
                  Create tasks automatically from email content
                </label>
              </div>
              
              <Button className=\"flex items-center gap-2\">
                <Settings className=\"h-4 w-4\" />
                Save Settings
              </Button>
            </CardContent>
          </Card>

          <Card>
            <CardHeader>
              <CardTitle>Phone Integration Settings</CardTitle>
            </CardHeader>
            <CardContent className=\"space-y-4\">
              <div>
                <label className=\"block text-sm font-medium text-gray-700 mb-2\">
                  Amazon Connect Instance ARN
                </label>
                <input
                  type=\"text\"
                  placeholder=\"arn:aws:connect:us-east-1:123456789:instance/...\"
                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"
                />
              </div>
              
              <div>
                <label className=\"block text-sm font-medium text-gray-700 mb-2\">
                  AWS Access Key ID
                </label>
                <input
                  type=\"text\"
                  placeholder=\"AKIA...\"
                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"
                />
              </div>
              
              <div>
                <label className=\"block text-sm font-medium text-gray-700 mb-2\">
                  AWS Secret Access Key
                </label>
                <input
                  type=\"password\"
                  placeholder=\"********\"
                  className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent\"
                />
              </div>
              
              <Button className=\"flex items-center gap-2\">
                <Settings className=\"h-4 w-4\" />
                Configure Phone System
              </Button>
            </CardContent>
          </Card>
        </div>
      )}
    </div>
  )
}
