/**
 * Claim Folder Manager
 * Manages folder structure and document organization for claims
 */

import React, { useState, useEffect } from 'react';
import { Folder, FolderPlus, Upload, FileText, MoreHorizontal, Move, Trash2 } from 'lucide-react';
import { Card } from '../ui/Card';
import { Button } from '../ui/Button';
import { Input } from '../ui/Input';
import { Badge } from '../ui/Badge';
import { Dialog, DialogContent, DialogHeader, DialogTitle, DialogTrigger } from '../ui/Dialog';
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuTrigger } from '../ui/DropdownMenu';
import { useToast } from '../../hooks/useToast';

interface DocumentFolder {
  id: string;
  name: string;
  claim_id: string;
  parent_folder_id?: string;
  folder_category: string;
  is_editable: boolean;
  is_deletable: boolean;
  sort_order: number;
  document_count: number;
}

interface ClaimDocument {
  id: string;
  filename: string;
  file_size: number;
  mime_type: string;
  folder_id?: string;
  uploaded_at: string;
}

interface ClaimFolderManagerProps {
  claimId: string;
  claimNumber: string;
  organizationId: string;
  onDocumentUpload?: (folderId: string, files: FileList) => void;
}

export const ClaimFolderManager: React.FC<ClaimFolderManagerProps> = ({
  claimId,
  claimNumber,
  organizationId,
  onDocumentUpload
}) => {
  const [folders, setFolders] = useState<DocumentFolder[]>([]);
  const [documents, setDocuments] = useState<ClaimDocument[]>([]);
  const [loading, setLoading] = useState(true);
  const [isCreateFolderOpen, setIsCreateFolderOpen] = useState(false);
  const [newFolderName, setNewFolderName] = useState('');
  const [selectedParentFolder, setSelectedParentFolder] = useState<string>('');
  const { success, error, warning, info } = useToast();

  useEffect(() => {
    loadFoldersAndDocuments();
  }, [claimId]);

  const loadFoldersAndDocuments = async () => {
    try {
      setLoading(true);
      // Mock data for now - in production, load from Supabase
      const mockFolders: DocumentFolder[] = [
        {
          id: 'folder-1',
          name: `${claimNumber} - Insurer Docs`,
          claim_id: claimId,
          folder_category: 'insurer',
          is_editable: false,
          is_deletable: false,
          sort_order: 1,
          document_count: 3
        },
        {
          id: 'folder-2',
          name: `${claimNumber} - Client Docs`,
          claim_id: claimId,
          folder_category: 'client',
          is_editable: false,
          is_deletable: false,
          sort_order: 2,
          document_count: 5
        },
        {
          id: 'folder-3',
          name: `${claimNumber} - Intake Docs`,
          claim_id: claimId,
          folder_category: 'intake',
          is_editable: false,
          is_deletable: false,
          sort_order: 3,
          document_count: 2
        },
        {
          id: 'folder-4',
          name: `${claimNumber} - Vendor Docs`,
          claim_id: claimId,
          folder_category: 'vendor',
          is_editable: false,
          is_deletable: false,
          sort_order: 4,
          document_count: 1
        },
        {
          id: 'folder-5',
          name: `${claimNumber} - Company Docs`,
          claim_id: claimId,
          folder_category: 'company',
          is_editable: false,
          is_deletable: false,
          sort_order: 5,
          document_count: 4
        }
      ];

      const mockDocuments: ClaimDocument[] = [
        {
          id: 'doc-1',
          filename: 'policy_document.pdf',
          file_size: 2048576,
          mime_type: 'application/pdf',
          folder_id: 'folder-1',
          uploaded_at: '2024-01-15T10:30:00Z'
        },
        {
          id: 'doc-2',
          filename: 'damage_photos.zip',
          file_size: 5242880,
          mime_type: 'application/zip',
          folder_id: 'folder-2',
          uploaded_at: '2024-01-15T11:45:00Z'
        }
      ];

      setFolders(mockFolders);
      setDocuments(mockDocuments);
    } catch (error) {
      console.error('Error loading folders and documents:', error);
      error('Failed to load folder structure');
    } finally {
      setLoading(false);
    }
  };

  const createFolder = async () => {
    if (!newFolderName.trim()) {
      error('Folder name is required');
      return;
    }

    try {
      // In production, save to Supabase
      const newFolder: DocumentFolder = {
        id: `folder-${Date.now()}`,
        name: newFolderName,
        claim_id: claimId,
        parent_folder_id: selectedParentFolder || undefined,
        folder_category: 'custom',
        is_editable: true,
        is_deletable: true,
        sort_order: folders.length + 1,
        document_count: 0
      };

      setFolders(prev => [...prev, newFolder]);
      setNewFolderName('');
      setSelectedParentFolder('');
      setIsCreateFolderOpen(false);
      success('Folder created successfully');
    } catch (error) {
      console.error('Error creating folder:', error);
      error('Failed to create folder');
    }
  };

  const deleteFolder = async (folderId: string) => {
    const folder = folders.find(f => f.id === folderId);
    if (!folder?.is_deletable) {
      error('This system folder cannot be deleted');
      return;
    }

    if (!confirm('Are you sure you want to delete this folder? Documents will be moved to the root level.')) {
      return;
    }

    try {
      // In production, delete from Supabase and move documents
      setFolders(prev => prev.filter(f => f.id !== folderId));
      success('Folder deleted successfully');
    } catch (error) {
      console.error('Error deleting folder:', error);
      error('Failed to delete folder');
    }
  };

  const handleFileUpload = (folderId: string) => {
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.onchange = (e) => {
      const files = (e.target as HTMLInputElement).files;
      if (files && onDocumentUpload) {
        onDocumentUpload(folderId, files);
      }
    };
    input.click();
  };

  const formatFileSize = (bytes: number) => {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
  };

  const getCategoryBadgeColor = (category: string) => {
    const colors = {
      insurer: 'bg-blue-100 text-blue-800',
      client: 'bg-green-100 text-green-800',
      intake: 'bg-purple-100 text-purple-800',
      vendor: 'bg-orange-100 text-orange-800',
      company: 'bg-gray-100 text-gray-800',
      custom: 'bg-indigo-100 text-indigo-800'
    };
    return colors[category as keyof typeof colors] || colors.custom;
  };

  if (loading) {
    return (
      <Card className="p-6">
        <div className="flex items-center justify-center py-8">
          <div className="text-gray-500">Loading folder structure...</div>
        </div>
      </Card>
    );
  }

  return (
    <div className="space-y-6">
      <div className="flex items-center justify-between">
        <h3 className="text-lg font-semibold">Document Organization</h3>
        <Dialog open={isCreateFolderOpen} onOpenChange={setIsCreateFolderOpen}>
          <DialogTrigger asChild>
            <Button variant="outline" size="sm">
              <FolderPlus className="h-4 w-4 mr-2" />
              New Folder
            </Button>
          </DialogTrigger>
          <DialogContent>
            <DialogHeader>
              <DialogTitle>Create New Folder</DialogTitle>
            </DialogHeader>
            <div className="space-y-4">
              <div>
                <label className="text-sm font-medium">Folder Name</label>
                <Input
                  value={newFolderName}
                  onChange={(e) => setNewFolderName(e.target.value)}
                  placeholder="Enter folder name"
                  className="mt-1"
                />
              </div>
              <div className="flex justify-end gap-2">
                <Button variant="outline" onClick={() => setIsCreateFolderOpen(false)}>
                  Cancel
                </Button>
                <Button onClick={createFolder}>Create Folder</Button>
              </div>
            </div>
          </DialogContent>
        </Dialog>
      </div>

      <div className="grid gap-4">
        {folders.map((folder) => (
          <Card key={folder.id} className="p-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-3">
                <Folder className="h-5 w-5 text-blue-600" />
                <div>
                  <div className="flex items-center gap-2">
                    <span className="font-medium">{folder.name}</span>
                    <Badge 
                      variant="secondary" 
                      className={getCategoryBadgeColor(folder.folder_category)}
                    >
                      {folder.folder_category}
                    </Badge>
                    {!folder.is_editable && (
                      <Badge variant="outline" className="text-xs">
                        System
                      </Badge>
                    )}
                  </div>
                  <div className="text-sm text-gray-500">
                    {folder.document_count} document{folder.document_count !== 1 ? 's' : ''}
                  </div>
                </div>
              </div>
              
              <div className="flex items-center gap-2">
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => handleFileUpload(folder.id)}
                >
                  <Upload className="h-4 w-4 mr-2" />
                  Upload
                </Button>
                
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <Button variant="ghost" size="sm" className="p-2">
                      <MoreHorizontal className="h-4 w-4" />
                    </Button>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end">
                    <DropdownMenuItem onClick={() => handleFileUpload(folder.id)}>
                      <Upload className="h-4 w-4 mr-2" />
                      Upload Documents
                    </DropdownMenuItem>
                    {folder.is_editable && (
                      <DropdownMenuItem>
                        <Move className="h-4 w-4 mr-2" />
                        Rename Folder
                      </DropdownMenuItem>
                    )}
                    {folder.is_deletable && (
                      <DropdownMenuItem 
                        onClick={() => deleteFolder(folder.id)}
                        className="text-red-600"
                      >
                        <Trash2 className="h-4 w-4 mr-2" />
                        Delete Folder
                      </DropdownMenuItem>
                    )}
                  </DropdownMenuContent>
                </DropdownMenu>
              </div>
            </div>

            {/* Documents in this folder */}
            {documents.filter(doc => doc.folder_id === folder.id).length > 0 && (
              <div className="mt-3 pt-3 border-t border-gray-200">
                <div className="space-y-2">
                  {documents
                    .filter(doc => doc.folder_id === folder.id)
                    .map(doc => (
                      <div key={doc.id} className="flex items-center justify-between text-sm">
                        <div className="flex items-center gap-2">
                          <FileText className="h-4 w-4 text-gray-500" />
                          <span>{doc.filename}</span>
                        </div>
                        <div className="text-gray-500">
                          {formatFileSize(doc.file_size)}
                        </div>
                      </div>
                    ))}
                </div>
              </div>
            )}
          </Card>
        ))}

        {folders.length === 0 && (
          <Card className="p-8 text-center">
            <Folder className="h-12 w-12 text-gray-400 mx-auto mb-4" />
            <h3 className="text-lg font-semibold mb-2">No Folders Created</h3>
            <p className="text-gray-600 mb-4">
              Create folders to organize your claim documents
            </p>
            <Button onClick={() => setIsCreateFolderOpen(true)}>
              <FolderPlus className="h-4 w-4 mr-2" />
              Create First Folder
            </Button>
          </Card>
        )}
      </div>
    </div>
  );
};

export default ClaimFolderManager;
