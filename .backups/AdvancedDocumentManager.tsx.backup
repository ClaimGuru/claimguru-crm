import React, { useState, useEffect } from 'react'
import { Card, CardContent, CardHeader, CardTitle } from '../ui/Card'
import { Button } from '../ui/Button'
import { LoadingSpinner } from '../ui/LoadingSpinner'
import { DocumentUpload } from '../ui/DocumentUpload'
import { AIDocumentAnalysis } from './AIDocumentAnalysis'
import { DocumentVersionHistory } from './DocumentVersionHistory'
import { DocumentShareModal } from './DocumentShareModal'
import { 
  Upload, 
  Search, 
  Filter, 
  FolderOpen,
  FileText,
  Image,
  Video,
  Archive,
  Download,
  Share,
  Eye,
  Edit,
  Trash2,
  Star,
  Clock,
  Users,
  Shield,
  Brain,
  Zap,
  Tag,
  Grid,
  List,
  Calendar,
  CheckCircle,
  AlertTriangle,
  FileCheck,
  Lock,
  Globe,
  Link,
  Copy,
  MoreVertical
} from 'lucide-react'
import { useAuth } from '../../contexts/AuthContext'
import { supabase } from '../../lib/supabase'

interface Document {
  id: string
  name: string
  type: string
  size: number
  url: string
  created_at: string
  updated_at: string
  created_by: string
  claim_id?: string
  client_id?: string
  category: string
  tags: string[]
  is_shared: boolean
  share_permissions: string[]
  compliance_status: 'compliant' | 'pending' | 'non_compliant'
  ai_analysis?: any
  version: number
  is_starred: boolean
  last_accessed: string
}

interface DocumentFolder {
  id: string
  name: string
  parent_id?: string
  created_at: string
  document_count: number
  is_template: boolean
}

const DOCUMENT_CATEGORIES = [
  { id: 'all', name: 'All Documents', icon: FileText, color: 'gray' },
  { id: 'photos', name: 'Photos & Images', icon: Image, color: 'blue' },
  { id: 'estimates', name: 'Estimates', icon: FileCheck, color: 'green' },
  { id: 'invoices', name: 'Invoices', icon: FileText, color: 'purple' },
  { id: 'contracts', name: 'Contracts', icon: FileCheck, color: 'orange' },
  { id: 'correspondence', name: 'Correspondence', icon: FileText, color: 'teal' },
  { id: 'reports', name: 'Reports', icon: FileText, color: 'indigo' },
  { id: 'videos', name: 'Videos', icon: Video, color: 'red' },
  { id: 'archived', name: 'Archived', icon: Archive, color: 'gray' }
]

export function AdvancedDocumentManager() {
  const { userProfile } = useAuth()
  const [loading, setLoading] = useState(true)
  const [documents, setDocuments] = useState<Document[]>([])
  const [folders, setFolders] = useState<DocumentFolder[]>([])
  const [selectedCategory, setSelectedCategory] = useState('all')
  const [searchTerm, setSearchTerm] = useState('')
  const [viewMode, setViewMode] = useState<'grid' | 'list'>('grid')
  const [selectedDocuments, setSelectedDocuments] = useState<string[]>([])
  const [isUploadOpen, setIsUploadOpen] = useState(false)
  const [selectedDocument, setSelectedDocument] = useState<Document | null>(null)
  const [showAIAnalysis, setShowAIAnalysis] = useState(false)
  const [showVersionHistory, setShowVersionHistory] = useState(false)
  const [showShareModal, setShowShareModal] = useState(false)

  useEffect(() => {
    if (userProfile?.organization_id) {
      loadDocuments()
      loadFolders()
    }
  }, [userProfile?.organization_id])

  async function loadDocuments() {
    setLoading(true)
    try {
      // Mock data for now - in production this would come from Supabase
      const mockDocuments: Document[] = [
        {
          id: '1',
          name: 'Property Damage Photos - Kitchen Fire.zip',
          type: 'application/zip',
          size: 15680000,
          url: '/documents/damage-photos.zip',
          created_at: '2025-07-08T10:30:00Z',
          updated_at: '2025-07-08T10:30:00Z',
          created_by: 'John Adjuster',
          claim_id: 'claim-001',
          category: 'photos',
          tags: ['fire damage', 'kitchen', 'before/after'],
          is_shared: true,
          share_permissions: ['client', 'carrier'],
          compliance_status: 'compliant',
          ai_analysis: {
            damage_detected: ['fire damage', 'smoke damage', 'water damage'],
            estimated_value: 25000,
            confidence: 0.92
          },
          version: 1,
          is_starred: true,
          last_accessed: '2025-07-09T14:20:00Z'
        },
        {
          id: '2',
          name: 'Restoration Estimate - ABC Company.pdf',
          type: 'application/pdf',
          size: 2340000,
          url: '/documents/estimate.pdf',
          created_at: '2025-07-07T16:45:00Z',
          updated_at: '2025-07-07T16:45:00Z',
          created_by: 'Sarah Estimator',
          claim_id: 'claim-001',
          category: 'estimates',
          tags: ['restoration', 'kitchen', 'approved'],
          is_shared: true,
          share_permissions: ['client'],
          compliance_status: 'compliant',
          version: 2,
          is_starred: false,
          last_accessed: '2025-07-09T09:15:00Z'
        },
        {
          id: '3',
          name: 'Assignment of Benefits Contract.docx',
          type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',
          size: 890000,
          url: '/documents/contract.docx',
          created_at: '2025-07-06T11:20:00Z',
          updated_at: '2025-07-08T14:30:00Z',
          created_by: 'Legal Team',
          client_id: 'client-001',
          category: 'contracts',
          tags: ['AOB', 'signed', 'legal'],
          is_shared: false,
          share_permissions: [],
          compliance_status: 'compliant',
          version: 3,
          is_starred: true,
          last_accessed: '2025-07-09T11:45:00Z'
        }
      ]
      setDocuments(mockDocuments)
    } catch (error) {
      console.error('Error loading documents:', error)
    } finally {
      setLoading(false)
    }
  }

  async function loadFolders() {
    try {
      // Mock folder data
      const mockFolders: DocumentFolder[] = [
        { id: '1', name: 'Claim Templates', created_at: '2025-07-01T00:00:00Z', document_count: 12, is_template: true },
        { id: '2', name: 'Active Claims', created_at: '2025-07-01T00:00:00Z', document_count: 45, is_template: false },
        { id: '3', name: 'Completed Claims', created_at: '2025-06-01T00:00:00Z', document_count: 128, is_template: false },
        { id: '4', name: 'Client Communications', created_at: '2025-07-01T00:00:00Z', document_count: 67, is_template: false }
      ]
      setFolders(mockFolders)
    } catch (error) {
      console.error('Error loading folders:', error)
    }
  }

  const filteredDocuments = documents.filter(doc => {
    const matchesCategory = selectedCategory === 'all' || doc.category === selectedCategory
    const matchesSearch = searchTerm === '' || 
      doc.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
      doc.tags.some(tag => tag.toLowerCase().includes(searchTerm.toLowerCase()))
    return matchesCategory && matchesSearch
  })

  const getFileIcon = (type: string) => {
    if (type.startsWith('image/')) return <Image className="h-8 w-8 text-blue-600" />
    if (type.startsWith('video/')) return <Video className="h-8 w-8 text-red-600" />
    if (type === 'application/pdf') return <FileText className="h-8 w-8 text-red-600" />
    if (type.includes('zip') || type.includes('archive')) return <Archive className="h-8 w-8 text-yellow-600" />
    return <FileText className="h-8 w-8 text-gray-600" />
  }

  const formatFileSize = (bytes: number) => {
    if (bytes === 0) return '0 Bytes'
    const k = 1024
    const sizes = ['Bytes', 'KB', 'MB', 'GB']
    const i = Math.floor(Math.log(bytes) / Math.log(k))
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i]
  }

  const getComplianceIcon = (status: string) => {
    switch (status) {
      case 'compliant':
        return <CheckCircle className="h-4 w-4 text-green-600" />
      case 'pending':
        return <Clock className="h-4 w-4 text-yellow-600" />
      case 'non_compliant':
        return <AlertTriangle className="h-4 w-4 text-red-600" />
      default:
        return null
    }
  }

  const handleDocumentSelect = (docId: string) => {
    setSelectedDocuments(prev => 
      prev.includes(docId) 
        ? prev.filter(id => id !== docId)
        : [...prev, docId]
    )
  }

  const handleBulkAction = (action: string) => {
    console.log(`Performing ${action} on documents:`, selectedDocuments)
    // Implement bulk actions (download, share, delete, etc.)
  }

  const handleShareDocument = (document: Document) => {
    setSelectedDocument(document)
    setShowShareModal(true)
  }

  const handleAIAnalysis = (document: Document) => {
    setSelectedDocument(document)
    setShowAIAnalysis(true)
  }

  if (loading) {
    return (
      <div className="flex items-center justify-center h-64">
        <LoadingSpinner size="lg" />
      </div>
    )
  }

  return (
    <div className="space-y-6">
      {/* Header with Actions */}
      <div className="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
        <div>
          <h1 className="text-3xl font-bold text-gray-900 flex items-center gap-2">
            <FolderOpen className="h-8 w-8 text-blue-600" />
            Smart Document Vault
          </h1>
          <p className="text-gray-600 mt-2">
            AI-powered document management with instant search and compliance tracking
          </p>
        </div>
        <div className="flex items-center gap-2">
          <Button
            variant="outline"
            size="sm"
            onClick={() => setViewMode(viewMode === 'grid' ? 'list' : 'grid')}
            className="flex items-center gap-2"
          >
            {viewMode === 'grid' ? <List className="h-4 w-4" /> : <Grid className="h-4 w-4" />}
            {viewMode === 'grid' ? 'List View' : 'Grid View'}
          </Button>
          <Button
            onClick={() => setIsUploadOpen(true)}
            className="flex items-center gap-2"
          >
            <Upload className="h-4 w-4" />
            Upload Documents
          </Button>
        </div>
      </div>

      {/* Quick Stats */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Total Documents</p>
                <p className="text-3xl font-bold text-gray-900">{documents.length}</p>
              </div>
              <FileText className="h-8 w-8 text-blue-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Shared Documents</p>
                <p className="text-3xl font-bold text-gray-900">
                  {documents.filter(d => d.is_shared).length}
                </p>
              </div>
              <Share className="h-8 w-8 text-green-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">AI Analyzed</p>
                <p className="text-3xl font-bold text-gray-900">
                  {documents.filter(d => d.ai_analysis).length}
                </p>
              </div>
              <Brain className="h-8 w-8 text-purple-600" />
            </div>
          </CardContent>
        </Card>

        <Card>
          <CardContent className="p-6">
            <div className="flex items-center justify-between">
              <div>
                <p className="text-sm font-medium text-gray-600">Compliance Rate</p>
                <p className="text-3xl font-bold text-gray-900">
                  {Math.round((documents.filter(d => d.compliance_status === 'compliant').length / documents.length) * 100)}%
                </p>
              </div>
              <Shield className="h-8 w-8 text-teal-600" />
            </div>
          </CardContent>
        </Card>
      </div>

      <div className="grid grid-cols-1 lg:grid-cols-4 gap-6">
        {/* Sidebar - Categories and Folders */}
        <div className="space-y-6">
          {/* Search */}
          <Card>
            <CardContent className="p-4">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 h-4 w-4" />
                <input
                  type="text"
                  placeholder="Search documents..."
                  value={searchTerm}
                  onChange={(e) => setSearchTerm(e.target.value)}
                  className="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                />
              </div>
            </CardContent>
          </Card>

          {/* Categories */}
          <Card>
            <CardHeader>
              <CardTitle className="text-sm font-medium">Categories</CardTitle>
            </CardHeader>
            <CardContent className="p-0">
              <div className="space-y-1">
                {DOCUMENT_CATEGORIES.map(category => {
                  const Icon = category.icon
                  const count = category.id === 'all' 
                    ? documents.length 
                    : documents.filter(d => d.category === category.id).length
                  
                  return (
                    <button
                      key={category.id}
                      onClick={() => setSelectedCategory(category.id)}
                      className={`w-full flex items-center justify-between px-4 py-2 text-left hover:bg-gray-50 ${
                        selectedCategory === category.id ? 'bg-blue-50 text-blue-700 border-r-2 border-blue-500' : 'text-gray-700'
                      }`}
                    >
                      <div className="flex items-center gap-2">
                        <Icon className="h-4 w-4" />
                        <span className="text-sm">{category.name}</span>
                      </div>
                      <span className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full">
                        {count}
                      </span>
                    </button>
                  )
                })}
              </div>
            </CardContent>
          </Card>

          {/* Quick Actions */}
          <Card>
            <CardHeader>
              <CardTitle className="text-sm font-medium">Quick Actions</CardTitle>
            </CardHeader>
            <CardContent className="p-4 space-y-2">
              <Button variant="outline" size="sm" className="w-full justify-start">
                <Zap className="h-4 w-4 mr-2" />
                Bulk Upload
              </Button>
              <Button variant="outline" size="sm" className="w-full justify-start">
                <Brain className="h-4 w-4 mr-2" />
                AI Batch Analysis
              </Button>
              <Button variant="outline" size="sm" className="w-full justify-start">
                <Shield className="h-4 w-4 mr-2" />
                Compliance Check
              </Button>
            </CardContent>
          </Card>
        </div>

        {/* Main Content */}
        <div className="lg:col-span-3 space-y-6">
          {/* Bulk Actions Bar */}
          {selectedDocuments.length > 0 && (
            <Card className="bg-blue-50 border-blue-200">
              <CardContent className="p-4">
                <div className="flex items-center justify-between">
                  <span className="text-sm font-medium text-blue-900">
                    {selectedDocuments.length} document(s) selected
                  </span>
                  <div className="flex items-center gap-2">
                    <Button size="sm" variant="outline" onClick={() => handleBulkAction('download')}>
                      <Download className="h-4 w-4 mr-1" />
                      Download
                    </Button>
                    <Button size="sm" variant="outline" onClick={() => handleBulkAction('share')}>
                      <Share className="h-4 w-4 mr-1" />
                      Share
                    </Button>
                    <Button size="sm" variant="outline" onClick={() => handleBulkAction('delete')}>
                      <Trash2 className="h-4 w-4 mr-1" />
                      Delete
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>
          )}

          {/* Document Grid/List */}
          {viewMode === 'grid' ? (
            <div className="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
              {filteredDocuments.map(document => (
                <Card key={document.id} className="hover:shadow-lg transition-shadow">
                  <CardContent className="p-4">
                    <div className="flex items-start justify-between mb-3">
                      <div className="flex items-center gap-3">
                        <input
                          type="checkbox"
                          checked={selectedDocuments.includes(document.id)}
                          onChange={() => handleDocumentSelect(document.id)}
                          className="rounded border-gray-300"
                        />
                        {getFileIcon(document.type)}
                      </div>
                      <div className="flex items-center gap-1">
                        {document.is_starred && <Star className="h-4 w-4 text-yellow-500 fill-current" />}
                        {getComplianceIcon(document.compliance_status)}
                        <Button variant="ghost" size="sm">
                          <MoreVertical className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>
                    
                    <h3 className="font-medium text-gray-900 mb-2 line-clamp-2">
                      {document.name}
                    </h3>
                    
                    <div className="space-y-2 text-sm text-gray-600">
                      <div className="flex items-center justify-between">
                        <span>Size:</span>
                        <span>{formatFileSize(document.size)}</span>
                      </div>
                      <div className="flex items-center justify-between">
                        <span>Version:</span>
                        <span>v{document.version}</span>
                      </div>
                      <div className="flex items-center justify-between">
                        <span>Shared:</span>
                        <span>{document.is_shared ? 'Yes' : 'No'}</span>
                      </div>
                    </div>

                    {document.tags.length > 0 && (
                      <div className="flex flex-wrap gap-1 mt-3">
                        {document.tags.slice(0, 2).map(tag => (
                          <span key={tag} className="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">
                            {tag}
                          </span>
                        ))}
                        {document.tags.length > 2 && (
                          <span className="px-2 py-1 bg-gray-100 text-gray-600 text-xs rounded">
                            +{document.tags.length - 2}
                          </span>
                        )}
                      </div>
                    )}

                    <div className="flex items-center justify-between mt-4 pt-3 border-t border-gray-200">
                      <div className="flex items-center gap-1">
                        <Button variant="ghost" size="sm" onClick={() => handleAIAnalysis(document)}>
                          <Brain className="h-4 w-4" />
                        </Button>
                        <Button variant="ghost" size="sm">
                          <Eye className="h-4 w-4" />
                        </Button>
                        <Button variant="ghost" size="sm" onClick={() => handleShareDocument(document)}>
                          <Share className="h-4 w-4" />
                        </Button>
                      </div>
                      <Button variant="ghost" size="sm">
                        <Download className="h-4 w-4" />
                      </Button>
                    </div>
                  </CardContent>
                </Card>
              ))}
            </div>
          ) : (
            <Card>
              <CardContent className="p-0">
                <div className="overflow-x-auto">
                  <table className="w-full">
                    <thead className="bg-gray-50">
                      <tr>
                        <th className="text-left py-3 px-4 font-medium text-gray-600">
                          <input
                            type="checkbox"
                            onChange={(e) => {
                              if (e.target.checked) {
                                setSelectedDocuments(filteredDocuments.map(d => d.id))
                              } else {
                                setSelectedDocuments([])
                              }
                            }}
                            className="rounded border-gray-300"
                          />
                        </th>
                        <th className="text-left py-3 px-4 font-medium text-gray-600">Document</th>
                        <th className="text-left py-3 px-4 font-medium text-gray-600">Type</th>
                        <th className="text-left py-3 px-4 font-medium text-gray-600">Size</th>
                        <th className="text-left py-3 px-4 font-medium text-gray-600">Modified</th>
                        <th className="text-left py-3 px-4 font-medium text-gray-600">Status</th>
                        <th className="text-left py-3 px-4 font-medium text-gray-600">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {filteredDocuments.map(document => (
                        <tr key={document.id} className="border-b border-gray-100 hover:bg-gray-50">
                          <td className="py-3 px-4">
                            <input
                              type="checkbox"
                              checked={selectedDocuments.includes(document.id)}
                              onChange={() => handleDocumentSelect(document.id)}
                              className="rounded border-gray-300"
                            />
                          </td>
                          <td className="py-3 px-4">
                            <div className="flex items-center gap-3">
                              {getFileIcon(document.type)}
                              <div>
                                <div className="font-medium text-gray-900">{document.name}</div>
                                <div className="text-sm text-gray-600">by {document.created_by}</div>
                              </div>
                            </div>
                          </td>
                          <td className="py-3 px-4 text-gray-600">{document.category}</td>
                          <td className="py-3 px-4 text-gray-600">{formatFileSize(document.size)}</td>
                          <td className="py-3 px-4 text-gray-600">
                            {new Date(document.updated_at).toLocaleDateString()}
                          </td>
                          <td className="py-3 px-4">
                            <div className="flex items-center gap-2">
                              {getComplianceIcon(document.compliance_status)}
                              {document.is_shared && <Share className="h-4 w-4 text-blue-600" />}
                              {document.is_starred && <Star className="h-4 w-4 text-yellow-500 fill-current" />}
                            </div>
                          </td>
                          <td className="py-3 px-4">
                            <div className="flex items-center gap-1">
                              <Button variant="ghost" size="sm">
                                <Eye className="h-4 w-4" />
                              </Button>
                              <Button variant="ghost" size="sm" onClick={() => handleShareDocument(document)}>
                                <Share className="h-4 w-4" />
                              </Button>
                              <Button variant="ghost" size="sm">
                                <Download className="h-4 w-4" />
                              </Button>
                            </div>
                          </td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </CardContent>
            </Card>
          )}
        </div>
      </div>

      {/* Upload Modal */}
      {isUploadOpen && (
        <DocumentUpload
          onClose={() => setIsUploadOpen(false)}
          onUpload={(files) => {
            console.log('Uploading files:', files)
            setIsUploadOpen(false)
            // Refresh documents list
            loadDocuments()
          }}
        />
      )}

      {/* AI Analysis Modal */}
      {showAIAnalysis && selectedDocument && (
        <AIDocumentAnalysis
          document={selectedDocument}
          isOpen={showAIAnalysis}
          onClose={() => setShowAIAnalysis(false)}
        />
      )}

      {/* Version History Modal */}
      {showVersionHistory && selectedDocument && (
        <DocumentVersionHistory
          document={selectedDocument}
          isOpen={showVersionHistory}
          onClose={() => setShowVersionHistory(false)}
        />
      )}
    </div>
  )
}
