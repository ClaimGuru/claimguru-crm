import React, { useState, useEffect } from 'react';
import { Card, CardContent, CardHeader, CardTitle } from '../../ui/Card';
import { Input } from '../../ui/Input';
import { Switch } from '../../ui/Switch';
import { AddressAutocomplete } from '../../ui/AddressAutocomplete';
import { 
  User, 
  MapPin, 
  Phone, 
  Mail,
  Users
} from 'lucide-react';

interface ManualClientDetailsStepProps {
  data: any;
  onUpdate: (data: any) => void;
}

export const ManualClientDetailsStep: React.FC<ManualClientDetailsStepProps> = ({
  data,
  onUpdate
}) => {
  // Initialize data from root level (matching schema expectations)
  const [clientDetails, setClientDetails] = useState({
    clientType: 'individual',
    firstName: '',
    lastName: '',
    businessName: '',
    primaryPhone: '',
    phoneType: 'cell', // Default to cell phone
    primaryEmail: '',
    alternatePhone: '',
    mailingAddress: {
      addressLine1: '',
      addressLine2: '',
      city: '',
      state: '',
      zipCode: ''
    },
    hasCoInsured: false,
    coInsuredName: '',
    coInsuredRelationship: '',
    // Load existing data from root level
    ...data
  });

  const handleInputChange = (field: string, value: string | boolean) => {
    const updatedDetails = { ...clientDetails };
    setFieldValue(updatedDetails, field, value);
    setClientDetails(updatedDetails);
    updateWizardData(updatedDetails);
  };

  const handleSwitchChange = (field: string, checked: boolean) => {
    const updatedDetails = {
      ...clientDetails,
      [field]: checked
    };
    setClientDetails(updatedDetails);
    updateWizardData(updatedDetails);
  };

  const handleAddressAutocomplete = (address: string, details?: google.maps.places.PlaceResult) => {
    // Parse the address or use details if available
    let addressData = {
      addressLine1: address,
      addressLine2: clientDetails.mailingAddress.addressLine2 || '',
      city: '',
      state: '',
      zipCode: ''
    };

    // If we have place details, extract components
    if (details && details.address_components) {
      const components = details.address_components;
      const streetNumber = components.find(c => c.types.includes('street_number'))?.long_name || '';
      const street = components.find(c => c.types.includes('route'))?.long_name || '';
      const city = components.find(c => c.types.includes('locality'))?.long_name || '';
      const state = components.find(c => c.types.includes('administrative_area_level_1'))?.short_name || '';
      const zipCode = components.find(c => c.types.includes('postal_code'))?.long_name || '';
      
      addressData = {
        addressLine1: `${streetNumber} ${street}`.trim(),
        addressLine2: clientDetails.mailingAddress.addressLine2 || '',
        city: city,
        state: state,
        zipCode: zipCode
      };
    }

    const updatedDetails = {
      ...clientDetails,
      mailingAddress: addressData
    };
    setClientDetails(updatedDetails);
    updateWizardData(updatedDetails);
  };

  const handleAddressFieldChange = (field: string, value: string) => {
    const updatedDetails = {
      ...clientDetails,
      mailingAddress: {
        ...clientDetails.mailingAddress,
        [field]: value
      }
    };
    setClientDetails(updatedDetails);
    updateWizardData(updatedDetails);
  };

  const updateWizardData = (details: any) => {
    // Update data at root level to match schema expectations
    onUpdate({
      ...data,
      ...details
    });
  };

  // Utility function to set nested field values
  const setFieldValue = (obj: any, path: string, value: any) => {
    const keys = path.split('.');
    const lastKey = keys.pop()!;
    const target = keys.reduce((current, key) => {
      if (!current[key]) current[key] = {};
      return current[key];
    }, obj);
    target[lastKey] = value;
  };

  return (
    <div className="space-y-6">
      {/* Main Client Details Form */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center gap-2">
            <User className="h-5 w-5 text-blue-600" />
            Client Information
          </CardTitle>
        </CardHeader>
        <CardContent className="space-y-4">
          {/* Client Type Selection */}
          <div className="space-y-3">
            <label className="block text-sm font-medium text-gray-700">
              Client Type *
            </label>
            <div className="flex gap-6">
              <label className="flex items-center gap-2">
                <input
                  type="radio"
                  value="individual"
                  checked={clientDetails.clientType === 'individual'}
                  onChange={(e) => handleInputChange('clientType', e.target.value)}
                  className="text-blue-600 focus:ring-blue-500"
                />
                <span className="text-sm">Individual/Residential</span>
              </label>
              <label className="flex items-center gap-2">
                <input
                  type="radio"
                  value="business"
                  checked={clientDetails.clientType === 'business'}
                  onChange={(e) => handleInputChange('clientType', e.target.value)}
                  className="text-blue-600 focus:ring-blue-500"
                />
                <span className="text-sm">Business/Commercial</span>
              </label>
            </div>
          </div>

          {/* Personal Information */}
          {clientDetails.clientType === 'individual' && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                First Name *
              </label>
              <Input
                type="text"
                value={clientDetails.firstName}
                onChange={(e) => handleInputChange('firstName', e.target.value)}
                placeholder="Enter first name"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Last Name *
              </label>
              <Input
                type="text"
                value={clientDetails.lastName}
                onChange={(e) => handleInputChange('lastName', e.target.value)}
                placeholder="Enter last name"
                required
              />
            </div>
            </div>
          )}

          {/* Business Information */}
          {clientDetails.clientType === 'business' && (
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Business Name *
              </label>
              <Input
                type="text"
                value={clientDetails.businessName || ''}
                onChange={(e) => handleInputChange('businessName', e.target.value)}
                placeholder="Enter business name"
                required
              />
            </div>
          )}

          {/* Contact Information */}
          <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div className="md:col-span-2">
              <label className="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-2">
                <Phone className="h-4 w-4" />
                Primary Phone *
              </label>
              <Input
                type="tel"
                value={clientDetails.primaryPhone}
                onChange={(e) => handleInputChange('primaryPhone', e.target.value)}
                placeholder="(555) 123-4567"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Phone Type
              </label>
              <select
                value={clientDetails.phoneType}
                onChange={(e) => handleInputChange('phoneType', e.target.value)}
                className="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
              >
                <option value="cell">Cell Phone</option>
                <option value="home">Home</option>
                <option value="office">Office</option>
                <option value="work">Work</option>
                <option value="business">Business</option>
                <option value="other">Other</option>
              </select>
            </div>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1 flex items-center gap-2">
                <Mail className="h-4 w-4" />
                Primary Email *
              </label>
              <Input
                type="email"
                value={clientDetails.primaryEmail}
                onChange={(e) => handleInputChange('primaryEmail', e.target.value)}
                placeholder="Enter email address"
                required
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Alternate Phone
              </label>
              <Input
                type="tel"
                value={clientDetails.alternatePhone}
                onChange={(e) => handleInputChange('alternatePhone', e.target.value)}
                placeholder="(555) 123-4567"
              />
            </div>
          </div>

          {/* Mailing Address */}
          <div className="space-y-4">
            <h4 className="text-sm font-medium text-gray-700 flex items-center gap-2">
              <MapPin className="h-4 w-4" />
              Mailing Address *
            </h4>
            
            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Street Address (Address 1) *
              </label>
              <AddressAutocomplete
                value={clientDetails.mailingAddress?.addressLine1 || ''}
                onChange={handleAddressAutocomplete}
                placeholder="Start typing street address..."
              />
            </div>

            <div>
              <label className="block text-sm font-medium text-gray-700 mb-1">
                Apartment, Suite, Unit, etc. (Address 2)
              </label>
              <Input
                type="text"
                value={clientDetails.mailingAddress?.addressLine2 || ''}
                onChange={(e) => handleAddressFieldChange('addressLine2', e.target.value)}
                placeholder="Apt, Suite, Unit, Building, Floor, etc."
              />
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  City *
                </label>
                <Input
                  type="text"
                  value={clientDetails.mailingAddress?.city || ''}
                  onChange={(e) => handleAddressFieldChange('city', e.target.value)}
                  placeholder="City"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  State *
                </label>
                <Input
                  type="text"
                  value={clientDetails.mailingAddress?.state || ''}
                  onChange={(e) => handleAddressFieldChange('state', e.target.value)}
                  placeholder="State"
                  required
                />
              </div>

              <div>
                <label className="block text-sm font-medium text-gray-700 mb-1">
                  ZIP Code *
                </label>
                <Input
                  type="text"
                  value={clientDetails.mailingAddress?.zipCode || ''}
                  onChange={(e) => handleAddressFieldChange('zipCode', e.target.value)}
                  placeholder="ZIP Code"
                  required
                />
              </div>
            </div>
          </div>

          {/* Co-Insured Section */}
          <div className="border-t pt-4">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center gap-2">
                <Users className="h-4 w-4 text-blue-600" />
                <h4 className="text-sm font-medium text-gray-700">Co-Insured</h4>
              </div>
              <Switch
                checked={clientDetails.hasCoInsured}
                onCheckedChange={(checked) => handleSwitchChange('hasCoInsured', checked)}
              />
            </div>

            {clientDetails.hasCoInsured && (
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Co-Insured Name *
                  </label>
                  <Input
                    type="text"
                    value={clientDetails.coInsuredName}
                    onChange={(e) => handleInputChange('coInsuredName', e.target.value)}
                    placeholder="Full name of co-insured"
                    required={clientDetails.hasCoInsured}
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-gray-700 mb-1">
                    Relationship
                  </label>
                  <select
                    value={clientDetails.coInsuredRelationship}
                    onChange={(e) => handleInputChange('coInsuredRelationship', e.target.value)}
                    className="w-full p-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                  >
                    <option value="">Select relationship</option>
                    <option value="spouse">Spouse</option>
                    <option value="partner">Partner</option>
                    <option value="parent">Parent</option>
                    <option value="child">Child</option>
                    <option value="sibling">Sibling</option>
                    <option value="business_partner">Business Partner</option>
                    <option value="co_owner">Co-Owner</option>
                    <option value="other">Other</option>
                  </select>
                </div>
              </div>
            )}
          </div>
        </CardContent>
      </Card>
    </div>
  );
};